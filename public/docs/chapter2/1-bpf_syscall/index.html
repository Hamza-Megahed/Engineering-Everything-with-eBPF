<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>bpf() syscall | Engineering Everything with eBPF</title>
<meta name="description" content="Single entry point the kernel exposes for loading programs, creating maps any more.">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter2/1-bpf_syscall/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="bpf() syscall">
  <meta property="og:description" content="Single entry point the kernel exposes for loading programs, creating maps any more.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">

  <meta itemprop="name" content="bpf() syscall">
  <meta itemprop="description" content="Single entry point the kernel exposes for loading programs, creating maps any more.">
  <meta itemprop="wordCount" content="1256">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="bpf() syscall">
  <meta name="twitter:description" content="Single entry point the kernel exposes for loading programs, creating maps any more.">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Engineering Everything with eBPF" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter0-li">
  <a href="/docs/chapter0/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter0"><span class="">Before We Begin</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter01-author-li">
  <a href="/docs/chapter0/1-author/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter01-author"><span class="">Author</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter03-copyright-li">
  <a href="/docs/chapter0/3-copyright/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter03-copyright"><span class="">Copyright</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter04-preface-li">
  <a href="/docs/chapter0/4-preface/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter04-preface"><span class="">Preface</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter05-contribution-li">
  <a href="/docs/chapter0/5-contribution/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter05-contribution"><span class="">Contribution Guidelines</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter02-acknowledgements-li">
  <a href="/docs/chapter0/2-acknowledgements/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter02-acknowledgements"><span class=""></span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter1-li">
  <a href="/docs/chapter1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter1"><span class="">What is eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter11-intro-li">
  <a href="/docs/chapter1/1-intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter11-intro"><span class="">Introduction</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter12-history-li">
  <a href="/docs/chapter1/2-history/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter12-history"><span class="">History of eBPF</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter13-real-world-li">
  <a href="/docs/chapter1/3-real-world/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter13-real-world"><span class="">eBPF in the Real World</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter14-why-li">
  <a href="/docs/chapter1/4-why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter14-why"><span class="">Why eBPF?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter15-arch-li">
  <a href="/docs/chapter1/5-arch/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter15-arch"><span class="">eBPF Architecture</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docschapter2-li">
  <a href="/docs/chapter2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter2"><span class="">eBPF Taking off</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docschapter21-bpf_syscall-li">
  <a href="/docs/chapter2/1-bpf_syscall/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-docschapter21-bpf_syscall"><span class="td-sidebar-nav-active-item">bpf() syscall</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter22-maps-li">
  <a href="/docs/chapter2/2-maps/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter22-maps"><span class="">eBPF Maps</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter23-map_operations-li">
  <a href="/docs/chapter2/3-map_operations/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter23-map_operations"><span class="">eBPF Map Operations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter24-prog_types-li">
  <a href="/docs/chapter2/4-prog_types/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter24-prog_types"><span class="">eBPF Program Types</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter3-li">
  <a href="/docs/chapter3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter3"><span class="">eBPF Probes</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter31-kprobe-kretprobe-li">
  <a href="/docs/chapter3/1-kprobe-kretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter31-kprobe-kretprobe"><span class="">Kprobe and Kretprobe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter32-uprobe-uretprobe-li">
  <a href="/docs/chapter3/2-uprobe-uretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter32-uprobe-uretprobe"><span class="">Uprobes and Uretprobes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter33-tracepoints-li">
  <a href="/docs/chapter3/3-tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter33-tracepoints"><span class="">Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter34-raw_tracepoints-li">
  <a href="/docs/chapter3/4-raw_tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter34-raw_tracepoints"><span class="">Raw Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter35-fentry-fexit-li">
  <a href="/docs/chapter3/5-fentry-fexit/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter35-fentry-fexit"><span class="">Fentry and Fexit</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter4-li">
  <a href="/docs/chapter4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter4"><span class="">Networking with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter41-socket-li">
  <a href="/docs/chapter4/1-socket/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter41-socket"><span class="">Socket Filter</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter42-lwt-li">
  <a href="/docs/chapter4/2-lwt/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter42-lwt"><span class="">Lightweight Tunnels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter43-tc-li">
  <a href="/docs/chapter4/3-tc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter43-tc"><span class="">Traffic Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter44-xdp-li">
  <a href="/docs/chapter4/4-xdp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter44-xdp"><span class="">XDP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter45-cgroup_sock_addr-li">
  <a href="/docs/chapter4/5-cgroup_sock_addr/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter45-cgroup_sock_addr"><span class="">CGroup Socket Address</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter5-li">
  <a href="/docs/chapter5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter5"><span class="">Security with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter51-seccomp-li">
  <a href="/docs/chapter5/1-seccomp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter51-seccomp"><span class="">Seccomp</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter52-lsm-li">
  <a href="/docs/chapter5/2-lsm/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter52-lsm"><span class="">Linux Security Module (LSM)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter53-landlock-li">
  <a href="/docs/chapter5/3-landlock/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter53-landlock"><span class="">Landlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter54-bpf_send_signal-li">
  <a href="/docs/chapter5/4-bpf_send_signal/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter54-bpf_send_signal"><span class="">bpf_send_signal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter55-tetragon-li">
  <a href="/docs/chapter5/5-tetragon/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter55-tetragon"><span class="">Tetragon</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter56-bpfilter-li">
  <a href="/docs/chapter5/6-bpfilter/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter56-bpfilter"><span class="">Bpfilter</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter6-li">
  <a href="/docs/chapter6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter6"><span class="">Tools and languages</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter61-bpftrace-li">
  <a href="/docs/chapter6/1-bpftrace/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter61-bpftrace"><span class="">bpftrace</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter62-bcc-li">
  <a href="/docs/chapter6/2-bcc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter62-bcc"><span class="">BCC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter63-bpftool-li">
  <a href="/docs/chapter6/3-bpftool/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter63-bpftool"><span class="">BPFTool</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter64-tail-call-li">
  <a href="/docs/chapter6/4-tail-call/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter64-tail-call"><span class="">Tail call</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/tree/main/content/docs/chapter2/1-bpf_syscall.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/edit/main/content/docs/chapter2/1-bpf_syscall.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/new/main/content/docs/chapter2?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new?title=bpf%28%29%20syscall" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/docs/chapter2/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction-to-the-bpf-system-call">Introduction to the bpf() System Call</a></li>
        <li><a href="#bpf_prog_load">bpf_prog_load</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a></li>
  <li class="breadcrumb-item">
    <a href="/docs/chapter2/">eBPF Taking off</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    bpf() syscall</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>bpf() syscall</h1>
	<div class="lead">Single entry point the kernel exposes for loading programs, creating maps any more.</div>
	<header class="article-meta">
		
  </header>
	<h3 id="introduction-to-the-bpf-system-call">Introduction to the bpf() System Call<a class="td-heading-self-link" href="#introduction-to-the-bpf-system-call" aria-label="Heading self-link"></a></h3>
<p>The bpf() system call serves as a central mechanism in the Linux kernel for working with the Extended Berkeley Packet Filter (eBPF) subsystem. Originally introduced as a tool to filter packets in the kernel’s networking stack, Berkeley Packet Filters (BPF) allowed user space to define small programs that run efficiently in kernel space. Over time, this concept has evolved significantly from “classic” BPF (cBPF) to “extended” BPF (eBPF), which unlocks a far richer set of capabilities. The extended model supports versatile data structures, the ability to attach programs to a variety of kernel subsystems, and the invocation of helper functions that simplify complex operations.</p>
<p>The bpf() system call accepts a command argument determining the exact operation to be performed, and a corresponding attribute structure that passes parameters specific to that operation. Among these operations are commands to load eBPF programs into the kernel, create and manage eBPF maps, attach programs to hooks, and query or manipulate existing eBPF objects. This wide range of functionality makes bpf() a cornerstone of eBPF-based tooling in modern Linux systems.</p>
<p>The kernel ensures eBPF programs cannot crash or destabilize the system through rigorous static analysis at load time. As a result, the bpf() system call provides a secure yet flexible interface for extending kernel functionality.</p>
<p>In the <strong><code>/include/uapi/linux/bpf.h</code></strong> header file, you will find a list of all the commands used in the <code>bpf()</code> syscall. These commands define the actions that can be performed on eBPF objects, such as loading programs, creating maps, attaching programs to kernel events, and more. The commands are organized as part of the <code>enum bpf_cmd</code>, which is used as an argument to specify the desired operation when invoking the <code>bpf()</code> syscall.</p>
<p>Here’s an example of how the <code>enum bpf_cmd</code> is defined in the kernel source:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_cmd</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_UPDATE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_DELETE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_NEXT_KEY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_PIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_GET</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_ATTACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_DETACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_TEST_RUN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_RUN</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_PROG_TEST_RUN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_GET_INFO_BY_FD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_QUERY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_RAW_TRACEPOINT_OPEN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_LOAD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_TASK_FD_QUERY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_AND_DELETE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_FREEZE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_AND_DELETE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_UPDATE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_DELETE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_UPDATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_ENABLE_STATS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_ITER_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_DETACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_BIND_MAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_TOKEN_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__MAX_BPF_CMD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>We are not going through the full list but among these commands, one of the most important is <code>bpf_prog_load</code>. This command is used to load an eBPF program into the kernel. By invoking <code>bpf()</code> with the <code>BPF_PROG_LOAD</code> command, the kernel verifies the program’s safety, ensuring that it won’t cause any harm to the system. Upon success, the program is loaded into the kernel, and the system call returns a file descriptor associated with this eBPF program, allowing the program to be attached to various kernel events or subsystems, such as network interfaces, tracepoints, or XDP.</p>
<p>In the kernel’s BPF subsystem, specifically in <code>kernel/bpf/syscall.c</code>, a switch statement is used to dispatch commands defined by the enum bpf_cmd to their corresponding handler functions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_CREATE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_LOOKUP_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_UPDATE_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_DELETE_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_GET_NEXT_KEY</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_FREEZE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_freeze</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p>Now, let’s take a closer look at how <code>bpf_prog_load</code> works in practice and how  eBPF programs can be loaded into the kernel.</p>
<h3 id="bpf_prog_load">bpf_prog_load<a class="td-heading-self-link" href="#bpf_prog_load" aria-label="Heading self-link"></a></h3>
<p>As outlined in <code>man 2 bpf</code>, the <code>bpf_prog_load</code> operation is used to load an eBPF program into the Linux kernel via the <code>bpf()</code> syscall. When successful, this operation returns a new file descriptor associated with the loaded eBPF program. This file descriptor can then be used for operations such as attaching the program to specific kernel events (e.g., networking, tracing), checking its status, or even unloading it when necessary. The <code>BPF_PROG_LOAD</code> operation is invoked through the <code>bpf()</code> syscall to load the eBPF program into the kernel.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">bpf_log_buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOG_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_insn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#000">attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">insns</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">insn_cnt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">license</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_buf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_log_buf</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LOG_BUF_SIZE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_level</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">bpf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Key Parameters:</strong></p>
<ul>
<li><code>prog_type</code>: Specifies the type of eBPF program (e.g., <code>BPF_PROG_TYPE_XDP</code>, <code>BPF_PROG_TYPE_KPROBE</code>).</li>
<li><code>insns</code>: The array of eBPF instructions (bytecode) that the program consists of.</li>
<li><code>insn_cnt</code>: The number of instructions in the <strong><code>insns</code></strong> array.</li>
<li><code>license</code>: This attribute specifies the license under which the eBPF program is distributed. It is important for ensuring compatibility with kernel helper functions that are <code>GPL-only</code>. Some eBPF helpers are restricted to being used only in programs that have a GPL-compatible license. Examples of such licenses include &ldquo;GPL&rdquo;, &ldquo;GPL v2&rdquo;, or &ldquo;Dual BSD/GPL&rdquo;. If the program’s license is not compatible with the GPL, it may not be allowed to invoke these specific helper functions.</li>
<li><code>log_buf</code>: A buffer where the kernel stores the verification log if the program fails verification.</li>
<li><code>log_size</code>: The size of the verification log buffer.</li>
</ul>
<p>When a user-space process issues a <code>BPF_PROG_LOAD</code> command, the kernel invokes the <code>bpf_prog_load(&amp;attr, uattr, size)</code> function which is defined in <code>kernel/bpf/syscall.c</code> kernel source code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bpfptr_t</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span> <span style="color:#000">uattr_size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">prog_type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst_prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">btf</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attach_btf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_token</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">bpf_cap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">license</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p><strong>libbpf Wrapper for <code>bpf_prog_load</code>:</strong></p>
<p>To simplify working with eBPF programs, libbpf provides the <code>bpf_prog_load()</code> function, which abstracts the complexity of interacting with the kernel via the <code>bpf()</code> syscall. This wrapper is located in <code>/tools/lib/bpf/bpf.c</code> and provides additional functionality like retrying failed program loads and setting detailed log options.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">prog_type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_insn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog_load_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>This function simplifies the process of loading eBPF programs by wrapping around the <strong><code>bpf()</code></strong> syscall, handling retries, and providing additional configuration options. <code>bpf_prog_load_opts</code> Structure:</p>
<p>This structure provides additional configuration options when loading an eBPF program, as seen below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog_load_opts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">;</span>                          <span style="color:#8f5902;font-style:italic">// Size of this structure for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">;</span>                        <span style="color:#8f5902;font-style:italic">// Retry attempts if bpf() returns -EAGAIN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_attach_type</span> <span style="color:#000">expected_attach_type</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Expected attachment type
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_btf_fd</span><span style="color:#000;font-weight:bold">;</span>                  <span style="color:#8f5902;font-style:italic">// BTF file descriptor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_flags</span><span style="color:#000;font-weight:bold">;</span>                   <span style="color:#8f5902;font-style:italic">// Program flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_ifindex</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Interface index for programs like XDP
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">kern_version</span><span style="color:#000;font-weight:bold">;</span>                  <span style="color:#8f5902;font-style:italic">// Kernel version for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fd_array</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Array of file descriptors for attachments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">func_info</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">// Function info for BTF
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">func_info_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Function info count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">func_info_rec_size</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">// Function info record size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">line_info</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">// Line info for BTF
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">line_info_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Line info count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">line_info_rec_size</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">// Line info record size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_level</span><span style="color:#000;font-weight:bold">;</span>                    <span style="color:#8f5902;font-style:italic">// Log verbosity for verifier logs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_size</span><span style="color:#000;font-weight:bold">;</span>                     <span style="color:#8f5902;font-style:italic">// Log buffer size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">log_buf</span><span style="color:#000;font-weight:bold">;</span>                      <span style="color:#8f5902;font-style:italic">// Log buffer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_true_size</span><span style="color:#000;font-weight:bold">;</span>                <span style="color:#8f5902;font-style:italic">// Actual log size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">token_fd</span><span style="color:#000;font-weight:bold">;</span>                     <span style="color:#8f5902;font-style:italic">// Token file descriptor (optional)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">fd_array_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Length of fd_array
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>                          <span style="color:#8f5902;font-style:italic">// Padding for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>At the heart of eBPF lies the concept of eBPF maps. Maps are generic, dynamic, kernel-resident data structures accessible from both eBPF programs and user space applications. They allow you to share state and pass information between user space and eBPF code.
The Linux man page (<code>man 2 bpf</code>) states:</p>
<blockquote>
<p>&ldquo;eBPF maps are a generic data structure for storage of different data types. Data types are generally treated as binary blobs. A user just specifies the size of the key and the size of the value at map-creation time.&rdquo;</p>
</blockquote>
<p>Now, let’s dive into the world of eBPF maps and explore how these powerful data structures are created, accessed, and used within the kernel. By understanding how to interact with maps, you’ll unlock the ability to efficiently store and retrieve data across different eBPF programs.</p>

	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>