<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Fentry and Fexit | Engineering Everything with eBPF</title>
<meta name="description" content="Modern low overhead probes attached directly to function start and return.">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter3/5-fentry-fexit/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="Fentry and Fexit">
  <meta property="og:description" content="Modern low overhead probes attached directly to function start and return.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">

  <meta itemprop="name" content="Fentry and Fexit">
  <meta itemprop="description" content="Modern low overhead probes attached directly to function start and return.">
  <meta itemprop="wordCount" content="1027">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Fentry and Fexit">
  <meta name="twitter:description" content="Modern low overhead probes attached directly to function start and return.">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.3c5aebc1447634a6b24181e7c36ac494.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.3c5aebc1447634a6b24181e7c36ac494.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Engineering Everything with eBPF" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter0-li">
  <a href="/docs/chapter0/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter0"><span class="">Before We Begin</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter01-author-li">
  <a href="/docs/chapter0/1-author/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter01-author"><span class="">Author</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter03-copyright-li">
  <a href="/docs/chapter0/3-copyright/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter03-copyright"><span class="">Copyright</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter04-preface-li">
  <a href="/docs/chapter0/4-preface/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter04-preface"><span class="">Preface</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter05-contribution-li">
  <a href="/docs/chapter0/5-contribution/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter05-contribution"><span class="">Contribution Guidelines</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter02-acknowledgements-li">
  <a href="/docs/chapter0/2-acknowledgements/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter02-acknowledgements"><span class=""></span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter1-li">
  <a href="/docs/chapter1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter1"><span class="">What is eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter11-intro-li">
  <a href="/docs/chapter1/1-intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter11-intro"><span class="">Introduction</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter12-history-li">
  <a href="/docs/chapter1/2-history/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter12-history"><span class="">History of eBPF</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter13-real-world-li">
  <a href="/docs/chapter1/3-real-world/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter13-real-world"><span class="">eBPF in the Real World</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter14-why-li">
  <a href="/docs/chapter1/4-why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter14-why"><span class="">Why eBPF?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter15-arch-li">
  <a href="/docs/chapter1/5-arch/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter15-arch"><span class="">eBPF Architecture</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter2-li">
  <a href="/docs/chapter2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter2"><span class="">eBPF Taking off</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter21-bpf_syscall-li">
  <a href="/docs/chapter2/1-bpf_syscall/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter21-bpf_syscall"><span class="">bpf() syscall</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter22-maps-li">
  <a href="/docs/chapter2/2-maps/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter22-maps"><span class="">eBPF Maps</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter23-map_operations-li">
  <a href="/docs/chapter2/3-map_operations/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter23-map_operations"><span class="">eBPF Map Operations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter24-prog_types-li">
  <a href="/docs/chapter2/4-prog_types/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter24-prog_types"><span class="">eBPF Program Types</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docschapter3-li">
  <a href="/docs/chapter3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter3"><span class="">eBPF Probes</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter31-kprobe-kretprobe-li">
  <a href="/docs/chapter3/1-kprobe-kretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter31-kprobe-kretprobe"><span class="">Kprobe and Kretprobe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter32-uprobe-uretprobe-li">
  <a href="/docs/chapter3/2-uprobe-uretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter32-uprobe-uretprobe"><span class="">Uprobes and Uretprobes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter33-tracepoints-li">
  <a href="/docs/chapter3/3-tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter33-tracepoints"><span class="">Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter34-raw_tracepoints-li">
  <a href="/docs/chapter3/4-raw_tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter34-raw_tracepoints"><span class="">Raw Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docschapter35-fentry-fexit-li">
  <a href="/docs/chapter3/5-fentry-fexit/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-docschapter35-fentry-fexit"><span class="td-sidebar-nav-active-item">Fentry and Fexit</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter4-li">
  <a href="/docs/chapter4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter4"><span class="">Networking with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter41-socket-li">
  <a href="/docs/chapter4/1-socket/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter41-socket"><span class="">Socket Filter</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter42-lwt-li">
  <a href="/docs/chapter4/2-lwt/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter42-lwt"><span class="">Lightweight Tunnels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter43-tc-li">
  <a href="/docs/chapter4/3-tc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter43-tc"><span class="">Traffic Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter44-xdp-li">
  <a href="/docs/chapter4/4-xdp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter44-xdp"><span class="">XDP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter45-cgroup_sock_addr-li">
  <a href="/docs/chapter4/5-cgroup_sock_addr/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter45-cgroup_sock_addr"><span class="">CGroup Socket Address</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter5-li">
  <a href="/docs/chapter5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter5"><span class="">Security with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter51-seccomp-li">
  <a href="/docs/chapter5/1-seccomp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter51-seccomp"><span class="">Seccomp</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter52-lsm-li">
  <a href="/docs/chapter5/2-lsm/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter52-lsm"><span class="">Linux Security Module (LSM)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter53-landlock-li">
  <a href="/docs/chapter5/3-landlock/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter53-landlock"><span class="">Landlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter54-bpf_send_signal-li">
  <a href="/docs/chapter5/4-bpf_send_signal/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter54-bpf_send_signal"><span class="">bpf_send_signal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter55-tetragon-li">
  <a href="/docs/chapter5/5-tetragon/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter55-tetragon"><span class="">Tetragon</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter56-bpfilter-li">
  <a href="/docs/chapter5/6-bpfilter/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter56-bpfilter"><span class="">Bpfilter</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter6-li">
  <a href="/docs/chapter6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter6"><span class="">Tools and languages</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter61-bpftrace-li">
  <a href="/docs/chapter6/1-bpftrace/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter61-bpftrace"><span class="">bpftrace</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter62-bcc-li">
  <a href="/docs/chapter6/2-bcc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter62-bcc"><span class="">BCC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter63-bpftool-li">
  <a href="/docs/chapter6/3-bpftool/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter63-bpftool"><span class="">BPFTool</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter64-tail-call-li">
  <a href="/docs/chapter6/4-tail-call/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter64-tail-call"><span class="">Tail call</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/tree/main/content/docs/chapter3/5-fentry-fexit.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/edit/main/content/docs/chapter3/5-fentry-fexit.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/new/main/content/docs/chapter3?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new?title=Fentry%20and%20Fexit" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/docs/chapter3/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#fentry">Fentry</a></li>
    <li><a href="#fexit">Fexit</a></li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a></li>
  <li class="breadcrumb-item">
    <a href="/docs/chapter3/">eBPF Probes</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    Fentry and Fexit</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Fentry and Fexit</h1>
	<div class="lead">Modern low overhead probes attached directly to function start and return.</div>
	<header class="article-meta">
		
  </header>
	<h2 id="fentry">Fentry<a class="td-heading-self-link" href="#fentry" aria-label="Heading self-link"></a></h2>
<p>An fentry eBPF program is attached precisely at the entry point of a kernel function. Introduced in Linux kernel 5.5 , fentry uses a BPF trampoline to patch function entry points to invoke eBPF code. This results in minimal overhead compared to traditional <code>kprobe</code>.</p>
<ul>
<li>When a function is compiled with tracing support CONFIG_FUNCTION_TRACER, the compiler inserts a call to <code>__fentry__</code> at the beginning of the function which contains several <code>NOP</code> instructions <code>0x90</code>.</li>
<li>When an fentry eBPF program is attached, the kernel patches the NOPs dynamically—replacing it with a jump to a BPF trampoline.</li>
<li>The trampoline then efficiently invokes fentry handler (without the overhead of breakpoints or interrupts) and, after executing, returns control to the original function so that normal execution continues.
Fentry-based and fexit-based eBPF programs are classified under the program type <code>BPF_PROG_TYPE_TRACING</code>.
By looking at the entry is a kernel function such as <code>do_set_acl</code>. First we need to download debug symbols for the kernel, on debian just <code>sudo apt-get install linux-image-$(uname -r)-dbg</code> and the debug symbols will be at <code>/usr/lib/debug/boot/vmlinux-$(uname -r)</code>.
Getting the entry point of <code>do_set_acl</code> using <code>objdump -d vmlinux-$(uname -r) | grep -A 10 &quot;&lt;do_set_acl&gt;:&quot;</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ffffffff814d7d20</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">do_set_acl</span><span style="color:#ce5c00;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d20</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">f3</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e</span> <span style="color:#000">fa</span>          	<span style="color:#000">endbr64</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d24</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">e8</span> <span style="color:#0000cf;font-weight:bold">37</span> <span style="color:#0000cf;font-weight:bold">56</span> <span style="color:#000">bb</span> <span style="color:#000">ff</span>       	<span style="color:#000">call</span>   <span style="color:#000">ffffffff8108d360</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__fentry__</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d29</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">41</span> <span style="color:#0000cf;font-weight:bold">55</span>                	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r13</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d2b</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">49</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">d5</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rdx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r13</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d2e</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">41</span> <span style="color:#0000cf;font-weight:bold">54</span>                	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r12</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d30</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">49</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">f4</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rsi</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r12</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d33</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">55</span>                   	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d34</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">48</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">fd</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rdi</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d37</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">53</span>                   	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbx</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d38</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000">d</span> <span style="color:#0000cf;font-weight:bold">85</span> <span style="color:#000">c0</span>             	<span style="color:#000">test</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r8</span>
</span></span></code></pre></div><p>We can look at <code>__fentry__</code> using <code>objdump -d vmlinux-$(uname -r) | grep -A 15 &quot;&lt;__fentry__&gt;:&quot;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ffffffff8108d360</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__fentry__</span><span style="color:#ce5c00;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d360</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">f3</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e</span> <span style="color:#000">fa</span>          	<span style="color:#000">endbr64</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d364</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d365</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d366</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d367</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d368</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d369</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36a</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36b</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36c</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36d</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">e9</span> <span style="color:#000">ee</span> <span style="color:#000">de</span> <span style="color:#000">c6</span> <span style="color:#0000cf;font-weight:bold">00</span>       	<span style="color:#000">jmp</span>    <span style="color:#000">ffffffff81cfb260</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__x86_return_thunk</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d372</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">66</span> <span style="color:#0000cf;font-weight:bold">66</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">e</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1f</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">00</span> 	<span style="color:#000">data16</span> <span style="color:#000">cs</span> <span style="color:#000">nopw</span> <span style="color:#0000cf;font-weight:bold">0x0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d379</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d37d</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1f</span> <span style="color:#0000cf;font-weight:bold">00</span>             	<span style="color:#000">nopl</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>Before inserting an fentry probe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-before.png" alt="Centered image" />
</p>
<p><strong>After inserting an fentry probe (with BPF trampoline):</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-after.png" alt="Centered image" />
</p>
<p>Let&rsquo;s see the following example, which attaches a probe to the entry of <code>do_set_acl</code> kernel function. <code>do_set_acl</code> is a kernel function that implements the setting of Access Control Lists (ACLs) on files and directories, enabling granular permission control beyond standard Unix permissions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fentry/do_set_acl&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handle_do_set_acl</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do_set_acl: dentry=%s, acl_name=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>do_set_acl</code> is defined in <code>fs/posix_acl.c</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">do_set_acl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We can also obtain the parameters using <code>sudo bpftrace -lv 'fentry:do_set_acl'</code> (bpftrace will be explained in details later):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fentry:vmlinux:do_set_acl
</span></span><span style="display:flex;"><span>    struct mnt_idmap * idmap
</span></span><span style="display:flex;"><span>    struct dentry * dentry
</span></span><span style="display:flex;"><span>    const char * acl_name
</span></span><span style="display:flex;"><span>    const void * kvalue
</span></span><span style="display:flex;"><span>    size_t size
</span></span><span style="display:flex;"><span>    int retval
</span></span></code></pre></div><p>user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;fentry.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fentry__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Executing <code>setctl</code> to change ACL such as <code>setfacl -m u:test:rwx /tmp/file1</code> or <code>setfacl -m u:test:rwx /etc/passwd</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&lt;...&gt;-3776      <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>file1, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access
</span></span><span style="display:flex;"><span>setfacl-3777    <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>passwd, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access
</span></span></code></pre></div><h2 id="fexit">Fexit<a class="td-heading-self-link" href="#fexit" aria-label="Heading self-link"></a></h2>
<p>An fexit eBPF program is attached at the point when a kernel function returns (exits). Introduced alongside fentry, fexit programs also leverage the BPF trampoline. When you attach an fexit program, the kernel finds and patches the return instruction in the function to jump to BPF trampoline. That trampoline then calls your fexit handler before finally returning to the caller. Unlike traditional <code>kretprobe</code>, fexit programs have direct access to both the input parameters of the traced kernel function and its return value. Thus, you don&rsquo;t need to use additional maps or state tracking to record inputs before function execution.</p>
<p><strong>Before inserting an fexit probe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fexit-before.png" alt="Centered image" />
</p>
<p><strong>After inserting an fexit probe (with BPF trampoline):</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-after.png" alt="Centered image" />
</p>
<p>Let&rsquo;s explore the following example which is attach a probe to return of do_set_acl kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fexit/do_set_acl&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handle_do_set_acl</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">retval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do_set_acl: dentry=%s, acl_name=%s, retval=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">retval</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;fexit.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fexit</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fexit__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>setfacl-3861 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>file1, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access, <span style="color:#000">retval</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;...&gt;-3862 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>passwd, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access, <span style="color:#000">retval</span><span style="color:#ce5c00;font-weight:bold">=</span>-1
</span></span></code></pre></div><p>Fexit programs have direct access to both the input parameters of the traced kernel function and its return value.</p>

	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>