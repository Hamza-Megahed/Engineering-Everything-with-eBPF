<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Kprobe and Kretprobe | Engineering Everything with eBPF</title>
<meta name="description" content="Instrument kernel functions at entry and exit for live tracing.">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter3/1-kprobe-kretprobe/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="Kprobe and Kretprobe">
  <meta property="og:description" content="Instrument kernel functions at entry and exit for live tracing.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">

  <meta itemprop="name" content="Kprobe and Kretprobe">
  <meta itemprop="description" content="Instrument kernel functions at entry and exit for live tracing.">
  <meta itemprop="wordCount" content="7324">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kprobe and Kretprobe">
  <meta name="twitter:description" content="Instrument kernel functions at entry and exit for live tracing.">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Engineering Everything with eBPF" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter0-li">
  <a href="/docs/chapter0/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter0"><span class="">Before We Begin</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter01-author-li">
  <a href="/docs/chapter0/1-author/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter01-author"><span class="">Author</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter03-copyright-li">
  <a href="/docs/chapter0/3-copyright/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter03-copyright"><span class="">Copyright</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter04-preface-li">
  <a href="/docs/chapter0/4-preface/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter04-preface"><span class="">Preface</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter05-contribution-li">
  <a href="/docs/chapter0/5-contribution/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter05-contribution"><span class="">Contribution Guidelines</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter02-acknowledgements-li">
  <a href="/docs/chapter0/2-acknowledgements/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter02-acknowledgements"><span class=""></span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter1-li">
  <a href="/docs/chapter1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter1"><span class="">What is eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter11-intro-li">
  <a href="/docs/chapter1/1-intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter11-intro"><span class="">Introduction</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter12-history-li">
  <a href="/docs/chapter1/2-history/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter12-history"><span class="">History of eBPF</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter13-real-world-li">
  <a href="/docs/chapter1/3-real-world/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter13-real-world"><span class="">eBPF in the Real World</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter14-why-li">
  <a href="/docs/chapter1/4-why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter14-why"><span class="">Why eBPF?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter15-arch-li">
  <a href="/docs/chapter1/5-arch/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter15-arch"><span class="">eBPF Architecture</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter2-li">
  <a href="/docs/chapter2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter2"><span class="">eBPF Taking off</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter21-bpf_syscall-li">
  <a href="/docs/chapter2/1-bpf_syscall/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter21-bpf_syscall"><span class="">bpf() syscall</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter22-maps-li">
  <a href="/docs/chapter2/2-maps/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter22-maps"><span class="">eBPF Maps</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter23-map_operations-li">
  <a href="/docs/chapter2/3-map_operations/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter23-map_operations"><span class="">eBPF Map Operations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter24-prog_types-li">
  <a href="/docs/chapter2/4-prog_types/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter24-prog_types"><span class="">eBPF Program Types</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docschapter3-li">
  <a href="/docs/chapter3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter3"><span class="">eBPF Probes</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docschapter31-kprobe-kretprobe-li">
  <a href="/docs/chapter3/1-kprobe-kretprobe/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-docschapter31-kprobe-kretprobe"><span class="td-sidebar-nav-active-item">Kprobe and Kretprobe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter32-uprobe-uretprobe-li">
  <a href="/docs/chapter3/2-uprobe-uretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter32-uprobe-uretprobe"><span class="">Uprobes and Uretprobes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter33-tracepoints-li">
  <a href="/docs/chapter3/3-tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter33-tracepoints"><span class="">Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter34-raw_tracepoints-li">
  <a href="/docs/chapter3/4-raw_tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter34-raw_tracepoints"><span class="">Raw Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter35-fentry-fexit-li">
  <a href="/docs/chapter3/5-fentry-fexit/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter35-fentry-fexit"><span class="">Fentry and Fexit</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter4-li">
  <a href="/docs/chapter4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter4"><span class="">Networking with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter41-socket-li">
  <a href="/docs/chapter4/1-socket/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter41-socket"><span class="">Socket Filter</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter42-lwt-li">
  <a href="/docs/chapter4/2-lwt/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter42-lwt"><span class="">Lightweight Tunnels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter43-tc-li">
  <a href="/docs/chapter4/3-tc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter43-tc"><span class="">Traffic Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter44-xdp-li">
  <a href="/docs/chapter4/4-xdp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter44-xdp"><span class="">XDP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter45-cgroup_sock_addr-li">
  <a href="/docs/chapter4/5-cgroup_sock_addr/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter45-cgroup_sock_addr"><span class="">CGroup Socket Address</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter5-li">
  <a href="/docs/chapter5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter5"><span class="">Security with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter51-seccomp-li">
  <a href="/docs/chapter5/1-seccomp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter51-seccomp"><span class="">Seccomp</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter52-lsm-li">
  <a href="/docs/chapter5/2-lsm/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter52-lsm"><span class="">Linux Security Module (LSM)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter53-landlock-li">
  <a href="/docs/chapter5/3-landlock/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter53-landlock"><span class="">Landlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter54-bpf_send_signal-li">
  <a href="/docs/chapter5/4-bpf_send_signal/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter54-bpf_send_signal"><span class="">bpf_send_signal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter55-tetragon-li">
  <a href="/docs/chapter5/5-tetragon/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter55-tetragon"><span class="">Tetragon</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter56-bpfilter-li">
  <a href="/docs/chapter5/6-bpfilter/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter56-bpfilter"><span class="">Bpfilter</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter6-li">
  <a href="/docs/chapter6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter6"><span class="">Tools and languages</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter61-bpftrace-li">
  <a href="/docs/chapter6/1-bpftrace/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter61-bpftrace"><span class="">bpftrace</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter62-bcc-li">
  <a href="/docs/chapter6/2-bcc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter62-bcc"><span class="">BCC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter63-bpftool-li">
  <a href="/docs/chapter6/3-bpftool/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter63-bpftool"><span class="">BPFTool</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter64-tail-call-li">
  <a href="/docs/chapter6/4-tail-call/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter64-tail-call"><span class="">Tail call</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/tree/main/content/docs/chapter3/1-kprobe-kretprobe.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/edit/main/content/docs/chapter3/1-kprobe-kretprobe.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/new/main/content/docs/chapter3?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new?title=Kprobe%20and%20Kretprobe" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/docs/chapter3/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#writing-ebpf-code">Writing eBPF Code</a></li>
        <li><a href="#libbpf">libbpf</a></li>
        <li><a href="#ebpf-probes">eBPF Probes</a></li>
      </ul>
    </li>
    <li><a href="#kprobe-kretprobe">kprobe-kretprobe</a>
      <ul>
        <li><a href="#kprobes-in-detail">Kprobes in Detail</a></li>
        <li><a href="#kretprobes-in-detail">Kretprobes in Detail</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a></li>
  <li class="breadcrumb-item">
    <a href="/docs/chapter3/">eBPF Probes</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    Kprobe and Kretprobe</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Kprobe and Kretprobe</h1>
	<div class="lead">Instrument kernel functions at entry and exit for live tracing.</div>
	<header class="article-meta">
		
  </header>
	<h3 id="writing-ebpf-code">Writing eBPF Code<a class="td-heading-self-link" href="#writing-ebpf-code" aria-label="Heading self-link"></a></h3>
<p>When writing eBPF code, you typically need to write two separate parts: one for <strong>kernel-space</strong> and the other for <strong>user-space</strong>.</p>
<p><strong>Kernel Space Code:</strong></p>
<p>The kernel-space code is responsible for performing specific tasks, such as tracing, monitoring network packets, filtering system calls, or attaching to kprobes, tracepoints, etc. This code interacts directly with the kernel and can access kernel data structures or events. The kernel space is highly sensitive, so the code running there must be safe and efficient.
The kernel-space code is written in a special eBPF-compatible language (with a C-like syntax) and is loaded into the kernel using helper libraries (such as libbpf) or system calls (like <code>bpf()</code>).</p>
<p><strong>User Space Code:</strong></p>
<p>User-space code is responsible for loading the eBPF program into the kernel, attaching it to specific hooks or events, and managing communication between user space and kernel space. It also handles tasks like retrieving data from the kernel (e.g., using maps for data storage).
User-space code is written in a regular programming language (such as C or Python) and runs outside the kernel, as a user-space application.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/eBPF-Architecture.png" alt="Centered image" />
</p>
<h3 id="libbpf">libbpf<a class="td-heading-self-link" href="#libbpf" aria-label="Heading self-link"></a></h3>
<p>libbpf is a C-based library designed to facilitate interaction with the eBPF subsystem in the Linux kernel. It provides a set of high-level and low-level APIs that simplify of loading, verifying, and managing eBPF programs. By handling the complexities of working with the kernel, libbpf enables developers to focus more on optimizing their eBPF code&rsquo;s performance and correctness, rather than managing the details of user-space and kernel-space interactions.</p>
<p>libbpf includes a variety of BPF helper functions that ease development. These helpers allow eBPF programs to interact with the system more effectively, providing functions for tasks like debugging, manipulating network packets, and working with eBPF maps. This reduces the amount of code developers need to write, enabling them to focus on the logic of their BPF programs.</p>
<p>One of the most significant benefits of libbpf is its support for eBPF CO-RE (Compile Once, Run Everywhere), a mechanism that enhances the portability of eBPF programs. By leveraging BTF (BPF Type Format)—a metadata format that describes kernel data types such as data structures, unions, enums, and function prototypes—libbpf allows developers to write eBPF programs that can be compiled once and run across multiple kernel versions. CO-RE produces an ELF file with precompiled eBPF bytecode that can run across different kernel versions, eliminating the need for recompiling or modifying eBPF code for different systems. BTF information can be generated via<br>
<code>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code>. Simply, libbpf uses BTF information to align or modify the types and fields in the eBPF program with the current running kernel. For more information about eBPF CO-RE, please refer to this <a href="https://nakryiko.com/posts/bpf-core-reference-guide/">https://nakryiko.com/posts/bpf-core-reference-guide/</a>.</p>
<p>As stated in <a href="https://docs.kernel.org/bpf/libbpf/libbpf_overview.html">https://docs.kernel.org/bpf/libbpf/libbpf_overview.html</a></p>
<pre tabindex="0"><code>libbpf provides APIs that user space programs can use to manipulate the BPF programs by triggering different phases of a BPF application lifecycle.

The following section provides a brief overview of each phase in the BPF life cycle:

- **Open phase**: In this phase, libbpf parses the BPF object file and discovers BPF maps, BPF programs, and global variables. After a BPF app is opened, user space apps can make additional adjustments (setting BPF program types, if necessary; pre-setting initial values for global variables, etc.) before all the entities are created and loaded.
    
- **Load phase**: In the load phase, libbpf creates BPF maps, resolves various relocations, and verifies and loads BPF programs into the kernel. At this point, libbpf validates all the parts of a BPF application and loads the BPF program into the kernel, but no BPF program has yet been executed. After the load phase, it’s possible to set up the initial BPF map state without racing with the BPF program code execution.
    
- **Attachment phase**: In this phase, libbpf attaches BPF programs to various BPF hook points (e.g., tracepoints, kprobes, cgroup hooks, network packet processing pipeline, etc.). During this phase, BPF programs perform useful work such as processing packets, or updating BPF maps and global variables that can be read from user space.
    
- **Tear down phase**: In the tear down phase, libbpf detaches BPF programs and unloads them from the kernel. BPF maps are destroyed, and all the resources used by the BPF app are freed.
</code></pre><p>A BPF Object Skeleton File is a C header file <code>(.skel.h)</code> generated using <code>bpftool</code> from a compiled eBPF object file. This header file provides a structured interface for interacting with the eBPF program, simplifying its management from user space. For developers seeking simplicity, the eBPF skeleton provides a more abstracted interface for interacting with eBPF programs. The skeleton generates functions such as <code>&lt;name&gt;__open()</code>, <code>&lt;name&gt;__load()</code>, <code>&lt;name&gt;__attach()</code>, and <code>&lt;name&gt;__destroy()</code>, which automate key steps in the eBPF lifecycle, allowing developers to manage eBPF programs with less effort. The skeleton also provides access to global variables and maps, which are directly accessible as structured fields in the user-space program, making it easier to manipulate these elements without relying on string-based lookups.</p>
<h3 id="ebpf-probes">eBPF Probes<a class="td-heading-self-link" href="#ebpf-probes" aria-label="Heading self-link"></a></h3>
<p>eBPF probes are mechanisms used to attach eBPF programs to specific events within the kernel or user-space. These probes allow developers to dynamically hook into various parts of the system and execute eBPF programs when those events or locations are triggered, enabling data collection, behavior monitoring, or influencing execution.</p>
<p>eBPF probes allow attaching to various points in the kernel’s execution flow to observe and sometimes modify behavior. Each type of eBPF probe corresponds to a particular attachment point. Some common probe types include:</p>
<ul>
<li><strong>kprobe:</strong> Attaches to almost any kernel instruction address.</li>
<li><strong>kretprobe (return probe):</strong> Attaches to the return point of a kernel function.</li>
<li><strong>uprobe and uretprobe:</strong> Attach to user-space functions and their returns.</li>
<li><strong>tracepoint and raw_tracepoint:</strong> Attach to static kernel tracepoints for predefined events.</li>
<li><strong>fentry:</strong> Attached to the entry point of a kernel function using an enhanced, lower-overhead mechanism.</li>
<li><strong>fexit:</strong> Attached to the return of a kernel function using an enhanced, lower-overhead mechanism.</li>
</ul>
<h2 id="kprobe-kretprobe">kprobe-kretprobe<a class="td-heading-self-link" href="#kprobe-kretprobe" aria-label="Heading self-link"></a></h2>
<h3 id="kprobes-in-detail">Kprobes in Detail<a class="td-heading-self-link" href="#kprobes-in-detail" aria-label="Heading self-link"></a></h3>
<p><strong>What is a Kprobe?</strong><br>
A kprobe is a dynamic instrumentation mechanism that allows you to attach a custom handler at almost any kernel instruction address, often used at the start of a kernel function. When the CPU executes this probed instruction, it triggers the kprobe handler. This handler can inspect CPU registers, function arguments, and kernel memory state before the original instruction executes. kprobe-based eBPF programs are classified under the program type <code>BPF_PROG_TYPE_KPROBE</code>.
You can list all of the kernel exported symbols using <code>sudo cat /proc/kallsyms</code> and we are only interested in <code>T</code> which represents globally visible text symbols (Code) and they can be attached.</p>
<p><strong>How Kprobes Work Under the Hood:</strong></p>
<ol>
<li>When you register a kprobe on a kernel function (e.g., <code>do_mkdirat</code>), the kernel replaces the first instruction bytes at that function’s entry with a breakpoint instruction <code>int3</code>.</li>
<li>When the function is called, the CPU hits the breakpoint instruction, a trap occurs.</li>
<li>The kernel’s kprobe infrastructure intercepts this exception and calls your eBPF program’s handler. Your eBPF code then has access to the function arguments and can perform any allowed eBPF operations (e.g., reading fields, printing debug information).</li>
<li>After the handler completes its task, instruction flow resumes by single-stepping the original instruction. If the kprobe is no longer needed, the original instruction is restored in place of the breakpoint.</li>
</ol>
<p><strong>Before kprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-before.png" alt="Centered image" />
</p>
<p><strong>After kprobe insertion:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-after.png" alt="Centered image" />
</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    kprobes can be attached to nearly any kernel instruction. However, certain functions—such as those involved in kprobe handling itself—cannot be probed, as doing so would trigger recursive traps and potentially destabilize the kernel.

</div>

<p>As stated in <a href="https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_KPROBE/">https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_KPROBE/</a></p>
<pre tabindex="0"><code>The context passed to kprobe programs is `struct pt_regs`. This structure is different for each CPU architecture since it contains a copy of the CPU registers at the time the kprobe was invoked.

It is common for kprobe programs to use the macros from the Libbpf `bpf_tracing.h` header file, which defines `PT_REGS_PARM1` ... `PT_REGS_PARM5` as well as a number of others. These macros will translate to the correct field in `struct pt_regs` depending on the current architecture. Communicating the architecture you are compiling the BPF program for is done by defining one of the `__TARGET_ARCH_*` values in your program or via the command line while compiling.
</code></pre><p>PT_REGS_PARMX macros are defined in <code>bpf_tracing.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM1(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM1_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM2(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM2_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM3(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM3_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM4(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM4_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM5(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM5_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM6(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM6_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM7(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM7_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM8(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM8_REG)
</span></span></span></code></pre></div><p><code>struct pt_regs</code> is defined in <code>/arch/x86/include/uapi/asm/ptrace.h</code> for the x86-64 architecture:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r15</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r14</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r13</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r12</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rbp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rbx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r11</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r9</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rax</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rcx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rdx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rsi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rdi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">orig_rax</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">eflags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rsp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ss</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>The <code>struct pt_regs</code> stores the CPU&rsquo;s register state at the time of an interrupt, system call, or exception, enabling the kernel to save and restore the execution context of a process. By capturing the state of general-purpose registers, segment registers, and special registers (such as the instruction pointer and stack pointer).</p>
<p>In the next example we will attach a kprobe to start of of <code>do_mkdirat</code> syscall which is used to create a new directory.<br>
<code>do_mkdirat</code> prototype <code>int do_mkdirat(int dfd, struct filename *name, umode_t mode);</code> and it has 3 parameters <code>dfd</code>, <code>struct filename</code>, <code>mode</code>.
<code>dfd</code>: stands for &ldquo;directory file descriptor.&rdquo; It specifies the directory relative to which the new directory should be created.
<code>struct filename</code> is a kernel data structure defined in <code>/include/linux/fs.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* pointer to actual string */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#204a87;font-weight:bold">char</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">uptr</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* original userland pointer */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">atomic_t</span>		<span style="color:#000">refcnt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">audit_names</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aname</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>		<span style="color:#000">iname</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>mode</code> File permission for the created directory.</p>
<p>Now let&rsquo;s start with eBPF kernel code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, as we just explained that we need to define <code>__TARGET_ARCH__XX </code> according to your architecture then include <code>vmlinux.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><p><code>bpf_core_read.h</code> header file provides macros for reading data from kernel or user space in a way that is compatible with BPF CO-RE (Compile Once, Run Everywhere) such as <code>BPF_CORE_READ</code> macro.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Then we added <code>license</code> we we discussed in the previous chapter</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>SEC</code> It tells the compile what ELF section to put which is <code>kprobe</code> and where to attach it which is <code>do_mkdirat</code>. Then kprobe handler <code>kprobe_mkdir</code>  that gets executed when <code>do_mkdirat</code> entry point is triggered.
<code>struct pt_regs *ctx</code> is the context passed to the eBPF program by the kernel. It contains information about the registers at the time the function was invoked, including the function arguments, return addresses. The <code>ctx</code> pointer will be used to extract these values.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>bpf_get_current_pid_tgid()</code> is an eBPF helper function that returns a 64-bit value, where:</p>
<ul>
<li>The lower 32 bits represent the thread group ID (TGID), which is the PID of the thread that initiated the system call.</li>
<li>The upper 32 bits represent the thread ID (PID) of the current thread.
Since we are interested in the <code>PID</code>, we shift the 64-bit value to the right by 32 bits (<code>&gt;&gt; 32</code>) to get just the process ID (PID) of the current process.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>PT_REGS_PARM2(ctx)</code>: As previously discussed, this is a macro used to extract the second argument of the function being probed. In this case, the second argument is a pointer to the <code>filename</code> structure, which is passed to the <code>do_mkdirat</code> function. <code>struct filename *name</code>: This line casts the second parameter (a pointer to <code>struct filename</code>) to the <code>name</code> variable. <code>struct filename</code> holds the path to the directory to be created.
<code>BPF_CORE_READ(name, name)</code>:  It uses the <code>BPF_CORE_READ</code> macro from the <code>bpf_core_read.h</code> header. This macro is a helper function designed to safely read fields from kernel structures in a way that is compatible with BPF CO-RE (Compile Once, Run Everywhere) and it&rsquo;s necessary because kernel structures may change between different kernel versions, and <code>BPF_CORE_READ</code> ensures that the field <code>name</code> can be accessed in a manner that works across various kernel versions.
<code>name</code> field: In this case, the field <code>name</code> in <code>struct filename</code> holds the string representing the path of the directory to be created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>PT_REGS_PARM3(ctx)</code>: This macro extracts the third argument passed to <code>do_mkdirat</code>, which represents the mode (permissions) of the directory to be created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>bpf_printk</code>: This is an eBPF macro that allows printing formatted output to the kernel&rsquo;s trace buffer, which is accessible via <code>/sys/kernel/debug/tracing/trace_pipe</code>. <code>bpf_printk</code> only supports up to 3 arguments.</p>
<p>At this point we need to compile this code into an object file using <code>clang</code> with help from <code>bpftool</code>.</p>
<ol>
<li>Install required tools <code>sudo apt install linux-tools-$(uname -r) clang llvm libbpf-dev bpftool</code>,</li>
<li>Generate <code>vmlinux.h</code>  via <code>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code></li>
<li>Compile eBPF code into an object file <code>clang -g -O2 -target bpf -c kprobe-mkdirat.bpf.c -o kprobe-mkdirat.o</code> with debugging information (<code>-g</code>) and optimization level <code>-O2</code>. The <code>-target bpf</code> flag ensures that Clang compiles the code for the eBPF target architecture.</li>
<li>Generate the skeleton header file <code>sudo bpftool gen skeleton kprobe-mkdirat.o &gt; kprobe-mkdirat.skel.h</code></li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    If you encounter the error <code>/usr/include/linux/types.h:5:10: fatal error: 'asm/types.h' file not found</code> while compiling the eBPF kernel code , you can execute the command <code>sudo ln -s /usr/include/x86_64-linux-gnu/asm /usr/include/asm</code>.

</div>

<p>Examining the generated object file <code>llvm-objdump -h kprobe-mkdirat.o</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kprobe-mkdirat.o:	file format elf64-bpf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sections:
</span></span><span style="display:flex;"><span>Idx Name                   Size     VMA              Type
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">0</span>                        <span style="color:#0000cf;font-weight:bold">00000000</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span> .strtab                <span style="color:#0000cf;font-weight:bold">00000141</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> .text                  <span style="color:#0000cf;font-weight:bold">00000000</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> TEXT
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">3</span> kprobe/do_mkdirat      000000a8 <span style="color:#0000cf;font-weight:bold">0000000000000000</span> TEXT
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">4</span> .relkprobe/do_mkdirat  <span style="color:#0000cf;font-weight:bold">00000010</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5</span> license                0000000d <span style="color:#0000cf;font-weight:bold">0000000000000000</span> DATA
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">6</span> .rodata                <span style="color:#0000cf;font-weight:bold">00000031</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> DATA
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The generated object file <code>kprobe-mkdirat.o</code> has the file format ELF64-BPF, indicating it is a 64-bit ELF object file specifically for BPF (eBPF) code.
<code>kprobe/do_mkdirat</code> This is the section header where the actual eBPF program resides, as indicated by <code>SEC(&quot;kprobe/do_mkdirat&quot;)</code> in the code. This section contains the code that will be executed when the <code>do_mkdirat</code> kprobe is triggered.</p>
<p>Let&rsquo;s move to the user-space code. The following code is derived from <a href="https://github.com/libbpf/libbpf-bootstrap">https://github.com/libbpf/libbpf-bootstrap</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s divide the code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>A function for libbpf debug and error messages.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>declares a pointer <code>skel</code> to a structure <code>kprobe_mkdirat</code>, which represents the eBPF skeleton for the eBPF program attached to the <code>do_mkdirat</code> kprobe. This structure is used to manage the loading, attaching, and cleanup of the eBPF program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>This function opens the eBPF skeleton for the <code>kprobe_mkdirat</code> program to set up the eBPF program, including its maps, and prepares it for loading.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function loads and verifies the eBPF program defined in the skeleton. It ensures that the eBPF code is valid and ready to be attached to the kernel.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function attaches the eBPF program to the kernel&rsquo;s <code>kprobe</code> at the <code>do_mkdirat</code> function. It makes the program active and starts tracing the specified kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">kprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function cleans up and frees resources used by the BPF skeleton. It detaches the program and destroys the associated maps and other resources.</p>
<p>All these functions (<code>_open()</code>, <code>_load()</code>, <code>_attach()</code>, and <code>_destroy()</code>) are automatically generated from the eBPF skeleton file. As we explained earlier that the skeleton file abstracts much of the complexity of interacting with BPF programs, making it much easier to build user-space code for managing and interacting with eBPF programs. It eliminates the need for manual setup and error handling, simplify the entire process.</p>
<p>To compile the user-space code, we use the following command: <code>clang -o loader loader.c -lbpf</code>. This compiles the <code>loader.c</code> file and links it with the <code>libbpf</code> library, producing an executable named <code>loader</code>.</p>
<p>To start the eBPF program, you can use the following command: <code>sudo ./loader</code>. This runs the compiled user-space program <code>loader</code>, which loads the eBPF program, attaches it to the kernel function (in this case, the <code>do_mkdirat</code> function via kprobes), and starts tracing the kernel function. The <code>sudo</code> is necessary because eBPF programs often require root privileges to attach to kernel functions or tracepoints.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>libbpf: loading object <span style="color:#4e9a06">&#39;kprobe_mkdirat&#39;</span> from buffer
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span> kprobe/do_mkdirat, size 168, link 0, flags 6, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>: found program <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span> at insn offset <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>, code size <span style="color:#0000cf;font-weight:bold">21</span> insns <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">168</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span> .relkprobe/do_mkdirat, size 16, link 27, flags 40, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>5<span style="color:#ce5c00;font-weight:bold">)</span> license, size 13, link 0, flags 3, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: license of kprobe_mkdirat is GPL
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>6<span style="color:#ce5c00;font-weight:bold">)</span> .rodata, size 49, link 0, flags 2, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>17<span style="color:#ce5c00;font-weight:bold">)</span> .BTF, size 1407, link 0, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>19<span style="color:#ce5c00;font-weight:bold">)</span> .BTF.ext, size 284, link 0, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>27<span style="color:#ce5c00;font-weight:bold">)</span> .symtab, size 384, link 1, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>libbpf: looking <span style="color:#204a87;font-weight:bold">for</span> externs among <span style="color:#0000cf;font-weight:bold">16</span> symbols...
</span></span><span style="display:flex;"><span>libbpf: collected <span style="color:#0000cf;font-weight:bold">0</span> externs total
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;kprobe_m.rodata&#39;</span> <span style="color:#ce5c00;font-weight:bold">(</span>global data<span style="color:#ce5c00;font-weight:bold">)</span>: at sec_idx 6, offset 0, flags 80.
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#0000cf;font-weight:bold">0</span> is <span style="color:#4e9a06">&#34;kprobe_m.rodata&#34;</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;.relkprobe/do_mkdirat&#39;</span>: collecting relocation <span style="color:#204a87;font-weight:bold">for</span> section<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;.relkprobe/do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: insn #14 against &#39;.rodata&#39;</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: found data map <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>kprobe_m.rodata, sec 6, off 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> insn <span style="color:#0000cf;font-weight:bold">14</span>
</span></span><span style="display:flex;"><span>libbpf: loading kernel BTF <span style="color:#4e9a06">&#39;/sys/kernel/btf/vmlinux&#39;</span>: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;kprobe_m.rodata&#39;</span>: created successfully, <span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>: found <span style="color:#0000cf;font-weight:bold">3</span> CO-RE relocations
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>83<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: &lt;byte_off&gt; [2] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: matching candidate #0 &lt;byte_off&gt; [83] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: patched insn #3 (LDX/ST/STX) off 104 -&gt; 104</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>7<span style="color:#ce5c00;font-weight:bold">]</span> struct filename: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>4878<span style="color:#ce5c00;font-weight:bold">]</span> struct filename in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: &lt;byte_off&gt; [7] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: matching candidate #0 &lt;byte_off&gt; [4878] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: patched insn #4 (ALU/ALU64) imm 0 -&gt; 0</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: &lt;byte_off&gt; [2] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: matching candidate #0 &lt;byte_off&gt; [83] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: patched insn #12 (LDX/ST/STX) off 96 -&gt; 96</span>
</span></span><span style="display:flex;"><span>Successfully started! Please run <span style="color:#4e9a06">`</span>sudo cat /sys/kernel/debug/tracing/trace_pipe<span style="color:#4e9a06">`</span> to see output of the BPF programs.
</span></span><span style="display:flex;"><span>..............
</span></span></code></pre></div><p>To view the output of the eBPF program, you can open a separate terminal window and run the following command: <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code></p>
<p>Then in another separate terminal run  <code>mkdir testing</code>. In the second terminal, you should now see the following output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    mkdir-2173    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...21 12952.686720: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2173, <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> testing, <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>mode = 511. The value 511 is the decimal representation of the octal permission <code>0777</code>.</p>
<p>To observe the behavior of loading the eBPF program, you can run <code>strace</code> using the following command: <code>sudo strace -ebpf ./loader</code>. This will trace the <code>bpf()</code> system calls made by the <code>loader</code> program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>21, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e460a0f0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kprobe_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e4608850, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e46088d0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>This output tells us that the program type is BPF_PROG_TYPE_KPROBE in <code>prog_type=BPF_PROG_TYPE_KPROBE</code>, and <code>prog_name=&quot;kprobe_mkdir&quot;</code> is the eBPF program that will be executed when the <code>do_mkdirat</code> entry point is triggered.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-example-1.png" alt="Centered image" />
</p>
Congratulations! You've just run your first eBPF program, and it's a portable eBPF program that can work across different kernel versions. It wasn't that complicated, was it?
<p>In eBPF kernel code, we used the name of the kprobe handler as <code>kprobe_mkdir</code> and passed a <code>struct pt_regs</code> as the context for the <code>kprobe_mkdir</code> function. Another approach is using <code>BPF_KPROBE</code>, which offers a more convenient and readable way to define kprobe handlers. With <code>BPF_KPROBE</code>, you specify the name of the function followed by any additional arguments you want to capture, making it a simpler and cleaner method.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">capture_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This approach is more convenient and readable, while giving the same results. Either way, it&rsquo;s up to you to choose which method is easier for you.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec810e0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;capture_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec7f840, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec7f8c0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>Now let&rsquo;s move forward to walkthrough kretprobe.</p>
<h3 id="kretprobes-in-detail">Kretprobes in Detail<a class="td-heading-self-link" href="#kretprobes-in-detail" aria-label="Heading self-link"></a></h3>
<p><strong>What is a Kretprobe?</strong><br>
A kretprobe fires when a monitored function returns. While a kprobe targets function entry (or a specific instruction), a kretprobe targets function exit. By pairing a kprobe at function entry with a kretprobe at function exit, you can measure how long a function took to run or check its return value. kretprobe-based eBPF programs are also classified under the program type <code>BPF_PROG_TYPE_KPROBE</code></p>
<p><strong>How Kretprobes Work Under the Hood:</strong></p>
<ol>
<li>When you register a kretprobe for a function, the kprobe mechanism inserts a probe at the function’s entry to store the original return address and replace it with a trampoline.</li>
<li>The original return address is replaced with kretprobe_trampoline() address (which is the address of the trampoline) during function entry. The trampoline is also kprobed.</li>
<li>When the function returns, control jumps to the trampoline instead of the original return address.</li>
<li>Hitting the trampoline triggers the kretprobe handler. This handler can access the function’s return value and any data stored at entry time.</li>
<li>The original return address is restored, and the function’s caller proceeds as usual.</li>
</ol>
<p><strong>Before kretprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kretprobe-before.png" alt="Centered image" />
</p>
<p><strong>After kretprobe insertion:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kretprobe-after.png" alt="Centered image" />
</p>
<p>Now let&rsquo;s take a look at the same example by hooking kretprobe to <code>do_mkdirat</code>. First, Let&rsquo;s look at the eBPF kernel code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kretprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, return = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We changed SEC from <code>(&quot;kprobe/do_mkdirat&quot;)</code> to <code>(&quot;kretprobe/do_mkdirat&quot;)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kretprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Using <code>PT_REGS_RC</code> macro to extract the return value form <code>pt_regs</code> structure. PT_REGS_RC is defined in <code>bpf_tracing.h</code> as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__PT_REGS_CAST</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">__PT_RC_REG</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p> To compile we could do exactly the same as we did in the previous kprobe example.</p>
<ol>
<li>Generate <code>vmlinux.h</code>  via <code>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code></li>
<li>Compile eBPF code into an object file <code>clang -g -O2 -target bpf -c kretprobe-mkdirat.bpf.c -o kretprobe-mkdirat.o</code> with debugging information (<code>-g</code>) and optimization level <code>-O2</code>. The <code>-target bpf</code> flag ensures that Clang compiles the code for the eBPF target architecture.</li>
<li>Generate the skeleton header file <code>sudo bpftool gen skeleton kretprobe-mkdirat.o &gt; kprobe-kretprobe.skel.h</code>
Moving to the second part which is the user-space code for opening, loading, attaching and destroying the eBPF code, let&rsquo;s use the the previous code and modify it.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kretprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kretprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">kretprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We need to change some lines here to match out generated skeleton file such as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1.</span> <span style="color:#a40000">#</span><span style="color:#000">include</span> <span style="color:#4e9a06">&#34;kretprobe-mkdirat.skel.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2.</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kretprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3.</span> <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4.</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5.</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6.</span> <span style="color:#000">kretprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Finally, let&rsquo;s compile it and link it to libbpf <code>clang -o loader loader.c -lbpf</code> then run it as the previous with <code>sudo ./loader</code>  Then <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code> in a separate terminal. Then use command <code>mkdir test</code> and we get</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>           &lt;...&gt;-2053    <span style="color:#ce5c00;font-weight:bold">[</span>002<span style="color:#ce5c00;font-weight:bold">]</span> ...21  5359.243727: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2053, <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>Return value 0 indicates success, while any non-zero value represents an error, with the specific error codes defined in <code>/include/uapi/asm-generic/errno-base.h</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EPERM</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">1</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Operation not permitted */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOENT</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">2</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No such file or directory */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ESRCH</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">3</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No such process */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EINTR</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">4</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Interrupted system call */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EIO</span><span style="color:#f8f8f8;text-decoration:underline">		     </span><span style="color:#000">5</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* I/O error */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENXIO</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">6</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No such device or address */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">E2BIG</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">7</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Argument list too long */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOEXEC</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">8</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Exec format error */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EBADF</span><span style="color:#f8f8f8;text-decoration:underline">		 </span><span style="color:#000">9</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Bad file number */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ECHILD</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">10</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No child processes */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EAGAIN</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">11</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Try again */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOMEM</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">12</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Out of memory */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EACCES</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">13</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Permission denied */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EFAULT</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">14</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Bad address */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOTBLK</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">15</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Block device required */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EBUSY</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">16</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Device or resource busy */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EEXIST</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">17</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* File exists */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EXDEV</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">18</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Cross-device link */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENODEV</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">19</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No such device */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOTDIR</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">20</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Not a directory */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EISDIR</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">21</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Is a directory */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EINVAL</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">22</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Invalid argument */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENFILE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">23</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* File table overflow */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EMFILE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">24</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Too many open files */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOTTY</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">25</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Not a typewriter */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ETXTBSY</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">26</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Text file busy */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EFBIG</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">27</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* File too large */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ENOSPC</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">28</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* No space left on device */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ESPIPE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">29</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Illegal seek */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EROFS</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">30</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Read-only file system */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EMLINK</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">31</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Too many links */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EPIPE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">32</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Broken pipe */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">EDOM</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">33</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Math argument out of domain of func */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000">ERANGE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000">34</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic">/* Math result not representable */</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For example, if you try to run <code>mkdir test</code> command again you will get the following output.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>           mkdir-2054    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...21  5365.024388: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2054, <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">=</span> -17
</span></span></code></pre></div><p>This indicate  <code>EEXIST - file exists</code> . Running it with strace <code>sudo strace -ebpf ./loader</code> to capture bpf() syscalls shows that the the <code>prog_type</code> is <code>BPF_PROG_TYPE_KPROBE</code> and the <code>prog_name</code> is <code>kretprobe_mkdir</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>11, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b8000, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kretprobe_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b67f0, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b6870, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>6, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>The better approach is to use <code>BPF_KRETPROBE</code> macro, which offers a more convenient and readable way to define kretprobe handlers, as mentioned earlier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KRETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, return = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>As you can see, this is much simpler and cleaner.</p>
<p>Combining the use of both <code>kprobe</code> and <code>kretprobe</code> on the <code>do_mkdirat</code> kernel function provides insight into the arguments received by <code>do_mkdirat</code> and its return value. This type of instrumentation is valuable for several reasons, such as debugging, system performance monitoring, maintaining a detailed record of directory creation for forensic analysis, and detecting malicious activities like attempting unauthorized directory creation.</p>
<p><code>/sys/kernel/debug/tracing/trace_pipe</code> is globally shared interface that aggregates all ebpf programs trace events, which can lead to contention and data mixing. In contrast, using maps provides a dedicated, structured, and efficient mechanism to pass data between kernel and user space, offering better control and isolation.</p>
<p>Let&rsquo;s go forward and use maps instead of the kernel&rsquo;s trace buffer <code>/sys/kernel/debug/tracing/trace_pipe</code>. Le&rsquo;ts go back the first example and add <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> to it and store our data using <code>bpf_perf_event_output</code> in BPF perf event.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-perf-buffer.png" alt="Centered image" />
</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First we defined the structure for the event data that will be sent to user-space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Then defined a map of type <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> as we explained earlier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Type of BPF map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// Maximum number of entries in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                            <span style="color:#8f5902;font-style:italic">// Type of the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                          <span style="color:#8f5902;font-style:italic">// Type of the value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we created <code>ev</code> of type  <code>struct event</code> and store both <code>pid</code> and <code>mode</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Next, we used <code>bpf_probe_read_str</code> to safely read a string from kernel space and copy it into the eBPF program&rsquo;s memory space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Finally,  write <code>ev</code> data into our created map <code>mkdir</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>The user-space loader code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;x.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PERF_BUFFER_PAGES 64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">mode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process ID: %d, filename: %s, mode: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lost %llu events on CPU %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">PERF_BUFFER_PAGES</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Listening for events...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perf_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First we defined the structure to store event data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Next, we defined <code>handle_event</code> which gets called when a new event is read from the perf buffer. It casts the <code>data</code> pointer to the <code>struct event</code> and prints the <code>pid</code>, <code>filename</code>, and <code>mode</code> values. Then, we defined <code>handle_lost_events</code> which handles lost events (when the buffer overflows). It prints a message indicating how many events were lost on a specific CPU.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process ID: %d, filename: %s, mode: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lost %llu events on CPU %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then we Initialize <code>pb</code> to hold the perf buffer, <code>struct perf_buffer</code> is defined in <code>/tools/lib/bpf/libbpf.c</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Next, we created a perf buffer for our <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> using <code>perf_buffer__new</code>  and it has the following prototype</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">perf_buffer__new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">map_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">page_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">perf_buffer_sample_fn</span> <span style="color:#000">sample_cb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">perf_buffer_lost_fn</span> <span style="color:#000">lost_cb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>perf_buffer__new</code> takes a file descriptor for  <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> , memory page size for each CPU, a function to invoke on each each received data, a function to invoke in case of data loss, *ctx and *opts.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">PERF_BUFFER_PAGES</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>perf_buffer__poll</code> is a function provided by the <code>libbpf</code> library that allows user-space applications to poll a perf buffer for new data. It has the following prototype:
<code>int perf_buffer__poll (struct perf_buffer *pb, int timeout_ms)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>If Positive <code>timeout_ms</code>: Blocks for the specified time (e.g., 100ms). If data arrives within that time, it processes and returns. If no data arrives, it returns 0.
If<code>timeout_ms == 0</code>: Non-blocking. Checks immediately for data. Returns 0 if no data is available.
If Negative <code>timeout_ms</code>: Blocks indefinitely until data becomes available.
Finally,  free perf buffer resource.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">perf_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>After compiling as we did before, run loader using <code>sudo</code> and run <code>mkdir /tmp/test</code> in a new terminal.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>11<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>136<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: &lt;byte_off&gt; [11] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: matching candidate #0 &lt;byte_off&gt; [136] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: patched insn #1 (LDX/ST/STX) off 104 -&gt; 104</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: &lt;byte_off&gt; [11] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: matching candidate #0 &lt;byte_off&gt; [136] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: patched insn #2 (LDX/ST/STX) off 96 -&gt; 96</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>25<span style="color:#ce5c00;font-weight:bold">]</span> struct filename: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>1410<span style="color:#ce5c00;font-weight:bold">]</span> struct filename in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: &lt;byte_off&gt; [25] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: matching candidate #0 &lt;byte_off&gt; [1410] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: patched insn #73 (ALU/ALU64) imm 0 -&gt; 0</span>
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;mkdir&#39;</span>: created successfully, <span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Successfully started! Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Process ID: 2416, filename: /tmp/test, mode: <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>Tracing bpf() syscall using <code>strace</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_MAP_CREATE, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">map_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_MAP_TYPE_PERF_EVENT_ARRAY, <span style="color:#000">key_size</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">value_size</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">max_entries</span><span style="color:#ce5c00;font-weight:bold">=</span>1024, <span style="color:#000">map_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">inner_map_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mkdir&#34;</span>, <span style="color:#000">map_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_key_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_extra</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 80<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>96, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd994ff0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;do_mkdirat&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd9937e0, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd9938c0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>13, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>This output tells us that there an extra component which is <code>BPF_MAP_CREATE</code> command creating a map of type <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> and map_name is <code>mkdir</code>.</p>
<p>Attaching a kprobe to system call can be done using the same methods or using <code>ksyscall</code> technique with <code>BPF_KSYSCALL</code> macro and <code>(&quot;ksyscall/syscall_name&quot;)</code> as section. For example, <code>SEC(&quot;ksyscall/execve&quot;)</code> as the next example, which we will attach a kprobe to <code>execve</code> syscall using <code>ksyscall</code>. The <code>execve</code> system call is one of the family of <code>exec</code> functions in Unix-like operating systems. It is used to execute a new program by replacing the current process image with a new one. The execve syscall is declared in <code>include/linux/syscalls.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">asmlinkage</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">sys_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">envp</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>asmlinkage</code>: It&rsquo;s a macro to tell the compile to that arguments are passed on the stack not registers.
<code>const char __user *filename</code>:  A pointer to the filename (a user-space string) of the program to execute.
<code>const char __user *const __user *argv</code>:  A pointer to an array of pointers (from user space) to the argument strings for the new program.
<code>const char __user *const __user _*envp</code>: A pointer to an array of pointers (from user space) to the environment variables for the new program.</p>
<p>In next example, we will attach kprobe to <code>execve</code> syscall using <code>ksyscall</code> and we will add ring buffer to ship our events to the user-space instead of perf buffer. Ring buffer needs to be defined, reserve then submit your events. The ring buffer minimizes overhead, offering lower latency and better performance for high-frequency event reporting compared to perf buffer mechanism.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    In kprobe programs, syscalls and kernel functions follow different ABIs. The syscall ABI defines the transition from user space to kernel space and dictates how its arguments are passed, while the kernel function ABI governs internal calls within the kernel.

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_ARGS 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ARG_SIZE 128
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rb</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ksyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KSYSCALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#pragma unroll
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">argp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We defined a ring buffer type of map with name <code>rb</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rb</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Define a data structure <code>event</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>We defined section with <code>ksyscall/execve</code> for <code>execve</code> syscall and use <code>BPF_KSYSCALL</code> macro. BPF_KSYSCALL macro defined two arguments of execve syscall instead of three because we only need filename to extract command being executed and argv to get command with its arguments and no need for environment variables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ksyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KSYSCALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span></code></pre></div><p>Then reserve space in eBPF ring buffer using <code>bpf_ringbuf_reserve</code> helper function which has prototype as the following <code>void *bpf_ringbuf_reserve(void *ringbuf, u64 size, u64 flags)</code>, it take a pointer to a ring buffer definition as the first argument and the number of bytes to be reserved in the ring buffer as the second argument and returns a valid pointer with <code>size</code> bytes of memory available and flags must be 0.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>bpf_probe_read_user_str</code> is an eBPF helper function that safely reads a null-terminated string from user-space memory into an eBPF program which has the prototype <code>long bpf_probe_read_user_str(void *dst, u32 size, const void *unsafe_ptr)</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This will copy the filename into path member of ev structure. The <code>argv</code> parameter is essentially a double pointer or pointer to a pointer (<code>const char __user *const __user *argv</code>), meaning it points to an array of pointers where each element is a pointer to a string. Hence, we first need to copy the pointer itself (to get the address of the string) and then copy the string data from that address. In our code, we copy up to 7 pointers (defined by <code>#define MAX_ARGS 7</code>) from <code>argv</code> into a temporary storage <code>argp</code> and then extract the strings into the <code>argv</code> member of the <code>ev</code> structure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">argp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We could add the <code>#pragma unroll</code> compiler directive to optimize our loop. Loop unrolling duplicates the loop body multiple times, reducing the overhead of loop control by executing multiple iterations&rsquo; work within a single loop iteration. For example,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#pragma unroll
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>After unrolling:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">];</span>
</span></span></code></pre></div><p>Then we submit reserved ring buffer data to make it available in the ring buffer using <code>bpf_ringbuf_submit</code> helper function.
<code>void bpf_ringbuf_submit(void *data, u64 flags)</code> It take a pointer to data as the first argument and flag as the second argument and the flag can be as follow:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>* If BPF_RB_NO_WAKEUP is specified in flags, no notification of new data availability is sent.
</span></span><span style="display:flex;"><span>* If BPF_RB_FORCE_WAKEUP is specified in flags, notification of new data availability is sent unconditionally.
</span></span><span style="display:flex;"><span>* If <span style="color:#0000cf;font-weight:bold">0</span> is specified in flags, an adaptive notification of new data availability is sent.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>What really happened is that we first reserved a space inside the ring buffer, then write our data into the reserved space and finally we submit to make these data available in the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;ksyscall.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_ARGS 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[execve] PID=%d Path=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;    argv[%d] = %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ksyscall</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing execve calls... Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EINTR</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ksyscall__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We Initialize <code>rb</code> to hold the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>ring_buffer__new</code> takes a file descriptor for  <code>BPF_MAP_TYPE_RINGBUF</code>  and function to invoke on each each received data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we retrieve the newly added data to the ring buffer using <code>ring_buffer__poll</code> function  which has the following prototype:<code>int ring_buffer__poll (struct ring_buffer *rb, int timeout_ms)</code>.
If Positive <code>timeout_ms</code>: Blocks for the specified time (e.g., 100ms). If data arrives within that time, it processes and returns. If no data arrives, it returns 0.
If<code>timeout_ms == 0</code>: Non-blocking. Checks immediately for data. Returns 0 if no data is available.
If Negative <code>timeout_ms</code>: Blocks indefinitely until data becomes available.</p>
<p>Compile the code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000">bpftool</span> <span style="color:#000">btf</span> <span style="color:#000">dump</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">kernel</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">btf</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">vmlinux</span> <span style="color:#000">format</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">vmlinux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">h</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clang</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">O2</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">target</span> <span style="color:#000">bpf</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">c</span> <span style="color:#000">ksyscall_execve</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bpf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">o</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">o</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000">bpftool</span> <span style="color:#000">gen</span> <span style="color:#000">skeleton</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">h</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clang</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">o</span> <span style="color:#000">loader</span> <span style="color:#000">loader</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">lbpf</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">loader</span>
</span></span></code></pre></div><p>Executing any commands will trigger the probe such as <code>ls -l /etc</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Tracing execve calls... Ctrl+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>execve<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">PID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2584</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/bin/ls
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> ls
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> --color<span style="color:#ce5c00;font-weight:bold">=</span>auto
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> -l
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>3<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> /etc
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-ring-buffer.png" alt="Centered image" />
</p>
<p>Examining the code using strace <code>sudo strace -ebpf ./loader</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_MAP_CREATE, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">map_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_MAP_TYPE_RINGBUF, <span style="color:#000">key_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">value_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">max_entries</span><span style="color:#ce5c00;font-weight:bold">=</span>65536, <span style="color:#000">map_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">inner_map_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;rb&#34;</span>, <span style="color:#000">map_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>5, <span style="color:#000">btf_key_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_extra</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 80<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>239, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2703020, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 17<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kprobe_sys_exec&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>5, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2701810, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2701890, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>115, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Shows the program type is indeed <code>BPF_PROG_TYPE_KPROBE</code> and the map type is <code>BPF_MAP_TYPE_RINGBUF</code>.</p>
<p>A similar approach can be used with the <code>kretsyscall</code> with <code>BPF_KRETPROBE</code> macro to capture a syscall&rsquo;s return value. The following probe will be triggered when <code>execve</code> syscall returns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">define</span> <span style="color:#000">__TARGET_ARCH_x86</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretsyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KRETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kretprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Execve return :pid = %d ret = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> &lt;...&gt;-1781 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1781</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> &lt;...&gt;-1782 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1782</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> &lt;...&gt;-1847 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1847</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> -2
</span></span></code></pre></div>
	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>