<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://ebpf.hamza-megahed.com/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://ebpf.hamza-megahed.com/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Engineering Everything with eBPF | Engineering Everything with eBPF</title>
<meta name="description" content="">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="Engineering Everything with eBPF">
  <meta property="og:description" content=" ">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Engineering Everything with eBPF">
  <meta itemprop="description" content=" ">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Engineering Everything with eBPF">
  <meta name="twitter:description" content=" ">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.3c5aebc1447634a6b24181e7c36ac494.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Engineering Everything with eBPF</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-4cd1923fdbedbcc6ccce9be2da1bd8f0">Before We Begin</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-f1abc94ab9dd0328ab8f7448ea29f5f9">Author</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-bd8dea12a0ce6cf6a67f34b2608f64bd">Copyright</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-05a22326b56c4d8a7045396638438327">Preface</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-1c6242dbc0bc81bc2d240d9164272607">Contribution Guidelines</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-bce1c354c315a95f95c7aade814709c6"></a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-3a4ad83f0eb0486386a1a310701ecfa0">What is eBPF</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-bc61bcf6c1e33409689f51be243e74b1">Introduction</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-7d4be615997631ee15f3b986ea0bdd99">History of eBPF</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-913f3a33743572b7b9ac9a4356af7737">eBPF in the Real World</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-a8fa3a1fe994e20887a5a028f76006d1">Why eBPF?</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-68d2ba4ee51daffab776702aa5ed8d84">eBPF Architecture</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-848d75a615c6173d8d861f898a3a67ce">eBPF Taking off</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-8610252594afa47bad49bf4c377c6985">bpf() syscall</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-aeb5952b27b44d42777e2c19cc90992b">eBPF Maps</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-4997b913a052f79145016d51846d1f29">eBPF Map Operations</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-3fb14d04fec3290f3c542c92855c4f2b">eBPF Program Types</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-10afc9594f87bad3f07dc64799a1d2a7">eBPF Probes</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-62f8d377f141b062b29f286dd524dde1">Kprobe and Kretprobe</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-b77aeac16a82fd2f25c603c7d7aaf653">Uprobes and Uretprobes</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-1b88c508e6f5ebe0cb712f275cf5d474">Tracepoints</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-1f9883a7f15f27e0b3f9403a187ec6e4">Raw Tracepoints</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-261561de9c95bc1adb21eae4a12787f1">Fentry and Fexit</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-25679eb65c0e8dfb7e8ace4c60fe07cc">Networking with eBPF</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-f879d53037865bc2c79335c3051f33b8">Socket Filter</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-9c945f0a156f58c4c58b74377e798e49">Lightweight Tunnels</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-4a36d5a41cd413ab4a54c502caa49c68">Traffic Control</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-d78ca62235ff4c2bacce5f846f2bc2ef">XDP</a></li>


    
  
    
    
	
<li>5.5: <a href="#pg-3021ad0e581015aa97f3ef212c1a52c3">CGroup Socket Address</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-b19ef890711f7ce8221ae9b15469c412">Security with eBPF</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-963291df6b201c8a3b105bddb30c924c">Seccomp</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-186e1d77b4d4edf4cd3714847b8a07fe">Linux Security Module (LSM)</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-8f50351f0c6b2104de204efd796695d8">Landlock</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-72b27f510604bdf56670cd8c84779f4a">bpf_send_signal</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-b7d361a59848674b28ddf805a6cadf60">Tetragon</a></li>


    
  
    
    
	
<li>6.6: <a href="#pg-9cde3793eee8ef4ff18d29f255e8e250">Bpfilter</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-f9210003ef0c1463a1512d31a898cf50">Tools and languages</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-5f9e11a6923b54f21057d837506b9990">bpftrace</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-593e25d400352b1b019a0a3a839e7cdb">BCC</a></li>


    
  
    
    
	
<li>7.3: <a href="#pg-b4551197eff5fbdde9f1f1576dc49c24">BPFTool</a></li>


    
  
    
    
	
<li>7.4: <a href="#pg-77ec8433956d6a9f2c325fa29eb7ae4d">Tail call</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p style="text-align: center;">
  <img src="/images/docs/cover/cover.png" alt="Centered image" />
</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4cd1923fdbedbcc6ccce9be2da1bd8f0">1 - Before We Begin</h1>
    <div class="lead">A compact front matter bundle that gives you the author bio copyright preface and contribution checklist so you know who wrote the book under what license and how to send improvements</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f1abc94ab9dd0328ab8f7448ea29f5f9">1.1 - Author</h1>
    <div class="lead">Brief background of the writer and why eBPF matters to them.</div>
	<h3 id="author">Author<a class="td-heading-self-link" href="#author" aria-label="Heading self-link"></a></h3>
<p>Hamza Megahed</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bd8dea12a0ce6cf6a67f34b2608f64bd">1.2 - Copyright</h1>
    <div class="lead">The legal line that tells the year, owner, and Creative Commons license.</div>
	<h3 id="license">License<a class="td-heading-self-link" href="#license" aria-label="Heading self-link"></a></h3>
<p>© 2025 Hamza Megahed – <em>Engineering Everything with eBPF</em></p>
<p><strong>License: Creative Commons Attribution 4.0 International (CC BY 4.0)</strong><br>
This license lets anyone copy, redistribute, remix, transform, and build upon the material for any purpose—even commercially—so long as they give appropriate credit and indicate if changes were made.</p>
<p><a href="https://creativecommons.org/licenses/by/4.0/"><img alt="CC BY 4.0 badge – click for license details" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a></p>
<h3 id="code-licenses">Code Licenses<a class="td-heading-self-link" href="#code-licenses" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Part of the project</th>
<th>License</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kernel-space eBPF examples</td>
<td><strong>GPL-2.0-or-later</strong></td>
</tr>
<tr>
<td>User-space loaders, scripts, utilities</td>
<td><strong>Apache 2.0</strong></td>
</tr>
<tr>
<td>Book text &amp; figures</td>
<td><strong>CC BY 4.0</strong> (this page)</td>
</tr>
</tbody>
</table>
<h3 id="disclaimer">Disclaimer<a class="td-heading-self-link" href="#disclaimer" aria-label="Heading self-link"></a></h3>
<p>Running eBPF programs generally requires root access or the <strong>CAP_BPF</strong> capability. The kernel verifier guards against crashes, but inefficient or incorrectly attached programs can still degrade performance or disrupt networking. Test all examples on a non-production system first. Neither the author shall be liable for any damages arising from the use of this material.</p>
<p>Running eBPF programs requires elevated privileges and can affect system stability. Follow the examples at your own risk. Neither the author nor the publisher shall be liable for any damages arising from the use of this material.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05a22326b56c4d8a7045396638438327">1.3 - Preface</h1>
    <div class="lead">Welcome message explaining what you will learn and how to use the book.</div>
	<p>Hello and welcome. <strong>Engineering Everything with eBPF</strong> is your friendly guide to eBPF on Linux. eBPF lets you run tiny programs inside the kernel so you can watch what the system is doing, filter network traffic, and even add safety checks—all without changing kernel source code. That sounds powerful, and it is. But it can also feel confusing the first time you see strange section names like <code>SEC(&quot;xdp&quot;)</code> or long helper calls. Do not worry. Every chapter walks you through one small idea at a time, then shows a real example working on your own machine.</p>
<p><strong>Why this book exists</strong><br>
When I began learning eBPF, I kept bouncing between blog posts and mailing-list threads, piecing things together. I wrote <strong>Engineering Everything with eBPF</strong> so you do not have to repeat that maze. You will start by loading a five-line program, see the result right away, and gradually build up to practical tools for tracing disk I/O, shaping network traffic, and securing containers.</p>
<p><strong>Plain language, lots of examples</strong><br>
I use short sentences, clear words, and plenty of code. Each new term—<em>map</em>, <em>verifier</em>, <em>tail call</em>—appears next to a tiny program you can copy, run, and explore. After you run the code, the explanation will make more sense. If something still feels cloudy, keep reading; later chapters revisit the idea from a different angle.</p>
<p><strong>Tested environment</strong><br>
All code listings were compiled and executed on Linux kernel 6.12.22, with Clang/LLVM 17 and libbpf 1.5. If you use this kernel (or a newer one) the examples should work exactly as printed. When newer kernels add handy helpers or map types, I point them out and tell you whether you need to adjust your code.<br>
Every example used in this book lives in the public repository</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF-Code
</span></span></code></pre></div><p><strong>What you need</strong></p>
<ul>
<li>A Linux box or virtual machine with kernel 6.12.22+</li>
<li><code>clang</code>, <code>lld</code>, <code>make</code>, and typical build tools</li>
<li>Root access (or the <code>CAP_BPF</code> capability) to load programs</li>
<li>A sense of curiosity—nothing else</li>
</ul>
<p><strong>How to read</strong><br>
<em>Skim first, run later.</em> Browse the chapter, copy the program, run it, then come back and read the full explanation. Learning speeds up when you see the output with your own eyes. If a term is still unclear, do not worry; it often becomes obvious after the next example.</p>
<p>By the final chapter you will have a small toolbox of eBPF programs you can adapt to real-world tasks—debugging, performance tuning, or keeping a service safe. Take your time, run the code, and enjoy the process. Everything will click, step by step. Let’s begin our journey into eBPF together.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1c6242dbc0bc81bc2d240d9164272607">1.4 - Contribution Guidelines</h1>
    <div class="lead">Quick steps for opening issues and pull requests plus the code and text licenses.</div>
	<p>We’re happy you want to make <strong>Engineering Everything with eBPF</strong> better.<br>
The steps below keep changes smooth and easy.</p>
<ol>
<li>
<p><strong>Open an issue first</strong></p>
<ul>
<li>Create a GitHub issue for typos, unclear text, new examples, or bugs in sample code.</li>
<li>Show what you saw and what you expect instead. Screenshots or terminal output help a lot.</li>
</ul>
</li>
<li>
<p><strong>Fork the repo and create a branch</strong></p>
<ul>
<li>Fork, then name your branch clearly—­for example <code>fix-ringbuf-example</code> or <code>add-cgroup-section</code>.</li>
</ul>
</li>
<li>
<p><strong>Write in the same simple style</strong></p>
<ul>
<li>Short sentences, plain English.</li>
<li>Use fenced code blocks (<code>```c</code> for C, <code>```bash</code> for shell).</li>
<li>Wrap Markdown lines at about 80 characters so diffs stay readable.</li>
</ul>
</li>
<li>
<p><strong>Test what you add</strong></p>
<ul>
<li>All examples must build and run on <strong>at least Linux 6.12.22, Clang/LLVM 17, and libbpf 1.5—or newer</strong>.</li>
<li>If you change existing code, run it to confirm the output still matches the book.</li>
<li>Add a short comment showing expected output if it helps readers verify success.</li>
</ul>
</li>
<li>
<p><strong>Open a pull request</strong></p>
<ul>
<li>Reference the related issue (for example, <code>Fixes #123</code>).</li>
<li>In the PR description, explain <strong>why</strong> you made the change and <strong>how</strong> you tested it.</li>
<li>CI checks will compile the code and build the book; please wait for them to pass.</li>
</ul>
</li>
<li>
<p><strong>Review process</strong></p>
<ul>
<li>We aim to review within a week. Friendly suggestions are normal—feel free to ask for clarification.</li>
<li>Once approved, a maintainer will merge and include your name in the release notes.</li>
</ul>
</li>
<li>
<p><strong>Licensing</strong></p>
<ul>
<li><strong>Kernel eBPF source files</strong>
<ul>
<li>If the file contains
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div>it is contributed under <strong>GPL-2.0-or-later</strong> so it can use GPL-only helpers.</li>
<li>You may instead set the string to <code>&quot;BSD&quot;</code>, <code>&quot;MIT&quot;</code>, or any SPDX-compatible identifier if you prefer a more permissive license.
<ul>
<li><strong>Important:</strong> the kernel will then <em>not</em> allow GPL-only helpers; choose this path only if your code does not need them.</li>
<li>State your chosen license in the file header so readers know the terms.</li>
</ul>
</li>
</ul>
</li>
<li><strong>User-space loaders, scripts, and utilities</strong> are <strong>Apache 2.0</strong> by default (mention in the header if you prefer GPL).</li>
<li><strong>Book text and diagrams</strong> remain <strong>Creative Commons BY 4.0</strong>.</li>
</ul>
</li>
<li>
<p><strong>Code of Conduct</strong></p>
<ul>
<li>We follow the <a href="https://www.contributor-covenant.org/">Contributor Covenant v2.1</a>. Please be respectful, patient, and welcoming.
That’s it! Thank you for helping more people engineer everything with eBPF.</li>
</ul>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bce1c354c315a95f95c7aade814709c6">1.5 - </h1>
    
	<!-- ---
title: Acknowledgements
description:
weight: 3
--- -->

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3a4ad83f0eb0486386a1a310701ecfa0">2 - What is eBPF</h1>
    <div class="lead">A gentle warm-up that explains what eBPF does where it came from why companies rely on it and how the architecture fits together.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bc61bcf6c1e33409689f51be243e74b1">2.1 - Introduction</h1>
    <div class="lead">Plain language snapshot of eBPF as tiny programs running safely in the Linux kernel.</div>
	<p><strong>eBPF</strong> (Extended Berkeley Packet Filter) is a revolutionary in-kernel virtual machine that allows developers to execute custom programs directly within the Linux kernel. Unlike traditional approaches, which require recompiling or modifying the kernel, eBPF enables the dynamic injection of code, providing a safe and efficient way to extend kernel functionality without rebooting the system.</p>
<p>eBPF programs are typically written in a restricted subset of C, compiled into bytecode, and then loaded into the kernel using the <code>bpf()</code> system call (which will be explained in more detail later). Once loaded, these programs can be attached to various hooks or events within the kernel, such as system calls, network packets, and tracepoints. The execution of eBPF programs is governed by strict safety checks to prevent them from crashing the kernel or accessing unauthorized memory areas.</p>
<p>In simpler terms, think of eBPF as a sandboxed virtual machine inside the kernel that can observe and modify system behavior safely and efficiently. This technology has opened up new possibilities for performance monitoring, networking enhancements, and security enforcement.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    eBPF is not a virtual machine in the traditional sense but rather a mechanism for executing special-purpose bytecode within the kernel.

</div>

<h3 id="key-capabilities-of-ebpf">Key Capabilities of eBPF<a class="td-heading-self-link" href="#key-capabilities-of-ebpf" aria-label="Heading self-link"></a></h3>
<ol>
<li>
<p><strong>Tracing</strong>: eBPF provides powerful tracing capabilities that allow developers to observe and analyze the behavior of the kernel and user-space applications. By attaching eBPF programs to tracepoints, kprobes (kernel probes), and uprobes (user-space probes), you can gather detailed insights into system performance and diagnose issues in real-time (which will be explained later).</p>
<ul>
<li><strong>Example Use Case</strong>: Using eBPF you can trace file open operations to see which files are being accessed by a process by attacheing an eBPF program to the <code>open()</code> system call tracepoint and prints the filename each time a file is opened. In cybersecurity, it helps detect unauthorized file access, enabling early threat detection and compliance monitoring.</li>
</ul>
</li>
<li>
<p><strong>Networking</strong>: eBPF enables advanced networking features by allowing custom packet filtering, modification, and routing logic to run within the kernel. This eliminates the need to copy packets to user space, reducing latency and improving performance.</p>
<ul>
<li><strong>Example Use Case</strong>: The XDP (eXpress Data Path) framework uses eBPF to perform high-speed packet processing at the network interface card (NIC) level. This is particularly useful for applications like DDoS mitigation and load balancing.</li>
</ul>
</li>
<li>
<p><strong>Security</strong>: eBPF enhances system security by allowing real-time monitoring and enforcement of security policies. With eBPF, you can detect and respond to security events, such as unauthorized system calls or suspicious network activity.</p>
<ul>
<li><strong>Example Use Case</strong>: Seccomp can be used to enforce security policies by restricting the system calls a process is allowed to make. In containerized environments or isolated applications, seccomp helps ensure that only necessary and authorized system calls are permitted, preventing potential security breaches by blocking access to sensitive kernel functionality.</li>
</ul>
</li>
<li>
<p><strong>Observability</strong>: eBPF provides deep observability into system behavior by allowing the collection of detailed telemetry data. Unlike traditional logging and metrics, eBPF-based observability can capture low-level events without requiring changes to application code.</p>
<ul>
<li><strong>Example Use Case</strong>: Tools like <code>bcc</code> (BPF Compiler Collection) and <code>bpftrace</code> allow you to profile CPU usage, memory access, and I/O operations in real-time, helping to identify performance bottlenecks and optimize system performance. In cybersecurity, this can be used to monitor for anomalous system behavior, such as unusual CPU spikes or memory access patterns, which could indicate a malware infection or unauthorized activities.</li>
</ul>
</li>
</ol>
<p>Don&rsquo;t worry if some of these concepts seem challenging right now; we’ll break them down with clear examples throughout the book. Now, let’s dive into the history of eBPF.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7d4be615997631ee15f3b986ea0bdd99">2.2 - History of eBPF</h1>
    <div class="lead">Journey from classic BPF in the nineties to the modern 64-bit virtual machine.</div>
	<h3 id="origins-of-bpf-berkeley-packet-filter">Origins of BPF (Berkeley Packet Filter)<a class="td-heading-self-link" href="#origins-of-bpf-berkeley-packet-filter" aria-label="Heading self-link"></a></h3>
<p>The origins of eBPF (extended Berkeley Packet Filter) trace back to its predecessor, the Berkeley Packet Filter (BPF). BPF was first introduced in 1992 by Steven McCanne and Van Jacobson at the Lawrence Berkeley Laboratory. It was designed to provide a high-performance, user-programmable packet filtering mechanism for network monitoring tools, particularly for capturing packets in real-time.</p>
<p>Prior to BPF, packet capturing was inefficient due to the need for constant context switching between the kernel and user space. The kernel would pass every network packet to user space, where filtering decisions were made. This approach led to significant overhead. BPF addressed this problem by enabling the execution of filtering programs directly within the kernel, allowing only relevant packets to be passed to user space. This dramatically improved performance and efficiency.</p>
<h3 id="classic-bpf-and-its-limitations">Classic BPF and Its Limitations<a class="td-heading-self-link" href="#classic-bpf-and-its-limitations" aria-label="Heading self-link"></a></h3>
<p>Classic BPF, often referred to as <strong>cBPF</strong> worked by allowing users to write simple programs to filter network traffic based on specific patterns. These programs were expressed as sequences of low-level instructions that the BPF virtual machine (VM) running in the kernel could interpret and execute. The most notable tool that leveraged cBPF was <code>tcpdump</code>, which allowed network administrators to capture and analyze network packets effectively.</p>
<p>Despite its efficiency, cBPF had several limitations:</p>
<ol>
<li>Limited Instruction Set: The instruction set of classic BPF was restricted to basic filtering operations, making it unsuitable for more complex use cases.</li>
<li>Single-Purpose: cBPF was designed primarily for packet filtering. It lacked the flexibility to perform tasks beyond network monitoring.</li>
<li>32-bit Architecture: Classic BPF programs operated on 32-bit registers, which limited performance and data processing capabilities.</li>
<li>Lack of Extensibility: There was no straightforward way to extend the functionality of cBPF beyond packet filtering.</li>
</ol>
<h3 id="integration-of-bpf-into-the-linux-kernel">Integration of BPF into the Linux Kernel<a class="td-heading-self-link" href="#integration-of-bpf-into-the-linux-kernel" aria-label="Heading self-link"></a></h3>
<p>BPF was first integrated into the Linux kernel in 1997, starting from version 2.1. This integration allowed kernel-level packet filtering for tools like <code>tcpdump</code> and <code>iptables</code>. Over time, the BPF VM became a reliable mechanism for filtering network traffic efficiently within the kernel space.</p>
<p>However, as system and network performance demands grew, the limitations of classic BPF became more clear. The need for a more powerful, flexible, and extensible version of BPF led to the development of eBPF.</p>
<h3 id="introduction-and-evolution-of-ebpf-2014-present">Introduction and Evolution of eBPF (2014-Present)<a class="td-heading-self-link" href="#introduction-and-evolution-of-ebpf-2014-present" aria-label="Heading self-link"></a></h3>
<p>In 2014, the Linux kernel version 3.18 introduced &ldquo;extended BPF&rdquo; (eBPF). eBPF was a significant enhancement over classic BPF, providing a modern, flexible, and powerful framework for executing user-defined programs within the kernel. The key improvements introduced by eBPF include:</p>
<ol>
<li>64-bit Registers: eBPF uses a 64-bit architecture, which improves performance and data-handling capabilities.</li>
<li>General-Purpose: eBPF is no longer limited to packet filtering; it can be used for various tasks, including tracing, performance monitoring, security enforcement, and more.</li>
<li>Extensible and Safe: eBPF programs are verified by an in-kernel verifier to ensure safety, preventing programs from crashing the kernel or causing security vulnerabilities.</li>
<li>Just-In-Time (JIT) Compilation: eBPF programs can be compiled into native machine code at runtime, which significantly improves execution speed.</li>
<li>Maps and Helpers: eBPF supports maps (key-value storage) and helper functions that provide interaction between eBPF programs and the kernel.</li>
</ol>
<p>Since its introduction, eBPF has evolved rapidly, with continuous enhancements to its feature set and performance. Projects like <code>bcc</code> (BPF Compiler Collection), <code>bpftool</code>, and <code>libbpf</code> have made writing and deploying eBPF programs more accessible. eBPF is now used extensively for networking, observability, and security tasks in major projects like Cilium, Falco, and the Kubernetes ecosystem.</p>
<h3 id="naming-confusion">Naming Confusion<a class="td-heading-self-link" href="#naming-confusion" aria-label="Heading self-link"></a></h3>
<p>The terminology surrounding BPF and eBPF often leads to confusion due to the historical evolution of the technology. Originally, BPF referred exclusively to the Berkeley Packet Filter designed for packet capture. However, with the introduction of eBPF in 2014, the technology evolved far beyond its initial purpose, supporting tasks like tracing, performance monitoring, and security.</p>
<p>Despite these advancements, many tools and kernel APIs continue to use the term &ldquo;BPF&rdquo; even when referring to eBPF functionality. For example, commands like <code>bpftool</code> and the <code>bpf()</code> system call refer to eBPF features while retaining the older name. This overlap in terminology can cause misunderstandings, especially for newcomers who may not be aware of the differences between classic BPF and modern eBPF.</p>
<p>To avoid confusion, it&rsquo;s helpful to use &ldquo;BPF&rdquo; when referring to the original packet-filtering technology and &ldquo;eBPF&rdquo; when discussing the extended capabilities introduced in the modern framework. This distinction clarifies communication and ensures a better understanding of the technology&rsquo;s capabilities in the Linux ecosystem.</p>
<h3 id="example-using-tcpdump">Example Using tcpdump<a class="td-heading-self-link" href="#example-using-tcpdump" aria-label="Heading self-link"></a></h3>
<p>To illustrate classic BPF in action, consider a simple <code>tcpdump</code> command that captures only TCP traffic on port 80 (HTTP):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -i eth0 <span style="color:#4e9a06">&#39;ip and tcp port 80&#39;</span>
</span></span></code></pre></div><p>This command filters packets to capture only those that are TCP-based and are using port 80. The underlying BPF bytecode generated by this command can be viewed using the <code>-d</code> flag:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -i eth0 -d <span style="color:#4e9a06">&#39;ip and tcp port 80 tcp port 80&#39;</span>
</span></span></code></pre></div><p>The output might look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>000<span style="color:#ce5c00;font-weight:bold">)</span> ldh      <span style="color:#ce5c00;font-weight:bold">[</span>12<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>001<span style="color:#ce5c00;font-weight:bold">)</span> jeq      <span style="color:#8f5902;font-style:italic">#0x800           jt 2    jf 12</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>002<span style="color:#ce5c00;font-weight:bold">)</span> ldb      <span style="color:#ce5c00;font-weight:bold">[</span>23<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>003<span style="color:#ce5c00;font-weight:bold">)</span> jeq      <span style="color:#8f5902;font-style:italic">#0x6             jt 4    jf 12</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>004<span style="color:#ce5c00;font-weight:bold">)</span> ldh      <span style="color:#ce5c00;font-weight:bold">[</span>20<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>005<span style="color:#ce5c00;font-weight:bold">)</span> jset     <span style="color:#8f5902;font-style:italic">#0x1fff          jt 12   jf 6</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>006<span style="color:#ce5c00;font-weight:bold">)</span> ldxb     4*<span style="color:#ce5c00;font-weight:bold">([</span>14<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">&amp;</span>0xf<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>007<span style="color:#ce5c00;font-weight:bold">)</span> ldh      <span style="color:#ce5c00;font-weight:bold">[</span>x + 14<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>008<span style="color:#ce5c00;font-weight:bold">)</span> jeq      <span style="color:#8f5902;font-style:italic">#0x50            jt 11   jf 9</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>009<span style="color:#ce5c00;font-weight:bold">)</span> ldh      <span style="color:#ce5c00;font-weight:bold">[</span>x + 16<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>010<span style="color:#ce5c00;font-weight:bold">)</span> jeq      <span style="color:#8f5902;font-style:italic">#0x50            jt 11   jf 12</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>011<span style="color:#ce5c00;font-weight:bold">)</span> ret      <span style="color:#8f5902;font-style:italic">#262144</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>012<span style="color:#ce5c00;font-weight:bold">)</span> ret      <span style="color:#8f5902;font-style:italic">#0</span>
</span></span></code></pre></div><h3 id="explanation-of-the-generated-bpf-bytecode">Explanation of the Generated BPF Bytecode<a class="td-heading-self-link" href="#explanation-of-the-generated-bpf-bytecode" aria-label="Heading self-link"></a></h3>
<p>Before diving into the example, take a moment to review the following diagram of the Ethernet, IP, and TCP headers. This will help you visualize how the packet is structured, making it easier to follow along with each step in the BPF bytecode. Keep this scheme in mind as we go through the example to understand how each instruction maps to specific parts of the packet.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter1/network-structure.png" alt="Centered image" />
</p>
<p>Here&rsquo;s the breakdown of each instruction, including the relevant source code location and <strong>snippets</strong> from the Linux kernel where these actions are defined or represented.</p>
<ol>
<li>
<p><strong>Instruction 000</strong> <code>ldh [12]</code>: Load the 16-bit EtherType field at offset 12 in the packet as described in the kernel source code <code>include/uapi/linux/if_ether.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_HLEN 14          </span><span style="color:#8f5902;font-style:italic">/* Total Ethernet header length */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_P_IP 0x0800      </span><span style="color:#8f5902;font-style:italic">/* IPv4 EtherType */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div></li>
<li>
<p><strong>Instruction 001</strong> <code>jeq #0x800 jt 2 jf 12</code>: If the EtherType is <code>0x800</code> (IPv4), jump to instruction 2; otherwise, jump to instruction 12.</p>
</li>
<li>
<p><strong>Instruction 002</strong> <code>ldb [23]</code>: Load the 8-bit protocol field at offset 23 in the IP header.</p>
</li>
<li>
<p><strong>Instruction 003</strong> <code>jeq #0x6 jt 4 jf 12</code>: If the protocol is <code>6</code> (TCP), jump to instruction 4; otherwise, jump to instruction 12 as described in the kernel source code <code>include/uapi/linux/in.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define IPPROTO_TCP 6        </span><span style="color:#8f5902;font-style:italic">/* Transmission Control Protocol */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div></li>
<li>
<p><strong>Instruction 004</strong>: <code>ldh [20]</code>: Load the 16-bit TCP source port at offset 20.</p>
</li>
<li>
<p><strong>Instruction 005</strong>: <code>jset #0x1fff jt 12 jf 6</code>: Check if the lower 13 bits of the TCP header are non-zero; if true, jump to instruction 12; otherwise, jump to instruction 6.</p>
</li>
<li>
<p><strong>Instruction 006</strong>: <code>ldxb 4*([14]&amp;0xf)</code>: Load the value in the TCP header, adjusting by scaling based on the value in the IP header.</p>
</li>
<li>
<p><strong>Instruction 007</strong>: <code>ldh [x + 14]</code>: Load the TCP destination port, located at offset 14 from the start of the packet.</p>
</li>
<li>
<p><strong>Instruction 008</strong>: <code>jeq #0x50 jt 11 jf 9</code>: If the destination port is <code>80</code> (0x50 in hexadecimal), jump to instruction 11; otherwise, jump to instruction 9.</p>
</li>
<li>
<p><strong>Instruction 009</strong>: <code>ldh [x + 16]</code>: Load the TCP source port, located at offset 16 from the start of the packet.</p>
</li>
<li>
<p><strong>Instruction 010</strong>: <code>jeq #0x50 jt 11 jf 12</code>: If the source port is <code>80</code> (0x50), jump to instruction 11; otherwise, jump to instruction 12.</p>
</li>
<li>
<p><strong>Instruction 011</strong>: <code>ret #262144</code>: If all conditions match, capture the packet (return the packet length).</p>
</li>
<li>
<p><strong>Instruction 012</strong>: <code>ret #0</code>: If the conditions do not match, drop the packet.</p>
</li>
</ol>
<p>These instructions illustrate a classic BPF packet filter that matches IPv4 and TCP traffic on port 80 (HTTP). The constants and structures provided are standard definitions in the Linux kernel. This bytecode demonstrates how classic BPF allows efficient filtering by executing a series of low-level instructions directly in the kernel.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    By specifying &ldquo;tcp port 80&rdquo; in the filter, the bytecode includes extra instructions (like Instruction 008 and Instruction 010) to check both the source and destination ports for port <code>80</code>. Without explicitly defining both ports, the filter would not distinguish between source and destination ports, simplifying the bytecode. These additional checks ensure that packets using port <code>80</code> in either direction are captured.

</div>

<p>Let’s explore the differences between classic BPF and eBPF to better understand the enhanced capabilities of eBPF.</p>
<h3 id="classic-bpf-vs-ebpf">Classic BPF vs. eBPF<a class="td-heading-self-link" href="#classic-bpf-vs-ebpf" aria-label="Heading self-link"></a></h3>
<p>As mentioned, Berkeley Packet Filter (BPF) was originally developed to filter network packets efficiently. It enabled in-kernel filtering of packets based on simple criteria. However, as the need for more versatile and performant filtering and monitoring grew, extended BPF (eBPF) emerged as a powerful evolution. eBPF transforms BPF into a general-purpose execution engine within the kernel, providing significantly more flexibility and efficiency.</p>
<p>The following 6 points explores the key differences between eBPF and classic BPF, based on Kernel Documentation <a href="https://docs.kernel.org/bpf/classic_vs_extended.html">https://docs.kernel.org/bpf/classic_vs_extended.html</a>.</p>
<h4 id="use-cases">Use Cases<a class="td-heading-self-link" href="#use-cases" aria-label="Heading self-link"></a></h4>
<p><strong>Classic BPF</strong> is primarily used for packet filtering. Its primary use case is in network monitoring tools like <code>tcpdump</code>, where it allows users to specify packet filtering rules directly within the kernel.</p>
<p>eBPF, however, has vastly expanded use cases. eBPF is used in:</p>
<ul>
<li><strong>System monitoring</strong>: Collecting detailed information on kernel events such as system calls, file access, and network traffic.</li>
<li><strong>Performance profiling</strong>: Monitoring the performance of different parts of the kernel, applications, or system calls in real-time.</li>
<li><strong>Security</strong>: Tools like seccomp (Secure Computing Mode) use eBPF to filter system calls, enforcing security policies directly at the kernel level.</li>
<li><strong>Tracing</strong>: Tracing the execution of kernel functions and user programs, providing insights into system behavior.</li>
</ul>
<h4 id="instruction-set-and-operations">Instruction Set and Operations<a class="td-heading-self-link" href="#instruction-set-and-operations" aria-label="Heading self-link"></a></h4>
<p>Classic BPF has a very limited instruction set, primarily designed for basic operations like loading data, performing simple arithmetic, jumping, and returning values.</p>
<p>eBPF, in contrast, expands the instruction set significantly. It introduces new operations like:</p>
<ul>
<li><strong>BPF_MOV</strong> for moving data between registers,</li>
<li><strong>BPF_ARSH</strong> for arithmetic right shift with sign extension,</li>
<li><strong>BPF_CALL</strong> for calling helper functions (which will be explained in more details later).</li>
</ul>
<p>Additionally, eBPF supports 64-bit operations (via <code>BPF_ALU64</code>) and atomic operations like BPF_XADD, enabling more sophisticated processing directly in the kernel.</p>
<h4 id="registers-and-data-handling">Registers and Data Handling<a class="td-heading-self-link" href="#registers-and-data-handling" aria-label="Heading self-link"></a></h4>
<p>Classic BPF only has two registers (A and X), with limited memory and stack space. The operations on data are simple and restricted to 32-bit width, and these registers are manipulated with specific instructions that limit flexibility.</p>
<p>eBPF greatly improves on this by expanding the number of registers from 2 to 10. eBPF&rsquo;s calling conventions are designed for high efficiency, utilizing registers (R1-R5) to pass arguments directly into the kernel functions. After the function call, registers R1-R5 are reset, and R0 holds the return value.This allows for more complex operations and handling of more data. Registers in eBPF are also 64-bit wide, which enables direct mapping to hardware registers on modern 64-bit processors. This wider register set and the introduction of a read-only frame pointer (R10) allow eBPF to handle more complex operations like function calls with multiple arguments and results.</p>
<h4 id="jit-compilation-and-performance">JIT Compilation and Performance<a class="td-heading-self-link" href="#jit-compilation-and-performance" aria-label="Heading self-link"></a></h4>
<p>Classic BPF is interpreted by the kernel, This means the kernel would read and execute each instruction one by one which adds overhead to the execution of each instruction. This can be a limiting factor when performing more complex operations or filtering on high-throughput systems.</p>
<p>eBPF is designed with Just-In-Time (JIT) compilation in mind, meaning that eBPF programs can be translated into optimized native machine code at runtime. The JIT compiler can convert eBPF bytecode to highly efficient machine instructions, reducing the overhead significantly. This allows eBPF programs to perform at speeds comparable to native code execution, even for complex tasks like system call filtering and network traffic analysis.</p>
<h4 id="safety-and-verifier">Safety and Verifier<a class="td-heading-self-link" href="#safety-and-verifier" aria-label="Heading self-link"></a></h4>
<p>Classic BPF uses a simple verifier that checks for program safety by ensuring there are no errors like out-of-bounds memory access.</p>
<p>eBPF, on the other hand, includes a more sophisticated verifier that ensures the program complies to a set of strict rules before execution. The verifier checks for issues like:</p>
<ul>
<li>Accessing invalid memory regions,</li>
<li>Ensuring correct pointer arithmetic,</li>
<li>Verifying that all function calls are made with valid arguments.</li>
</ul>
<p>This makes eBPF programs much safer, even when they are running with elevated privileges or performing sensitive tasks in the kernel.</p>
<h4 id="program-size-and-restrictions">Program Size and Restrictions<a class="td-heading-self-link" href="#program-size-and-restrictions" aria-label="Heading self-link"></a></h4>
<p>Classic BPF: The original BPF format had a program size limit of 4096 instructions, and programs had to be very efficient to avoid exceeding this limit. The limited number of registers and operations meant that programs were usually simple and short.</p>
<p>eBPF: While eBPF still retains a 4096 instruction limit for kernels before 5.2 and one million instructions for kernel starting from 5.2, its expanded instruction set and register size allow for significantly more complex programs. Additionally, the eBPF verifier ensures that programs are safe, loop-free, and deterministic. Furthermore, there are restrictions on the number of arguments that can be passed to kernel functions (currently up to five), although these can be relaxed in future versions of eBPF. Tail calls also allow chaining multiple eBPF programs together, effectively extending the overall execution beyond the single-program instruction limit.</p>
<p>Now, let&rsquo;s dive into real-world examples to see how eBPF is applied in action and understand its practical benefits.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-913f3a33743572b7b9ac9a4356af7737">2.3 - eBPF in the Real World</h1>
    <div class="lead">Short case studies of Netflix Meta Cloudflare and more.</div>
	<h3 id="netflix-performance-tracing-and-debugging">Netflix: Performance Tracing and Debugging<a class="td-heading-self-link" href="#netflix-performance-tracing-and-debugging" aria-label="Heading self-link"></a></h3>
<p>Netflix relies heavily on maintaining a high level of performance and reliability for its massive streaming infrastructure. With millions of users accessing content simultaneously, identifying performance bottlenecks and ensuring smooth streaming is critical. To address these challenges, Netflix leverages eBPF for advanced performance tracing and debugging.</p>
<p>eBPF allows Netflix engineers to dynamically instrument production systems to gain real-time insights into various kernel and application-level events without impacting system performance. Tools like BPFtrace and bcc (BPF Compiler Collection) help trace everything from CPU utilization to memory allocation and disk I/O latency. eBPF enables the monitoring of these metrics without requiring code modifications or system restarts, providing a seamless debugging experience.</p>
<p>One of the key benefits for Netflix is the ability to analyze issues in real time. When a problem arises, engineers can deploy eBPF-based tracing programs to identify the root cause immediately. This minimizes downtime and ensures rapid resolution. For example, if a particular server experiences unexpected delays, eBPF can quickly pinpoint whether the issue stems from the network stack, disk latency, or a CPU bottleneck.</p>
<p>Moreover, eBPF’s low overhead makes it suitable for use in high-traffic production environments. Unlike traditional tracing tools, which often introduce performance degradation, eBPF maintains efficiency while providing deep insights. This combination of power and performance helps Netflix maintain the quality of service users expect.</p>
<h3 id="facebook-meta-load-balancing-with-katran">Facebook (Meta): Load Balancing with Katran<a class="td-heading-self-link" href="#facebook-meta-load-balancing-with-katran" aria-label="Heading self-link"></a></h3>
<p>Facebook (now Meta) handles billions of user interactions daily, requiring robust and efficient load-balancing mechanisms. To achieve this, Facebook developed Katran, a high-performance, eBPF-based layer 4 load balancer. Katran powers the edge network for Facebook’s backend services, providing scalable and reliable traffic distribution.</p>
<p>Katran uses XDP eBPF to offload load-balancing tasks to the Linux kernel, bypassing some of the traditional limitations of user-space load balancers. By running directly in the kernel, eBPF ensures that packet processing is both fast and efficient, reducing the need for context switches and avoiding bottlenecks.</p>
<p>A key feature of Katran is its ability to dynamically adapt to changes in traffic patterns. eBPF programs enable the load balancer to update its forwarding rules on the fly without requiring restarts. This dynamic updating capability ensures minimal disruption and allows Facebook to handle sudden traffic surges smoothly <a href="https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/">https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/</a>.</p>
<h3 id="cloudflare-ddos-mitigation">Cloudflare: DDoS Mitigation<a class="td-heading-self-link" href="#cloudflare-ddos-mitigation" aria-label="Heading self-link"></a></h3>
<p>Cloudflare provides security and performance services to millions of websites worldwide, making it a prime target for Distributed Denial of Service (DDoS) attacks. To protect against these attacks, Cloudflare uses XDP eBPF to enhance its DDoS mitigation capabilities.</p>
<p>eBPF enables Cloudflare to monitor network traffic in real time, identifying and filtering out malicious packets before they reach the application layer. By deploying eBPF programs directly in the kernel, Cloudflare can analyze packet headers, track connection states, and enforce filtering rules with minimal latency.</p>
<p>One advantage of using eBPF for DDoS mitigation is its flexibility. eBPF allows Cloudflare to update filtering logic dynamically, adapting to new attack vectors without requiring system downtime or restarts. For example, when a new type of DDoS attack is identified, Cloudflare can deploy an updated eBPF filter to block the attack within seconds <a href="https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/">https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/</a>.</p>
<p>Moreover, eBPF’s performance efficiency ensures that mitigation measures do not degrade legitimate traffic. Cloudflare can maintain high throughput and low latency even when under attack, providing a seamless experience for end users.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a8fa3a1fe994e20887a5a028f76006d1">2.4 - Why eBPF?</h1>
    <div class="lead">Key benefits such as speed safety live updates observability and portability.</div>
	<p>eBPF offers a range of benefits that make it an attractive choice for organizations looking to improve performance, security, and flexibility in their systems. Here are some key reasons to use eBPF:</p>
<ol>
<li><strong>High Performance</strong></li>
</ol>
<p>eBPF programs run directly in the kernel, avoiding the performance penalties associated with user-space operations. With Just-In-Time (JIT) compilation, eBPF code is translated into efficient machine code, ensuring minimal latency and high throughput. This makes eBPF suitable for performance-critical applications like load balancing, packet filtering, and tracing.</p>
<ol start="2">
<li><strong>Flexibility in Use Cases</strong></li>
</ol>
<p>eBPF’s flexibility allows it to be used across various domains, including:</p>
<ul>
<li><strong>Networking</strong>: Load balancing, DDoS mitigation, and network filtering.</li>
<li><strong>Tracing</strong>: Performance monitoring, debugging, and observability.</li>
<li><strong>Security</strong>: Real-time policy enforcement, intrusion detection, and runtime security monitoring.</li>
</ul>
<p>This flexibility allows organizations to implement a wide range of solutions without needing different tools for each use case.</p>
<ol start="3">
<li><strong>Security Enhancements</strong></li>
</ol>
<p>eBPF enhances security by enabling real-time policy enforcement and providing deep visibility into system behavior. The eBPF verifier ensures that programs are safe to run, preventing harmful or insecure code from affecting the kernel. This safety mechanism reduces the risk of vulnerabilities and exploits.</p>
<ol start="4">
<li><strong>Dynamic Updates</strong></li>
</ol>
<p>One of eBPF’s standout features is its ability to update functionality dynamically. Whether for tracing, load balancing, or security filtering, eBPF programs can be modified and reloaded without rebooting the system. This ensures minimal downtime and enables rapid responses to changing conditions.</p>
<ol start="5">
<li><strong>Observability and Monitoring</strong></li>
</ol>
<p>eBPF provides powerful tools for real-time observability. By attaching eBPF programs to various kernel and user-space events, organizations can gain detailed insights into system behavior, identify bottlenecks, and troubleshoot issues quickly.</p>
<ol start="6">
<li><strong>Portability</strong></li>
</ol>
<p>While eBPF programs are highly portable across different Linux distributions, their portability can be affected by variations in kernel versions, architectures, and the available helper functions. The eBPF subsystem in the kernel provides a consistent foundation, but certain kernel updates or changes in architecture may introduce new features or limitations that require modifications to the eBPF programs. Despite these potential variations, eBPF still offers a relatively high degree of portability for cloud-based applications and large-scale environments, allowing organizations to deploy solutions across diverse systems with minimal overhead, provided that compatibility is taken into account.</p>
<p>Now that we’ve explored the general benefits of eBPF, let’s take a closer look at how these advantages specifically apply to the realm of cybersecurity.</p>
<h3 id="ebpf-in-cybersecurity">eBPF in Cybersecurity<a class="td-heading-self-link" href="#ebpf-in-cybersecurity" aria-label="Heading self-link"></a></h3>
<p>eBPF’s capabilities make it a powerful tool for enhancing cybersecurity across multiple layers of infrastructure. By operating within the kernel, eBPF can monitor, analyze, and enforce security policies with low latency and high efficiency. This ability to operate in real time gives organizations a crucial edge in protecting against modern cyber threats.</p>
<ol>
<li><strong>Intrusion Detection and Prevention</strong></li>
</ol>
<p>eBPF enables deep inspection of network traffic and system calls, allowing for real-time detection of anomalous behavior. Organizations can use eBPF to build intrusion detection and prevention systems (IDS/IPS) that identify and block malicious activities such as SQL injection, malware payloads, and privilege escalation attempts. eBPF’s ability to analyze packets at the kernel level ensures minimal overhead while maintaining thorough security checks.</p>
<ol start="2">
<li><strong>DDoS Mitigation</strong></li>
</ol>
<p>eBPF’s flexibility allows for rapid deployment of filters to block DDoS traffic patterns. When an attack is detected, eBPF programs can be dynamically updated to mitigate new attack vectors in real time. This adaptive capability ensures continuous protection without service disruption.</p>
<ol start="3">
<li><strong>Runtime Security Enforcement</strong></li>
</ol>
<p>eBPF can enforce security policies at runtime by monitoring system calls and blocking unauthorized actions. For instance, if a process attempts to access restricted files or execute suspicious operations, eBPF can intervene immediately to block the action and alert administrators. This helps mitigate insider threats and potential exploits.</p>
<ol start="4">
<li><strong>Process and Kernel Integrity Monitoring</strong></li>
</ol>
<p>By attaching eBPF probes to system processes and kernel functions, organizations can monitor for integrity violations. eBPF can detect unauthorized modifications to critical processes (such as injecting code into a running process) or kernel structures, providing an additional layer of defense against cyber attacks.</p>
<ol start="5">
<li><strong>Real-Time Threat Intelligence</strong></li>
</ol>
<p>eBPF can integrate with threat intelligence platforms to apply real-time security updates. For example, new threat indicators can be deployed as eBPF filters to block known malicious IP addresses, domains, or file hashes. This real-time enforcement capability helps organizations stay ahead of evolving threats.</p>
<p>In summary, eBPF’s combination of real-time monitoring, dynamic policy enforcement, and low-latency execution makes it a cornerstone for modern cybersecurity strategies. It could empowers organizations to defend against cyber threats while maintaining performance and system integrity.</p>
<p>Don’t worry if this all feels a bit abstract right now—throughout the next chapters, we’ll dive into specific examples that illustrate how eBPF can be applied to these cybersecurity challenges.</p>
<p>Now that we&rsquo;ve seen how eBPF can enhance cybersecurity, let&rsquo;s take a closer look at its architecture, which enables these powerful capabilities.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-68d2ba4ee51daffab776702aa5ed8d84">2.5 - eBPF Architecture</h1>
    <div class="lead">High level flow loader to verifier to JIT with maps and helpers alongside.</div>
	<p>The eBPF architecture is both simple—through its rigid instruction set, maps, and helpers—and sophisticated—via the verifier, JIT, and integration points. At a high level, it is a pipeline taking user-space defined logic through a safety check and into the kernel’s execution environment. At a deep level, each component (verifier, maps, JIT) enforces strict rules that guarantee the kernel’s stability and performance.
Through this layered design, eBPF achieves a rare combination: the ability to safely run custom code inside the kernel at near-native speeds while maintaining robust security and reliability guarantees.</p>
<p>Some of the following may not be clear to you yet, as each component will be explained in more detail in the following chapters.</p>
<p>A high-level view of the architecture:</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter1/eBPF-Architecture.png" alt="Centered image" />
</p>
<h4 id="ebpf-loader-and-user-space-tools">eBPF Loader and User-Space Tools<a class="td-heading-self-link" href="#ebpf-loader-and-user-space-tools" aria-label="Heading self-link"></a></h4>
<p>User space tooling compiles and loads these eBPF programs. For example, Clang/LLVM: Compiles C (or other) source code to eBPF bytecode using a special <code>-target bpf</code> flag. The workflow is similar to the following:</p>
<ol>
<li>Write program in C (or higher-level language).</li>
<li>Compile to eBPF bytecode with clang.</li>
<li>Use <code>bpf()</code> system calls via libbpf or bpftool to load the bytecode into the kernel.</li>
<li>The verifier inspects it, and if safe, it is ready to run.</li>
</ol>
<p>This pipeline ensures a controlled, step-by-step process from user space into the kernel.</p>
<h4 id="verification-and-safety-constraints">Verification and Safety Constraints<a class="td-heading-self-link" href="#verification-and-safety-constraints" aria-label="Heading self-link"></a></h4>
<p>Before an eBPF program runs, it must pass through a static verifier that analyzes every possible execution path. The verifier ensures:</p>
<ul>
<li><strong>Memory Safety:</strong> No out-of-bounds accesses to the stack, no invalid pointer arithmetic, and no unsafe direct memory dereferences.</li>
<li><strong>Termination Guarantee:</strong> No infinite loops; all loops must have known upper bounds.</li>
<li><strong>Argument Checking:</strong> Arguments passed to helper functions must conform to expected types and constraints.</li>
<li><strong>Register State Tracking:</strong> The verifier tracks register states to ensure no use of uninitialized values and proper pointer usage rules.</li>
</ul>
<p style="text-align: center;">
  <img src="/images/docs/chapter1/verifier.png" alt="Centered image" />
</p>
<p>The verifier ensures that once a program is accepted, it cannot violate kernel integrity.</p>
<h4 id="jit-compilation-and-performanc">JIT Compilation and Performanc<a class="td-heading-self-link" href="#jit-compilation-and-performanc" aria-label="Heading self-link"></a></h4>
<p>Once verified, eBPF bytecode can be interpreted by an in-kernel virtual machine, or just-in-time compiled into native machine instructions. The JIT compiler:</p>
<ul>
<li>Translates eBPF instructions to efficient CPU instructions.</li>
<li>Eliminates interpretation overhead.</li>
<li>Ensures near-native performance, which is vital for high-frequency events like networking.</li>
</ul>
<p>This makes eBPF suitable for performance-critical tasks, such as packet processing at line rate with XDP (eXpress Data Path).</p>
<h4 id="context-and-hook-points">Context and Hook Points<a class="td-heading-self-link" href="#context-and-hook-points" aria-label="Heading self-link"></a></h4>
<p>eBPF programs are executed when certain kernel events occur. These events are known as <code>hook points</code>. Common hook points include:</p>
<ul>
<li><strong>Tracepoints &amp; Kprobes:</strong> Run when specific kernel functions or events occur.</li>
<li><strong>XDP Hooks:</strong> Triggered at the earliest point in network packet processing, allowing for ultra-fast packet filtering or modification.</li>
<li><strong>Socket and TC Hooks:</strong> Attach to sockets or traffic control ingress/egress points for per-packet decision making.</li>
</ul>
<p>Each hook provides a context—a structured pointer to data relevant to that event (e.g., packet metadata, process info). The program reads fields from this context within verifier-approved bounds, making decisions based on current state.</p>
<h4 id="maps">Maps<a class="td-heading-self-link" href="#maps" aria-label="Heading self-link"></a></h4>
<p>Maps are the primary mechanism for storing and sharing state between eBPF programs and user space. They enable persistent data storage, counters, histograms, or lookup tables that eBPF code can use at runtime.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter1/maps.png" alt="Centered image" />
</p>
<p>The verifier knows the properties of each map and ensures all access is safe (e.g., correct key size, no out-of-bounds reads). This static knowledge allows for safe data sharing between eBPF and user space.</p>
<p>Don&rsquo;t worry if you don&rsquo;t fully understand all the details yet—this is completely normal! As we go through applied examples, each step of the architecture will become much clearer, and you&rsquo;ll be able to see how everything fits together in practice.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-848d75a615c6173d8d861f898a3a67ce">3 - eBPF Taking off</h1>
    <div class="lead">Core building blocks that let you load your first working tool and understand how data moves between user space and the kernel.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8610252594afa47bad49bf4c377c6985">3.1 - bpf() syscall</h1>
    <div class="lead">Single entry point the kernel exposes for loading programs, creating maps any more.</div>
	<h3 id="introduction-to-the-bpf-system-call">Introduction to the bpf() System Call<a class="td-heading-self-link" href="#introduction-to-the-bpf-system-call" aria-label="Heading self-link"></a></h3>
<p>The bpf() system call serves as a central mechanism in the Linux kernel for working with the Extended Berkeley Packet Filter (eBPF) subsystem. Originally introduced as a tool to filter packets in the kernel’s networking stack, Berkeley Packet Filters (BPF) allowed user space to define small programs that run efficiently in kernel space. Over time, this concept has evolved significantly from “classic” BPF (cBPF) to “extended” BPF (eBPF), which unlocks a far richer set of capabilities. The extended model supports versatile data structures, the ability to attach programs to a variety of kernel subsystems, and the invocation of helper functions that simplify complex operations.<br>
The bpf() system call accepts a command argument determining the exact operation to be performed, and a corresponding attribute structure that passes parameters specific to that operation. Among these operations are commands to load eBPF programs into the kernel, create and manage eBPF maps, attach programs to hooks, and query or manipulate existing eBPF objects. This wide range of functionality makes bpf() a cornerstone of eBPF-based tooling in modern Linux systems.<br>
The kernel ensures eBPF programs cannot crash or destabilize the system through rigorous static analysis at load time. As a result, the bpf() system call provides a secure yet flexible interface for extending kernel functionality.<br>
In the <strong><code>/include/uapi/linux/bpf.h</code></strong> header file, you will find a list of all the commands used in the <code>bpf()</code> syscall. These commands define the actions that can be performed on eBPF objects, such as loading programs, creating maps, attaching programs to kernel events, and more. The commands are organized as part of the <code>enum bpf_cmd</code>, which is used as an argument to specify the desired operation when invoking the <code>bpf()</code> syscall.<br>
Here’s an example of how the <code>enum bpf_cmd</code> is defined in the kernel source:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_cmd</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_UPDATE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_DELETE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_NEXT_KEY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_PIN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_GET</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_ATTACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_DETACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_TEST_RUN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_RUN</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_PROG_TEST_RUN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_OBJ_GET_INFO_BY_FD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_QUERY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_RAW_TRACEPOINT_OPEN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_LOAD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_TASK_FD_QUERY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_AND_DELETE_ELEM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_FREEZE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_BTF_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_LOOKUP_AND_DELETE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_UPDATE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_DELETE_BATCH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_UPDATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_GET_FD_BY_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_GET_NEXT_ID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_ENABLE_STATS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_ITER_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_LINK_DETACH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_PROG_BIND_MAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_TOKEN_CREATE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__MAX_BPF_CMD</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>We are not going through the full list but among these commands, one of the most important is <code>bpf_prog_load</code>. This command is used to load an eBPF program into the kernel. By invoking <code>bpf()</code> with the <code>BPF_PROG_LOAD</code> command, the kernel verifies the program’s safety, ensuring that it won’t cause any harm to the system. Upon success, the program is loaded into the kernel, and the system call returns a file descriptor associated with this eBPF program, allowing the program to be attached to various kernel events or subsystems, such as network interfaces, tracepoints, or XDP.<br>
In the kernel’s BPF subsystem, specifically in <code>kernel/bpf/syscall.c</code>, a switch statement is used to dispatch commands defined by the enum bpf_cmd to their corresponding handler functions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_CREATE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_LOOKUP_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_UPDATE_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_DELETE_ELEM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_GET_NEXT_KEY</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_MAP_FREEZE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map_freeze</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p>Now, let’s take a closer look at how <code>bpf_prog_load</code> works in practice and how  eBPF programs can be loaded into the kernel.</p>
<h3 id="bpf_prog_load">bpf_prog_load<a class="td-heading-self-link" href="#bpf_prog_load" aria-label="Heading self-link"></a></h3>
<p>As outlined in <code>man 2 bpf</code>, the <code>bpf_prog_load</code> operation is used to load an eBPF program into the Linux kernel via the <code>bpf()</code> syscall. When successful, this operation returns a new file descriptor associated with the loaded eBPF program. This file descriptor can then be used for operations such as attaching the program to specific kernel events (e.g., networking, tracing), checking its status, or even unloading it when necessary. The <code>BPF_PROG_LOAD</code> operation is invoked through the <code>bpf()</code> syscall to load the eBPF program into the kernel.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">bpf_log_buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">LOG_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_insn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#000">attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">insns</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">insn_cnt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">license</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_buf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_log_buf</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LOG_BUF_SIZE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">log_level</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">bpf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_PROG_LOAD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Key Parameters:</strong></p>
<ul>
<li><strong>prog_type</strong>: Specifies the type of eBPF program (e.g., BPF_PROG_TYPE_XDP, BPF_PROG_TYPE_KPROBE).</li>
<li><strong>insns</strong>: The array of eBPF instructions (bytecode) that the program consists of.</li>
<li><strong>insn_cnt</strong>: The number of instructions in the insns array.</li>
<li><strong>license</strong>: This attribute specifies the license under which the eBPF program is distributed. It is important for ensuring compatibility with kernel helper functions that are <code>GPL-only</code>. Some eBPF helpers are restricted to being used only in programs that have a GPL-compatible license. Examples of such licenses include &ldquo;GPL&rdquo;, &ldquo;GPL v2&rdquo;, or &ldquo;Dual BSD/GPL&rdquo;. If the program’s license is not compatible with the GPL, it may not be allowed to invoke these specific helper functions.</li>
<li><strong>log_buf</strong>: A buffer where the kernel stores the verification log if the program fails verification.</li>
<li><strong>log_size</strong>: The size of the verification log buffer.</li>
</ul>
<p>When a user-space process issues a <code>BPF_PROG_LOAD</code> command, the kernel invokes the <code>bpf_prog_load(&amp;attr, uattr, size)</code> function which is defined in <code>kernel/bpf/syscall.c</code> kernel source code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bpfptr_t</span> <span style="color:#000">uattr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span> <span style="color:#000">uattr_size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">prog_type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst_prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">btf</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attach_btf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_token</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">bpf_cap</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">license</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><h3 id="libbpf-wrapper-for-bpf_prog_load">libbpf Wrapper for bpf_prog_load<a class="td-heading-self-link" href="#libbpf-wrapper-for-bpf_prog_load" aria-label="Heading self-link"></a></h3>
<p>To simplify working with eBPF programs, libbpf provides the <code>bpf_prog_load()</code> function, which abstracts the complexity of interacting with the kernel via the <code>bpf()</code> syscall. This wrapper is located in <code>/tools/lib/bpf/bpf.c</code> and provides additional functionality like retrying failed program loads and setting detailed log options.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_prog_load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_prog_type</span> <span style="color:#000">prog_type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">license</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_insn</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">insns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">insn_cnt</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog_load_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>This function simplifies the process of loading eBPF programs by wrapping around the <code>bpf()</code> syscall, handling retries, and providing additional configuration options.<br>
<strong>bpf_prog_load_opts</strong> structure: This structure provides additional configuration options when loading an eBPF program, as seen below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_prog_load_opts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">;</span>                          <span style="color:#8f5902;font-style:italic">// Size of this structure for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">;</span>                        <span style="color:#8f5902;font-style:italic">// Retry attempts if bpf() returns -EAGAIN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_attach_type</span> <span style="color:#000">expected_attach_type</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Expected attachment type
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_btf_fd</span><span style="color:#000;font-weight:bold">;</span>                  <span style="color:#8f5902;font-style:italic">// BTF file descriptor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_flags</span><span style="color:#000;font-weight:bold">;</span>                   <span style="color:#8f5902;font-style:italic">// Program flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">prog_ifindex</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Interface index for programs like XDP
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">kern_version</span><span style="color:#000;font-weight:bold">;</span>                  <span style="color:#8f5902;font-style:italic">// Kernel version for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fd_array</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Array of file descriptors for attachments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">func_info</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">// Function info for BTF
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">func_info_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Function info count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">func_info_rec_size</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">// Function info record size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">line_info</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">// Line info for BTF
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">line_info_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Line info count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">line_info_rec_size</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#8f5902;font-style:italic">// Line info record size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_level</span><span style="color:#000;font-weight:bold">;</span>                    <span style="color:#8f5902;font-style:italic">// Log verbosity for verifier logs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_size</span><span style="color:#000;font-weight:bold">;</span>                     <span style="color:#8f5902;font-style:italic">// Log buffer size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">log_buf</span><span style="color:#000;font-weight:bold">;</span>                      <span style="color:#8f5902;font-style:italic">// Log buffer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">log_true_size</span><span style="color:#000;font-weight:bold">;</span>                <span style="color:#8f5902;font-style:italic">// Actual log size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">token_fd</span><span style="color:#000;font-weight:bold">;</span>                     <span style="color:#8f5902;font-style:italic">// Token file descriptor (optional)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__u32</span> <span style="color:#000">fd_array_cnt</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// Length of fd_array
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>                          <span style="color:#8f5902;font-style:italic">// Padding for compatibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>At the heart of eBPF lies the concept of eBPF maps. Maps are generic, dynamic, kernel-resident data structures accessible from both eBPF programs and user space applications. They allow you to share state and pass information between user space and eBPF code.
The Linux man page (<code>man 2 bpf</code>) states:</p>
<blockquote>
<p>&ldquo;eBPF maps are a generic data structure for storage of different data types. Data types are generally treated as binary blobs. A user just specifies the size of the key and the size of the value at map-creation time.&rdquo;</p>
</blockquote>
<p>Now, let’s dive into the world of eBPF maps and explore how these powerful data structures are created, accessed, and used within the kernel. By understanding how to interact with maps, you’ll unlock the ability to efficiently store and retrieve data across different eBPF programs.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aeb5952b27b44d42777e2c19cc90992b">3.2 - eBPF Maps</h1>
    <div class="lead">Kernel-resident hash tables arrays LRU caches and ring buffers that store data shared between eBPF programs and user processes making stateful tasks possible.</div>
	<h3 id="introduction-to-ebpf-maps">Introduction to eBPF Maps<a class="td-heading-self-link" href="#introduction-to-ebpf-maps" aria-label="Heading self-link"></a></h3>
<p>One of the key design elements that make eBPF so flexible and powerful is the concept of maps. An eBPF map is a data structure residing in the kernel, accessible both by eBPF programs and user space applications. Maps provide a stable way to share state, pass configuration or lookup data, store metrics, and build more complex logic around kernel events.<br>
Unlike traditional kernel data structures, eBPF maps are created, managed, and destroyed via well-defined syscalls and helper functions. They offer a form of persistent kernel memory to eBPF programs, ensuring that data can outlast a single function call or event. This allows administrators and developers to build sophisticated tools for tracing, networking, security, performance monitoring, and more—without modifying or recompiling the kernel.</p>
<p>The Linux kernel defines numerous map types (more than 30 as of this writing), each optimized for different use cases. Some store generic key-value pairs, others store arrays or are used specifically for attaching events, referencing other maps, or implementing special data structures like tries. Choosing the right map type depends on the data and the operations you need to perform.<br>
Before we start with explaining eBPF maps, we need to install either <code>gcc</code> or <code>clang</code>, along with <code>libbpf-dev</code>, to compile our examples. These tools are essential for building and linking the necessary components for eBPF programs. On Debian and Ubuntu, you can install them using the following command:
<code>sudo apt install gcc libbpf-dev</code><br>
Below, we explore ten commonly used eBPF map types, detailing their conceptual purpose, common use cases, and providing code snippets demonstrating their creation using the <code>bpf_create_map()</code> API.<br>
From the large collection defined in the kernel’s <code>/include/uapi/linux/bpf.h</code>,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_map_type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_UNSPEC</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PROG_ARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PERCPU_HASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PERCPU_ARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_STACK_TRACE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_CGROUP_ARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_LRU_HASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_LRU_PERCPU_HASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_LPM_TRIE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_ARRAY_OF_MAPS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_HASH_OF_MAPS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_DEVMAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_SOCKMAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_CPUMAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_XSKMAP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_SOCKHASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_CGROUP_STORAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_REUSEPORT_SOCKARRAY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE_DEPRECATED</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE_DEPRECATED</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_QUEUE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_STACK</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_SK_STORAGE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_DEVMAP_HASH</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_STRUCT_OPS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_INODE_STORAGE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_TASK_STORAGE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_BLOOM_FILTER</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_USER_RINGBUF</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_CGRP_STORAGE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BPF_MAP_TYPE_ARENA</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__MAX_BPF_MAP_TYPE</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>we’ll focus on these ten map types:</p>
<ol>
<li>BPF_MAP_TYPE_HASH</li>
<li>BPF_MAP_TYPE_ARRAY</li>
<li>BPF_MAP_TYPE_PERF_EVENT_ARRAY</li>
<li>BPF_MAP_TYPE_PROG_ARRAY</li>
<li>BPF_MAP_TYPE_PERCPU_HASH</li>
<li>BPF_MAP_TYPE_PERCPU_ARRAY</li>
<li>BPF_MAP_TYPE_LPM_TRIE</li>
<li>BPF_MAP_TYPE_ARRAY_OF_MAPS</li>
<li>BPF_MAP_TYPE_HASH_OF_MAPS</li>
<li>BPF_MAP_TYPE_RINGBUF</li>
</ol>
<p>These map types are either widely used or particularly illustrative of eBPF’s capabilities. Together, they represent a broad spectrum of data structures and functionalities.</p>
<h3 id="maps-in-ebpf-program">Maps in eBPF program<a class="td-heading-self-link" href="#maps-in-ebpf-program" aria-label="Heading self-link"></a></h3>
<p>In eBPF, there are two main components: the eBPF program (which runs in the kernel) and the user-space code (both components will be explained later). It is common to define maps in the eBPF program, but maps are actually created and managed in user-space using the <code>bpf()</code> syscall.<br>
The eBPF program (kernel-side) defines how the map should look and how it will be used by the program. This definition specifies the map&rsquo;s type, key size, value size, and other parameters. However, the actual creation of the map (allocating memory for it in the kernel and linking it to the eBPF program) occurs in user-space. This process involves invoking the <code>bpf()</code> syscall with the <code>BPF_MAP_CREATE</code> command.<br>
In practice, BTF (BPF Type Format) style maps are the preferred method for defining maps in eBPF programs. Using BTF provides a more flexible, type-safe way to define maps and makes it easier to manage complex data structures. We will explain BTF (BPF Type Format) later in details. When a user-space process issues a BPF_MAP_CREATE command, the kernel invokes the <code>map_create(&amp;attr)</code> function which look like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_ops</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ops</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_token</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">numa_node</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_attr_numa_node</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">map_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">attr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">map_type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">token_flag</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">f_flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p>The <code>bpf_map_create()</code> function is part of the libbpf library, which provides a user-space interface for interacting with eBPF in Linux. Internally, <code>bpf_map_create()</code> sets up the necessary parameters for creating an eBPF map and then makes a call to the <code>bpf()</code> syscall with the <code>BPF_MAP_CREATE</code> command. This function simplifies the process for the user by abstracting away the complexities of directly using the <code>bpf()</code> syscall. It configures the map, including its type, key size, value size, and the number of entries, and once these parameters are prepared, <code>bpf_map_create()</code> invokes the <code>bpf()</code> syscall with the <code>BPF_MAP_CREATE</code> command, instructing the kernel to create the eBPF map. In essence, <code>bpf_map_create()</code> serves as a user-friendly wrapper around the <code>bpf()</code> syscall&rsquo;s <code>BPF_MAP_CREATE</code> command or <code>map_create</code> function, making it easier for user-space programs to create eBPF maps.<br>
<code>bpf_map_create()</code> wrapper function is defined in the Kernel source code under <code>tools/lib/bpf/bpf.c</code>. The function prototype is as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">bpf_map_type</span> <span style="color:#000">map_type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#000">__u32</span> <span style="color:#000">key_size</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#000">__u32</span> <span style="color:#000">value_size</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#000">__u32</span> <span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_create_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><ul>
<li><strong>map_type</strong>: Specifies the type of the map (e.g., <code>BPF_MAP_TYPE_HASH</code>).</li>
<li><strong>map_name</strong>: The name of the map.</li>
<li><strong>key_size</strong>: Size of the key in the map.</li>
<li><strong>value_size</strong>: Size of the value in the map.</li>
<li><strong>max_entries</strong>: Maximum number of entries the map can hold.</li>
<li><strong>opts</strong>: A pointer to the <code>bpf_map_create_opts</code> structure, which contains additional options for map creation (such as flags, BTF information, etc.).</li>
</ul>
<p>The <code>bpf_map_create_opts</code> structure in <strong>libbpf</strong> is defined as follows in <code>/tools/lib/bpf/bpf.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_create_opts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">;</span>                     <span style="color:#8f5902;font-style:italic">/* Size of this struct for forward/backward compatibility */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">btf_fd</span><span style="color:#000;font-weight:bold">;</span>                  <span style="color:#8f5902;font-style:italic">/* BTF (BPF Type Format) file descriptor for type information */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">btf_key_type_id</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">/* BTF key type ID for the map */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">btf_value_type_id</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">/* BTF value type ID for the map */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* BTF vmlinux value type ID for maps */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">/* File descriptor for an inner map (for nested maps) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">map_flags</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* Flags for the map (e.g., read-only, etc.) */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">map_extra</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* Extra space for future expansion or additional settings */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">numa_node</span><span style="color:#000;font-weight:bold">;</span>               <span style="color:#8f5902;font-style:italic">/* NUMA node to assign the map */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">map_ifindex</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">/* Network interface index for map assignment */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__s32</span> <span style="color:#000">value_type_btf_obj_fd</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* File descriptor for the BTF object corresponding to the value type */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">token_fd</span><span style="color:#000;font-weight:bold">;</span>                <span style="color:#8f5902;font-style:italic">/* BPF token FD passed in a corresponding command&#39;s token_fd field */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>                      <span style="color:#8f5902;font-style:italic">/* Reserved for future compatibility (bitfield) */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><ul>
<li><strong>sz</strong>: Size of the structure, ensuring forward/backward compatibility.</li>
<li><strong>btf_fd</strong>, <strong>btf_key_type_id</strong>, <strong>btf_value_type_id</strong>, <strong>btf_vmlinux_value_type_id</strong>: These fields are related to the <strong>BPF Type Format</strong> (BTF), which provides type information for the map’s key and value types</li>
<li><strong>inner_map_fd</strong>: The file descriptor of an inner map if the map is being used as part of a nested structure.</li>
<li><strong>map_flags</strong>: Flags that modify the behavior of the map, such as setting the map to read-only or enabling special features (e.g., memory-mapping).</li>
<li><strong>map_extra</strong>: Reserved for future extensions to the structure or additional configuration.</li>
<li><strong>numa_node</strong>: Specifies the NUMA node for memory locality when creating the map (used for NUMA-aware systems).</li>
<li><strong>map_ifindex</strong>: Specifies the network interface index for associating the map with a specific network interface.</li>
<li><strong>value_type_btf_obj_fd</strong>: A file descriptor pointing to the BTF object representing the map’s value type.</li>
<li><strong>token_fd</strong>: A token FD for passing file descriptors across different BPF operations.</li>
</ul>
<p>These fields allow for fine-grained control over how the eBPF map behaves, including its memory allocation, access permissions, and type information. Don&rsquo;t worry about these details now, as some of them will be used shortly when we dive into more examples.</p>
<p>Now that we&rsquo;ve covered the basics of map creation, let’s start exploring some of the most commonly used eBPF map types.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    All the following snippets of code use different contexts for working with the same BPF map. &ldquo;The Map Definition in eBPF Program&rdquo; snippet is used within the eBPF kernel code to declare the map (using section annotations like <code>SEC(&quot;.maps&quot;)</code>) so that the eBPF program can use it. The &ldquo;Hash Map User-Space Example snippet&rdquo;, on the other hand, shows how user-space code (using libbpf and BPF syscalls) can interact with the map—such as creating or obtaining a file descriptor for the map.

</div>
</p>
<h3 id="1-hash-map">1. Hash Map<a class="td-heading-self-link" href="#1-hash-map" aria-label="Heading self-link"></a></h3>
<p>A hash map stores key-value pairs. Each key maps to a corresponding value, and both the key and value have fixed sizes determined at creation time. The hash map provides fast lookups and updates, making it a great choice for data that changes frequently. Common uses include tracking connection states in networking, counting events keyed by process ID or file descriptor, or caching metadata for quick lookups.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/hash-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">hash_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>Hash Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We can compile it using <code>gcc -o hash_map hash_map.c -lbpf</code> and <code>-lbpf</code> which tells the compiler to link against the <code>libbpf</code> library, or by using <code>clang -o ring_buff ring_buff.c -lbpf</code>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    You should always use <code>close()</code> when you&rsquo;re done using a BPF map file descriptor to ensure proper resource management, prevent resource leaks, and allow the system to release the map&rsquo;s resources.

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Loading most eBPF programs into the kernel requires root privileges, as they require access to restricted kernel resources and system calls. However, it&rsquo;s possible for non-root users to load eBPF programs if they have been granted specific capabilities, such as <code>CAP_BPF</code>.

</div>
</p>
<p>To run this program, you need to use the sudo command<code>sudo ./hash_map</code></p>
<h3 id="2-array-map">2. Array Map<a class="td-heading-self-link" href="#2-array-map" aria-label="Heading self-link"></a></h3>
<p>An array map stores a fixed number of elements indexed by integer keys. Unlike a hash map, array keys are not arbitrary—they are simply indexes from 0 to max_entries -1. This simplifies lookups and can provide stable, predictable memory usage. Array maps are perfect for scenarios where you know the exact number of elements you need and require constant-time indexed access. Typical uses include lookup tables, static configuration data, or indexing CPU-related counters by CPU number.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/array-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">array_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>Array Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_array_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;array_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>   <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create array map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_array_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Array map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-perf-event-array-map">3. Perf Event Array Map<a class="td-heading-self-link" href="#3-perf-event-array-map" aria-label="Heading self-link"></a></h3>
<p>The Perf Event Array map provides a mechanism to redirect perf events (such as hardware counters or software events) into user space using the perf ring buffer infrastructure. By attaching eBPF programs to perf events and using this map, you can efficiently gather performance metrics from the kernel, making it a cornerstone of low-overhead performance monitoring and observability tools.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/perf-event-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">perf_event_array_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    You can ignore <code>max_entries</code> as it will be set automatically to the number of CPUs on your computer by <code>libbpf</code> as per <a href="https://nakryiko.com/posts/bpf-ringbuf/">https://nakryiko.com/posts/bpf-ringbuf/</a>.

</div>

<p><strong>Pert Event Array Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_perf_event_array_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;perf_event_array_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>   <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>   <span style="color:#8f5902;font-style:italic">// value_size (fd)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">// max_entries (for events)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create perf event array map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_perf_event_array_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;perf event array map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-prog-array-map">4. Prog Array Map<a class="td-heading-self-link" href="#4-prog-array-map" aria-label="Heading self-link"></a></h3>
<p>A program array holds references to other eBPF programs, enabling &ldquo;tail calls&rdquo;. Tail calls allow one eBPF program to jump into another without returning, effectively chaining multiple programs into a pipeline. This map type is essential for building modular and dynamic eBPF toolchains that can be reconfigured at runtime without reloading the entire set of programs.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/prog-array-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PROG_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">prog_array_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>Prog Array Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_prog_array_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_PROG_ARRAY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;prog_array_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// value_size (prog FD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create prog array map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_prog_array_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prog array map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-percpu-hash-map">5. PERCPU Hash Map<a class="td-heading-self-link" href="#5-percpu-hash-map" aria-label="Heading self-link"></a></h3>
<p>A per-CPU hash map is similar to a standard hash map but stores distinct values for each CPU. This design minimizes lock contention and cache-line ping-ponging, allowing for extremely high-performance counting or state tracking when updates are frequent. Each CPU updates its own version of the value, and user space can aggregate these values later.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/percpu-hash-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERCPU_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">percpu_hash_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>PERCPU Hash Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_percpu_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_PERCPU_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;percpu_hash_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>    <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>   <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create PERCPU hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_percpu_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PERCPU hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="6-percpu-array-map">6. PERCPU Array Map<a class="td-heading-self-link" href="#6-percpu-array-map" aria-label="Heading self-link"></a></h3>
<p>A per-CPU array, like the per-CPU hash, stores distinct copies of array elements for each CPU. This further reduces contention, making it ideal for per-CPU statistics counters, histograms, or other metrics that need to be incremented frequently without facing synchronization overhead.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/percpu-array-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERCPU_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">percpu_array_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>PERCPU Array Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_percpu_array_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_PERCPU_ARRAY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;percpu_array_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>    <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>   <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create PERCPU array map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_percpu_array_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PERCPU array map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="7-lpm-trie-map">7. LPM Trie Map<a class="td-heading-self-link" href="#7-lpm-trie-map" aria-label="Heading self-link"></a></h3>
<p>The LPM (Longest Prefix Match) Trie map is designed for prefix-based lookups, commonly used in networking. For example, you might store IP prefixes (like CIDR blocks) and quickly determine which prefix best matches a given IP address. This is useful for routing, firewall rules, or policy decisions based on IP addresses.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    When creating an LPM Trie map, it is important to use the <code>BPF_F_NO_PREALLOC</code> flag. This flag prevents the kernel from pre-allocating memory for all entries at map creation time, allowing the map to dynamically allocate memory as needed.

</div>
</p>
<p>For example, if you create a map that is intended to hold <strong>1,000 entries</strong>, the kernel might allocate memory for all <strong>1,000 entries</strong> at map creation time. However, in the case of an <strong>LPM Trie map</strong>, the situation is different. An LPM Trie map is used for <strong>prefix-based lookups</strong>, such as storing <strong>CIDR blocks</strong> or IP address prefixes for example <code>192.168.0.0/24</code>. The number of entries and the amount of memory required for the map can vary depending on the data stored. You can still specify a <code>max_entries</code> value when creating an LPM Trie map, but it is important to note that <strong>the kernel will ignore this value</strong>. The actual number of entries in an LPM Trie map depends on how many prefixes are inserted, and the map dynamically allocates memory based on the prefixes.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/lpm-trie-map.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_LPM_TRIE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">lpm_trie_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>LPM Trie Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_lpm_trie_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_create_opts</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_F_NO_PREALLOC</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_LPM_TRIE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;lpm_trie_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// max_entries and it will ignored
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create LMP trie map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_lpm_trie_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LMP trie map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="8-array-of-maps-map">8. Array of Maps Map<a class="td-heading-self-link" href="#8-array-of-maps-map" aria-label="Heading self-link"></a></h3>
<p>An array-of-maps stores references to other maps. Each element in this array is itself a map FD. This structure allows building hierarchical or modular configurations. For example, you might keep a set of hash maps, each representing a different tenant or set of rules, and select which one to use at runtime by indexing into the array-of-maps.
In the following example, we will first create a hash map to serve as the inner map, and then use this hash map as the reference for creating an array of maps.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/array-of-maps.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">inner_map</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">hash_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY_OF_MAPS</span><span style="color:#000;font-weight:bold">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">__array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">array_of_maps_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>Array of Maps Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_inner_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_array_of_maps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_create_opts</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Specify the inner map FD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_ARRAY_OF_MAPS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;array_of_maps_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#8f5902;font-style:italic">// value_size (placeholder for map FD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create Array of maps map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 1: Create the inner hash map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_inner_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Step 2: Create the array of maps, using the inner map FD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_array_of_maps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Array of maps map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">array_of_maps_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="9-hash-of-maps-maps">9. Hash of Maps Maps<a class="td-heading-self-link" href="#9-hash-of-maps-maps" aria-label="Heading self-link"></a></h3>
<p>A hash-of-maps extends the concept of array-of-maps to dynamic keying. Instead of indexing by integer, you can use arbitrary keys to select which map is referenced. This allows flexible and dynamic grouping of maps, where user space can manage complex configurations by updating keys and associated map FDs. Again, <code>bpf_create_map()</code> cannot set <code>inner_map_fd</code>, so this example is minimal.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/hash-of-maps.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">inner_map</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">hash_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH_OF_MAPS</span><span style="color:#000;font-weight:bold">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">__array</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">hash_of_maps_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><strong>Hash of Maps Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_inner_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_of_maps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_create_opts</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Specify the inner map FD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH_OF_MAPS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_of_maps_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>  <span style="color:#8f5902;font-style:italic">// value_size (placeholder for map FD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash of maps map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 1: Create the inner hash map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_inner_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Step 2: Create the array of maps, using the inner map FD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_of_maps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Array_of_maps map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">array_of_maps_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">array_of_maps_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="10-ring-buffer-map">10. Ring Buffer Map<a class="td-heading-self-link" href="#10-ring-buffer-map" aria-label="Heading self-link"></a></h3>
<p>The ring buffer map is a relatively new addition that enables lock-free communication from kernel to user space. Instead of performing lookups or updates for each record, the kernel-side eBPF program writes events into the ring buffer, and user space reads them as a continuous stream. A ring buffer is a circular data structure that uses a continuous block of memory to store data sequentially. When data is added to the buffer and the end is reached, new data wraps around to the beginning, potentially overwriting older data if it hasn&rsquo;t been read yet. A typical ring buffer uses two pointers (or &ldquo;heads&rdquo;): one for writing and one for reading. The write pointer marks where new data is added, while the read pointer indicates where data should be consumed. This dual-pointer system allows for efficient and concurrent operations, ensuring that the writer doesn&rsquo;t overwrite data before the reader has processed it. Additionally, the ring buffer is shared across all CPUs, consolidating events from multiple cores into a single stream. This greatly reduces overhead for high-volume event reporting, making it ideal for profiling, tracing, or continuous monitoring tools.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/ring-buffer.png" alt="Centered image" />
</p>
<p><strong>BTF Map Definition in eBPF Program</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">//It must be a power of 2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">ring_buffer_map_example</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>max_entries</code> in <code>BPF_MAP_TYPE_RINGBUF</code> must be a power of 2 such as <code>4096</code>.

</div>

<p><strong>Ring Buffer Map User-Space Example</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_ringbuf_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The size of the ringbuf is given in bytes by max_entries.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ring_buffer_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">// key_size = 0 for ringbuf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">// value_size = 0 for ringbuf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_ringbuf_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Ring buffer map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="the-right-ebpf-map-type">The Right eBPF Map Type<a class="td-heading-self-link" href="#the-right-ebpf-map-type" aria-label="Heading self-link"></a></h3>
<p>By combining these map types with your eBPF programs, you can build sophisticated, runtime-configurable kernel instrumentation, security monitors, network traffic analyzers, and performance profiling tools. Each map type adds a new capability or performance characteristic, allowing developers to craft solutions that were previously challenging or impossible without kernel modifications. This flexibility not only enhances existing solutions but also opens up new possibilities for kernel-level programming. Given the ongoing evolution of eBPF, selecting the right map type for your use case becomes even more important. When doing so, it&rsquo;s essential to consider factors such as access patterns, data size, performance requirements, and the complexity of your architecture. Here are some things to keep in mind:</p>
<ul>
<li><strong>Access Pattern and Data Size</strong>:<br>
If you have a known, fixed number of entries indexed by integer keys, <code>BPF_MAP_TYPE_ARRAY</code> might be ideal. If keys are dynamic or unpredictable, <code>BPF_MAP_TYPE_HASH</code> might be the go-to.</li>
<li><strong>Performance and Concurrency</strong>:<br>
Under heavy load, where multiple CPUs frequently update shared data, per-CPU maps (<code>BPF_MAP_TYPE_PERCPU_HASH</code> or <code>BPF_MAP_TYPE_PERCPU_ARRAY</code>) can reduce contention. Similarly, <code>BPF_MAP_TYPE_RINGBUF</code> is the perfect fit for high-throughput streaming scenarios.</li>
<li><strong>Complexity and Modularity</strong>:<br>
If you need to dynamically chain programs or manage multiple maps at runtime, you could use <code>BPF_MAP_TYPE_PROG_ARRAY</code>, <code>BPF_MAP_TYPE_ARRAY_OF_MAPS</code>, or <code>BPF_MAP_TYPE_HASH_OF_MAPS</code> to facilitate more sophisticated architectures.</li>
<li><strong>Networking and Prefix Matching</strong>:<br>
For IP-based lookups, <code>BPF_MAP_TYPE_LPM_TRIE</code> offers a specialized structure optimized for network prefixes and routing logic.</li>
<li><strong>Observability and Tracing</strong>:<br>
<code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> ties into the Linux perf subsystem, enabling advanced performance monitoring and event correlation in conjunction with eBPF programs.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4997b913a052f79145016d51846d1f29">3.3 - eBPF Map Operations</h1>
    <div class="lead">Create read update delete batch pin freeze everything you need to manage maps.</div>
	<h2 id="ebpf-map-operations-overview">eBPF Map Operations Overview<a class="td-heading-self-link" href="#ebpf-map-operations-overview" aria-label="Heading self-link"></a></h2>
<p>eBPF map operations are a set of functions defined in the Linux kernel that allow interaction with eBPF maps. These operations enable reading, writing, deleting, and managing data within the maps. The operations are part of the <code>bpf_cmd</code> defined in the kernel source file <code>/include/uapi/linux/bpf.h</code>. Some commonly used operations include:</p>
<ul>
<li><strong>BPF_MAP_CREATE</strong>: Creates a new eBPF map. This operation sets up a map.</li>
<li><strong>BPF_MAP_UPDATE_ELEM</strong>: Inserts or updates a key-value pair.</li>
<li><strong>BPF_MAP_LOOKUP_ELEM</strong>: Retrieves the value associated with a given key.</li>
<li><strong>BPF_MAP_DELETE_ELEM</strong>: Deletes a key-value pair by its key.</li>
<li><strong>BPF_MAP_LOOKUP_AND_DELETE_ELEM</strong>: Retrieves a value by key and deletes the entry in one step.</li>
<li><strong>BPF_MAP_GET_NEXT_KEY</strong>: Iterates through the keys in the map.</li>
<li><strong>BPF_MAP_LOOKUP_BATCH</strong>: Retrieves multiple entries in a single call.</li>
<li><strong>BPF_MAP_UPDATE_BATCH</strong>: Updates multiple entries at once.</li>
<li><strong>BPF_MAP_DELETE_BATCH</strong>: Deletes multiple entries in one operation.</li>
<li><strong>BPF_MAP_FREEZE</strong>: Converts the map into a read-only state.</li>
<li><strong>BPF_OBJ_PIN</strong>: Pins the map to the BPF filesystem so it persists beyond the process&rsquo;s lifetime.</li>
<li><strong>BPF_OBJ_GET</strong>: Retrieves a previously pinned map.</li>
</ul>
<p>These operations allow efficient data sharing between eBPF programs and user-space applications. The <code>bpf()</code> syscall is used to perform these operations, providing a flexible interface for interacting with eBPF maps. Each operation serves a specific purpose.</p>
<p>In this chapter, we have already explained <code>BPF_MAP_CREATE</code> in detail , so we will not cover it again. Instead, we will focus on the rest. We will show how to use them with a simple hash map and explain the code thoroughly.</p>
<p>Some map operations differ between user-space and kernel-space code. In user-space, you interact with eBPF maps using file descriptors and functions that often require an output parameter, Libbpf provides convenient wrappers for these commands which are defined in tools/lib/bpf/bpf.c.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">attr_sz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">offsetofend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#000">attr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">memset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr_sz</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sys_bpf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_UPDATE_ELEM</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr_sz</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">libbpf_err_errno</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">attr_sz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">offsetofend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000">bpf_attr</span> <span style="color:#000">attr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">memset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr_sz</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ptr_to_u64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sys_bpf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_LOOKUP_ELEM</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr_sz</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">libbpf_err_errno</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p>whereas in kernel-space (within eBPF programs) perform equivalent operations using built-in helper functions which are defined in <code>kernel/bpf/helpers.c</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_CALL_2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WARN_ON_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_held</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_trace_held</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		     <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_bh_held</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ops</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_func_proto</span> <span style="color:#000">bpf_map_lookup_elem_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">func</span>		<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">gpl_only</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">pkt_access</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">ret_type</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RET_PTR_TO_MAP_VALUE_OR_NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">arg1_type</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ARG_CONST_MAP_PTR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">.</span><span style="color:#000">arg2_type</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ARG_PTR_TO_MAP_KEY</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">BPF_CALL_4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	   <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WARN_ON_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_held</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_trace_held</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		     <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rcu_read_lock_bh_held</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ops</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Additionally, some operations—like batch operations and object pinning/getting—are implemented in the kernel but are intended to be invoked from user-space via system calls or libbpf rather than being used directly inside eBPF programs. We&rsquo;ll explain each operation in both contexts.</p>
<h2 id="1-map-update-element">1. Map Update Element<a class="td-heading-self-link" href="#1-map-update-element" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code">User-Space code<a class="td-heading-self-link" href="#user-space-code" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_UPDATE_ELEM</code> command inserts or updates a key-value pair in the map.<br>
The function <code>bpf_map_update_elem</code> is a libbpf wrapper for <code>BPF_MAP_UPDATE_ELEM</code> command, it&rsquo;s part of the libbpf library, which provides a user-space interface for interacting with eBPF maps in the Linux kernel with prototype as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>It takes a map file descriptor, pointers to the key and value, and a flag indicating how the update should be performed. The flag can be</p>
<ol>
<li><code>BPF_NOEXIST</code> to insert only if the key does not exist.</li>
<li><code>BPF_EXIST</code> to update only if the key already exists.</li>
<li><code>BPF_ANY</code> to insert or update unconditionally.
On success, this call returns zero. On failure, it returns -1 and sets <code>errno</code> to indicate the cause of the error. For instance, if you use <code>BPF_NOEXIST</code> but the key already exists, it returns <code>EEXIST</code>. If you use <code>BPF_EXIST</code> but the key does not exist, it returns <code>ENOENT</code> which is <code>No such file or directory</code>.</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>BPF_NOEXIST</code> isn&rsquo;t supported for array type maps since all keys always exist.

</div>

<p>Here is an example that first tries to insert a new element using <code>BPF_NOEXIST</code> and then updates it using <code>BPF_EXIST</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert elements in the hash map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">// BPF_ANY means insert or update
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// Close the map before returning
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Update an element in the hash map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_EXIST</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// Close the map before returning
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Update an element that doesn&#39;t exist in the hash map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_EXIST</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// Close the map before returning
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>To compile and run the program, use the following command: <code>gcc -o update-ebpf-map update-ebpf-map.c -lbpf</code>.<br>
Then, execute the program with: <code>sudo ./update-ebpf-map</code>.
We first create a map and then insert <code>(5 -&gt; 100)</code> using <code>BPF_ANY</code>, which either inserts or updates unconditionally. Since the map was empty, <code>(5 -&gt; 100)</code> is inserted. Next, we update <code>(5 -&gt; 100)</code> to <code>(5 -&gt; 200)</code> using <code>BPF_EXIST</code>, ensuring that the key must exist beforehand. The operation succeeds, and the value associated with key <code>5</code> is now <code>200</code>.
Then, we try to insert <code>(4 -&gt; 300)</code> using <code>BPF_EXIST</code>, which requires the key to already exist in the map. Since the key <code>4</code> does not exist in the map, the operation fails, and the error <code>ENOENT</code> is triggered, resulting in the message &ldquo;Failed to insert or update element: No such file or directory.&rdquo;<br>
The output from running the program (<code>sudo ./update-ebpf-map</code>) is as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 5, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 5, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">200</span>
</span></span><span style="display:flex;"><span>Failed to insert or update element: No such file or directory
</span></span></code></pre></div><h3 id="kernel-space-code">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="2-map-lookup-element">2. Map Lookup Element<a class="td-heading-self-link" href="#2-map-lookup-element" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-1">User-Space code<a class="td-heading-self-link" href="#user-space-code-1" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_LOOKUP_ELEM</code> command is used to retrieve the value associated with a given key. The <code>bpf_map_lookup_elem</code> function is a libbpf wrapper for <code>BPF_MAP_LOOKUP_ELEM</code> command and its prototype is : <code>int bpf_map_lookup_elem(int fd, const void *key, void *value)</code> , so you provide the map’s file descriptor, a pointer to the key you want to look up, and a pointer to a buffer where the value will be stored if the key is found. If the operation succeeds, it returns zero, and the value is copied into the user-provided buffer. If the key does not exist, it returns -1 and sets <code>errno</code> to <code>ENOENT</code>.</p>
<p>Consider a scenario where you have inserted an entry <code>(key=10, value=100)</code> into the map. Looking it up would look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert a single entry: (10 -&gt; 100)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Attempt to look up the value for key=10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Found value %d for key %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Element doesn&#39;t exist: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Attempt to look up a value that doesn&#39;t exist 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">lookup_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">lookup_val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Found value %d for key %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Element doesn&#39;t exist: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>   
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In this example, we first create a hash map, then insert <code>(10 -&gt; 100)</code> into it. When we call <code>bpf_map_lookup_elem</code> with <code>lookup_key=10</code>, the kernel checks the map for this key. Since it exists, <code>lookup_val</code> is set to <code>100</code> and the function returns zero. If the key had not existed, <code>bpf_map_lookup_elem</code> would return <code>-1</code> and set <code>errno=ENOENT</code> and the output should look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Found value <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#204a87;font-weight:bold">for</span> key <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>Element doesn<span style="color:#a40000">&#39;</span>t exist: No such file or directory
</span></span></code></pre></div><p>This operation allows you to query the map and read the data it contains without modifying it. If the map is empty or does not contain the requested key, <code>bpf_map_lookup_elem</code> simply fails and sets an appropriate error code.</p>
<h3 id="kernel-space-code-1">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-1" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="3-map-delete-element">3. Map Delete Element<a class="td-heading-self-link" href="#3-map-delete-element" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-2">User-Space code<a class="td-heading-self-link" href="#user-space-code-2" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_DELETE_ELEM</code> command removes a key-value pair from the map.<br>
The <code>bpf_map_delete_elem</code> function is a libbpf wrapper for <code>BPF_MAP_DELETE_ELEM</code> command and its prototype is : <code>int bpf_map_delete_elem(int fd, const void *key)</code> which takes a map file descriptor and a pointer to the key you want to remove. If the key is found and deleted, it returns zero. If the key does not exist, it returns -1 and sets <code>errno=ENOENT</code>.</p>
<p>Here is an example of deleting a key:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert a key-value pair (20 -&gt; 250)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">250</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Now delete the key-value pair for key=20
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Key %d deleted successfully</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to delete element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Confirm that the key no longer exists
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpectedly found key %d after deletion, value=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ENOENT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Confirmed that key %d no longer exists</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element still exists</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>After inserting <code>(20 -&gt; 250)</code> into the map, we call <code>bpf_map_delete_elem</code> to remove it. The call succeeds, returning zero. A subsequent lookup for <code>key=20</code> fails with <code>ENOENT</code>, confirming that the entry has been removed and the output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 20, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">250</span>
</span></span><span style="display:flex;"><span>Key <span style="color:#0000cf;font-weight:bold">20</span> deleted successfully
</span></span><span style="display:flex;"><span>Confirmed that key <span style="color:#0000cf;font-weight:bold">20</span> no longer exists
</span></span></code></pre></div><p>If you call <code>bpf_map_delete_elem</code> for a key that does not exist, the operation simply returns an error and sets <code>errno=ENOENT</code>, indicating that there was nothing to delete.</p>
<h3 id="kernel-space-code-2">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-2" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="4-map-lookup-and-delete-element">4. Map Lookup and Delete Element<a class="td-heading-self-link" href="#4-map-lookup-and-delete-element" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-3">User-Space code<a class="td-heading-self-link" href="#user-space-code-3" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_LOOKUP_AND_DELETE_ELEM</code> command retrieves the value associated with the given key, just like <code>BPF_MAP_LOOKUP_ELEM</code> command, but it also removes the key-value pair from the map in a single operation The <code>bpf_map_lookup_and_delete_elem</code> function is a libbpf wrapper for <code>BPF_MAP_LOOKUP_AND_DELETE_ELEM</code> command and its prototype is: <code>int bpf_map_lookup_and_delete_elem(int fd, const void *key, void *value)</code> . If the key exists, the function returns zero, copies the value to the user-provided buffer, and deletes that entry from the map. If the key is not found, it returns -1 and sets <code>errno=ENOENT</code>. This operation is particularly useful for scenarios where you want to consume entries from a map, such as implementing a queue or stack-like structure, or simply ensuring that once you retrieve a value, it is removed without requiring a separate delete call.</p>
<p>First, consider inserting a key-value pair and then looking it up and deleting it at the same time:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert a key-value pair (10 -&gt; 100)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Now perform lookup-and-delete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_and_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Lookup and delete succeeded, value=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_val</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Verify that the key is no longer in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">verify_val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">verify_val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpectedly found key %d after deletion</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ENOENT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Confirmed that key %d no longer exists</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element still exists</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The previous example inserts <code>(10 -&gt; 100)</code> into a hash map, then the program calls <code>bpf_map_lookup_and_delete_elem</code> for <code>key=10</code>. The operation returns the value <code>100</code> and removes the entry from the map at the same time. A subsequent lookup confirms the key is gone. The output is similar to this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Lookup and delete succeeded, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Confirmed that key <span style="color:#0000cf;font-weight:bold">10</span> no longer exists
</span></span></code></pre></div><h3 id="kernel-space-code-3">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-3" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bpf_map_lookup_and_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="5-get-next-key">5. Get Next Key<a class="td-heading-self-link" href="#5-get-next-key" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-4">User-Space code<a class="td-heading-self-link" href="#user-space-code-4" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_GET_NEXT_KEY</code> command iterates through the keys in a map. If you pass a specific key, the function returns the next key in the map, or sets <code>errno=ENOENT</code> if there is no next key. If you call it with a non-existing key or a NULL pointer (in some usages), it can return the first key in the map. This allows you to iterate over all keys one by one, even if you do not know them in advance.. The <code>bpf_map_get_next_key</code> function is a libbpf wrapper for <code>BPF_MAP_GET_NEXT_KEY</code> command and its prototype is: <code>int bpf_map_get_next_key(int fd, const void *key, void *next_key)</code>.<br>
It&rsquo;s important to note that the order of keys returned by <code>bpf_map_get_next_key</code> is not guaranteed to be the same as the typical ordering found in most iterators in other programming languages. The keys in eBPF maps are stored in an internal, arbitrary order determined by the kernel. Therefore, the order in which keys are returned when iterating is not necessarily sequential (e.g., ascending or based on insertion order). If you need a specific order, such as sorted keys, you will need to handle that ordering manually in your application.</p>
<p>Here’s how you might iterate over all keys:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert multiple keys for demonstration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">values</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// We&#39;ll start by using a key that doesn&#39;t exist (e.g., start_key=-1) to get the first key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">start_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Next key: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error getting next key: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Move to the next key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">start_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">start_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Next key: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error getting next key: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Move to the next key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">start_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">start_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Next key: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error getting next key: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In this example, we insert <code>(10-&gt;100)</code>, <code>(20-&gt;200)</code>, <code>(30-&gt;300)</code> into the map. We start iteration with a key (-1) that we know does not exist. The kernel returns the first key in ascending order. We then print each key-value pair and call <code>bpf_map_get_next_key</code> to advance to the next key. When <code>ENOENT</code> is returned, we know we have reached the end of the map. This process allows scanning the map’s contents without knowing the keys upfront.</p>
<h3 id="kernel-space-code-4">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-4" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_get_next_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="6-map-lookup-batch">6. Map Lookup Batch<a class="td-heading-self-link" href="#6-map-lookup-batch" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-5">User-Space code<a class="td-heading-self-link" href="#user-space-code-5" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_LOOKUP_BATCH</code> command fetches multiple elements from the map in a single call. Instead of calling <code>BPF_MAP_LOOKUP_ELEM</code> command repeatedly for each key, you can use this operation to retrieve several keys and their associated values at once. This improves performance when dealing with large maps or when you need to read multiple entries efficiently.<br>
The <code>bpf_map_lookup_batch</code> function is a libbpf wrapper for <code>BPF_MAP_LOOKUP_BATCH</code> command and it uses two special parameters: <strong><code>in_batch</code></strong> and <strong><code>out_batch</code></strong>, which help maintain the state between successive batch lookups. You begin by passing a <code>NULL</code> <code>in_batch</code> to start from the first set of entries. The kernel then returns a batch of <code>(key, value)</code> pairs and sets <code>out_batch</code> to indicate where to resume from. On subsequent calls, you pass <code>out_batch</code> as <code>in_batch</code> to continue retrieving the next batch of entries until all entries have been retrieved. This method is particularly efficient for maps with a large number of entries, as it reduces the overhead of making individual lookups for each element, thus speeding up the retrieval process.<br>
The helper function prototype is</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_lookup_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">in_batch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">out_batch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_batch_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><ul>
<li><strong>fd</strong>: The file descriptor for the eBPF map you&rsquo;re querying.</li>
<li><strong>in_batch</strong>: The address of the first element in the batch to read. You pass <code>NULL</code> for the first call to start from the beginning of the map. On subsequent calls, you pass the address of <code>out_batch</code> to continue from the last retrieved entry.</li>
<li><strong>out_batch</strong>: This is an output parameter that the kernel sets to the position of the last element retrieved. It indicates where to resume for the next batch lookup.</li>
<li><strong>keys</strong>: A pointer to a buffer where the kernel will store the keys retrieved.</li>
<li><strong>values</strong>: A pointer to a buffer where the kernel will store the corresponding values for the retrieved keys.</li>
<li><strong>count</strong>: On input, this specifies the number of elements you want to retrieve in the batch. On output, it will contain the actual number of elements retrieved.</li>
<li><strong>opts</strong>: An optional parameter for additional configuration (can be <code>NULL</code> if not needed).</li>
</ul>
<p>Let&rsquo;s go through an example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Insert several entries for demonstration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">70</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">90</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">values</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">600</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">700</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">800</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">900</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Prepare to batch lookup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">batch_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">batch_vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u32</span> <span style="color:#000">batch_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Number of elements to retrieve in one go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">in_batch</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Start from the beginning
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">__u32</span> <span style="color:#000">out_batch</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in_batch</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">out_batch</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                       <span style="color:#000">batch_keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">batch_vals</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">batch_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">batch_count</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Batch element: key=%d, value=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">batch_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">batch_vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// Prepare for next batch: continue from last position
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">in_batch</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">out_batch</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// Set `in_batch` to the position of the last element
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ENOENT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// An error other than ENOENT means a failure occurred.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lookup batch failed: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The previous example first inserts nine key-value pairs into a hash map. Then, it calls <code>bpf_map_lookup_batch</code> repeatedly to retrieve elements in batches, until <code>ENOENT</code> indicates that all entries have been retrieved. Each successful batch call prints out a subset of the map entries. Since there are only nine entries, you will likely retrieve them in one or two batches, depending on the batch size. However, this method scales well for larger maps.<br>
The batch size is set to <code>2</code> (in <code>batch_count</code>), meaning the program will attempt to retrieve two entries in each call to <code>bpf_map_lookup_batch</code>. If the map does not contain enough entries to fill the entire batch, <code>batch_count</code> is adjusted to reflect how many entries were actually returned. When <code>bpf_map_lookup_batch</code> eventually returns <code>ENOENT</code>, it indicates that all elements have been retrieved. The output could be like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 20, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">200</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 30, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">300</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 40, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">400</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 50, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">500</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 60, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 70, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">700</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 80, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">800</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 90, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">900</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>30, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">300</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>20, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">400</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>80, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">800</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>70, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">900</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>60, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>40, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">700</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>50, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">500</span>
</span></span><span style="display:flex;"><span>Batch element: <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>90, <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">600</span>
</span></span></code></pre></div><h3 id="kernel-space-code-5">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-5" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<h2 id="7-map-update-batch">7. Map Update Batch<a class="td-heading-self-link" href="#7-map-update-batch" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-6">User-Space code<a class="td-heading-self-link" href="#user-space-code-6" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_UPDATE_BATCH</code> command  allows you to insert or update multiple keys and values in a single call. Similar to <code>BPF_MAP_LOOKUP_BATCH</code> command, this can significantly reduce overhead compared to performing multiple <code>BPF_MAP_LOOKUP_ELEM</code> calls in a loop. The <code>bpf_map_update_batch</code> function is a libbpf wrapper for <code>BPF_MAP_UPDATE_BATCH</code> command and its prototype is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_update_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			 <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_batch_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>You provide arrays of keys and values, along with a count, and <code>bpf_map_update_batch</code> attempts to insert or update all of them at once. Just like <code>bpf_map_update_elem</code>, you can specify flags such as <code>BPF_ANY</code>, <code>BPF_NOEXIST</code>, or <code>BPF_EXIST</code> to control insertion and update behavior as we mentioned earlier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Prepare arrays of keys and values
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">600</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u32</span> <span style="color:#000">bulk_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Update multiple entries in one go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bulk_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Batch update succeeded</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Batch update failed: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Verify that the entries are now in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Key=%d, Value=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Key=%d not found after batch update: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This example inserts <code>(40-&gt;400)</code>, <code>(50-&gt;500)</code>, and <code>(60-&gt;600)</code> into the map in a single <code>bpf_map_update_batch</code> call. Afterward, we verify that all three keys were successfully inserted. If any error occurs (e.g., map is full), some keys might be updated before the error is returned. You can inspect <code>errno</code> and <code>bulk_count</code> for partial success handling.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Batch update succeeded
</span></span><span style="display:flex;"><span><span style="color:#000">Key</span><span style="color:#ce5c00;font-weight:bold">=</span>40, <span style="color:#000">Value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">400</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Key</span><span style="color:#ce5c00;font-weight:bold">=</span>50, <span style="color:#000">Value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Key</span><span style="color:#ce5c00;font-weight:bold">=</span>60, <span style="color:#000">Value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">50</span>
</span></span></code></pre></div><p>This bulk approach is especially beneficial when populating maps with a large set of keys during initialization or when updating multiple entries at once.</p>
<h3 id="kernel-space-code-6">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-6" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<h2 id="8-map-delete-batch">8. Map Delete Batch<a class="td-heading-self-link" href="#8-map-delete-batch" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-7">User-Space code<a class="td-heading-self-link" href="#user-space-code-7" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_DELETE_BATCH</code> command removes multiple entries from the map in a single call, much like <code>BPF_MAP_DELETE_ELEM</code> does for individual keys. You supply arrays of keys along with a count, and the kernel attempts to delete all those keys at once. This operation is more efficient than deleting entries one by one, especially for large sets of keys. The <code>bpf_map_delete_batch</code> function is a libbpf wrapper for <code>BPF_MAP_DELETE_BATCH</code> command and its prototype is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_delete_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			 <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map_batch_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>The <strong>fd</strong> parameter is the file descriptor for the map, and <strong>keys</strong> is a pointer to an array of keys to delete. The <strong>count</strong> parameter specifies the number of keys to delete and is updated with the actual number of deletions. The <strong>opts</strong> parameter is optional and allows additional configuration (usually passed as <code>NULL</code>). The function returns <code>0</code> if successful, or a negative error code if an error occurs, with <strong>errno</strong> providing more details.</p>
<p>For example, if your map currently contains <code>(10-&gt;100)</code>, <code>(20-&gt;200)</code>, and <code>(30-&gt;300)</code>, and you want to remove <code>(10, 20, 30)</code> all at once:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Prepare arrays of keys and values
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">600</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u32</span> <span style="color:#000">bulk_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Update multiple entries in one go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bulk_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Batch update succeeded</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Batch update failed: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Now batch-delete them
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">__u32</span> <span style="color:#000">delete_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_delete_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">delete_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Batch delete succeeded</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Batch delete failed: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Confirm deletion
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpectedly found key %d after batch deletion</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ENOENT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Confirmed key %d is removed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lookup error: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>If successful, all three keys are removed. If an error occurs (for example, if one key does not exist), <code>delete_count</code> may be set to the number of successfully deleted keys before the error. In that case, you can handle partial success accordingly.
This approach is ideal when you need to clear out a subset of keys without performing multiple individual deletions.</p>
<h3 id="kernel-space-code-7">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-7" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<h2 id="9-map-freeze">9. Map Freeze<a class="td-heading-self-link" href="#9-map-freeze" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-8">User-Space code<a class="td-heading-self-link" href="#user-space-code-8" aria-label="Heading self-link"></a></h3>
<p><code>BPF_MAP_FREEZE</code> command converts the specified map into a read-only state. After freezing a map, no further updates or deletions can be performed using <code>bpf()</code> syscalls, although eBPF programs themselves can still read and, in some cases, modify certain fields if allowed by the map type. Freezing is useful when you have finished constructing or populating a map and want to ensure its contents remain stable.<br>
The <code>bpf_map_freeze</code> function is a libbpf wrapper for <code>BPF_MAP_FREEZE</code> command and its prototype is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_map_freeze</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>To freeze a map:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Insert an entry (10-&gt;100)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Element inserted or updated successfully: key = %d, value = %ld</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to insert or update element: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Freeze the map to prevent further updates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_freeze</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Map is now frozen and read-only</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bpf_map_freeze&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Attempting to update after freezing should fail
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">new_val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">new_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">EPERM</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Update failed, map is frozen</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	            <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bpf_map_update_elem&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unexpected success, map should have been frozen</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>After this call, attempts to update or delete elements through <code>bpf_map_update_elem</code> or <code>bpf_map_delete_elem</code> will fail with <code>EPERM</code>. This ensures that user-space cannot inadvertently modify the map’s contents, making it a suitable mechanism for finalizing configuration or ensuring data integrity.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hash map created successfully with fd: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Element inserted or updated successfully: <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 10, <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>Map is now frozen and read-only
</span></span><span style="display:flex;"><span>Update failed, map is frozen
</span></span></code></pre></div><h3 id="kernel-space-code-8">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-8" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<h2 id="10-object-pin">10. Object Pin<a class="td-heading-self-link" href="#10-object-pin" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-9">User-Space code<a class="td-heading-self-link" href="#user-space-code-9" aria-label="Heading self-link"></a></h3>
<p><code>BPF_OBJ_PIN</code> command allows you to pin a map (or other eBPF objects like programs) to a location in the eBPF filesystem (<code>/sys/fs/bpf</code> by default). Pinning makes the map accessible to other processes after the original process that created it terminates, thereby extending the map’s lifetime beyond that of a single application.<br>
The <code>bpf_obj_pin_opts</code> function is a libbpf wrapper for <code>BPF_OBJ_PIN</code> command and its prototype is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_obj_pin_opts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_obj_pin_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The pathname argument must not contain a dot (“.”).

</div>

For instance, to pin a map under <code>/sys/fs/bpf/my_map</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hash_map_example&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>      <span style="color:#8f5902;font-style:italic">// key_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>     <span style="color:#8f5902;font-style:italic">// value_size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic">// max_entries
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                            <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>            <span style="color:#8f5902;font-style:italic">// map_flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create hash map: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">create_hash_map</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hash map created successfully with fd: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Prepare arrays of keys and values
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">600</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">__u32</span> <span style="color:#000">bulk_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Update multiple entries in one go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_update_batch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bulk_values</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bulk_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Batch update succeeded</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Batch update failed: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#8f5902;font-style:italic">// Pin the map to the BPF filesystem
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pin_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/sys/fs/bpf/my_map&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_obj_pin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pin_path</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Map pinned at %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pin_path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bpf_obj_pin&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Here, we create a map, insert <code>(20-&gt;200)</code>, and pin it to <code>/sys/fs/bpf/my_map</code>. After pinning, we can safely close the file descriptor without losing the map. The map remains accessible at the pin path, allowing other processes to open it later.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Closing <code>fd</code> in the current process does not destroy the map. It persists at <code>/sys/fs/bpf/my_map</code> until unlinked or until the system reboots.

</div>
</p>
<h3 id="kernel-space-code-9">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-9" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<h2 id="11-object-get">11. Object Get<a class="td-heading-self-link" href="#11-object-get" aria-label="Heading self-link"></a></h2>
<h3 id="user-space-code-10">User-Space code<a class="td-heading-self-link" href="#user-space-code-10" aria-label="Heading self-link"></a></h3>
<p><code>BPF_OBJ_GET</code> command retrieves a file descriptor for a previously pinned map, allowing a separate process to access and interact with that map.  This facilitates sharing eBPF maps between multiple processes or restoring access to the map after the original creating process has exited.<br>
The <code>bpf_obj_get</code> function is a libbpf wrapper for <code>BPF_OBJ_GET</code> command and its prototype is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_obj_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>By calling <code>bpf_obj_get(path)</code>, you open a reference to the pinned map from the filesystem path. Let&rsquo;s get the previous map <code>/sys/fs/bpf/my_map</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pin_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/sys/fs/bpf/my_map&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Open the pinned map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pinned_map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_obj_get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pin_path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pinned_map_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bpf_obj_get&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Opened pinned map from %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pin_path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Verify the map&#39;s content
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pinned_map_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Retrieved value %d for key %d from pinned map</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bpf_map_lookup_elem&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pinned_map_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This program assumes that a map was previously pinned at <code>/sys/fs/bpf/my_map</code>. Calling <code>bpf_obj_get</code> opens a file descriptor to that map. We then retrieve <code>(50-&gt;500)</code> that was inserted in the previous example, confirming that the pinned map persists across processes.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Opened pinned map from /sys/fs/bpf/my_map
</span></span><span style="display:flex;"><span>Retrieved value <span style="color:#0000cf;font-weight:bold">500</span> <span style="color:#204a87;font-weight:bold">for</span> key <span style="color:#0000cf;font-weight:bold">50</span> from pinned map
</span></span></code></pre></div><p>If successful, <code>pinned_map_fd</code> can be used just like any other map file descriptor. This is essential for long-running services or tools that need persistent state maintained across restarts, or for sharing data structures between different components of a system.</p>
<h3 id="kernel-space-code-10">Kernel-Space code<a class="td-heading-self-link" href="#kernel-space-code-10" aria-label="Heading self-link"></a></h3>
<p>There is no helper function for such operation.</p>
<p>I know it can be challenging to wrap your head around the differences between eBPF user-space code and kernel-space eBPF programs. Bear with me—soon we&rsquo;ll see eBPF programs in action, including maps and map operations, and everything will start to click!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3fb14d04fec3290f3c542c92855c4f2b">3.4 - eBPF Program Types</h1>
    <div class="lead">Menu of hook kinds such as XDP kprobe tracepoint LSM and many more.</div>
	<p>Understanding eBPF’s capabilities is a thorough grasp of eBPF program types. Each eBPF program type represents a different interface or hook point in the kernel’s workflow. By selecting a particular program type when loading an eBPF program, the user defines the program’s environment: which kernel functions or events it can attach to, what kinds of data structures it can access, and which kernel helper functions can be called. Understanding these program types is crucial, because eBPF is not a one-size-fits-all technology. Instead, it offers a toolkit of specialized hooks, each tailored to a specific domain within the kernel.<br>
In the Linux kernel source code, eBPF program types are listed in the UAPI header file <code>include/uapi/linux/bpf.h</code>. This header file provides an enumeration called <code>enum bpf_prog_type</code> that declares all the recognized program types.</p>
<pre tabindex="0"><code>enum bpf_prog_type {
	BPF_PROG_TYPE_UNSPEC,
	BPF_PROG_TYPE_SOCKET_FILTER,
	BPF_PROG_TYPE_KPROBE,
	BPF_PROG_TYPE_SCHED_CLS,
	BPF_PROG_TYPE_SCHED_ACT,
	BPF_PROG_TYPE_TRACEPOINT,
	BPF_PROG_TYPE_XDP,
	BPF_PROG_TYPE_PERF_EVENT,
	BPF_PROG_TYPE_CGROUP_SKB,
	BPF_PROG_TYPE_CGROUP_SOCK,
	BPF_PROG_TYPE_LWT_IN,
	BPF_PROG_TYPE_LWT_OUT,
	BPF_PROG_TYPE_LWT_XMIT,
	BPF_PROG_TYPE_SOCK_OPS,
	BPF_PROG_TYPE_SK_SKB,
	BPF_PROG_TYPE_CGROUP_DEVICE,
	BPF_PROG_TYPE_SK_MSG,
	BPF_PROG_TYPE_RAW_TRACEPOINT,
	BPF_PROG_TYPE_CGROUP_SOCK_ADDR,
	BPF_PROG_TYPE_LWT_SEG6LOCAL,
	BPF_PROG_TYPE_LIRC_MODE2,
	BPF_PROG_TYPE_SK_REUSEPORT,
	BPF_PROG_TYPE_FLOW_DISSECTOR,
	BPF_PROG_TYPE_CGROUP_SYSCTL,
	BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE,
	BPF_PROG_TYPE_CGROUP_SOCKOPT,
	BPF_PROG_TYPE_TRACING,
	BPF_PROG_TYPE_STRUCT_OPS,
	BPF_PROG_TYPE_EXT,
	BPF_PROG_TYPE_LSM,
	BPF_PROG_TYPE_SK_LOOKUP,
	BPF_PROG_TYPE_SYSCALL, /* a program that can execute syscalls */
	BPF_PROG_TYPE_NETFILTER,
	__MAX_BPF_PROG_TYPE
};
</code></pre><p>When the user invokes the <code>bpf()</code> system call with the <code>BPF_PROG_LOAD</code> command, they specify one of these types. The kernel’s eBPF subsystem, including the verifier and the JIT compiler, then interprets the program according to the type requested. This choice determines what the program can do and which kernel functions it can safely interact with.<br>
For example, when an operator writes an eBPF program that inspects network packets at a very early stage, they will choose the XDP (eXpress Data Path) program type. When performing dynamic tracing of kernel functions, they might use a kprobe or tracepoint program type. For building network firewalls or address-based restrictions at the cgroup level, they might opt for cgroup-related program types. Thus, each program type stands at the intersection of kernel events, context definitions, and allowed helper functions. This allows eBPF to cover a wide range of kernel instrumentation and customization scenarios while maintaining a strong safety and verification model.<br>
It is also important to understand that each eBPF program type has a well-defined context structure and is closely tied to specific kernel functions or subsystems. For example, a socket filter program interacts with the socket layer, and the kernel provides a context structure (such as <code>struct __sk_buff</code>) that the eBPF program can read and manipulate. Similarly, a kprobe program type interacts with kernel functions specified by the user, and the kernel exposes function arguments through a context representing CPU registers. While kernel code is typically written in C, with some assembly and domain-specific macros, the eBPF environment operates as a restricted virtual machine inside the kernel, ensuring safety through static verification.<br>
These eBPF programs can be attached to different types of events in the kernel, which defines where and when the program is executed. While many program types have a default attachment point deduced from the program type itself, some can attach to multiple locations in the kernel. In these cases, the attachment type must be explicitly specified to ensure the program is hooked to the correct event, such as a specific tracepoint. This distinction between program types and attachment types allows for greater flexibility and precision in how eBPF programs interact with kernel functions and events.<br>
The following table, sourced from the kernel manual for libbpf, outlines the various eBPF program types and ELF section names. For more details, you can refer to the official documentation at <a href="https://docs.kernel.org/bpf/libbpf/program_types.html">https://docs.kernel.org/bpf/libbpf/program_types.html</a>.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter2/prog-types-table.png" alt="Centered image" />
</p>
<p><strong>Sleepable eBPF programs</strong> are programs that are allowed to sleep during execution, marked by the <strong><code>BPF_F_SLEEPABLE</code></strong> flag. These programs are typically limited to specific types, such as security or tracing programs, while most other eBPF programs cannot sleep due to performance and safety reasons.<br>
Before diving into specific program types, it is worth noting what a “kernel function” means in this context. The Linux kernel exports a wide range of functions, some internal and some available as hooks or tracepoints. Traditional kernel development would require a developer to write a loadable kernel module (LKM) and link it against these kernel functions, potentially breaking stability. With eBPF, however, the developer attaches to these kernel functions or kernel events indirectly, through stable, well-defined interfaces like kprobes, tracepoints, or security hooks. The “kernel function” from the perspective of an eBPF developer is usually a point in the kernel’s execution flow where they can gain insight or exert minimal influence. eBPF provides indirect access through safe, monitored gateways rather than direct manipulation of kernel symbols, ensuring that even when instrumentation is performed at runtime, kernel stability and security remain intact. We have the full list of eBPF program types here. Now, let&rsquo;s dive into the ones used most often.</p>
<h3 id="bpf_prog_type_socket_filter">BPF_PROG_TYPE_SOCKET_FILTER<a class="td-heading-self-link" href="#bpf_prog_type_socket_filter" aria-label="Heading self-link"></a></h3>
<p>One of the earliest and most foundational uses of eBPF is the socket filter program type. Historically, classic BPF (cBPF) was introduced for socket filtering, allowing a user program to attach a small filtering program to a raw socket. With eBPF, the socket filter functionality is extended to a more versatile and powerful environment.<br>
A SOCKET_FILTER type program executes whenever a packet arrives at the socket it is attached to. Its context is a <code>struct __sk_buff</code>, a data structure defined in the kernel’s networking subsystem. This structure represents the packet’s metadata: its length, protocol, and pointers to the packet’s head and tail within the kernel’s networking stack. When the socket filter program runs, it can inspect packet headers, check IP addresses, transport layer ports, or even packet payload data.<br>
In the kernel source code, the logic that associates a BPF program with a socket can be found in networking-related files, such as <code>net/core/filter.c</code>. The kernel functions involved in socket receive paths ultimately invoke the attached eBPF program. While the developer never directly calls these kernel functions from user space, understanding that the <code>bpf()</code> syscall with <code>BPF_PROG_LOAD</code> installs a filter that the kernel will call on packet reception helps conceptualize how kernel and eBPF code interact.</p>
<h3 id="bpf_prog_type_kprobe">BPF_PROG_TYPE_KPROBE<a class="td-heading-self-link" href="#bpf_prog_type_kprobe" aria-label="Heading self-link"></a></h3>
<p>Kprobes are a kernel mechanism that allows the insertion of breakpoints into running kernel code for debugging and tracing. A KPROBE type eBPF program leverages this mechanism to execute whenever a specified kernel function is called. The corresponding kernel functions providing this capability are found in <code>kernel/kprobes.c</code> and related source files. Although these are low-level kernel features, from a user’s perspective, attaching a kprobe-based eBPF program is a matter of specifying the function name and loading the program with the correct type and section name (such as <code>SEC(&quot;kprobe/…&quot;)</code>).<br>
When the kernel hits the probed function, it automatically invokes the attached eBPF program. Inside the eBPF program, the context may provide access to the registers and arguments of that kernel function call. Unlike a static interface, a kprobe can be attached to almost any kernel function symbol, enabling dynamic and powerful instrumentation. This is especially useful for performance analysis, debugging kernel behavior, or collecting usage statistics for particular kernel subsystems.<br>
For instance, consider a scenario where the user wants to monitor file opens in the kernel by probing the <code>do_sys_open</code> function. By attaching a kprobe eBPF program to this function, it becomes possible to log every file open event, record the filename argument, and store it in eBPF map keyed by process ID. In user space, an operator can retrieve this data to understand which processes are touching which files over time. Previously, achieving this level of detail would require recompiling the kernel with special instrumentation or using heavyweight tools. With eBPF kprobes, it is dynamic, safe, and efficient.</p>
<h3 id="bpf_prog_type_tracepoint">BPF_PROG_TYPE_TRACEPOINT<a class="td-heading-self-link" href="#bpf_prog_type_tracepoint" aria-label="Heading self-link"></a></h3>
<p>While kprobes attach to arbitrary kernel functions, tracepoints represent a set of pre-defined static instrumentation points placed throughout the kernel. Tracepoints are designed by kernel developers and maintainers to provide stable, versioned interfaces for tracing particular events. They might mark the start or end of a scheduling operation, the completion of I/O operations, or the invocation of certain subsystems.<br>
A TRACEPOINT type eBPF program, when loaded and attached to a specific tracepoint event, is guaranteed a stable and well-defined context structure. For example, a tracepoint may provide the PID of the task involved in a scheduling event or the device number in a block I/O event. This stability makes tracepoints well-suited for long-term monitoring and performance analysis tools, because they are less prone to changes as the kernel evolves than raw function symbols.<br>
A compelling application might be monitoring scheduling events to understand how often a particular process is context-switched. By attaching an eBPF tracepoint program to the <code>sched_process_exec</code> tracepoint, the user can record every time a new process executes, linking PIDs to command lines, and gathering metrics about system activity. This data can be streamed to user space and visualized or stored for later analysis. Because tracepoints are standardized, the same eBPF program code is likely to work across multiple kernel releases, enhancing maintainability and portability.</p>
<h3 id="bpf_prog_type_xdp">BPF_PROG_TYPE_XDP<a class="td-heading-self-link" href="#bpf_prog_type_xdp" aria-label="Heading self-link"></a></h3>
<p>XDP, short for eXpress Data Path, is a revolutionary approach to packet processing. XDP programs run extremely early in the packet’s journey, often at the device driver level, before the kernel’s networking stack processes the packet. This positioning allows XDP programs to achieve exceptionally high performance, making them an attractive option for load balancing, denial-of-service protection, and advanced packet filtering.<br>
In the kernel source code, XDP integration can be found in network driver code and in <code>net/core/dev.c</code>, where the kernel’s receive path logic is implemented. The kernel functions that handle packet arrival invoke the XDP hook, giving the XDP eBPF program direct access to the packet’s raw buffer and metadata. The eBPF code can then decide to drop, pass, redirect, or modify the packet in place, all with minimal overhead.<br>
Consider a data center environment with a load balancer at the edge. By deploying an XDP eBPF program, the operator can inspect incoming packets and choose which backend server to forward them to, based on dynamic policies stored in maps. If a sudden attack occurs, the same XDP program can recognize malicious patterns and drop unwanted traffic immediately, preventing the kernel’s main networking stack from wasting CPU cycles. This ability to implement custom high-performance networking logic on the fly is one of the reasons XDP is considered a game-changer in Linux networking.</p>
<h3 id="bpf_prog_type_perf_event">BPF_PROG_TYPE_PERF_EVENT<a class="td-heading-self-link" href="#bpf_prog_type_perf_event" aria-label="Heading self-link"></a></h3>
<p>Linux’s perf subsystem provides powerful performance monitoring capabilities, including counting hardware events (cache misses, branch mispredictions), software events (task migrations, page faults), and custom tracepoints. By attaching an eBPF PERF_EVENT type program, developers can collect and process performance data in real time. The kernel code handling these events lives largely within the <code>kernel/events/</code> directory, where the perf subsystem is implemented.<br>
A PERF_EVENT type eBPF program can run periodically based on sampling events or be triggered by certain performance conditions. Once triggered, it can record the current instruction pointer, stack trace, or other metrics into eBPF map. User space can then use tools like <code>bpftool</code> or <code>perf</code> itself to retrieve this data and generate flame graphs, histograms, or other visualizations. The benefit of using eBPF here is the flexibility to implement custom logic within the kernel’s perf event callbacks, something that would be impossible or cumbersome without eBPF.<br>
For example, a developer might sample the CPU at a fixed rate to capture instruction pointers and thereby build a statistical profile of the hottest code paths in a production system. With a PERF_EVENT eBPF program, this sampling can be done efficiently and continuously, helping identify performance bottlenecks and guiding optimization efforts without stopping the system or deploying debugging kernels.</p>
<h3 id="bpf_prog_type_raw_tracepoint">BPF_PROG_TYPE_RAW_TRACEPOINT<a class="td-heading-self-link" href="#bpf_prog_type_raw_tracepoint" aria-label="Heading self-link"></a></h3>
<p>Raw tracepoints are similar to standard tracepoints, but they give the eBPF program direct access to the raw event data before the kernel applies stable formatting or abstractions. In other words, a RAW_TRACEPOINT program deals with the tracepoint’s underlying arguments and data structures without the stable, versioned interface offered by regular tracepoints. Kernel code related to raw tracepoints can also be found in tracing subsystems, but these are often less documented or guaranteed.<br>
While this makes RAW_TRACEPOINT programs more fragile, it also grants advanced users more flexibility. If a developer needs to instrument a kernel feature that does not have a stable tracepoint or must interpret tracepoint data in a custom way, a raw tracepoint provides that opportunity. As the kernel evolves, a raw tracepoint may require updates in the eBPF program to remain compatible, but for advanced instrumentation tasks, the raw access can be invaluable.<br>
A possible use case is for low-level file system or memory management events that have not been given stable tracepoint formats. By attaching a RAW_TRACEPOINT eBPF program to a kernel event, the user can parse the raw data structures themselves, extracting fields that normal tracepoints would not expose.</p>
<h3 id="bpf_prog_type_cgroup_sock_addr">BPF_PROG_TYPE_CGROUP_SOCK_ADDR<a class="td-heading-self-link" href="#bpf_prog_type_cgroup_sock_addr" aria-label="Heading self-link"></a></h3>
<p>Cgroup socket address programs integrate eBPF with Linux control groups (cgroups), providing the ability to enforce network policies at a container or service level. When a process inside a particular cgroup attempts to bind or connect a socket, the attached eBPF program runs. This allows administrators to define policies that restrict which IP addresses or ports a cgrouped process may use.<br>
The kernel code that integrates eBPF with cgroups lives in <code>kernel/cgroup</code> and <code>net/core/sock.c</code>, among other places. By setting <code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code>, the user signals that the program will be invoked at the socket layer whenever an address operation occurs. In the program, the context provides access to the requested IP and port. The eBPF code can then check these values against a map of allowed destinations and return a decision—permit or deny. This approach is more dynamic and fine-grained than static firewall rules, and it fits seamlessly into containerized environments where cgroups define the boundaries of service-level isolation.<br>
For instance, if an operator wants to ensure that a container running a certain microservice can only connect to a backend database cluster and nowhere else, a cgroup sock address eBPF program can implement this logic. By updating the map of allowed addresses in real time, the operator can adapt policies as the network environment changes, without having to restart the containers or adjust complicated firewall configurations. This helps build more secure, isolated, and manageable service ecosystems.</p>
<h3 id="bpf_prog_type_flow_dissector">BPF_PROG_TYPE_FLOW_DISSECTOR<a class="td-heading-self-link" href="#bpf_prog_type_flow_dissector" aria-label="Heading self-link"></a></h3>
<p>The kernel uses a flow dissector to classify packets into flows for features like packet steering, hashing, and load balancing. By default, this classification might rely on a standard tuple of IP addresses and ports. However, in complex environments, administrators may need custom logic to handle encapsulation protocols, new transport protocols, or proprietary headers.<br>
A FLOW_DISSECTOR type eBPF program allows customization of the kernel’s flow classification logic. Inside the kernel source, flow dissector code can be found in files like <code>net/core/flow_dissector.c</code>. By loading a FLOW_DISSECTOR eBPF program, the user can instruct the kernel how to parse packet headers and extract keys differently than the default code. This can be crucial in environments that rely heavily on tunneling or need specialized hashing strategies.<br>
Imagine a data center that uses a custom tunnel header format for internal traffic. Without eBPF, the kernel’s flow classification might fail to distinguish different flows correctly, leading to poor load balancing and performance. With a FLOW_DISSECTOR eBPF program, the operator can parse these custom headers and properly hash flows across multiple CPUs or network paths.</p>
<h3 id="bpf_prog_type_raw_tracepoint_writable">BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE<a class="td-heading-self-link" href="#bpf_prog_type_raw_tracepoint_writable" aria-label="Heading self-link"></a></h3>
<p>While most eBPF program types are focused on reading data and making decisions, RAW_TRACEPOINT_WRITABLE introduces a scenario where the program can potentially modify certain event data. This is advanced feature, allowing the developer to experiment with kernel events and, in some cases, adjust parameters or fields as they are passed to kernel subsystems. The relevant code is tightly integrated with the tracing subsystem, and due to the risk and complexity involved, the kernel imposes strict verification rules to ensure this does not compromise stability.<br>
A RAW_TRACEPOINT_WRITABLE eBPF program might be used in highly specialized debugging scenarios, where a developer needs to simulate unusual conditions or override fields to test kernel behavior. Because this feature is neither common nor intended for typical production use, it is rarely encountered by average eBPF practitioners.</p>
<h3 id="bpf_prog_type_lsm">BPF_PROG_TYPE_LSM<a class="td-heading-self-link" href="#bpf_prog_type_lsm" aria-label="Heading self-link"></a></h3>
<p>Linux Security Modules (LSMs) are a mechanism by which security frameworks like SELinux or AppArmor integrate with the kernel to enforce access control policies. With eBPF’s introduction, it became possible to write LSM policies dynamically. By choosing <code>BPF_PROG_TYPE_LSM</code>, the developer can attach eBPF programs to LSM hooks, allowing them to implement custom security policies without patching or rebuilding the kernel.<br>
The kernel’s security subsystem defines a variety of hooks for filesystem operations, network accesses, and system call checks. Attaching an LSM eBPF program means that whenever a protected operation occurs—such as opening a file, creating a socket, or executing a binary—the eBPF code runs to decide whether to permit or deny the action. This approach blends eBPF’s runtime adaptability with the kernel’s security framework.<br>
A straightforward example might be a scenario where a particular container should never read from a certain sensitive file or directory. By attaching an LSM eBPF program to the relevant file-open hook, the system can block any open attempts that violate this policy. If conditions change (say the file’s allowed access pattern must be updated), the administrator can simply update the eBPF map or reload the LSM program. This transforms what was once a static policy configuration into a dynamic, code-driven security model.</p>
<h3 id="bpf_prog_type_netfilter">BPF_PROG_TYPE_NETFILTER<a class="td-heading-self-link" href="#bpf_prog_type_netfilter" aria-label="Heading self-link"></a></h3>
<p>Netfilter is the framework underlying most Linux firewall and NAT functionalities. Historically configured via iptables or nftables, Netfilter provides hooks at various stages of packet traversal within the kernel’s networking stack. By writing a NETFILTER type eBPF program, the developer can plug into these hooks and implement dynamic, programmable firewall rules and packet handling logic.<br>
In kernel source code, netfilter hooks are spread across the <code>net/ipv4</code>, <code>net/ipv6</code>, and <code>net/netfilter</code> directories. Attaching an eBPF program at these hooks allows rewriting packets, filtering them according to complex criteria, or even performing custom NAT logic. Unlike static Netfilter rules, which rely on limited matching conditions and actions, an eBPF NETFILTER program can execute arbitrary logic, consult eBPF maps for dynamically updated policies, and integrate seamlessly with other eBPF components like XDP or cgroup hooks.<br>
For instance, a complex multi-tenant environment might require distinct firewall policies per tenant that evolve as services change. By storing these policies in maps and using a NETFILTER eBPF program, the operator can update them at runtime, achieving a level of flexibility and programmability that static rules cannot offer. As the kernel continues to integrate eBPF more deeply into its subsystems, NETFILTER type programs are poised to become a powerful complement or even replacement for traditional firewall configurations.<br>
We don&rsquo;t need to explain the Attach Types because they are abstracted away when using libbpf. It automatically sets the proper attachment based on the program type and ELF section name.<br>
Don&rsquo;t worry if you don&rsquo;t fully understand everything just yet or can&rsquo;t see the big picture—by working through the examples in the next chapter, the concepts will become much clearer. We will explore practical examples of eBPF programs and their interaction with various kernel events, demonstrating how to apply the concepts we&rsquo;ve covered and providing hands-on experience with attaching eBPF programs to real-world events.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10afc9594f87bad3f07dc64799a1d2a7">4 - eBPF Probes</h1>
    <div class="lead">Deep dive into tracing hooks so you can watch almost any function run inside the kernel or in user processes.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-62f8d377f141b062b29f286dd524dde1">4.1 - Kprobe and Kretprobe</h1>
    <div class="lead">Instrument kernel functions at entry and exit for live tracing.</div>
	<h3 id="writing-ebpf-code">Writing eBPF Code<a class="td-heading-self-link" href="#writing-ebpf-code" aria-label="Heading self-link"></a></h3>
<p>When writing eBPF code, you typically need to write two separate parts: one for <strong>kernel-space</strong> and the other for <strong>user-space</strong>.<br>
<strong>Kernel Space Code:</strong><br>
The kernel-space code is responsible for performing specific tasks, such as tracing, monitoring network packets, filtering system calls, or attaching to kprobes, tracepoints, etc. This code interacts directly with the kernel and can access kernel data structures or events. The kernel space is highly sensitive, so the code running there must be safe and efficient.
The kernel-space code is written in a special eBPF-compatible language (with a C-like syntax) and is loaded into the kernel using helper libraries (such as libbpf) or system calls (like <code>bpf()</code>).<br>
<strong>User Space Code:</strong><br>
User-space code is responsible for loading the eBPF program into the kernel, attaching it to specific hooks or events, and managing communication between user space and kernel space. It also handles tasks like retrieving data from the kernel (e.g., using maps for data storage).<br>
User-space code is written in a regular programming language (such as C or Python) and runs outside the kernel, as a user-space application.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/eBPF-Architecture.png" alt="Centered image" />
</p>
<h3 id="libbpf">libbpf<a class="td-heading-self-link" href="#libbpf" aria-label="Heading self-link"></a></h3>
<p>libbpf is a C-based library designed to facilitate interaction with the eBPF subsystem in the Linux kernel. It provides a set of high-level and low-level APIs that simplify of loading, verifying, and managing eBPF programs. By handling the complexities of working with the kernel, libbpf enables developers to focus more on optimizing their eBPF code&rsquo;s performance and correctness, rather than managing the details of user-space and kernel-space interactions.<br>
libbpf includes a variety of BPF helper functions that ease development. These helpers allow eBPF programs to interact with the system more effectively, providing functions for tasks like debugging, manipulating network packets, and working with eBPF maps. This reduces the amount of code developers need to write, enabling them to focus on the logic of their BPF programs.<br>
One of the most significant benefits of libbpf is its support for eBPF CO-RE (Compile Once, Run Everywhere), a mechanism that enhances the portability of eBPF programs. By leveraging BTF (BPF Type Format)—a metadata format that describes kernel data types such as data structures, unions, enums, and function prototypes—libbpf allows developers to write eBPF programs that can be compiled once and run across multiple kernel versions. CO-RE produces an ELF file with precompiled eBPF bytecode that can run across different kernel versions, eliminating the need for recompiling or modifying eBPF code for different systems. BTF information can be generated via</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span></code></pre></div><p>Simply, libbpf uses BTF information to align or modify the types and fields in the eBPF program with the current running kernel. For more information about eBPF CO-RE, please refer to this <a href="https://nakryiko.com/posts/bpf-core-reference-guide/">https://nakryiko.com/posts/bpf-core-reference-guide/</a>.<br>
As stated in <a href="https://docs.kernel.org/bpf/libbpf/libbpf_overview.html">https://docs.kernel.org/bpf/libbpf/libbpf_overview.html</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>libbpf provides APIs that user space programs can use to manipulate the BPF programs by triggering different phases of a BPF application lifecycle.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The following section provides a brief overview of each phase in the BPF life cycle:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Open phase: In this phase, libbpf parses the BPF object file and discovers BPF maps, BPF programs, and global variables. After a BPF app is opened, user space apps can make additional adjustments (setting BPF program types, if necessary; pre-setting initial values for global variables, etc.) before all the entities are created and loaded.
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>Load phase: In the load phase, libbpf creates BPF maps, resolves various relocations, and verifies and loads BPF programs into the kernel. At this point, libbpf validates all the parts of a BPF application and loads the BPF program into the kernel, but no BPF program has yet been executed. After the load phase, it’s possible to set up the initial BPF map state without racing with the BPF program code execution.
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>Attachment phase: In this phase, libbpf attaches BPF programs to various BPF hook points (e.g., tracepoints, kprobes, cgroup hooks, network packet processing pipeline, etc.). During this phase, BPF programs perform useful work such as processing packets, or updating BPF maps and global variables that can be read from user space.
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>Tear down phase: In the tear down phase, libbpf detaches BPF programs and unloads them from the kernel. BPF maps are destroyed, and all the resources used by the BPF app are freed.
</span></span></code></pre></div><p>A BPF Object Skeleton File is a C header file <code>(.skel.h)</code> generated using <code>bpftool</code> from a compiled eBPF object file. This header file provides a structured interface for interacting with the eBPF program, simplifying its management from user space. For developers seeking simplicity, the eBPF skeleton provides a more abstracted interface for interacting with eBPF programs. The skeleton generates functions such as <code>&lt;name&gt;__open()</code>, <code>&lt;name&gt;__load()</code>, <code>&lt;name&gt;__attach()</code>, and <code>&lt;name&gt;__destroy()</code>, which automate key steps in the eBPF lifecycle, allowing developers to manage eBPF programs with less effort. The skeleton also provides access to global variables and maps, which are directly accessible as structured fields in the user-space program, making it easier to manipulate these elements without relying on string-based lookups.</p>
<h3 id="ebpf-probes">eBPF Probes<a class="td-heading-self-link" href="#ebpf-probes" aria-label="Heading self-link"></a></h3>
<p>eBPF probes are mechanisms used to attach eBPF programs to specific events within the kernel or user-space. These probes allow developers to dynamically hook into various parts of the system and execute eBPF programs when those events or locations are triggered, enabling data collection, behavior monitoring, or influencing execution.<br>
eBPF probes allow attaching to various points in the kernel’s execution flow to observe and sometimes modify behavior. Each type of eBPF probe corresponds to a particular attachment point. Some common probe types include:</p>
<ul>
<li><strong>kprobe:</strong> Attaches to almost any kernel instruction address.</li>
<li><strong>kretprobe (return probe):</strong> Attaches to the return point of a kernel function.</li>
<li><strong>uprobe and uretprobe:</strong> Attach to user-space functions and their returns.</li>
<li><strong>tracepoint and raw_tracepoint:</strong> Attach to static kernel tracepoints for predefined events.</li>
<li><strong>fentry:</strong> Attached to the entry point of a kernel function using an enhanced, lower-overhead mechanism.</li>
<li><strong>fexit:</strong> Attached to the return of a kernel function using an enhanced, lower-overhead mechanism.</li>
</ul>
<h2 id="kprobe-kretprobe">kprobe-kretprobe<a class="td-heading-self-link" href="#kprobe-kretprobe" aria-label="Heading self-link"></a></h2>
<h3 id="kprobes">Kprobes<a class="td-heading-self-link" href="#kprobes" aria-label="Heading self-link"></a></h3>
<p>A kprobe is a dynamic instrumentation mechanism that allows you to attach a custom handler at almost any kernel instruction address, often used at the start of a kernel function. When the CPU executes this probed instruction, it triggers the kprobe handler. This handler can inspect CPU registers, function arguments, and kernel memory state before the original instruction executes. kprobe-based eBPF programs are classified under the program type <code>BPF_PROG_TYPE_KPROBE</code>.<br>
You can list all of the kernel exported symbols using <code>sudo cat /proc/kallsyms</code> and we are only interested in <code>T</code> which represents globally visible text symbols (Code) and they can be attached.</p>
<h4 id="how-kprobes-work-under-the-hood">How Kprobes Work Under the Hood<a class="td-heading-self-link" href="#how-kprobes-work-under-the-hood" aria-label="Heading self-link"></a></h4>
<ol>
<li>When you register a kprobe on a kernel function (e.g., <code>do_mkdirat</code>), the kernel replaces the first instruction bytes at that function’s entry with a breakpoint instruction <code>int3</code>.</li>
<li>When the function is called, the CPU hits the breakpoint instruction, a trap occurs.</li>
<li>The kernel’s kprobe infrastructure intercepts this exception and calls your eBPF program’s handler. Your eBPF code then has access to the function arguments and can perform any allowed eBPF operations (e.g., reading fields, printing debug information).</li>
<li>After the handler completes its task, instruction flow resumes by single-stepping the original instruction. If the kprobe is no longer needed, the original instruction is restored in place of the breakpoint.</li>
</ol>
<p><strong>Before kprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-before.png" alt="Centered image" />
</p>
<p><strong>After kprobe insertion:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-after.png" alt="Centered image" />
</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    kprobes can be attached to nearly any kernel instruction. However, certain functions—such as those involved in kprobe handling itself—cannot be probed, as doing so would trigger recursive traps and potentially destabilize the kernel.

</div>

<p>As stated in <a href="https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_KPROBE/">https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_KPROBE/</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>The context passed to kprobe programs is `struct pt_regs`. This structure is different for each CPU architecture since it contains a copy of the CPU registers at the time the kprobe was invoked.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>It is common for kprobe programs to use the macros from the Libbpf `bpf_tracing.h` header file, which defines `PT_REGS_PARM1` ... `PT_REGS_PARM5` as well as a number of others. These macros will translate to the correct field in `struct pt_regs` depending on the current architecture. Communicating the architecture you are compiling the BPF program for is done by defining one of the `__TARGET_ARCH_*` values in your program or via the command line while compiling.
</span></span></code></pre></div><p>PT_REGS_PARMX macros are defined in <code>bpf_tracing.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM1(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM1_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM2(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM2_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM3(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM3_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM4(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM4_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM5(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM5_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM6(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM6_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM7(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM7_REG)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_PARM8(x) (__PT_REGS_CAST(x)-&gt;__PT_PARM8_REG)
</span></span></span></code></pre></div><p><code>struct pt_regs</code> is defined in <code>/arch/x86/include/uapi/asm/ptrace.h</code> for the x86-64 architecture:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r15</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r14</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r13</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r12</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rbp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rbx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r11</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r9</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">r8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rax</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rcx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rdx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rsi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rdi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">orig_rax</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">eflags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rsp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ss</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>The <code>struct pt_regs</code> stores the CPU&rsquo;s register state at the time of an interrupt, system call, or exception, enabling the kernel to save and restore the execution context of a process. By capturing the state of general-purpose registers, segment registers, and special registers (such as the instruction pointer and stack pointer).</p>
<p>In the next example we will attach a kprobe to start of of <code>do_mkdirat</code> syscall which is used to create a new directory.<br>
<code>do_mkdirat</code> prototype <code>int do_mkdirat(int dfd, struct filename *name, umode_t mode);</code> and it has 3 parameters <code>dfd</code>, <code>struct filename</code>, <code>mode</code>.
<code>dfd</code>: stands for &ldquo;directory file descriptor.&rdquo; It specifies the directory relative to which the new directory should be created.
<code>struct filename</code> is a kernel data structure defined in <code>/include/linux/fs.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* pointer to actual string */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#204a87;font-weight:bold">char</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">uptr</span><span style="color:#000;font-weight:bold">;</span>	<span style="color:#8f5902;font-style:italic">/* original userland pointer */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">atomic_t</span>		<span style="color:#000">refcnt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">audit_names</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aname</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span>		<span style="color:#000">iname</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>mode</code> represents file permissions for the created directory.</p>
<p>Now let&rsquo;s start with eBPF kernel code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, as we just explained that we need to define <code>__TARGET_ARCH__XX </code> according to your architecture then include <code>vmlinux.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><p><code>bpf_core_read.h</code> header file provides macros for reading data from kernel or user space in a way that is compatible with BPF CO-RE (Compile Once, Run Everywhere) such as <code>BPF_CORE_READ</code> macro.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Then we added <code>license</code> we we discussed in the previous chapter</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>SEC</code> It tells the compile what ELF section to put which is <code>kprobe</code> and where to attach it which is <code>do_mkdirat</code>. Then kprobe handler <code>kprobe_mkdir</code>  that gets executed when <code>do_mkdirat</code> entry point is triggered.<br>
<code>struct pt_regs *ctx</code> is the context passed to the eBPF program by the kernel. It contains information about the registers at the time the function was invoked, including the function arguments, return addresses. The <code>ctx</code> pointer will be used to extract these values.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>bpf_get_current_pid_tgid()</code> is an eBPF helper function that returns a 64-bit value, where:</p>
<ul>
<li>The lower 32 bits represent the thread group ID (TGID), which is the PID of the thread that initiated the system call.</li>
<li>The upper 32 bits represent the thread ID (PID) of the current thread.
Since we are interested in the <code>PID</code>, we shift the 64-bit value to the right by 32 bits (<code>&gt;&gt; 32</code>) to get just the process ID (PID) of the current process.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>PT_REGS_PARM2(ctx)</code>: As previously discussed, this is a macro used to extract the second argument of the function being probed. In this case, the second argument is a pointer to the <code>filename</code> structure, which is passed to the <code>do_mkdirat</code> function. <code>struct filename *name</code>: This line casts the second parameter (a pointer to <code>struct filename</code>) to the <code>name</code> variable. <code>struct filename</code> holds the path to the directory to be created.<br>
<code>BPF_CORE_READ(name, name)</code>:  It uses the <code>BPF_CORE_READ</code> macro from the <code>bpf_core_read.h</code> header. This macro is a helper function designed to safely read fields from kernel structures in a way that is compatible with BPF CO-RE (Compile Once, Run Everywhere) and it&rsquo;s necessary because kernel structures may change between different kernel versions, and <code>BPF_CORE_READ</code> ensures that the field <code>name</code> can be accessed in a manner that works across various kernel versions.<br>
<code>name</code> field: In this case, the field <code>name</code> in <code>struct filename</code> holds the string representing the path of the directory to be created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>PT_REGS_PARM3(ctx)</code>: This macro extracts the third argument passed to <code>do_mkdirat</code>, which represents the mode (permissions) of the directory to be created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>bpf_printk</code>: This is an eBPF macro that allows printing formatted output to the kernel&rsquo;s trace buffer, which is accessible via <code>/sys/kernel/debug/tracing/trace_pipe</code>. <code>bpf_printk</code> only supports up to 3 arguments.</p>
<p>At this point we need to compile this code into an object file using <code>clang</code> with help from <code>bpftool</code>.</p>
<ol>
<li>Install required tools <code>sudo apt install linux-tools-$(uname -r) clang llvm libbpf-dev bpftool</code>,</li>
<li>Generate <code>vmlinux.h</code>  via <code>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</code></li>
<li>Compile eBPF code into an object file <code>clang -g -O2 -target bpf -c kprobe-mkdirat.bpf.c -o kprobe-mkdirat.o</code> with debugging information (<code>-g</code>) and optimization level <code>-O2</code>. The <code>-target bpf</code> flag ensures that Clang compiles the code for the eBPF target architecture.</li>
<li>Generate the skeleton header file <code>sudo bpftool gen skeleton kprobe-mkdirat.o &gt; kprobe-mkdirat.skel.h</code></li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    If you encounter the error <code>/usr/include/linux/types.h:5:10: fatal error: 'asm/types.h' file not found</code> while compiling the eBPF kernel code , you can execute the command <code>sudo ln -s /usr/include/x86_64-linux-gnu/asm /usr/include/asm</code>.

</div>

<p>Examining the generated object file <code>llvm-objdump -h kprobe-mkdirat.o</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kprobe-mkdirat.o:	file format elf64-bpf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sections:
</span></span><span style="display:flex;"><span>Idx Name                   Size     VMA              Type
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">0</span>                        <span style="color:#0000cf;font-weight:bold">00000000</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span> .strtab                <span style="color:#0000cf;font-weight:bold">00000141</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> .text                  <span style="color:#0000cf;font-weight:bold">00000000</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> TEXT
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">3</span> kprobe/do_mkdirat      000000a8 <span style="color:#0000cf;font-weight:bold">0000000000000000</span> TEXT
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">4</span> .relkprobe/do_mkdirat  <span style="color:#0000cf;font-weight:bold">00000010</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5</span> license                0000000d <span style="color:#0000cf;font-weight:bold">0000000000000000</span> DATA
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">6</span> .rodata                <span style="color:#0000cf;font-weight:bold">00000031</span> <span style="color:#0000cf;font-weight:bold">0000000000000000</span> DATA
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The generated object file <code>kprobe-mkdirat.o</code> has the file format ELF64-BPF, indicating it is a 64-bit ELF object file specifically for BPF (eBPF) code.<br>
<code>kprobe/do_mkdirat</code> This is the section header where the actual eBPF program resides, as indicated by <code>SEC(&quot;kprobe/do_mkdirat&quot;)</code> in the code. This section contains the code that will be executed when the <code>do_mkdirat</code> kprobe is triggered.</p>
<p>Let&rsquo;s move to the user-space code. The following code is derived from <a href="https://github.com/libbpf/libbpf-bootstrap">https://github.com/libbpf/libbpf-bootstrap</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s divide the code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>A function for libbpf debug and error messages.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>declares a pointer <code>skel</code> to a structure <code>kprobe_mkdirat</code>, which represents the eBPF skeleton for the eBPF program attached to the <code>do_mkdirat</code> kprobe. This structure is used to manage the loading, attaching, and cleanup of the eBPF program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>This function opens the eBPF skeleton for the <code>kprobe_mkdirat</code> program to set up the eBPF program, including its maps, and prepares it for loading.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function loads and verifies the eBPF program defined in the skeleton. It ensures that the eBPF code is valid and ready to be attached to the kernel.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function attaches the eBPF program to the kernel&rsquo;s <code>kprobe</code> at the <code>do_mkdirat</code> function. It makes the program active and starts tracing the specified kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>	<span style="color:#000">kprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This function cleans up and frees resources used by the BPF skeleton. It detaches the program and destroys the associated maps and other resources.<br>
All these functions (<code>_open()</code>, <code>_load()</code>, <code>_attach()</code>, and <code>_destroy()</code>) are automatically generated from the eBPF skeleton file. As we explained earlier that the skeleton file abstracts much of the complexity of interacting with BPF programs, making it much easier to build user-space code for managing and interacting with eBPF programs. It eliminates the need for manual setup and error handling, simplify the entire process.<br>
To compile the user-space code, we use the following command: <code>clang -o loader loader.c -lbpf</code>. This compiles the <code>loader.c</code> file and links it with the <code>libbpf</code> library, producing an executable named <code>loader</code>.<br>
To start the eBPF program, you can use the following command: <code>sudo ./loader</code>. This runs the compiled user-space program <code>loader</code>, which loads the eBPF program, attaches it to the kernel function (in this case, the <code>do_mkdirat</code> function via kprobes), and starts tracing the kernel function. The <code>sudo</code> is necessary because eBPF programs often require root privileges to attach to kernel functions or tracepoints.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>libbpf: loading object <span style="color:#4e9a06">&#39;kprobe_mkdirat&#39;</span> from buffer
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span> kprobe/do_mkdirat, size 168, link 0, flags 6, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>: found program <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span> at insn offset <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>, code size <span style="color:#0000cf;font-weight:bold">21</span> insns <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">168</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span> .relkprobe/do_mkdirat, size 16, link 27, flags 40, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>5<span style="color:#ce5c00;font-weight:bold">)</span> license, size 13, link 0, flags 3, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: license of kprobe_mkdirat is GPL
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>6<span style="color:#ce5c00;font-weight:bold">)</span> .rodata, size 49, link 0, flags 2, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>17<span style="color:#ce5c00;font-weight:bold">)</span> .BTF, size 1407, link 0, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>19<span style="color:#ce5c00;font-weight:bold">)</span> .BTF.ext, size 284, link 0, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>libbpf: elf: section<span style="color:#ce5c00;font-weight:bold">(</span>27<span style="color:#ce5c00;font-weight:bold">)</span> .symtab, size 384, link 1, flags 0, <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>libbpf: looking <span style="color:#204a87;font-weight:bold">for</span> externs among <span style="color:#0000cf;font-weight:bold">16</span> symbols...
</span></span><span style="display:flex;"><span>libbpf: collected <span style="color:#0000cf;font-weight:bold">0</span> externs total
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;kprobe_m.rodata&#39;</span> <span style="color:#ce5c00;font-weight:bold">(</span>global data<span style="color:#ce5c00;font-weight:bold">)</span>: at sec_idx 6, offset 0, flags 80.
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#0000cf;font-weight:bold">0</span> is <span style="color:#4e9a06">&#34;kprobe_m.rodata&#34;</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;.relkprobe/do_mkdirat&#39;</span>: collecting relocation <span style="color:#204a87;font-weight:bold">for</span> section<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;.relkprobe/do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: insn #14 against &#39;.rodata&#39;</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: found data map <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>kprobe_m.rodata, sec 6, off 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> insn <span style="color:#0000cf;font-weight:bold">14</span>
</span></span><span style="display:flex;"><span>libbpf: loading kernel BTF <span style="color:#4e9a06">&#39;/sys/kernel/btf/vmlinux&#39;</span>: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;kprobe_m.rodata&#39;</span>: created successfully, <span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;kprobe/do_mkdirat&#39;</span>: found <span style="color:#0000cf;font-weight:bold">3</span> CO-RE relocations
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>83<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: &lt;byte_off&gt; [2] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: matching candidate #0 &lt;byte_off&gt; [83] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: patched insn #3 (LDX/ST/STX) off 104 -&gt; 104</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>7<span style="color:#ce5c00;font-weight:bold">]</span> struct filename: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>4878<span style="color:#ce5c00;font-weight:bold">]</span> struct filename in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: &lt;byte_off&gt; [7] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: matching candidate #0 &lt;byte_off&gt; [4878] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: patched insn #4 (ALU/ALU64) imm 0 -&gt; 0</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: &lt;byte_off&gt; [2] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: matching candidate #0 &lt;byte_off&gt; [83] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;kprobe_mkdir&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: patched insn #12 (LDX/ST/STX) off 96 -&gt; 96</span>
</span></span><span style="display:flex;"><span>Successfully started! Please run <span style="color:#4e9a06">`</span>sudo cat /sys/kernel/debug/tracing/trace_pipe<span style="color:#4e9a06">`</span> to see output of the BPF programs.
</span></span><span style="display:flex;"><span>..............
</span></span></code></pre></div><p>To view the output of the eBPF program, you can open a separate terminal window and run the following command: <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code></p>
<p>Then in another separate terminal run  <code>mkdir testing</code>. In the second terminal, you should now see the following output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    mkdir-2173    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...21 12952.686720: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2173, <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> testing, <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>mode = 511. The value 511 is the decimal representation of the octal permission <code>0777</code>.</p>
<p>To observe the behavior of loading the eBPF program, you can run <code>strace</code> using the following command: <code>sudo strace -ebpf ./loader</code>. This will trace the <code>bpf()</code> system calls made by the <code>loader</code> program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>21, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e460a0f0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kprobe_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e4608850, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f5e46088d0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>The previous output tells us that the program type is BPF_PROG_TYPE_KPROBE in <code>prog_type=BPF_PROG_TYPE_KPROBE</code>, and <code>prog_name=&quot;kprobe_mkdir&quot;</code> is the eBPF program that will be executed when the <code>do_mkdirat</code> entry point is triggered.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-example-1.png" alt="Centered image" />
</p>
<p>Congratulations! You&rsquo;ve just run your first eBPF program, and it&rsquo;s a portable eBPF program that can work across different kernel versions.  It wasn&rsquo;t that complicated, was it?<br>
In eBPF kernel code, we used the name of the kprobe handler as <code>kprobe_mkdir</code> and passed a <code>struct pt_regs</code> as the context for the <code>kprobe_mkdir</code> function. Another approach is using <code>BPF_KPROBE</code>, which offers a more convenient and readable way to define kprobe handlers. With <code>BPF_KPROBE</code>, you specify the name of the function followed by any additional arguments you want to capture, making it a simpler and cleaner method.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">capture_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This approach is more convenient and readable, while giving the same results. Either way, it&rsquo;s up to you to choose which method is easier for you.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec810e0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;capture_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec7f840, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x556e4ec7f8c0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>Now let&rsquo;s move forward to walkthrough kretprobe.</p>
<h3 id="kretprobes">Kretprobes<a class="td-heading-self-link" href="#kretprobes" aria-label="Heading self-link"></a></h3>
<p>A kretprobe fires when a monitored function returns. While a kprobe targets function entry (or a specific instruction), a kretprobe targets function exit. By pairing a kprobe at function entry with a kretprobe at function exit, you can measure how long a function took to run or check its return value. kretprobe-based eBPF programs are also classified under the program type <code>BPF_PROG_TYPE_KPROBE</code></p>
<h4 id="how-kretprobes-work-under-the-hood">How Kretprobes Work Under the Hood<a class="td-heading-self-link" href="#how-kretprobes-work-under-the-hood" aria-label="Heading self-link"></a></h4>
<ol>
<li>When you register a kretprobe for a function, the kprobe mechanism inserts a probe at the function’s entry to store the original return address and replace it with a trampoline.</li>
<li>The original return address is replaced with kretprobe_trampoline() address (which is the address of the trampoline) during function entry. The trampoline is also kprobed.</li>
<li>When the function returns, control jumps to the trampoline instead of the original return address.</li>
<li>Hitting the trampoline triggers the kretprobe handler. This handler can access the function’s return value and any data stored at entry time.</li>
<li>The original return address is restored, and the function’s caller proceeds as usual.</li>
</ol>
<p><strong>Before kretprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kretprobe-before.png" alt="Centered image" />
</p>
<p><strong>After kretprobe insertion:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kretprobe-after.png" alt="Centered image" />
</p>
<p>Now let&rsquo;s take a look at the same example by hooking kretprobe to <code>do_mkdirat</code>. First, Let&rsquo;s look at the eBPF kernel code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kretprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, return = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We changed SEC from <code>(&quot;kprobe/do_mkdirat&quot;)</code> to <code>(&quot;kretprobe/do_mkdirat&quot;)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kretprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Using <code>PT_REGS_RC</code> macro to extract the return value form <code>pt_regs</code> structure. PT_REGS_RC is defined in <code>bpf_tracing.h</code> as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PT_REGS_RC(x) (__PT_REGS_CAST(x)-&gt;__PT_RC_REG)
</span></span></span></code></pre></div><p> To compile we could do exactly the same as we did in the previous kprobe example.</p>
<ol>
<li>Generate <code>vmlinux.h</code> via</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span></code></pre></div><ol start="2">
<li>Compile eBPF code into an object file <code>clang -g -O2 -target bpf -c kretprobe-mkdirat.bpf.c -o kretprobe-mkdirat.o</code> with debugging information (<code>-g</code>) and optimization level <code>-O2</code>. The <code>-target bpf</code> flag ensures that Clang compiles the code for the eBPF target architecture.</li>
<li>Generate the skeleton header file</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftool gen skeleton kretprobe-mkdirat.o &gt; kprobe-kretprobe.skel.h
</span></span></code></pre></div><p>Moving to the second part which is the user-space code for opening, loading, attaching and destroying the eBPF code, let&rsquo;s use the the previous code and modify it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kretprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kretprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">kretprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We need to change some lines here to match out generated skeleton file such as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kretprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kretprobe_mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kretprobe_mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kretprobe_mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Finally, let&rsquo;s compile it and link it to libbpf <code>clang -o loader loader.c -lbpf</code> then run it as the previous with <code>sudo ./loader</code>  Then <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code> in a separate terminal. Then use command <code>mkdir test</code> and we get</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>           &lt;...&gt;-2053    <span style="color:#ce5c00;font-weight:bold">[</span>002<span style="color:#ce5c00;font-weight:bold">]</span> ...21  5359.243727: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2053, <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>Return value 0 indicates success, while any non-zero value represents an error, with the specific error codes defined in <code>/include/uapi/asm-generic/errno-base.h</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EPERM		 1	</span><span style="color:#8f5902;font-style:italic">/* Operation not permitted */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOENT		 2	</span><span style="color:#8f5902;font-style:italic">/* No such file or directory */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ESRCH		 3	</span><span style="color:#8f5902;font-style:italic">/* No such process */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EINTR		 4	</span><span style="color:#8f5902;font-style:italic">/* Interrupted system call */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EIO		     5	</span><span style="color:#8f5902;font-style:italic">/* I/O error */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENXIO		 6	</span><span style="color:#8f5902;font-style:italic">/* No such device or address */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	E2BIG		 7	</span><span style="color:#8f5902;font-style:italic">/* Argument list too long */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOEXEC		 8	</span><span style="color:#8f5902;font-style:italic">/* Exec format error */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EBADF		 9	</span><span style="color:#8f5902;font-style:italic">/* Bad file number */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ECHILD		10	</span><span style="color:#8f5902;font-style:italic">/* No child processes */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EAGAIN		11	</span><span style="color:#8f5902;font-style:italic">/* Try again */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOMEM		12	</span><span style="color:#8f5902;font-style:italic">/* Out of memory */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EACCES		13	</span><span style="color:#8f5902;font-style:italic">/* Permission denied */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EFAULT		14	</span><span style="color:#8f5902;font-style:italic">/* Bad address */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOTBLK		15	</span><span style="color:#8f5902;font-style:italic">/* Block device required */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EBUSY		16	</span><span style="color:#8f5902;font-style:italic">/* Device or resource busy */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EEXIST		17	</span><span style="color:#8f5902;font-style:italic">/* File exists */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EXDEV		18	</span><span style="color:#8f5902;font-style:italic">/* Cross-device link */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENODEV		19	</span><span style="color:#8f5902;font-style:italic">/* No such device */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOTDIR		20	</span><span style="color:#8f5902;font-style:italic">/* Not a directory */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EISDIR		21	</span><span style="color:#8f5902;font-style:italic">/* Is a directory */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EINVAL		22	</span><span style="color:#8f5902;font-style:italic">/* Invalid argument */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENFILE		23	</span><span style="color:#8f5902;font-style:italic">/* File table overflow */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EMFILE		24	</span><span style="color:#8f5902;font-style:italic">/* Too many open files */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOTTY		25	</span><span style="color:#8f5902;font-style:italic">/* Not a typewriter */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ETXTBSY		26	</span><span style="color:#8f5902;font-style:italic">/* Text file busy */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EFBIG		27	</span><span style="color:#8f5902;font-style:italic">/* File too large */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ENOSPC		28	</span><span style="color:#8f5902;font-style:italic">/* No space left on device */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ESPIPE		29	</span><span style="color:#8f5902;font-style:italic">/* Illegal seek */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EROFS		30	</span><span style="color:#8f5902;font-style:italic">/* Read-only file system */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EMLINK		31	</span><span style="color:#8f5902;font-style:italic">/* Too many links */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EPIPE		32	</span><span style="color:#8f5902;font-style:italic">/* Broken pipe */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	EDOM		33	</span><span style="color:#8f5902;font-style:italic">/* Math argument out of domain of func */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define	ERANGE		34	</span><span style="color:#8f5902;font-style:italic">/* Math result not representable */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><p>For example, if you try to run <code>mkdir test</code> command again you will get the following output.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>           mkdir-2054    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...21  5365.024388: bpf_trace_printk: KPROBE ENTRY <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> 2054, <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">=</span> -17
</span></span></code></pre></div><p>This indicate <code>EEXIST - file exists</code>. Running it with strace <code>sudo strace -ebpf ./loader</code> to capture bpf() syscalls shows that the the <code>prog_type</code> is <code>BPF_PROG_TYPE_KPROBE</code> and the <code>prog_name</code> is <code>kretprobe_mkdir</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>11, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b8000, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kretprobe_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b67f0, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55eb0c2b6870, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>6, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>The better approach is to use <code>BPF_KRETPROBE</code> macro, which offers a more convenient and readable way to define kretprobe handlers, as mentioned earlier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KRETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, return = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>As you can see, this is much simpler and cleaner.</p>
<p>Combining the use of both <code>kprobe</code> and <code>kretprobe</code> on the <code>do_mkdirat</code> kernel function provides insight into the arguments received by <code>do_mkdirat</code> and its return value. This type of instrumentation is valuable for several reasons, such as debugging, system performance monitoring, maintaining a detailed record of directory creation for forensic analysis, and detecting malicious activities like attempting unauthorized directory creation.</p>
<p><code>/sys/kernel/debug/tracing/trace_pipe</code> is globally shared interface that aggregates all ebpf programs trace events, which can lead to contention and data mixing. In contrast, using maps provides a dedicated, structured, and efficient mechanism to pass data between kernel and user space, offering better control and isolation.</p>
<p>Let&rsquo;s go forward and use maps instead of the kernel&rsquo;s trace buffer <code>/sys/kernel/debug/tracing/trace_pipe</code>. Le&rsquo;ts go back the first example and add <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> to it and store our data using <code>bpf_perf_event_output</code> in BPF perf event.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-perf-buffer.png" alt="Centered image" />
</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First we defined the structure for the event data that will be sent to user-space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Then defined a map of type <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> as we explained earlier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Type of BPF map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// Maximum number of entries in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                            <span style="color:#8f5902;font-style:italic">// Type of the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                          <span style="color:#8f5902;font-style:italic">// Type of the value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we created <code>ev</code> of type  <code>struct event</code> and store both <code>pid</code> and <code>mode</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Next, we used <code>bpf_probe_read_str</code> to safely read a string from kernel space and copy it into the eBPF program&rsquo;s memory space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Finally,  write <code>ev</code> data into our created map <code>mkdir</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>The user-space loader code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;kprobe-mkdirat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define PERF_BUFFER_PAGES 64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">mode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process ID: %d, filename: %s, mode: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lost %llu events on CPU %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">kprobe</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mkdirat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mkdirat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mkdirat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">kprobe</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mkdirat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">PERF_BUFFER_PAGES</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Listening for events...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perf_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">kprobe</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mkdirat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First we defined the structure to store event data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Next, we defined <code>handle_event</code> which gets called when a new event is read from the perf buffer. It casts the <code>data</code> pointer to the <code>struct event</code> and prints the <code>pid</code>, <code>filename</code>, and <code>mode</code> values. Then, we defined <code>handle_lost_events</code> which handles lost events (when the buffer overflows). It prints a message indicating how many events were lost on a specific CPU.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process ID: %d, filename: %s, mode: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lost %llu events on CPU %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lost_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then we Initialize <code>pb</code> to hold the perf buffer, <code>struct perf_buffer</code> is defined in <code>/tools/lib/bpf/libbpf.c</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Next, we created a perf buffer for our <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> using <code>perf_buffer__new</code>  and it has the following prototype</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">perf_buffer__new</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">map_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">page_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">perf_buffer_sample_fn</span> <span style="color:#000">sample_cb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">perf_buffer_lost_fn</span> <span style="color:#000">lost_cb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">perf_buffer_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>perf_buffer__new</code> takes a file descriptor for  <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> , memory page size for each CPU, a function to invoke on each each received data, a function to invoke in case of data loss, *ctx and *opts.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">pb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">PERF_BUFFER_PAGES</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_lost_events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create perf buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>perf_buffer__poll</code> is a function provided by the <code>libbpf</code> library that allows user-space applications to poll a perf buffer for new data. It has the following prototype:
<code>int perf_buffer__poll (struct perf_buffer *pb, int timeout_ms)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">perf_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>If Positive <code>timeout_ms</code>: Blocks for the specified time (e.g., 100ms). If data arrives within that time, it processes and returns. If no data arrives, it returns 0.
If<code>timeout_ms == 0</code>: Non-blocking. Checks immediately for data. Returns 0 if no data is available.
If Negative <code>timeout_ms</code>: Blocks indefinitely until data becomes available.
Finally,  free perf buffer resource.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">perf_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pb</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>After compiling as we did before, run loader using <code>sudo</code> and run <code>mkdir /tmp/test</code> in a new terminal.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>11<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>136<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: &lt;byte_off&gt; [11] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: matching candidate #0 &lt;byte_off&gt; [136] struct pt_regs.si (0:13 @ offset 104)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: patched insn #1 (LDX/ST/STX) off 104 -&gt; 104</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: &lt;byte_off&gt; [11] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: matching candidate #0 &lt;byte_off&gt; [136] struct pt_regs.dx (0:12 @ offset 96)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#1: patched insn #2 (LDX/ST/STX) off 96 -&gt; 96</span>
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>25<span style="color:#ce5c00;font-weight:bold">]</span> struct filename: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>1410<span style="color:#ce5c00;font-weight:bold">]</span> struct filename in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: &lt;byte_off&gt; [25] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: matching candidate #0 &lt;byte_off&gt; [1410] struct filename.name (0:0 @ offset 0)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;do_mkdirat&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#2: patched insn #73 (ALU/ALU64) imm 0 -&gt; 0</span>
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;mkdir&#39;</span>: created successfully, <span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Successfully started! Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Process ID: 2416, filename: /tmp/test, mode: <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>Tracing bpf() syscall using <code>strace</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_MAP_CREATE, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">map_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_MAP_TYPE_PERF_EVENT_ARRAY, <span style="color:#000">key_size</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">value_size</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">max_entries</span><span style="color:#ce5c00;font-weight:bold">=</span>1024, <span style="color:#000">map_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">inner_map_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mkdir&#34;</span>, <span style="color:#000">map_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_key_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_extra</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 80<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>96, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd994ff0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;do_mkdirat&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd9937e0, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55cbcd9938c0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>13, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>This output tells us that there an extra component which is <code>BPF_MAP_CREATE</code> command creating a map of type <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code> and map_name is <code>mkdir</code>.</p>
<p>Attaching a kprobe to system call can be done using the same methods or using <code>ksyscall</code> technique with <code>BPF_KSYSCALL</code> macro and <code>(&quot;ksyscall/syscall_name&quot;)</code> as section. For example, <code>SEC(&quot;ksyscall/execve&quot;)</code> as the next example, which we will attach a kprobe to <code>execve</code> syscall using <code>ksyscall</code>. The <code>execve</code> system call is one of the family of <code>exec</code> functions in Unix-like operating systems. It is used to execute a new program by replacing the current process image with a new one. The execve syscall is declared in <code>include/linux/syscalls.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">asmlinkage</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">sys_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">__user</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">envp</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>asmlinkage</code>: It&rsquo;s a macro to tell the compile to that arguments are passed on the stack not registers.
<code>const char __user *filename</code>:  A pointer to the filename (a user-space string) of the program to execute.
<code>const char __user *const __user *argv</code>:  A pointer to an array of pointers (from user space) to the argument strings for the new program.
<code>const char __user *const __user _*envp</code>: A pointer to an array of pointers (from user space) to the environment variables for the new program.</p>
<p>In next example, we will attach kprobe to <code>execve</code> syscall using <code>ksyscall</code> and we will add ring buffer to ship our events to the user-space instead of perf buffer. Ring buffer needs to be defined, reserve then submit your events. The ring buffer minimizes overhead, offering lower latency and better performance for high-frequency event reporting compared to perf buffer mechanism.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    In kprobe programs, syscalls and kernel functions follow different ABIs. The syscall ABI defines the transition from user space to kernel space and dictates how its arguments are passed, while the kernel function ABI governs internal calls within the kernel.

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_ARGS 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ARG_SIZE 128
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rb</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ksyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KSYSCALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#pragma unroll
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">argp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We defined a ring buffer type of map with name <code>rb</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rb</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Define a data structure <code>event</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">ARG_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>We defined section with <code>ksyscall/execve</code> for <code>execve</code> syscall and use <code>BPF_KSYSCALL</code> macro. BPF_KSYSCALL macro defined two arguments of execve syscall instead of three because we only need filename to extract command being executed and argv to get command with its arguments and no need for environment variables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ksyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KSYSCALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span></code></pre></div><p>Then reserve space in eBPF ring buffer using <code>bpf_ringbuf_reserve</code> helper function which has prototype as the following <code>void *bpf_ringbuf_reserve(void *ringbuf, u64 size, u64 flags)</code>, it take a pointer to a ring buffer definition as the first argument and the number of bytes to be reserved in the ring buffer as the second argument and returns a valid pointer with <code>size</code> bytes of memory available and flags must be 0.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>bpf_probe_read_user_str</code> is an eBPF helper function that safely reads a null-terminated string from user-space memory into an eBPF program which has the prototype <code>long bpf_probe_read_user_str(void *dst, u32 size, const void *unsafe_ptr)</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This will copy the filename into path member of ev structure. The <code>argv</code> parameter is essentially a double pointer or pointer to a pointer (<code>const char __user *const __user *argv</code>), meaning it points to an array of pointers where each element is a pointer to a string. Hence, we first need to copy the pointer itself (to get the address of the string) and then copy the string data from that address. In our code, we copy up to 7 pointers (defined by <code>#define MAX_ARGS 7</code>) from <code>argv</code> into a temporary storage <code>argp</code> and then extract the strings into the <code>argv</code> member of the <code>ev</code> structure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">argp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">argp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We could add the <code>#pragma unroll</code> compiler directive to optimize our loop. Loop unrolling duplicates the loop body multiple times, reducing the overhead of loop control by executing multiple iterations&rsquo; work within a single loop iteration. For example,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#pragma unroll
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>After unrolling:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">];</span>
</span></span></code></pre></div><p>Then we submit reserved ring buffer data to make it available in the ring buffer using <code>bpf_ringbuf_submit</code> helper function.
<code>void bpf_ringbuf_submit(void *data, u64 flags)</code> It take a pointer to data as the first argument and flag as the second argument and the flag can be as follow:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>* If BPF_RB_NO_WAKEUP is specified in flags, no notification of new data availability is sent.
</span></span><span style="display:flex;"><span>* If BPF_RB_FORCE_WAKEUP is specified in flags, notification of new data availability is sent unconditionally.
</span></span><span style="display:flex;"><span>* If <span style="color:#0000cf;font-weight:bold">0</span> is specified in flags, an adaptive notification of new data availability is sent.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>What really happened is that we first reserved a space inside the ring buffer, then write our data into the reserved space and finally we submit to make these data available in the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;ksyscall.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_ARGS 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[execve] PID=%d Path=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_ARGS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;    argv[%d] = %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ksyscall</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ksyscall__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing execve calls... Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EINTR</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ksyscall__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We Initialize <code>rb</code> to hold the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>ring_buffer__new</code> takes a file descriptor for  <code>BPF_MAP_TYPE_RINGBUF</code>  and function to invoke on each each received data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we retrieve the newly added data to the ring buffer using <code>ring_buffer__poll</code> function  which has the following prototype:<code>int ring_buffer__poll (struct ring_buffer *rb, int timeout_ms)</code>.
If Positive <code>timeout_ms</code>: Blocks for the specified time (e.g., 100ms). If data arrives within that time, it processes and returns. If no data arrives, it returns 0.
If<code>timeout_ms == 0</code>: Non-blocking. Checks immediately for data. Returns 0 if no data is available.
If Negative <code>timeout_ms</code>: Blocks indefinitely until data becomes available.</p>
<p>Compile the code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000">bpftool</span> <span style="color:#000">btf</span> <span style="color:#000">dump</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">kernel</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">btf</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">vmlinux</span> <span style="color:#000">format</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">vmlinux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">h</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clang</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">O2</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">target</span> <span style="color:#000">bpf</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">c</span> <span style="color:#000">ksyscall_execve</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bpf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">o</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">o</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000">bpftool</span> <span style="color:#000">gen</span> <span style="color:#000">skeleton</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">ksyscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">h</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clang</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">o</span> <span style="color:#000">loader</span> <span style="color:#000">loader</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">lbpf</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sudo</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">loader</span>
</span></span></code></pre></div><p>Executing any commands will trigger the probe such as <code>ls -l /etc</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Tracing execve calls... Ctrl+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>execve<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000">PID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2584</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/bin/ls
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>0<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> ls
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> --color<span style="color:#ce5c00;font-weight:bold">=</span>auto
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> -l
</span></span><span style="display:flex;"><span>    argv<span style="color:#ce5c00;font-weight:bold">[</span>3<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> /etc
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter3/kprobe-ring-buffer.png" alt="Centered image" />
</p>
<p>Examining the code using strace <code>sudo strace -ebpf ./loader</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_MAP_CREATE, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">map_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_MAP_TYPE_RINGBUF, <span style="color:#000">key_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">value_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">max_entries</span><span style="color:#ce5c00;font-weight:bold">=</span>65536, <span style="color:#000">map_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">inner_map_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;rb&#34;</span>, <span style="color:#000">map_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>5, <span style="color:#000">btf_key_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_extra</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 80<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>239, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2703020, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 17<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kprobe_sys_exec&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>5, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2701810, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55f2a2701890, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>115, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Shows the program type is indeed <code>BPF_PROG_TYPE_KPROBE</code> and it uses the map type of <code>BPF_MAP_TYPE_RINGBUF</code>.<br>
A similar approach can be used with the <code>kretsyscall</code> with <code>BPF_KRETPROBE</code> macro to capture a syscall&rsquo;s return value. The following probe will be triggered when <code>execve</code> syscall returns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">define</span> <span style="color:#000">__TARGET_ARCH_x86</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kretsyscall/execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KRETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kretprobe_sys_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Execve return :pid = %d ret = %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> &lt;...&gt;-1781 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1781</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> &lt;...&gt;-1782 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1782</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> &lt;...&gt;-1847 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  bpf_trace_printk: Execve <span style="color:#204a87;font-weight:bold">return</span> :pid <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1847</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> -2
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b77aeac16a82fd2f25c603c7d7aaf653">4.2 - Uprobes and Uretprobes</h1>
    <div class="lead">Entry and return probes for user-space functions so you can trace any binary or shared library at run time without recompiling or restarting the application.</div>
	<p>Uprobes and uretprobes enable instrumentation of user-space applications in a manner similar to how kprobes and kretprobes instrument kernel functions. Instead of tracing kernel-level routines, uprobes and uretprobes attach to functions (or instructions) within user-space executables and shared libraries. This allows system-wide dynamic instrumentation of user applications, including libraries that are shared among many processes.<br>
Unlike the kprobe interface—where the kernel knows the symbol addresses of kernel functions—uprobes require the user to specify the file path and offset of the instruction(s) or function(s) to probe. The offset is calculated from the start of the executable or library file. Once attached, any process using that binary (including those that start in the future) is instrumented.</p>
<h3 id="uprobes">Uprobes<a class="td-heading-self-link" href="#uprobes" aria-label="Heading self-link"></a></h3>
<p>A uprobe is placed at a specific instruction in a user-space binary (e.g., a function’s entry point in an application or library). When that instruction executes, the CPU hits a breakpoint, and control is transferred to the kernel’s uprobes framework, which then calls the attached eBPF handler. This handler can inspect arguments (readable from user-space memory), task metadata, and more. uprobe eBPF programs are classified under the program type <code>BPF_PROG_TYPE_KPROBE</code>.</p>
<h4 id="how-uprobes-work-under-the-hood">How Uprobes Work Under the Hood<a class="td-heading-self-link" href="#how-uprobes-work-under-the-hood" aria-label="Heading self-link"></a></h4>
<ol>
<li>The user identifies the target function or instruction’s offset from the binary’s start. A breakpoint instruction (similar to kprobe’s approach) is inserted into the user-space code at runtime.</li>
<li>When a process executes that instruction, a trap occurs, switching to kernel mode where the uprobes framework runs the attached eBPF program.</li>
<li>The eBPF handler runs in the kernel but can read arguments and other data from user-space memory using <code>bpf_probe_read_user()</code> or related helpers. After the handler completes, uprobes single-step the replaced instruction and return execution control to user space.</li>
</ol>
<p><strong>Before uprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uprobe-before.png" alt="Centered image" />
</p>
<p><strong>After uprobe insertion:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uprobe-after.png" alt="Centered image" />
</p>
<p>We can get list of all symbols from object or binary files using <code>nm</code> or <code>objdump</code>, for example, to get list of all symbols from <code>/bin/bash</code> all we have to do is <code>nm -D /bin/bash</code> to get dynamic symbols because <code>/bin/bash</code> is stripped of debug symbols, so if you use <code>nm /bin/bash</code> you will get <code>nm: /bin/bash: no symbols</code>.
<code>objdump</code> can extract dynamic symbols using <code>objdump -T /bin/bash</code>. That&rsquo;s how the output looks in case of nm</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000000136828</span> D shell_builtins
</span></span><span style="display:flex;"><span>0000000000135cf8 D shell_compatibility_level
</span></span><span style="display:flex;"><span>000000000013d938 B shell_environment
</span></span><span style="display:flex;"><span>000000000013da90 B shell_eof_token
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000000048930</span> T shell_execve
</span></span><span style="display:flex;"><span>0000000000131b40 D shell_flags
</span></span><span style="display:flex;"><span>000000000013f270 B shell_function_defs
</span></span><span style="display:flex;"><span>000000000013f280 B shell_functions
</span></span><span style="display:flex;"><span>00000000000839e0 T shell_glob_filename
</span></span><span style="display:flex;"><span>000000000013d97c B shell_initialized
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000000032110</span> T shell_is_restricted
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>D or data symbols which represent initialized variable, while B or BSS symbols represent uninitialized global variables and T or text symbols represent code which we are interested in. Let&rsquo;s attach uprobe to entry point of <code>shell_execve</code> function. <code>shell_execve</code> has a prototype of <code>int shell_execve(char *filename, char **argv, char **envp);</code>  which is similar to <code>execve</code> syscall <code>man 2 execve</code> which has this prototype</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">_Nullable</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">_Nullable</span> <span style="color:#000">envp</span><span style="color:#000;font-weight:bold">[]);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>       pathname must be either a binary executable, or a script starting with a line of the form:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           <span style="color:#8f5902;font-style:italic">#!interpreter [optional-arg]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       argv  is an array of pointers to strings passed to the new program as its command-line ar‐
</span></span><span style="display:flex;"><span>       guments.  By convention, the first of these strings <span style="color:#ce5c00;font-weight:bold">(</span>i.e.,  argv<span style="color:#ce5c00;font-weight:bold">[</span>0<span style="color:#ce5c00;font-weight:bold">])</span>  should  contain  the
</span></span><span style="display:flex;"><span>       filename  associated with the file being executed.  The argv array must be terminated by a
</span></span><span style="display:flex;"><span>       null pointer.  <span style="color:#ce5c00;font-weight:bold">(</span>Thus, in the new program, argv<span style="color:#ce5c00;font-weight:bold">[</span>argc<span style="color:#ce5c00;font-weight:bold">]</span> will be a null pointer.<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       envp is an array of pointers to strings, conventionally of the form <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>value,  which  are
</span></span><span style="display:flex;"><span>       passed as the environment of the new program.  The envp array must be terminated by a null
</span></span><span style="display:flex;"><span>       pointer.
</span></span></code></pre></div><p>Starting with attache uprobe to <code>/bin/bash:shell_execve</code> and extract which command is being executed along with PID and send events to the user-space via ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//bin/bash:shell_execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uprobe_bash_shell_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We defined a ring buffer type of map with name <code>events</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we used <code>BPF_UPROBE</code> macro which is exactly like <code>BPF_KPROBE</code> which takes the first argument as a name for the function followed by any additional arguments you want to capture.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uprobe_bash_shell_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Then reserve space in eBPF ring buffer using <code>bpf_ringbuf_reserve</code> helper function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we copy filename into command member in evt structure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then we submit evt structure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The user-space code is similar to the one we did before in ksyscall.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;uprobe.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process ID: %d, Command: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">uprobe</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uprobe__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uprobe__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uprobe__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Listening for events...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uprobe__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s compile both codes and run the code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span><span style="display:flex;"><span>clang -g -O2 -target bpf -c uprobe-shell_execve.bpf.c -o uprobe.o
</span></span><span style="display:flex;"><span>sudo bpftool gen skeleton uprobe.o &gt; uprobe.skel.h
</span></span><span style="display:flex;"><span>clang -o loader loader.c -lbpf
</span></span><span style="display:flex;"><span>sudo ./loader
</span></span></code></pre></div><p>Open a new terminal and execute <code>bash &amp;</code> then <code>gdb -p PID</code> in my case <code>gdb -p 1923</code> then <code>disassemble shell_execve</code> and you will get something similar</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> disassemble shell_execve 
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">function</span> shell_execve:
</span></span><span style="display:flex;"><span>   0x00005601e928c930 &lt;+0&gt;:	int3
</span></span><span style="display:flex;"><span>   0x00005601e928c931 &lt;+1&gt;:	nop    %edx
</span></span><span style="display:flex;"><span>   0x00005601e928c934 &lt;+4&gt;:	push   %r15
</span></span><span style="display:flex;"><span>   0x00005601e928c936 &lt;+6&gt;:	push   %r14
</span></span><span style="display:flex;"><span>   0x00005601e928c938 &lt;+8&gt;:	push   %r13
</span></span><span style="display:flex;"><span>   0x00005601e928c93a &lt;+10&gt;:	mov    %rsi,%r13
</span></span><span style="display:flex;"><span>   0x00005601e928c93d &lt;+13&gt;:	push   %r12
</span></span><span style="display:flex;"><span>   0x00005601e928c93f &lt;+15&gt;:	push   %rbp
</span></span><span style="display:flex;"><span>   0x00005601e928c940 &lt;+16&gt;:	push   %rbx
</span></span><span style="display:flex;"><span>   0x00005601e928c941 &lt;+17&gt;:	mov    %rdi,%rbx
</span></span><span style="display:flex;"><span>   0x00005601e928c944 &lt;+20&gt;:	sub    <span style="color:#000">$0</span>xa8,%rsp
</span></span><span style="display:flex;"><span>   0x00005601e928c94b &lt;+27&gt;:	mov    %fs:0x28,%r14
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Notice <code>int3</code> at the entry point of <code>shell_execve</code> which is a software breakpoint set by uprobe. You will get also something similar on the loader terminal</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>libbpf: sec <span style="color:#4e9a06">&#39;uprobe//bin/bash:shell_execve&#39;</span>: found <span style="color:#0000cf;font-weight:bold">1</span> CO-RE relocations
</span></span><span style="display:flex;"><span>libbpf: CO-RE relocating <span style="color:#ce5c00;font-weight:bold">[</span>10<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs: found target candidate <span style="color:#ce5c00;font-weight:bold">[</span>136<span style="color:#ce5c00;font-weight:bold">]</span> struct pt_regs in <span style="color:#ce5c00;font-weight:bold">[</span>vmlinux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;uprobe_bash_shell_execve&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: &lt;byte_off&gt; [10] struct pt_regs.di (0:14 @ offset 112)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;uprobe_bash_shell_execve&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: matching candidate #0 &lt;byte_off&gt; [136] struct pt_regs.di (0:14 @ offset 112)</span>
</span></span><span style="display:flex;"><span>libbpf: prog <span style="color:#4e9a06">&#39;uprobe_bash_shell_execve&#39;</span>: relo <span style="color:#8f5902;font-style:italic">#0: patched insn #0 (LDX/ST/STX) off 112 -&gt; 112</span>
</span></span><span style="display:flex;"><span>libbpf: map <span style="color:#4e9a06">&#39;events&#39;</span>: created successfully, <span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>libbpf: elf: symbol address match <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">&#39;shell_execve&#39;</span> in <span style="color:#4e9a06">&#39;/bin/bash&#39;</span>: 0x48930
</span></span><span style="display:flex;"><span>Successfully started! Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Process ID: 1923, Command: /usr/bin/bash
</span></span><span style="display:flex;"><span>Process ID: 1924, Command: /usr/bin/gdb
</span></span></code></pre></div><p>Running it with strace <code>sudo strace -ebpf ./loader</code> to capture bpf() syscalls shows that the the <code>prog_type</code> is indeed <code>BPF_PROG_TYPE_KPROBE</code> and the <code>prog_name</code> is <code>uprobe_bash_shell_execve</code> and <code>map_type</code> is <code>BPF_MAP_TYPE_RINGBUF</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_MAP_CREATE, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">map_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_MAP_TYPE_RINGBUF, <span style="color:#000">key_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">value_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">max_entries</span><span style="color:#ce5c00;font-weight:bold">=</span>4096, <span style="color:#000">map_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">inner_map_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;events&#34;</span>, <span style="color:#000">map_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">btf_key_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">btf_vmlinux_value_type_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">map_extra</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 80<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_KPROBE, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>21, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55adbd3b0000, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;uprobe_bash_shell_execve&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_CGROUP_INET_INGRESS, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55adbd3ae7e0, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x55adbd3ae860, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>At this point i hope you got that you can uprobe your own code. Compile this code as <code>/tmp/test</code> and compile it <code>gcc -g test.c -o test</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">get_message</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;got uprobed!!&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_message</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>With eBPF code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//tmp/test:get_message&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">trace_my_function</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID %d </span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then you will get</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>            exam-3142    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...11 17712.082503: bpf_trace_printk: PID <span style="color:#0000cf;font-weight:bold">3142</span> 
</span></span></code></pre></div><h3 id="uretprobes">Uretprobes<a class="td-heading-self-link" href="#uretprobes" aria-label="Heading self-link"></a></h3>
<p>A uretprobe triggers when a user-space function returns. Just like kretprobes, uretprobes replace the function’s return address with a trampoline so that when the function completes, execution hits the trampoline first—invoking the eBPF return handler before returning to the actual caller. uprobe eBPF programs are also classified under the program type <code>BPF_PROG_TYPE_KPROBE</code>.</p>
<h4 id="how-uretprobes-work-under-the-hood">How Uretprobes Work Under the Hood<a class="td-heading-self-link" href="#how-uretprobes-work-under-the-hood" aria-label="Heading self-link"></a></h4>
<ol>
<li>When you register a uretprobe, a corresponding uprobe is placed at the function’s entry to record the return address and replace it with a trampoline.</li>
<li>At function entry, the uprobe saves the original return address and sets the trampoline address. An optional entry handler can run here, deciding if we should track this particular instance.</li>
<li>When the function returns, instead of going directly back to the caller, it hits the trampoline. The trampoline has its own probe, triggering the uretprobe handler. The handler can read the function’s return value, gather timing information, or finalize any data collected at entry.</li>
<li>The original return address is restored, and the application continues execution as if nothing happened.</li>
</ol>
<p><strong>Before uretprobe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uretprobe-before.png" alt="Centered image" />
</p>
<p><strong>After uretprobe installation:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uretprobe-after.png" alt="Centered image" />
</p>
<p>The <code>readline</code> function in <code>bash</code> reads the user&rsquo;s input from the terminal and returns a pointer to the string containing the text of the line read. Its prototype is:<br>
<code>char *readline (const char *prompt);</code>. You can use eBPF to capture or record the user input in <code>bash</code> by hooking into the return of the <code>readline</code> function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//bin/bash:readline&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uretprobe_readline</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Successfully started! Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Process ID: 1859, Command: cat /etc/passwd
</span></span><span style="display:flex;"><span>Process ID: 1859, Command: cat /etc/issue.net 
</span></span><span style="display:flex;"><span>Process ID: 1859, Command: ls -l 
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Uprobes can add overhead, especially when targeting high-frequency user-space functions (like <code>malloc()</code>). The overhead can compound significantly if millions of events occur per second, potentially causing a noticeable slowdown in the application.
Consider carefully which user-space functions to instrument and apply uprobes selectively, possibly in a test environment or only when diagnosing severe issues.

</div>

<p>Let&rsquo;s walk through some advanced examples: we will demonstrate how to capture the password entered in PAM and how to observe decrypted traffic without needing CA certificates, all using uprobes.<br>
PAM (Pluggable Authentication Modules) is a framework that offers a modular approach to authentication, making it easier to manage and secure the login process. During authentication, the <code>pam_get_user</code> function is responsible for obtaining the username from the session, while <code>pam_get_authtok</code> retrieves the corresponding password or token, ensuring that each step is handled securely and flexibly.<br>
The function prototype for pam_get_authtok is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pam_get_authtok</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">pam_handle_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pamh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">authtok</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prompt</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>According to the man page, this function returns the cached authentication token (for example, a password) if one is available, or it prompts the user to enter one if no token is cached. Upon successful return, the <code>**authtok</code> parameter will point to the value of the authentication token. This function is intended for internal use by Linux-PAM and PAM service modules.</p>
<p>The prototype for pam_get_user is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">pam_get_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">pam_handle_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pamh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prompt</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The <code>pam_get_user</code> function returns the name of the user specified by the pam_start function, which is responsible for creating the PAM context and initiating the PAM transaction. A pointer to the username is then returned as the contents of *user.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Please note that both <code>**authtok</code> in <code>pam_get_authtok</code> and <code>**user</code> in <code>pam_get_user</code> are pointers to pointers.

</div>

<p>To capture the password, we need to attach uprobe to libpam <code>/lib/x86_64-linux-gnu/libpam.so.0:pam_get_authtok</code> at the entry point and exit point, why entry point and exit point, short answer is that in <code>pam_get_authtok</code>  the password pointer (<code>**authtok</code>) isn’t fully assigned or valid at the start of the function. Instead, the function fills in that pointer somewhere inside (for example, prompting the user or retrieving from memory), so by the time the function returns, the pointer (and thus the password string) is set. Hence, a uretprobe (return probe) is the only reliable place to grab the final pointer to the password.<br>
The same goes for capturing the user, we need to attach uprobe to libpam <code>/lib/x86_64-linux-gnu/libpam.so.0:pam_get_user</code> at the entry point and exit point.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uprobe-pam.png" alt="Centered image" />
</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_PW_LEN 128
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_USER_LEN 64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_PW_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">username</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_USER_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">authtok_ptrs</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">user_ptrs</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libpam.so.0:pam_get_authtok&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pam_get_authtok_enter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pamh</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">authtok</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prompt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">atok_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">authtok</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">authtok_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">atok_ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libpam.so.0:pam_get_authtok&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pam_get_authtok_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">stored</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">authtok_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">stored</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">authtok_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">atok_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">atok_addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">atok_addr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">stored</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">atok_addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">atok_addr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libpam.so.0:pam_get_user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pam_get_user_enter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pamh</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prompt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">user_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user_ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libpam.so.0:pam_get_user&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pam_get_user_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">stored</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">stored</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user_ptrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">user_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">user_addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_addr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">stored</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user_addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">username</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">username</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">user_addr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, we defined <code>struct event</code> and then created two <code>BPF_MAP_TYPE_HASH</code> maps to process and hold the username and password passed by the functions. Since <code>**authtok</code> and <code>**user</code> are pointers to pointers, we need to call <code>bpf_probe_read_user</code> twice to correctly read the values.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdarg.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;pamcapture.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_PW_LEN 128
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_PW_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">username</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">---- PAM Password capture ----</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">username</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">---- PAM Password captured ----</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, COMM: %.*s, Password: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">---- PAM Uusername capture ----</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, username = %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">username</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pamcapture</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pamcapture__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pamcapture__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pamcapture__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PAM password capture attached! Press Ctrl-C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pamcapture__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The output should be similar to the following</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PAM password capture attached! Press Ctrl-C to exit.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---- PAM Uusername capture ----
</span></span><span style="display:flex;"><span>PID: 2663, <span style="color:#000">username</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---- PAM Password captured ----
</span></span><span style="display:flex;"><span>PID: 2663, COMM: sshd-session, Password: admin
</span></span></code></pre></div><p>Let&rsquo;s explore another example to show you the power of uprobe/uretprobe. Libssl is a core component of the OpenSSL library, providing implementations of the Secure Sockets Layer (SSL) and Transport Layer Security (TLS) protocols to enable secure communications over network by encrypting data. You can check the list of all functions by executing command like <code>nm</code> on <code>/lib/x86_64-linux-gnu/libssl.so.3</code> or whatever <code>libssl</code> version you have. Couple of its core functions are <code>SSL_read</code> and <code>SSL_write</code>.
<code>SSL_read</code> reads data from an SSL/TLS connection, decrypting it and storing the result in the buffer pointed to by <code>buf</code>. Here, <code>buf</code> is a pointer to user-space memory where the decrypted data is written. <code>SSL_read</code> has a prototype of:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">SSL_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SSL</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ssl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">num</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>SSL_write</code> function writes data to an SSL/TLS connection by encrypting the content of the buffer pointed to by <code>buf</code> and transmitting it. In this case, <code>buf</code> is a pointer to the user-space memory containing the plaintext data that will be encrypted. <code>SSL_write</code> has a prototype of:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">SSL_write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SSL</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ssl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">num</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Uprobes let you intercept user-space function calls at runtime. By attaching them to libssl&rsquo;s SSL_read and SSL_write, you capture data after it&rsquo;s decrypted (or before it&rsquo;s encrypted) inside the process memory. This means you get the plaintext data directly, without needing to use a CA to decrypt network traffic.<br>
To capture decrypted traffic for both ways (send and receive ), we need to attach uprobe at the entry point and the exit point for each function. You need to attach a probe at the entry point to capture the buffer pointer (the address of buf) as soon as the function is called, because that pointer is passed as an argument. Then, attaching a probe at the exit point lets you read the final data from that buffer after the function has processed it.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/uprobe-libssl.png" alt="Centered image" />
</p>
<p>The <code>curl</code> command on my ubuntu box is version <code>8.5.0</code> which still uses libssl</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -V
</span></span><span style="display:flex;"><span>curl 8.5.0 <span style="color:#ce5c00;font-weight:bold">(</span>x86_64-pc-linux-gnu<span style="color:#ce5c00;font-weight:bold">)</span> libcurl/8.5.0 OpenSSL/3.0.13 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 <span style="color:#ce5c00;font-weight:bold">(</span>+libidn2/2.3.7<span style="color:#ce5c00;font-weight:bold">)</span> libssh/0.10.6/openssl/zlib nghttp2/1.59.0 librtmp/2.3 OpenLDAP/2.6.7
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ldd /usr/bin/curl
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	libssl.so.3 <span style="color:#ce5c00;font-weight:bold">=</span>&gt; /lib/x86_64-linux-gnu/libssl.so.3 <span style="color:#ce5c00;font-weight:bold">(</span>0x00007a1b58443000<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Let&rsquo;s see the kernel code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_BUF_SIZE 4096
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_READ</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_WRITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">buffers</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#000">__u32</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ssl_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">bufp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">STATE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libssl.so.3:SSL_read&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_read_enter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ssl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">num</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libssl.so.3:SSL_read&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_read_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ssl_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STATE_READ</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libssl.so.3:SSL_write&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_write_enter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ssl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">num</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libssl.so.3:SSL_write&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_write_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ssl_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STATE_WRITE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The <code>ssl_exit</code> function retrieves the return value to determine if any data was processed and then uses the process ID (tgid) to look up the previously stored user-space buffer pointer. The function then reserves an event structure from the ring buffer, reads the actual data from user memory using <code>bpf_probe_read_user</code>, and finally submits the event while cleaning up the stored pointer from the BPF hash map.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The <code>__always_inline</code> macros is used to tell the compiler to inline a function.This means that rather than generating a normal function call, the compiler inserts the body of the function directly into the calling code.

</div>

<p>The user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;sslsniff.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_BUF_SIZE 4096
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_READ</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_WRITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">data_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_BUF_SIZE</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f57900">len</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir_str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">STATE</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">STATE_WRITE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#4e9a06">&#34;SEND&#34;</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RECV&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">--- Perf Event ---</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process: %s, Type: %d, Bytes: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dir_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Data (first %d bytes):</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_len</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fwrite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sslsniff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sslsniff__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sslsniff__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sslsniff__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;libssl sniffer attached. Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sslsniff__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Running curl command <code>curl https://www.hamza-megahed.com/robots.txt --http1.1</code> and we will get a similar traffic to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--- Perf Event ---
</span></span><span style="display:flex;"><span>Process: curl, Type: SEND, Bytes: <span style="color:#0000cf;font-weight:bold">94</span>
</span></span><span style="display:flex;"><span>Data <span style="color:#ce5c00;font-weight:bold">(</span>first <span style="color:#0000cf;font-weight:bold">94</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>GET /robots.txt HTTP/1.1
</span></span><span style="display:flex;"><span>Host: www.hamza-megahed.com
</span></span><span style="display:flex;"><span>User-Agent: curl/8.5.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- Perf Event ---
</span></span><span style="display:flex;"><span>Process: curl, Type: RECV, Bytes: <span style="color:#0000cf;font-weight:bold">1172</span>
</span></span><span style="display:flex;"><span>Data <span style="color:#ce5c00;font-weight:bold">(</span>first <span style="color:#0000cf;font-weight:bold">1172</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Date: Sun, <span style="color:#0000cf;font-weight:bold">02</span> Mar <span style="color:#0000cf;font-weight:bold">2025</span> 20:57:27 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/plain
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">66</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User-agent: *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sitemap: https://www.hamza-megahed.com/sitemap.xml
</span></span></code></pre></div><p>As you can see, the traffic is decrypted!</p>
<p>Now let&rsquo;s do the same to GnuTLS which has two functions gnutls_record_recv and gnutls_record_send
GnuTLS is a secure communications library that implements TLS/SSL protocols. Two core functions in this library are: <code>gnutls_record_recv</code> with prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">gnutls_record_recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">gnutls_session_t</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_size</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>gnutls_record_recv</code> function receives an encrypted record from a GnuTLS session, decrypts it, and writes the resulting plaintext into the user-provided buffer pointed to by data.</p>
<p>Function <code>gnutls_record_send</code> with prototype</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">gnutls_record_send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">gnutls_session_t</span> <span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_size</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>gnutls_record_send</code> function takes plaintext data from the user-provided buffer pointed to by data, encrypts it, and sends it over the network as an encrypted record.</p>
<p>I have another box with <code>curl</code> version <code>8.12.1</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl 8.12.1 <span style="color:#ce5c00;font-weight:bold">(</span>x86_64-pc-linux-gnu<span style="color:#ce5c00;font-weight:bold">)</span> libcurl/8.12.1 GnuTLS/3.8.9 zlib/1.3.1 brotli/1.1.0 zstd/1.5.6 libidn2/2.3.7 libpsl/0.21.2 libssh2/1.11.1 nghttp2/1.64.0 ngtcp2/1.9.1 nghttp3/1.6.0 librtmp/2.3 OpenLDAP/2.6.9
</span></span><span style="display:flex;"><span>Release-Date: 2025-02-13, security patched: 8.12.1-2
</span></span></code></pre></div><p>The location of  libgnutls linked to <code>curl</code> command can be obtained by running <code>ldd /usr/bin/curl</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>libgnutls.so.30 <span style="color:#ce5c00;font-weight:bold">=</span>&gt; /lib/x86_64-linux-gnu/libgnutls.so.30 <span style="color:#ce5c00;font-weight:bold">(</span>0x00007f82da200000<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter3/uprobe-libgnutls.png" alt="Centered image" />
</p>
<p>To capture the decrypted or plaintext data processed by these functions, you need to attach uprobes at both the entry and exit points of each function. Attaching a probe at the entry captures the buffer pointer as it is passed to the function, while attaching a probe at the exit allows you to read the final processed data from that buffer once the function has completed its work.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_BUF_SIZE 4096
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_READ</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_WRITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">buffers</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#000">__u32</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">record_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_RC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">bufp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">STATE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bufp</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_delete_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libgnutls.so.30:gnutls_record_recv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gnutls_record_recv_enter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">sizeofdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libgnutls.so.30:gnutls_record_recv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gnutls_record_recv_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">record_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STATE_READ</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uprobe//lib/x86_64-linux-gnu/libgnutls.so.30:gnutls_record_send&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_UPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gnutls_record_send_enter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">sizeofdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">tgid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_tgid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">buffers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tgid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uretprobe//lib/x86_64-linux-gnu/libgnutls.so.30:gnutls_record_send&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_URETPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gnutls_record_send_exit</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">record_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STATE_WRITE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;gnutls_sniffer.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_BUF_SIZE 4096
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_READ</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">STATE_WRITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">STATE</span> <span style="color:#000">STATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">data_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">MAX_BUF_SIZE</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f57900">len</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">MAX_BUF_SIZE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir_str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">STATE</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">STATE_WRITE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#4e9a06">&#34;SEND&#34;</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RECV&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">--- Perf Event ---</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process: %s, Type: %s, Bytes: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dir_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Data (first %d bytes):</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_len</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fwrite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data_len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stdout</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">gnutls_sniffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gnutls_sniffer__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gnutls_sniffer__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load/verify BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gnutls_sniffer__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GnuTLS sniffer attached. Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">gnutls_sniffer__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Same results</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>GnuTLS sniffer attached. Press Ctrl+C to exit.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- Perf Event ---
</span></span><span style="display:flex;"><span>Process: curl, Type: SEND, Bytes: <span style="color:#0000cf;font-weight:bold">95</span>
</span></span><span style="display:flex;"><span>Data <span style="color:#ce5c00;font-weight:bold">(</span>first <span style="color:#0000cf;font-weight:bold">95</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>GET /robots.txt HTTP/1.1
</span></span><span style="display:flex;"><span>Host: www.hamza-megahed.com
</span></span><span style="display:flex;"><span>User-Agent: curl/8.12.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- Perf Event ---
</span></span><span style="display:flex;"><span>Process: curl, Type: RECV, Bytes: <span style="color:#0000cf;font-weight:bold">1174</span>
</span></span><span style="display:flex;"><span>Data <span style="color:#ce5c00;font-weight:bold">(</span>first <span style="color:#0000cf;font-weight:bold">1174</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Date: Sun, <span style="color:#0000cf;font-weight:bold">02</span> Mar <span style="color:#0000cf;font-weight:bold">2025</span> 21:34:37 GMT
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User-agent: *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sitemap: https://www.hamza-megahed.com/sitemap.xml
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1b88c508e6f5ebe0cb712f275cf5d474">4.3 - Tracepoints</h1>
    <div class="lead">Stable versioned hooks inserted by kernel developers for common events.</div>
	<p>Tracepoints are static instrumentation points compiled into the kernel at code locations chosen by kernel developers. They are placed in meaningful logical places in the code—such as the allocation of memory, the scheduling of tasks, or network packet events—so that when enabled, they can provide consistent and stable data about kernel events. Unlike kprobes, which dynamically instrument arbitrary functions at runtime, tracepoints are predefined by the kernel and remain stable across kernel versions. This makes them a preferred interface whenever a suitable tracepoint is available for the event you are interested in. Tracepoint eBPF programs are classified under the program type <code>BPF_PROG_TYPE_TRACEPOINT</code>.</p>
<h3 id="how-tracepoints-work-under-the-hood">How Tracepoints Work Under the Hood<a class="td-heading-self-link" href="#how-tracepoints-work-under-the-hood" aria-label="Heading self-link"></a></h3>
<ul>
<li>At compile time, each tracepoint location in the kernel is reserved with a 5-byte NOP (on x86_64).</li>
<li>At runtime, if a tracepoint is enabled, the 5-byte NOP is patched into a 5-byte jump to the trampoline.</li>
<li>When the tracepoint is disabled (or the last callback is removed), the jump is reverted back to NOP, keeping overhead minimal.</li>
</ul>
<p><strong>Disabled tracepoint</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/tracepoint-before.png" alt="Centered image" />
</p>
<p><strong>Enabled tracepoint:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/tracepoint-after.png" alt="Centered image" />
</p>
<p>To list all available tracepoints in a Linux system, you can use either <code>sudo bpftrace -l 'tracepoint:*'</code> or <code>sudo ls /sys/kernel/debug/tracing/events/</code> directory or <code>/sys/kernel/tracing/available_events</code> file which contains a list of all available tracepoints on the system. The SEC name usually follows the format <code>tracepoint__&lt;category&gt;__&lt;name&gt;</code>, for example, <code>SEC(&quot;tracepoint/syscalls/sys_enter_unlinkat&quot;)</code>. Similarly, the context structure for tracepoints typically follows the naming convention <code>trace_event_raw_&lt;name&gt; </code>(e.g., <code>trace_event_raw_sys_enter</code> and <code>trace_event_raw_sys_exit</code>).</p>
<p>However, there are exceptions. For instance, in the libbpf-bootstrap example (<a href="https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/bootstrap.bpf.c)">https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/bootstrap.bpf.c)</a>, you’ll find:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tp/sched/sched_process_exit&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sched_process_template</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Here, based on the naming convention explained previously, the context name should be trace_event_raw_sched_process_exit rather than trace_event_raw_sched_process_template. You can verify the correct context by checking the <code>vmlinux.h</code> file.</p>
<p>Let&rsquo;s explore one of the defined tracepoints from the kernel source code <code>include/trace/events/net.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">DECLARE_EVENT_CLASS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_dev_template</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_STRUCT__entry</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__field</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span>		<span style="color:#000">skbaddr</span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__field</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span>	<span style="color:#000">len</span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__string</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>		<span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dev</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_fast_assign</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">skbaddr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">skb</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__assign_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dev=%s skbaddr=%p len=%u&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__get_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">skbaddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DEFINE_EVENT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_dev_template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">net_dev_queue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DEFINE_EVENT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_dev_template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">netif_receive_skb</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DEFINE_EVENT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_dev_template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">netif_rx</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Tracepoints are defined using macros like <code>DECLARE_EVENT_CLASS</code> and <code>DEFINE_EVENT</code>. For example, <code>netif_rx</code> is defined as a trace event that logs information about received packets.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">DEFINE_EVENT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_dev_template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">netif_rx</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>In <code>net/core/dev.c</code>, inside the <code>netif_rx_internal()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">netif_rx_internal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">net_timestamp_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">READ_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net_hotdata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tstamp_prequeue</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">skb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace_netif_rx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef CONFIG_RPS
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">static_branch_unlikely</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rps_needed</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">rps_dev_flow</span> <span style="color:#000">voidflow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rflow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">voidflow</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rcu_read_lock</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_rps_cpu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rflow</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">smp_processor_id</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">enqueue_to_backlog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rflow</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">last_qtail</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rcu_read_unlock</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[...]</span>
</span></span></code></pre></div><p>You can see <code>trace_netif_rx(skb);</code>. This call triggers the tracepoint event for packet reception which logs the event if tracing is enabled.<br>
Then by running <code>gdb /usr/lib/debug/boot/vmlinux-$(uname -r)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> disassemble netif_rx_internal
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">function</span> netif_rx_internal:
</span></span><span style="display:flex;"><span>   0xffffffff81a23d70 &lt;+0&gt;:	call   0xffffffff8108d360 &lt;__fentry__&gt;
</span></span><span style="display:flex;"><span>   0xffffffff81a23d75 &lt;+5&gt;:	push   %rbx
</span></span><span style="display:flex;"><span>   0xffffffff81a23d76 &lt;+6&gt;:	sub    <span style="color:#000">$0</span>x18,%rsp
</span></span><span style="display:flex;"><span>   0xffffffff81a23d7a &lt;+10&gt;:	mov    %gs:0x28,%rbx
</span></span><span style="display:flex;"><span>   0xffffffff81a23d83 &lt;+19&gt;:	mov    %rbx,0x10<span style="color:#ce5c00;font-weight:bold">(</span>%rsp<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0xffffffff81a23d88 &lt;+24&gt;:	mov    %rdi,%rbx
</span></span><span style="display:flex;"><span>   0xffffffff81a23d8b &lt;+27&gt;:	xchg   %ax,%ax
</span></span><span style="display:flex;"><span>   0xffffffff81a23d8d &lt;+29&gt;:	nopl   0x0<span style="color:#ce5c00;font-weight:bold">(</span>%rax,%rax,1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0xffffffff81a23d92 &lt;+34&gt;:	xchg   %ax,%ax
</span></span><span style="display:flex;"><span>   0xffffffff81a23d94 &lt;+36&gt;:	mov    %gs:0x7e611471<span style="color:#ce5c00;font-weight:bold">(</span>%rip<span style="color:#ce5c00;font-weight:bold">)</span>,%esi        <span style="color:#8f5902;font-style:italic"># 0x3520c &lt;pcpu_hot+12&gt;</span>
</span></span><span style="display:flex;"><span>   0xffffffff81a23d9b &lt;+43&gt;:	mov    %rbx,%rdi
</span></span><span style="display:flex;"><span>   0xffffffff81a23d9e &lt;+46&gt;:	lea    0x8<span style="color:#ce5c00;font-weight:bold">(</span>%rsp<span style="color:#ce5c00;font-weight:bold">)</span>,%rdx
</span></span><span style="display:flex;"><span>   0xffffffff81a23da3 &lt;+51&gt;:	call   0xffffffff81a239e0 &lt;enqueue_to_backlog&gt;
</span></span><span style="display:flex;"><span>   0xffffffff81a23da8 &lt;+56&gt;:	mov    %eax,%ebx
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The disassembly confirms that at address &lt;+29&gt; you see a reserved 5-byte NOP (shown as <code>nopl 0x0(%rax,%rax,1)</code>). This placeholder is exactly what the kernel uses for its dynamic patching mechanism—when the tracepoint (or static call) is enabled, that NOP will be patched into a jump to the corresponding trampoline (and ultimately to the tracepoint handler).<br>
In the next example, we will examine <code>unlinkat</code> syscall entry point (which removes a directory entry relative to a directory file descriptor) with context <code>trace_event_raw_sys_enter</code> , but what exactly is the content of <code>struct trace_event_raw_sys_enter</code>. We can get the content by searching the <code>vmlinux.h</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_entry</span> <span style="color:#000">ent</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">__data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Using <code>trace_event_raw_sys_enter</code> as context supports BTF. You can also define the context by using the old approach by defining a structure matching the same parameters defined in the <code>format</code> file. For example, for the <code>unlinkat</code> syscall, this file is located at  <code>/sys/kernel/debug/tracing/events/syscalls/sys_enter_unlinkat/format</code> which has the following content</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>name: sys_enter_unlinkat
</span></span><span style="display:flex;"><span>ID: <span style="color:#0000cf;font-weight:bold">849</span>
</span></span><span style="display:flex;"><span>format:
</span></span><span style="display:flex;"><span>	field:unsigned short common_type<span style="color:#000;font-weight:bold">;</span>	offset:0<span style="color:#000;font-weight:bold">;</span>	size:2<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_flags<span style="color:#000;font-weight:bold">;</span>	offset:2<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_preempt_count<span style="color:#000;font-weight:bold">;</span>	offset:3<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int common_pid<span style="color:#000;font-weight:bold">;</span>	offset:4<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	field:int __syscall_nr<span style="color:#000;font-weight:bold">;</span>	offset:8<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int dfd<span style="color:#000;font-weight:bold">;</span>	offset:16<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:const char * pathname<span style="color:#000;font-weight:bold">;</span>	offset:24<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int flag<span style="color:#000;font-weight:bold">;</span>	offset:32<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print fmt: <span style="color:#4e9a06">&#34;dfd: 0x%08lx, pathname: 0x%08lx, flag: 0x%08lx&#34;</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;dfd<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;pathname<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;flag<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>Based on this information, we can deduce that the corresponding structure looks like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter_unlinkat</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">pathname_ptr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Then the program can use a pointer of type of that structure as context as in <code>int trace_unlinkat(struct trace_event_raw_sys_enter_unlinkat* ctx)</code> However,  this approach is not ideal at all for portability.</p>
<p>If we look at the prototype <code>int unlinkat(int dirfd, const char *pathname, int flags);</code> which takes the following parameters:
<strong>dirfd:</strong> This is a directory file descriptor. When the pathname provided is relative, it’s interpreted relative to this directory.
<strong>pathname:</strong> This is the path of the file or directory to remove. If the pathname is absolute (starts with a <code>/</code>), the <code>dirfd</code> parameter is ignored.
<strong>flags:</strong> This parameter allows you to modify the behavior of the call. Typically, it is set to 0 for removing files. If you want to remove a directory, you must include the <code>AT_REMOVEDIR</code> flag, which tells the system to remove the directory instead of a regular file.</p>
<p>Let&rsquo;s attach a probe to the entry point of the unlinkat syscall. As you&rsquo;ll see, using more examples makes the process even easier.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_unlinkat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_unlinkat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We captured the pathname by accessing the second argument (pathname is the second argument in unlinkat syscall) in the context&rsquo;s args array, as shown in:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span></code></pre></div><p>By creating and removing files and directories, you should see similar output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Successfully started! Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Process ID: 1899, Command: rm, Filename: test1
</span></span><span style="display:flex;"><span>Process ID: 1914, Command: rm, Filename: test2
</span></span><span style="display:flex;"><span>Process ID: 1918, Command: rm, Filename: test3
</span></span></code></pre></div><p>As you saw, there tremendous amount of possibilities of using such probes, such as using <code>tracepoint:syscalls:sys_enter_connect</code> which allows you to monitor when a process initiates a network connection using the <code>connect()</code> system call, and this is just the tip of the iceberg.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f9883a7f15f27e0b3f9403a187ec6e4">4.4 - Raw Tracepoints</h1>
    <div class="lead">Lower level access when you need every byte of the event payload.</div>
	<p>Raw tracepoints provide a lower-level interface to the same static instrumentation points used by regular tracepoints, but without the overhead of argument type casting and stable ABI guarantees. Introduced in Linux 4.17 by Alexei Starovoitov. Whereas normal tracepoints provide a stable set of arguments, often cast into well-defined data structures, raw tracepoints give direct access to the arguments in the form used by the kernel’s tracepoint handler. This means there’s no guarantee about the argument layout staying consistent across kernel versions—if the kernel’s internal definition of the tracepoint changes, your raw tracepoint program must adapt. Raw tracepoints attach to the same kernel tracepoints as normal tracepoint-based BPF programs. You specify a raw tracepoint by name, just as you would a regular tracepoint, but you load the BPF program with a type that indicates you want raw access, such as <code>BPF_PROG_TYPE_TRACING</code> with a section prefix like <code>raw_tp/</code> or <code>tp_btf/</code>.</p>
<h3 id="how-raw-tracepoints-work-under-the-hood">How Raw Tracepoints Work Under the Hood<a class="td-heading-self-link" href="#how-raw-tracepoints-work-under-the-hood" aria-label="Heading self-link"></a></h3>
<p>Raw tracepoints use the same static jump patching mechanism as regular tracepoints, they differ in that they pass unformatted, low-level event data directly to the attached program.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/raw-tracepoint.png" alt="Centered image" />
</p>
<p>The list of all raw tracepoints are available at <code>/sys/kernel/debug/tracing/available_events</code> file</p>
<p>Raw tracepoints are not defined for each individual syscall but are provided as generic entry and exit points (such as sys_enter and sys_exit) for all system calls. Therefore, if you want to target a specific syscall, you must filter events by checking the syscall ID.</p>
<p>Raw tracepoint uses <code>bpf_raw_tracepoint_args</code> data structure as context which is defined in <code>include/uapi/linux/bpf.h</code>as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_raw_tracepoint_args</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>To get what args points to in case of <code>sys_enter</code> is by examining include/trace/events/syscalls.h</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">TRACE_EVENT_SYSCALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys_enter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_STRUCT__entry</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__field</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">,</span>		<span style="color:#000">id</span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__array</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">,</span>	<span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span>	<span style="color:#0000cf;font-weight:bold">6</span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_fast_assign</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">id</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syscall_get_arguments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">current</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NR %ld (%lx, %lx, %lx, %lx, %lx, %lx)&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syscall_regfunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall_unregfunc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>It has args as <code>args[0]</code> -&gt; points to <code>pt_regs</code> structure and <code>args[1]</code> is the syscall number.</p>
<p>To access the target syscalls&rsquo; parameters, you can either cast <code>ctx-&gt;args[0]</code> to a pointer to a <code>struct pt_regs</code> and use it directly, or copy its contents into a local variable of type <code>struct pt_regs</code> (e.g., <code>struct pt_regs regs;</code>). Then, you can extract the syscall parameters using the <code>PT_REGS_PARM</code> macros (such as <code>PT_REGS_PARM1</code>, <code>PT_REGS_PARM2</code>, etc.).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;raw_tracepoint/sys_enter&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_unlinkat_raw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_raw_tracepoint_args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#000">regs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The syscall number is stored in ctx-&gt;args[1]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">syscall_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall_id</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">263</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;rtp_unlinkat.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">volatile</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">exiting</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">sig_handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">signo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">exiting</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %u, COMM: %s, FILENAME: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">rtp_unlinkat</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_strict_mode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LIBBPF_STRICT_ALL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rtp_unlinkat__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rtp_unlinkat__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rtp_unlinkat__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to create ring buffer</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SIGINT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sig_handler</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting for events... Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">exiting</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error polling ring buffer: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rtp_unlinkat__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PID: 3440, COMM: rm, FILENAME: test1
</span></span><span style="display:flex;"><span>PID: 3442, COMM: rm, FILENAME: test2
</span></span></code></pre></div><p>Let&rsquo;s explore another example other than <code>sys_enter</code>. The following is raw tracepoint  <code>task_rename</code> which is triggered when a process change its command name. Detecting such activity is crucial in security field such as malware try to hide its true identity or mimic a trusted process such as using <code>prctl(PR_SET_NAME)</code> to change the name of comm.
By examining task_rename tracing event source code located in <code>include/trace/events/task.h</code>,we can see how the tracing mechanism is implemented:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">TRACE_EVENT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">task_rename</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_ARGS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_STRUCT__entry</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__field</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">pid_t</span><span style="color:#000;font-weight:bold">,</span>	<span style="color:#000">pid</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__array</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldcomm</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__array</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newcomm</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__field</span><span style="color:#000;font-weight:bold">(</span>	<span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">,</span>	<span style="color:#000">oom_score_adj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_fast_assign</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">oldcomm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">strscpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">newcomm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">oom_score_adj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">oom_score_adj</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TP_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pid=%d oldcomm=%s newcomm=%s oom_score_adj=%hd&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">oldcomm</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">newcomm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">oom_score_adj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>From <code>TP_PTORO</code>, we can see that the first argument <code>ctx-&gt;args[0]</code> is pointing to <code>struct task_struct *task</code> and the second <code>ctx-&gt;args[1]</code> argument is pointing to <code>const char *comm</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">TP_PROTO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>struct task_struct</code> data structure is defined in <code>include/linux/sched.h</code>. Let&rsquo;s see the following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef TASK_COMM_LEN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define TASK_COMM_LEN 16
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">parent_pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">new_comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">old_comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;raw_tracepoint/task_rename&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">raw_tracepoint_task_rename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_raw_tracepoint_args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">task</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">new_comm_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">parent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">task</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">real_parent</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">parent_pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">old_comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">old_comm</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">new_comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">new_comm</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">new_comm_ptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The first argument <code>ctx-&gt;args[0]</code> is pointing to <code>struct task_struct *task</code> and the second <code>ctx-&gt;args[1]</code> argument is pointing to <code>const char *comm</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">task</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_struct</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">new_comm_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;task_rename_ringbuf.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">parent_pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">new_comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">old_comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pid=%u, parent_pid=%u, new_comm=%s, old_comm=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">parent_pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">new_comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">old_comm</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">task_rename_ringbuf_bpf</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">task_rename_ringbuf_bpf__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">task_rename_ringbuf_bpf__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">task_rename_ringbuf_bpf__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">errno</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: failed to create ring buffer: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting for task_rename events... Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EINTR</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: polling ring buffer failed: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">task_rename_ringbuf_bpf__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now let&rsquo;s create a simple code to use <code>prctl(PR_SET_NAME)</code> to change comm name:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_GET_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_GET_NAME)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Current process name: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">fake_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;systemd&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">fake_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NAME)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">memset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_GET_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_GET_NAME)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process name changed to: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">current_name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile it using <code>gcc fake.c -o fake</code> then run it <code>./fake</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Waiting <span style="color:#204a87;font-weight:bold">for</span> task_rename events... Press Ctrl+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#000">pid</span><span style="color:#ce5c00;font-weight:bold">=</span>7839, <span style="color:#000">parent_pid</span><span style="color:#ce5c00;font-weight:bold">=</span>7478, <span style="color:#000">new_comm</span><span style="color:#ce5c00;font-weight:bold">=</span>fake, <span style="color:#000">old_comm</span><span style="color:#ce5c00;font-weight:bold">=</span>bash
</span></span><span style="display:flex;"><span><span style="color:#000">pid</span><span style="color:#ce5c00;font-weight:bold">=</span>7839, <span style="color:#000">parent_pid</span><span style="color:#ce5c00;font-weight:bold">=</span>7478, <span style="color:#000">new_comm</span><span style="color:#ce5c00;font-weight:bold">=</span>systemd, <span style="color:#000">old_comm</span><span style="color:#ce5c00;font-weight:bold">=</span>fake
</span></span></code></pre></div><p>Then process changed it&rsquo;s comm from fake to systemd. We can confirm by</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /proc/7839/comm
</span></span><span style="display:flex;"><span>systemd
</span></span></code></pre></div><p>Or using <code>top</code> command, <code>top --pid 7839</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>top - 04:57:06 up  4:42,  <span style="color:#0000cf;font-weight:bold">6</span> users,  load average: 0.02, 0.01, 0.00
</span></span><span style="display:flex;"><span>Tasks:   <span style="color:#0000cf;font-weight:bold">1</span> total,   <span style="color:#0000cf;font-weight:bold">0</span> running,   <span style="color:#0000cf;font-weight:bold">1</span> sleeping,   <span style="color:#0000cf;font-weight:bold">0</span> stopped,   <span style="color:#0000cf;font-weight:bold">0</span> zombie
</span></span><span style="display:flex;"><span>%Cpu<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>:  0.1 us,  0.1 sy,  0.0 ni, 99.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st 
</span></span><span style="display:flex;"><span>MiB Mem :   3921.3 total,   1481.0 free,   1199.2 used,   1534.0 buff/cache     
</span></span><span style="display:flex;"><span>MiB Swap:   3169.0 total,   3169.0 free,      0.0 used.   2722.1 avail Mem 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                       
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">7839</span> ebpf      <span style="color:#0000cf;font-weight:bold">20</span>   <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">2560</span>   <span style="color:#0000cf;font-weight:bold">1616</span>   <span style="color:#0000cf;font-weight:bold">1616</span> S   0.0   0.0   0:00.00 systemd
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-261561de9c95bc1adb21eae4a12787f1">4.5 - Fentry and Fexit</h1>
    <div class="lead">Modern low overhead probes attached directly to function start and return.</div>
	<h2 id="fentry">Fentry<a class="td-heading-self-link" href="#fentry" aria-label="Heading self-link"></a></h2>
<p>An fentry eBPF program is attached precisely at the entry point of a kernel function. Introduced in Linux kernel 5.5 , fentry uses a BPF trampoline to patch function entry points to invoke eBPF code. This results in minimal overhead compared to traditional <code>kprobe</code>.</p>
<ul>
<li>When a function is compiled with tracing support CONFIG_FUNCTION_TRACER, the compiler inserts a call to <code>__fentry__</code> at the beginning of the function which contains several <code>NOP</code> instructions <code>0x90</code>.</li>
<li>When an fentry eBPF program is attached, the kernel patches the NOPs dynamically—replacing it with a jump to a BPF trampoline.</li>
<li>The trampoline then efficiently invokes fentry handler (without the overhead of breakpoints or interrupts) and, after executing, returns control to the original function so that normal execution continues.
Fentry-based and fexit-based eBPF programs are classified under the program type <code>BPF_PROG_TYPE_TRACING</code>.
By looking at the entry is a kernel function such as <code>do_set_acl</code>. First we need to download debug symbols for the kernel, on debian just <code>sudo apt-get install linux-image-$(uname -r)-dbg</code> and the debug symbols will be at <code>/usr/lib/debug/boot/vmlinux-$(uname -r)</code>.
Getting the entry point of <code>do_set_acl</code> using <code>objdump -d vmlinux-$(uname -r) | grep -A 10 &quot;&lt;do_set_acl&gt;:&quot;</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ffffffff814d7d20</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">do_set_acl</span><span style="color:#ce5c00;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d20</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">f3</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e</span> <span style="color:#000">fa</span>          	<span style="color:#000">endbr64</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d24</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">e8</span> <span style="color:#0000cf;font-weight:bold">37</span> <span style="color:#0000cf;font-weight:bold">56</span> <span style="color:#000">bb</span> <span style="color:#000">ff</span>       	<span style="color:#000">call</span>   <span style="color:#000">ffffffff8108d360</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__fentry__</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d29</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">41</span> <span style="color:#0000cf;font-weight:bold">55</span>                	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r13</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d2b</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">49</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">d5</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rdx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r13</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d2e</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">41</span> <span style="color:#0000cf;font-weight:bold">54</span>                	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r12</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d30</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">49</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">f4</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rsi</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r12</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d33</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">55</span>                   	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d34</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">48</span> <span style="color:#0000cf;font-weight:bold">89</span> <span style="color:#000">fd</span>             	<span style="color:#000">mov</span>    <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rdi</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbp</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d37</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">53</span>                   	<span style="color:#000">push</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rbx</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff814d7d38</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000">d</span> <span style="color:#0000cf;font-weight:bold">85</span> <span style="color:#000">c0</span>             	<span style="color:#000">test</span>   <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">r8</span>
</span></span></code></pre></div><p>We can look at <code>__fentry__</code> using <code>objdump -d vmlinux-$(uname -r) | grep -A 15 &quot;&lt;__fentry__&gt;:&quot;</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ffffffff8108d360</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__fentry__</span><span style="color:#ce5c00;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d360</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">f3</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">e</span> <span style="color:#000">fa</span>          	<span style="color:#000">endbr64</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d364</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d365</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d366</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d367</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d368</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d369</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36a</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36b</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36c</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">90</span>                   	<span style="color:#000">nop</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d36d</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#000">e9</span> <span style="color:#000">ee</span> <span style="color:#000">de</span> <span style="color:#000">c6</span> <span style="color:#0000cf;font-weight:bold">00</span>       	<span style="color:#000">jmp</span>    <span style="color:#000">ffffffff81cfb260</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">__x86_return_thunk</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d372</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">66</span> <span style="color:#0000cf;font-weight:bold">66</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">e</span> <span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1f</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">00</span> 	<span style="color:#000">data16</span> <span style="color:#000">cs</span> <span style="color:#000">nopw</span> <span style="color:#0000cf;font-weight:bold">0x0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d379</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 
</span></span><span style="display:flex;"><span><span style="color:#f57900">ffffffff8108d37d</span><span style="color:#000;font-weight:bold">:</span>	<span style="color:#0000cf;font-weight:bold">0f</span> <span style="color:#0000cf;font-weight:bold">1f</span> <span style="color:#0000cf;font-weight:bold">00</span>             	<span style="color:#000">nopl</span>   <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">rax</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>Before inserting an fentry probe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-before.png" alt="Centered image" />
</p>
<p><strong>After inserting an fentry probe (with BPF trampoline):</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-after.png" alt="Centered image" />
</p>
<p>Let&rsquo;s see the following example, which attaches a probe to the entry of <code>do_set_acl</code> kernel function. <code>do_set_acl</code> is a kernel function that implements the setting of Access Control Lists (ACLs) on files and directories, enabling granular permission control beyond standard Unix permissions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fentry/do_set_acl&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handle_do_set_acl</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do_set_acl: dentry=%s, acl_name=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>do_set_acl</code> is defined in <code>fs/posix_acl.c</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">do_set_acl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We can also obtain the parameters using <code>sudo bpftrace -lv 'fentry:do_set_acl'</code> (bpftrace will be explained in details later):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fentry:vmlinux:do_set_acl
</span></span><span style="display:flex;"><span>    struct mnt_idmap * idmap
</span></span><span style="display:flex;"><span>    struct dentry * dentry
</span></span><span style="display:flex;"><span>    const char * acl_name
</span></span><span style="display:flex;"><span>    const void * kvalue
</span></span><span style="display:flex;"><span>    size_t size
</span></span><span style="display:flex;"><span>    int retval
</span></span></code></pre></div><p>user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;fentry.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fentry__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fentry__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Executing <code>setctl</code> to change ACL such as <code>setfacl -m u:test:rwx /tmp/file1</code> or <code>setfacl -m u:test:rwx /etc/passwd</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&lt;...&gt;-3776      <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>file1, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access
</span></span><span style="display:flex;"><span>setfacl-3777    <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>  do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>passwd, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access
</span></span></code></pre></div><h2 id="fexit">Fexit<a class="td-heading-self-link" href="#fexit" aria-label="Heading self-link"></a></h2>
<p>An fexit eBPF program is attached at the point when a kernel function returns (exits). Introduced alongside fentry, fexit programs also leverage the BPF trampoline. When you attach an fexit program, the kernel finds and patches the return instruction in the function to jump to BPF trampoline. That trampoline then calls your fexit handler before finally returning to the caller. Unlike traditional <code>kretprobe</code>, fexit programs have direct access to both the input parameters of the traced kernel function and its return value. Thus, you don&rsquo;t need to use additional maps or state tracking to record inputs before function execution.</p>
<p><strong>Before inserting an fexit probe:</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fexit-before.png" alt="Centered image" />
</p>
<p><strong>After inserting an fexit probe (with BPF trampoline):</strong></p>
<p style="text-align: center;">
  <img src="/images/docs/chapter3/fentry-after.png" alt="Centered image" />
</p>
<p>Let&rsquo;s explore the following example which is attach a probe to return of do_set_acl kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fexit/do_set_acl&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handle_do_set_acl</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mnt_idmap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">idmap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kvalue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>             <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">retval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">acl_name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do_set_acl: dentry=%s, acl_name=%s, retval=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">acl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">retval</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>user-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;fexit.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fexit</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fexit__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fexit__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>setfacl-3861 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>file1, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access, <span style="color:#000">retval</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;...&gt;-3862 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> do_set_acl: <span style="color:#000">dentry</span><span style="color:#ce5c00;font-weight:bold">=</span>passwd, <span style="color:#000">acl_name</span><span style="color:#ce5c00;font-weight:bold">=</span>system.posix_acl_access, <span style="color:#000">retval</span><span style="color:#ce5c00;font-weight:bold">=</span>-1
</span></span></code></pre></div><p>Fexit programs have direct access to both the input parameters of the traced kernel function and its return value.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-25679eb65c0e8dfb7e8ace4c60fe07cc">5 - Networking with eBPF</h1>
    <div class="lead">All the packet path hooks you need to shape traffic build firewalls or speed up data planes.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f879d53037865bc2c79335c3051f33b8">5.1 - Socket Filter</h1>
    <div class="lead">Classic filtering on a socket before data reaches user space.</div>
	<p>We saw socket filter program type definition in previous chapter, a <code>SOCKET_FILTER</code> type program executes whenever a packet arrives at the socket it is attached to give you access to examine all packets passed through the socket and can&rsquo;t give you control to modify packets and believe me, it&rsquo;s easier than you think, all you have to do is to look at the the entire packet structure as we will see. Socket filter eBPF programs are classified under the program type <code>BPF_PROG_TYPE_SOCKET_FILTER</code>.</p>
<p>The socket buffer (or <code>sk_buff</code>) is the primary structure used within the Linux kernel to represent network packets. It stores not only the packet data itself but also various metadata such as header pointers, packet lengths, protocol information, and state flags. <code>sk_buff</code> is defined in <code>include/linux/skbuff.h</code> and it has four major pointers:</p>
<ol>
<li>head: A pointer to the beginning of the allocated memory buffer for the packet.</li>
<li>data: A pointer to the beginning of the valid packet data within the buffer.</li>
<li>tail: A pointer that marks the end of the valid data currently stored in the buffer.</li>
<li>end: A pointer to the end of the allocated memory region.</li>
</ol>
<p>These four pointers provide the framework for managing the packet data within a single contiguous memory allocation. The sk_buff&rsquo;s allocated memory region divided into several logical segments that these pointers describe:</p>
<ol>
<li>Headroom: Space before the packet data for prepending headers.</li>
<li>Data: The actual packet contents (headers and payload).</li>
<li>Tailroom: Space after the packet data for appending headers or trailers.</li>
<li>skb_shared_info: Metadata structure for reference counting, fragments, and other shared data.</li>
</ol>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-sk_buff.png" alt="Centered image" />
</p>
<p><code>__sk_buff</code> data structure is a simplified version of <code>sk_buff</code> structure that’s exposed to eBPF programs. It provides a subset of information about a network packet that eBPF programs can use to inspect, filter, or even modify packets without needing access to all the internals of the full <code>sk_buff</code>.</p>
<p><code>__sk_buff</code> used as context for eBPF programs such as in socket filter programs. <code>__sk_buff</code> is defined in <code>include/uapi/linux/bpf.h</code> as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">pkt_type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">mark</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">queue_mapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">vlan_present</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">vlan_tci</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">vlan_proto</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">priority</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">ingress_ifindex</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">tc_index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">cb</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">tc_classid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">napi_id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">remote_ip4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">local_ip4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">remote_ip6</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">local_ip6</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">remote_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">local_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">data_meta</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__bpf_md_ptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_flow_keys</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flow_keys</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">tstamp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">wire_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">gso_segs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__bpf_md_ptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_sock</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sk</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">gso_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u8</span>  <span style="color:#000">tstamp_type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f57900">__u32</span> <span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">hwtstamp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Therefore, to detect an ICMP echo request packet (as in the following example), you need to perform the following checks: first, verify that it&rsquo;s an IPv4 packet. If it is, then confirm that the protocol is ICMP. Finally, check if the ICMP type is an echo request or an echo reply all of that is just by reading <code>__sk_buff</code> using <code>bpf_skb_load_bytes</code> . <code>bpf_skb_load_bytes</code>  is a helper function which can be used to load <code>data</code> from a packet and it has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">`</span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">26</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">`</span>
</span></span></code></pre></div><p><code>bpf_skb_load_bytes</code> takes a pointer to <code>sk_buff</code> , offset which means which part of the packet you want to load or extract, a pointer to a location where you want to store the loaded or extracted data and finally, the length you want to extract.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_TYPE     12 </span><span style="color:#8f5902;font-style:italic">// EtherType
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ETH_HLEN     14 </span><span style="color:#8f5902;font-style:italic">// ETH header length 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ICMP_LEN     34 </span><span style="color:#8f5902;font-style:italic">// ICMP header start point
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ETH_P_IP     0x0800 </span><span style="color:#8f5902;font-style:italic">// Internet Protocol packet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define IPPROTO_ICMP 1 </span><span style="color:#8f5902;font-style:italic">// Echo request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;socket&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">icmp_filter_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_TYPE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_HLEN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">ip_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_HLEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ip_proto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_proto</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_ICMP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">icmp_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ICMP_LEN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">icmp_type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">icmp_type</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">icmp_type</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We need to keep the following diagram in front of us to understand this code:</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-example1-1.png" alt="Centered image" />
</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_TYPE     12 </span><span style="color:#8f5902;font-style:italic">// EtherType
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ETH_HLEN     14 </span><span style="color:#8f5902;font-style:italic">// ETH header length 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ICMP_LEN     34 </span><span style="color:#8f5902;font-style:italic">// ICMP header start point
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define ETH_P_IP     0x0800 </span><span style="color:#8f5902;font-style:italic">// Internet Protocol packet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define IPPROTO_ICMP 1 </span><span style="color:#8f5902;font-style:italic">// Echo request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;socket&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">icmp_filter_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_TYPE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, we defined Ethernet type , Ethernet header length which is the start point of IP header, ICMP header length (Ethernet header length + IP header length). The program is defined as socket as you can see in SEC, then <code>__sk_buff</code> as context.
The first thing to is extract Ethernet type to determine of the packet is IP packet or not, all we need to do is get the following place in Ethernet header</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-example1-2.png" alt="Centered image" />
</p>
<p><code>bpf_skb_load_bytes</code> helper function will do that <code>bpf_skb_load_bytes(skb, ETH_TYPE, &amp;eth_proto, sizeof(eth_proto))</code>, it will extract EtherType for us and save the output in <code>eth_proto</code>. We define <code>eth_proto</code> as <code>__u16</code> which is unsigned 16-bit integer and that&rsquo;s why <code>bpf_skb_load_bytes</code> will extract in that case 2 bytes because we specified the length we need as <code>sizeof(eth_proto)</code>.
Then we used <code>bpf_ntohs</code> macro which used to convert multi-byte values like EtherType, IP addresses, and port numbers from network byte order (big-endian) to host byte order, then we we perform out check if the packet is IP packet by comparing the retrieved value with 0x0800 which represent IP EtherType, as defined in the <code>/include/uapi/linux/if_ether.h</code> kernel source code. If the value does not match, the code will drop the packet from the socket.</p>
<p>The same concept goes with IP version part:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_HLEN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-example1-3.png" alt="Centered image" />
</p>
<p>We need to extract the first 1 byte (<code>__u8</code>) of the IP header. The top nibble (the first 4 bits) is the version of IP <code>ip_version = ip_version &gt;&gt; 4</code> followed by checking if the version is 4 or drop the packet from the socket. Then we need to move to Protocol field in IP header to check if the packet is ICMP by comparing the retrieved value with 1 which represents ICMP as defined in <code>/include/uapi/linux/in.h</code> kernel source code. If the value does not match, the code will drop the packet from the socket.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    We assumed that IP header has fixed size 20 byes just for the sake of simplifying, but in reality you should check IP header size from Ver/IHL first.

</div>
</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-example1-4.png" alt="Centered image" />
</p>
<p>Then the last part is moving to the first byte of ICMP header and check if the packet is echo request or drop the packet from the socket.  and final like <code>return skb-&gt;len</code> indicated that the packet should be accepted and passed along to user space or to further processing. Let&rsquo;s move to the user-space code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;arpa/inet.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/socket.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;net/ethernet.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;icmp_socket_filter.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">icmp_socket_filter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">icmp_socket_filter__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">icmp_socket_filter__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">icmp_filter_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to get program FD</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AF_PACKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOCK_RAW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_ALL</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error creating raw socket: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setsockopt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SO_ATTACH_BPF</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;setsockopt(SO_ATTACH_BPF) failed: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Only ICMP Echo Requests (ping) will be seen by this raw socket.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received %zd bytes (ICMP echo request) on this socket</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">icmp_socket_filter__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We made a few modifications to the user-space file , instead of attaching the eBPF program directly, we first,retrieve the file descriptor of the loaded eBPF program as shown below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">icmp_filter_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to get program FD</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The next step is creating a socket as shown in the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AF_PACKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOCK_RAW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_ALL</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error creating raw socket: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Finally, attach the file descriptor of the loaded eBPF program to the created socket as in the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setsockopt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SO_ATTACH_BPF</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;setsockopt(SO_ATTACH_BPF) failed: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile the eBPF program, then generate skeleton file. After that, compile the loader. Start the program and ping from the same machine or from an external machine. You should see output similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Only ICMP Echo Requests <span style="color:#ce5c00;font-weight:bold">(</span>ping<span style="color:#ce5c00;font-weight:bold">)</span> will be seen by this raw socket.
</span></span><span style="display:flex;"><span>Received <span style="color:#0000cf;font-weight:bold">98</span> bytes <span style="color:#ce5c00;font-weight:bold">(</span>ICMP <span style="color:#204a87">echo</span> request<span style="color:#ce5c00;font-weight:bold">)</span> on this socket
</span></span><span style="display:flex;"><span>Received <span style="color:#0000cf;font-weight:bold">98</span> bytes <span style="color:#ce5c00;font-weight:bold">(</span>ICMP <span style="color:#204a87">echo</span> request<span style="color:#ce5c00;font-weight:bold">)</span> on this socket
</span></span><span style="display:flex;"><span>Received <span style="color:#0000cf;font-weight:bold">98</span> bytes <span style="color:#ce5c00;font-weight:bold">(</span>ICMP <span style="color:#204a87">echo</span> request<span style="color:#ce5c00;font-weight:bold">)</span> on this socket
</span></span><span style="display:flex;"><span>Received <span style="color:#0000cf;font-weight:bold">98</span> bytes <span style="color:#ce5c00;font-weight:bold">(</span>ICMP <span style="color:#204a87">echo</span> request<span style="color:#ce5c00;font-weight:bold">)</span> on this socket
</span></span><span style="display:flex;"><span>Received <span style="color:#0000cf;font-weight:bold">98</span> bytes <span style="color:#ce5c00;font-weight:bold">(</span>ICMP <span style="color:#204a87">echo</span> request<span style="color:#ce5c00;font-weight:bold">)</span> on this socket
</span></span></code></pre></div><p>Let&rsquo;s demonstrate another simple example and yet has important benefits which is extracting a keyword from HTTP request by storing only 64 bytes from the request&rsquo;s TCP payload in a buffer and searching that buffer. The buffer size significantly reduced so we don&rsquo;t need to address IP fragmentation. By performing some checks as we did in the previous example until we get to the TCP payload and search in it by a magic word.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_TYPE     12
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_HLEN     14
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ETH_P_IP     0x0800  </span><span style="color:#8f5902;font-style:italic">// IPv4 EtherType
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#define IPPROTO_TCP  6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define TCP_LEN      34 </span><span style="color:#8f5902;font-style:italic">// TCP header start point
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define HTTP_PORT    8080
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define HTTP_PAYLOAD_READ_LEN 64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">search_substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcp_buff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">tcp_buff_len</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">magic_word_len</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">tcp_buff_len</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">magic_word_len</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tcp_buff_len</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">tcp_buff_len</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcp_buff</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;socket&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">http_filter_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;l33t&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_TYPE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_HLEN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_version</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">ip_proto</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_HLEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ip_proto</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_proto</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ip_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TCP_LEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tcp_hdr_len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TCP_LEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">dport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">HTTP_PORT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">tcp_hdr_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">http_buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">HTTP_PAYLOAD_READ_LEN</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TCP_LEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">tcp_hdr_len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http_buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http_buf</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;packet </span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">%s&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">http_buf</span> <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">search_substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http_buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HTTP_PAYLOAD_READ_LEN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ALERT: Magic Word Found in the HTTP request payload</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Keep the following diagram in front of you to understand this code:</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/socket-example2-1.png" alt="Centered image" />
</p>
<p>A simple search function is added to search for &ldquo;l33t&rdquo; in TCP payload, it can be sent via GET request such as <code>/?id=l33t</code>. The function, <code>search_substring</code>, perfroms a basic substring search algorithm. Due to its <code>__always_inline</code> attribute, this function offers performance benefits. The function takes the payload buffer, its length, the search term, and its length as input. It returns 1 if the search term is found within the payload, and 0 otherwise. This allows for simple pattern-based filtering of network traffic within our the eBPF program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">search_substring</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcp_buff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">tcp_buff_len</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">magic_word_len</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">tcp_buff_len</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">magic_word_len</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tcp_buff_len</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">tcp_buff_len</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcp_buff</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">magic_word</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">magic_word_len</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Calculating TCP header size is important because we need to know where TCP payload data begins as the size of TCP header is not fixed as in the most cases of IP header due to TCP options.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">__u8</span> <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TCP_LEN</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tcp_hdr_len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    IP header has options too but in most cases the IP header size is 20 bytes, parsing IHL in IP header will give the exact size of IP header size.

</div>

<p>Let&rsquo;s move to user-space code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;arpa/inet.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/socket.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;net/ethernet.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BPF_OBJ_FILE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http_extract.o&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_object</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_program</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__open_file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_OBJ_FILE</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error opening BPF object file</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error loading BPF object: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__find_program_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;http_filter_prog&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error finding BPF program by name.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error getting program FD.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AF_PACKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOCK_RAW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_ALL</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error creating raw socket: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setsockopt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SO_ATTACH_BPF</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;setsockopt(SO_ATTACH_BPF) failed: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BPF socket filter attached. It will detect HTTP methods on port 80.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received %zd bytes on this socket</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sock_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The first 4 bits of <code>Offset/Flags</code> field in TCP header contains the size of the TCP header <code> tcp_hdr_len &gt;&gt;= 4</code> then multiplies the value by 4 to convert the header length from 32-bit words to bytes. Compile and start the program then start HTTP server on your machine on port 8080 or change  <code>HTTP_PORT</code> from the code, you can use python</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3 -m http.server <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span></code></pre></div><p>Then curl from another box</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl http://192.168.1.2:8080/index.html?id<span style="color:#ce5c00;font-weight:bold">=</span>l33t
</span></span></code></pre></div><p>And you will get similar results because we entered the magic word which is <code>l33t</code> in our request.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>GET /index.html?id<span style="color:#ce5c00;font-weight:bold">=</span>l33t HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.1.2:8080
</span></span><span style="display:flex;"><span>    sshd-session-1423    <span style="color:#ce5c00;font-weight:bold">[</span>000<span style="color:#ce5c00;font-weight:bold">]</span> ..s11 28817.447546: bpf_trace_printk: ALERT: Magic Word Found in the HTTP request payload
</span></span></code></pre></div><p>This program&rsquo;s ability to inspect network traffic is crucial for intrusion detection and web application firewalls. Its functionality enables security tools to identify suspicious patterns or malicious content as it passes through the network, allowing for proactive threat detection with minimal performance overhead.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9c945f0a156f58c4c58b74377e798e49">5.2 - Lightweight Tunnels</h1>
    <div class="lead">LWT IN OUT and XMIT hooks in the routing stack where eBPF can add or strip headers perform NAT or steer packets into overlays with minimal extra latency.</div>
	<p>Lightweight Tunnels (LWT) in the Linux kernel provides a way to handle network tunneling defined in <code>/net/core/lwtunnel.c</code>. Rather than being standalone protocols like TCP or UDP, these encapsulation types are identifiers used to select a specific method of wrapping packets for tunneling. For example, MPLS encapsulation wraps packets with an MPLS label stack, while SEG6 encapsulation uses an IPv6 Segment Routing header. The code below shows how these encapsulation types are mapped to human‐readable form:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">encap_type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_MPLS</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;MPLS&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_ILA</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ILA&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_SEG6</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;SEG6&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_BPF</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;BPF&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_SEG6_LOCAL</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;SEG6LOCAL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_RPL</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;RPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_IOAM6</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;IOAM6&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_XFRM</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_IP6</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_IP</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">LWTUNNEL_ENCAP_NONE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">__LWTUNNEL_ENCAP_MAX</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">WARN_ON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>There are four types of programs in eBPF to handle Lightweight Tunnels. Among them, <code>BPF_PROG_TYPE_LWT_IN</code> and <code>BPF_PROG_TYPE_LWT_OUT</code> are the most important. BPF_PROG_TYPE_LWT_IN can be attached to incoming path of Lightweight Tunnel  and uses &ldquo;lwt_in&rdquo; as section definition while <code>BPF_PROG_TYPE_LWT_OUT</code> can be attached the outgoing path of Lightweight Tunnel and used &ldquo;lwt_out&rdquo; as section definition. Both applications can add more control to the route by allowing or dropping of traffic and also inspect the traffic on a specific route but they are not allowed to modify. Information on the full capabilities of these LWT eBPF program types is limited, making them hard to fully explore.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Both LWT &ldquo;in&rdquo; and &ldquo;out&rdquo; programs run at a stage where the packet data has already been processed by the routing stack and the kernel has already stripped the Layer 2 (Ethernet) header. This means that the packet data passed to your eBPF program starts directly with the IP header.

</div>
</p>
<p>We can build a simple <code>BPF_PROG_TYPE_LWT_OUT</code> program for testing without the need to make Lightweight Tunnel. The idea of this program is to block outgoing 8080 connection from 10.0.0.2 to 10.0.0.3.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lwt_out&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_egress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping egress packet to port 8080</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_DROP</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Here we utilize another technique to access packet fields without manually calculating offsets for each field. For example, we defined <code>struct iphdr ip;</code> from <code>linux/ip.h</code> header which allows us to directly access protocol fields within IP header. <code>iphdr</code> structure has the following definition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(__LITTLE_ENDIAN_BITFIELD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__u8</span>	<span style="color:#f57900">ihl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined (__BIG_ENDIAN_BITFIELD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__u8</span>	<span style="color:#f57900">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  		<span style="color:#f57900">ihl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#error	&#34;Please fix &lt;asm/byteorder.h&gt;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__u8</span>	<span style="color:#000">tos</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">tot_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">frag_off</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u8</span>	<span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u8</span>	<span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__sum16</span>	<span style="color:#000">check</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__struct_group</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* no tag */</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addrs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">/* no attrs */</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__be32</span>	<span style="color:#000">saddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">__be32</span>	<span style="color:#000">daddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>This enables us to check if the packet is TCP using <code>if (ip.protocol != IPPROTO_TCP)</code>. If the packet is TCP, it passes the check with <code>BPF_OK</code> and proceeds to the next check.
<code>tcphdr</code>structure has the following definition in <code>linux/tcp.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">source</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">dest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be32</span>	<span style="color:#000">seq</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be32</span>	<span style="color:#000">ack_seq</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(__LITTLE_ENDIAN_BITFIELD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__u16</span>	<span style="color:#f57900">res1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">doff</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">fin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">syn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">rst</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">psh</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">ack</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">urg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">ece</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">cwr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__BIG_ENDIAN_BITFIELD)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__u16</span>	<span style="color:#f57900">doff</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">res1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">cwr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">ece</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">urg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">ack</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">psh</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">rst</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">syn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f57900">fin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#error	&#34;Adjust your &lt;asm/byteorder.h&gt; defines&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">__be16</span>	<span style="color:#000">window</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__sum16</span>	<span style="color:#000">check</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__be16</span>	<span style="color:#000">urg_ptr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>The final check is validating if the destination port is 8080 then it will drop the packet and print out message using <code>bpf_printk</code>.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The eBPF verifier requires explicit boundary checks to ensure that any access to packet data is safe. Without these checks, the verifier will reject your program, as it can&rsquo;t guarantee that your memory accesses remain within the valid packet boundaries.

</div>

<p>Compile the eBPF program and attach it to your interface or tunnel using something similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo ip route add 10.0.0.3/32 encap bpf out obj drop_egress_8080.o section lwt_out dev tun0
</span></span></code></pre></div><p>Next, setup a web server on the remote machine</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3 -m http.server <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span></code></pre></div><p>Then, from the eBPF machine run</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl http://10.0.0.3:8080/index.html
</span></span></code></pre></div><p>You should notice that the connection is dropped and messages in <code>/sys/kernel/debug/tracing/trace_pipe</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>          &lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s21  6747.667466: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>          &lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s21  6748.729064: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>          &lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s21  6749.753690: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>          &lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s21  6750.777898: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>            curl-3437    <span style="color:#ce5c00;font-weight:bold">[</span>001<span style="color:#ce5c00;font-weight:bold">]</span> b..11  8589.106765: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>          &lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>001<span style="color:#ce5c00;font-weight:bold">]</span> b.s31  8590.112358: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span></code></pre></div><p>This program for sure can be used to inspecting or monitoring, all you need to do is to replace <code>BPF_DROP</code> with <code>BPF_OK</code>. Now let&rsquo;s look at <code>BPF_PROG_TYPE_LWT_IN</code> programs which can be attached to incoming path of Lightweight Tunnel. Let&rsquo;s use the previous example and make some changes. Modifying the code to block ingress traffic originated from 10.0.0.3 on port 8080</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define TARGET_IP 0x0A000003  </span><span style="color:#8f5902;font-style:italic">// 10.0.0.3 in hexadecimal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lwt_in&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_ingress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">saddr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">bpf_htonl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TARGET_IP</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping ingress packet to port 8080 for IP 10.0.0.3</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_DROP</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">BPF_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile it then attach it using <code>sudo ip route replace table local local 10.0.0.2/32 encap bpf headroom 14 in obj drop_ingress_8080.o section lwt_in dev tun0</code>. Start a web server on eBPF machine , then from the other machine with IP address 10.0.0.3 run <code>curl http://10.0.0.2:8080</code>  and you should notice that the connection is dropped and messages in <code>/sys/kernel/debug/tracing/trace_pipe</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>000<span style="color:#ce5c00;font-weight:bold">]</span> b.s21    81.669152: bpf_trace_printk: Dropping ingress packet to port <span style="color:#0000cf;font-weight:bold">8080</span> <span style="color:#204a87;font-weight:bold">for</span> IP 10.0.0.3
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>000<span style="color:#ce5c00;font-weight:bold">]</span> b.s21    82.694440: bpf_trace_printk: Dropping ingress packet to port <span style="color:#0000cf;font-weight:bold">8080</span> <span style="color:#204a87;font-weight:bold">for</span> IP 10.0.0.3
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>000<span style="color:#ce5c00;font-weight:bold">]</span> b.s21    84.741651: bpf_trace_printk: Dropping ingress packet to port <span style="color:#0000cf;font-weight:bold">8080</span> <span style="color:#204a87;font-weight:bold">for</span> IP 10.0.0.3
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>000<span style="color:#ce5c00;font-weight:bold">]</span> b.s21    88.773985: bpf_trace_printk: Dropping ingress packet to port <span style="color:#0000cf;font-weight:bold">8080</span> <span style="color:#204a87;font-weight:bold">for</span> IP 10.0.0.3
</span></span></code></pre></div><p>I hope these two examples were easy and straightforward, and that LWT is now clearer. Next, we&rsquo;ll explore the Traffic Control subsystem, which can direct and manage traffic effectively.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4a36d5a41cd413ab4a54c502caa49c68">5.3 - Traffic Control</h1>
    <div class="lead">Ingress and egress shaping and filtering in the TC layer with cls bpf.</div>
	<p>Traffic Control subsystem is designed to schedule packets using a queuing system which controls the traffic direction and filtering. Traffic control can be used to filter traffic by applying rules and traffic shaping among other functions.
The core of traffic control is built around qdiscs which stands for queuing disciplines, qdiscs define the rules for how packets are handled by a queuing system. There are two types of qdiscs, classful and classless. classful qdiscs enable the creation of hierarchical queuing structures to facilitates the implementation of complex traffic management policies.
Classful qdiscs consist of two parts, filters and classes. The best definition is in the man page which says the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Queueing Discipline:
</span></span><span style="display:flex;"><span>qdisc is short for &#39;queueing discipline&#39; and it is elementary to understanding traffic control. Whenever the Kernel needs to send a packet to an interface, it is enqueued to the qdisc configured for that interface. Immediately afterwards, the Kernel tries to get as many packets as possible from the qdisc, for giving them to the network adaptor driver.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Classes:
</span></span><span style="display:flex;"><span>Some qdiscs can contain classes, which contain further qdiscs,traffic may then be enqueued in any of the inner qdiscs, which are within the classes.  When the kernel tries to dequeue a packet from such a classful qdisc it can come from any of the classes. A qdisc may for example prioritize certain kinds of traffic by trying to dequeue from certain classes before others.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Filters:
</span></span><span style="display:flex;"><span>A filter is used by a classful qdisc to determine in which class a packet will be enqueued. Whenever traffic arrives at a class with subclasses, it needs to be classified. Various methods may be employed to do so, one of these are the filters. All filters attached to the class are called, until one of them returns with a verdict. If no verdict was made, other criteria may be available. This differs per qdisc.
</span></span></code></pre></div><p>In essence: classful qdiscs have filters which are used to classify traffic and determine which class a packet should be placed in.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/tc-1.png" alt="Centered image" />
</p>
<p>Classless qdiscs are designed to operate as standalone queuing disciplines. classless qdiscs don&rsquo;t have children or classes which is impossible to attach a filters to it. eBPF filters are intended to work with classful qdiscs where they can classify packets into different classes. You can check which qdisc attached to your network devices is by using <code>ip</code> command or <code>sudo tc qdisc</code> shows the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>qdisc noqueue 0: dev lo root refcnt <span style="color:#0000cf;font-weight:bold">2</span> 
</span></span><span style="display:flex;"><span>qdisc fq_codel 0: dev enp1s0 root refcnt <span style="color:#0000cf;font-weight:bold">2</span> limit 10240p flows <span style="color:#0000cf;font-weight:bold">1024</span> quantum <span style="color:#0000cf;font-weight:bold">1514</span> target 5ms interval 100ms memory_limit 32Mb ecn drop_batch <span style="color:#0000cf;font-weight:bold">64</span> 
</span></span></code></pre></div><p><code>qdisc noqueue</code> on localhost which means no qdisc attached to the localhost which is normal.<code>qdisc fq_codel</code> is attached to the physical interface <code>enp1s0</code>. <code>qdisc fq_codel</code> stands for <code>Fair Queuing Controlled Delay</code> is queuing discipline that classifies data using a stochastic model that it uses a combination of fair queuing and delay control techniques to manage congestion to ensure the fairness of sharing the flow.
<code>limit 10240p</code> this is the queue size and if the limit exceeds this value, packet will start dropping.
<code>flows 1024</code> this is the number of flow for the incoming packets or the qdisc can track up to 1,024 separate flows.
<code>target 5ms</code> which is the acceptable minimum queue delay.
<code>memory_limit 32Mb</code> sets a limit on the total number of bytes that can be queued in this FQ-CoDel instance.
<code>drop_batch 64</code> sets the maximum number of packets to drop when limit or memory_limit is exceeded.</p>
<p>Traffic Control has two major components: classifiers and actions. Classifiers are used to inspect packets and decide if they match certain criteria, such as IP addresses, ports or protocols. They essentially sort packets into groups based on rules so that further processing can be applied to the appropriate packets.
Actions define what happens to a packet after it has been classified. Once a packet matches a rule, an action is executed on it—such as dropping the packet, changing its priority or redirecting it to another interface.</p>
<p>Traffic control eBPF programs are classified either as <code>BPF_PROG_TYPE_SCHED_CLS </code> with <code>SEC(&quot;tc&quot;) </code>or  <code>BPF_PROG_TYPE_SCHED_ACT</code> with <code>SEC(&quot;action/&quot;)</code>. <code>BPF_PROG_TYPE_SCHED_CLS</code> is often preferred, as it can function as both a classifier and an action executor when used with the direct-action flag. One key advantage is that these eBPF programs can be attached to both egress (outgoing) and ingress (incoming) traffic. This ability allows administrators to inspect, modify and filter packets in both directions.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    A single eBPF program instance can only be attached to either egress or ingress on a given interface, but separate instances can be deployed for each direction if needed.

</div>
</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/tc-diagram.png" alt="Centered image" />
</p>
<p>Actions and their corresponding values are defined in <code>include/uapi/linux/pkt_cls.h</code> kernel source code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_UNSPEC</span><span style="color:#f8f8f8;text-decoration:underline">	     </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_OK</span><span style="color:#f8f8f8;text-decoration:underline">		      </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_RECLASSIFY</span><span style="color:#f8f8f8;text-decoration:underline">	  </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_SHOT</span><span style="color:#f8f8f8;text-decoration:underline">		      </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_PIPE</span><span style="color:#f8f8f8;text-decoration:underline">		      </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_STOLEN</span><span style="color:#f8f8f8;text-decoration:underline">	   	  </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_QUEUED</span><span style="color:#f8f8f8;text-decoration:underline">		  </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_REPEAT</span><span style="color:#f8f8f8;text-decoration:underline">		  </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_REDIRECT</span><span style="color:#f8f8f8;text-decoration:underline">		  </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TC_ACT_TRAP</span><span style="color:#f8f8f8;text-decoration:underline">		      </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Actions and direct-action are defined in<br>
<a href="https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SCHED_CLS/#direct-action">https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SCHED_CLS/#direct-action</a> which stated as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Direct action
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>When attached in direct action mode, the eBPF program will act as both a classifier and an action. This mode simplifies setups for the most common use cases where we just want to always execute an action. In direct action mode the return value can be one of:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>* TC_ACT_UNSPEC (-1) - Signals that the default configured action should be taken.
</span></span><span style="display:flex;"><span>* TC_ACT_OK (0) - Signals that the packet should proceed.
</span></span><span style="display:flex;"><span>* TC_ACT_RECLASSIFY (1) - Signals that the packet has to re-start classification from the root qdisc. This is typically used after modifying the packet so its classification might have different results.
</span></span><span style="display:flex;"><span>* TC_ACT_SHOT (2) - Signals that the packet should be dropped, no other TC processing should happen.
</span></span><span style="display:flex;"><span>* TC_ACT_PIPE	(3) - While defined, this action should not be used and holds no particular meaning for eBPF classifiers.
</span></span><span style="display:flex;"><span>* TC_ACT_STOLEN (4) - While defined, this action should not be used and holds no particular meaning for eBPF classifiers.
</span></span><span style="display:flex;"><span>* TC_ACT_QUEUED (5) - While defined, this action should not be used and holds no particular meaning for eBPF classifiers.
</span></span><span style="display:flex;"><span>* TC_ACT_REPEAT (6) - While defined, this action should not be used and holds no particular meaning for eBPF classifiers.
</span></span><span style="display:flex;"><span>* TC_ACT_REDIRECT	(7) - Signals that the packet should be redirected, the details of how and where to are set as side effects by helpers functions.
</span></span></code></pre></div><p>Now, let&rsquo;s look at an example to fully understand the concepts discussed above. In the next example, we use <code>BPF_PROG_TYPE_SCHED_CLS</code> program but will allow us to take actions based on out classification using direct-action later. The code checks for packets on egress with port 8080 and drops them and send a message with <code>bpf_printk</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/pkt_cls.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tc&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_egress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping egress packet to port 8080</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_SHOT</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>As shown in the previous code, the program performs a chain of checks. For packets that are not of interest, it returns <code>TC_ACT_OK</code>, allowing them to proceed. However, if the final check detects that the destination port is 8080, it returns <code>TC_ACT_SHOT</code>, which means the packet should be dropped.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    When the eBPF program returns <code>TC_ACT_OK</code>, it signals that the packet should continue its normal processing in the networking stack, effectively &ldquo;exiting&rdquo; our code without any special intervention like dropping or redirecting it.

</div>
</p>
<p>Compile the code using LLVM/clang, then add the <code>clsact</code> qdisc, which enables hooking eBPF programs for both ingress (incoming) and egress (outgoing) traffic <code>sudo tc qdisc add dev qdisc clsact</code>
Next, attach the object file to the egress traffic with the direct-action flag: <code>sudo tc filter add dev enp1s0 egress bpf direct-action obj tc_drop_egress.o sec tc</code>. On a separate machine, start a web server on port 8080 using <code>python3 -m http.server 8080</code>. Back to the eBPF machine, executing a curl command <code>curl http://192.168.1.6:8080/</code> you will notice that traffic is being dropped and you can see the debug messages using <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code> or you could use <code>sudo tc exec bpf dbg</code> to show the debug messages, which might look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Running! Hang up with ^C!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl-1636    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b..1.  1735.290483: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s3.  1736.321969: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>001<span style="color:#ce5c00;font-weight:bold">]</span> b.s3.  1736.834411: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s3.  1737.346341: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s3.  1737.858194: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0       <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> b.s3.  1738.370403: bpf_trace_printk: Dropping egress packet to port <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span></code></pre></div><p>The attachment can be stopped by deleting the qdisc using <code>sudo tc qdisc del dev enp1s0 clsact</code>. I hope that Traffic Control is much clearer at this point.</p>
<p>If we want to set up a sensor to analyze traffic from a specific service or port, all we need to do is redirect that traffic using the <code>bpf_clone_redirect</code> helper function to a predefined interface for tapping. The cloning will allow us to monitor traffic with actively interfering or impacting performance. The redirected traffic can then be forwarded to traffic analysis tools such as Security Onion, Suricata, Snort, zeek, &hellip;etc. The <code>bpf_clone_redirect</code> helper function clones the packet and then redirects the clone to another interface, while the <code>bpf_redirect</code> helper function redirects the packet without cloning it. Both helper functions require the target interface&rsquo;s ifindex, which represents the interface ID.  <code>bpf_clone_redirect</code> helper function has a prototype as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">long</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_clone_redirect</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Cloning traffic not just for IPS/IDS , it can be also used to keep full packet capture (FPC) for later to be used in incident analysis or compromise assessment.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/tc-clone.png" alt="Centered image" />
</p>
<p>First, let&rsquo;s setup the interface by creating dummy interface <code>sudo ip link add dummy0 type dummy</code>, then bring the interface up using <code>sudo ip link set dummy0 up</code>, then verify the interface <code>ip link show dummy0</code> which gives similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>4: dummy0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue state UNKNOWN mode DEFAULT group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:aa:51:3c:b7:7b brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>The interface ID is 4. Now let&rsquo;s modify the previous code to allow the traffic on port 8080 while cloning it to the dummy interface with ID 4.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/pkt_cls.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tc&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">clone_egress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">target_ifindex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cloning packet to ifindex %d and allowing original packet</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">target_ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">bpf_clone_redirect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">target_ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile and attach the eBPF program then setup a web server as we did in the previous example. Next, start capturing the traffic on the dummy interface using <code>sudo tcpdump -i dummy0</code> then <code>curl http://192.168.1.6:8080/index.html</code> You should see <code>tcpdump</code> output similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tcpdump: verbose output suppressed, use -v<span style="color:#ce5c00;font-weight:bold">[</span>v<span style="color:#ce5c00;font-weight:bold">]</span>... <span style="color:#204a87;font-weight:bold">for</span> full protocol decode
</span></span><span style="display:flex;"><span>listening on dummy0, link-type EN10MB <span style="color:#ce5c00;font-weight:bold">(</span>Ethernet<span style="color:#ce5c00;font-weight:bold">)</span>, snapshot length <span style="color:#0000cf;font-weight:bold">262144</span> bytes
</span></span><span style="display:flex;"><span>23:12:53.941290 IP debian.58768 &gt; client-Standard-PC-Q35-ICH9-2009.http-alt: Flags <span style="color:#ce5c00;font-weight:bold">[</span>S<span style="color:#ce5c00;font-weight:bold">]</span>, seq 1415486505, win 64240, options <span style="color:#ce5c00;font-weight:bold">[</span>mss 1460,sackOK,TS val <span style="color:#0000cf;font-weight:bold">3409122040</span> ecr 0,nop,wscale 7<span style="color:#ce5c00;font-weight:bold">]</span>, length <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>23:12:53.941711 IP debian.58768 &gt; client-Standard-PC-Q35-ICH9-2009.http-alt: Flags <span style="color:#ce5c00;font-weight:bold">[</span>.<span style="color:#ce5c00;font-weight:bold">]</span>, ack 1257763673, win 502, options <span style="color:#ce5c00;font-weight:bold">[</span>nop,nop,TS val <span style="color:#0000cf;font-weight:bold">3409122040</span> ecr 2981277197<span style="color:#ce5c00;font-weight:bold">]</span>, length <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>23:12:53.941792 IP debian.58768 &gt; client-Standard-PC-Q35-ICH9-2009.http-alt: Flags <span style="color:#ce5c00;font-weight:bold">[</span>P.<span style="color:#ce5c00;font-weight:bold">]</span>, seq 0:93, ack 1, win 502, options <span style="color:#ce5c00;font-weight:bold">[</span>nop,nop,TS val <span style="color:#0000cf;font-weight:bold">3409122040</span> ecr 2981277197<span style="color:#ce5c00;font-weight:bold">]</span>, length 93: HTTP: GET /index.html HTTP/1.1
</span></span><span style="display:flex;"><span>23:12:53.942842 IP debian.58768 &gt; client-Standard-PC-Q35-ICH9-2009.http-alt: Flags <span style="color:#ce5c00;font-weight:bold">[</span>.<span style="color:#ce5c00;font-weight:bold">]</span>, ack 185, win 501, options <span style="color:#ce5c00;font-weight:bold">[</span>nop,nop,TS val <span style="color:#0000cf;font-weight:bold">3409122041</span> ecr 2981277198<span style="color:#ce5c00;font-weight:bold">]</span>, length <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>23:12:53.942980 IP debian.58768 &gt; client-Standard-PC-Q35-ICH9-2009.http-alt: Flags <span style="color:#ce5c00;font-weight:bold">[</span>F.<span style="color:#ce5c00;font-weight:bold">]</span>, seq 93, ack 188, win 501, options <span style="color:#ce5c00;font-weight:bold">[</span>nop,nop,TS val <span style="color:#0000cf;font-weight:bold">3409122041</span> ecr 2981277198<span style="color:#ce5c00;font-weight:bold">]</span>, length <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>The traffic captured on the dummy interface can then be analyzed by Suricata or any other network analysis and monitoring tool. The cloned traffic can also be sent to another NIC to be sent out to a sensor machine such as Security Onion server (forward nodes).</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/tc-clone2.png" alt="Centered image" />
</p>
<p>The next example demonstrates one of the capabilities of traffic control—manipulating traffic. In this example, the program will change the first 4 bytes of an HTTP response (initiated from port 8080) to &lsquo;XXXX&rsquo;. This means that instead of seeing &lsquo;HTTP/1.0&rsquo;, you would see &lsquo;XXXX/1.0&rsquo;.</p>
<p>The steps are as follows:</p>
<ol>
<li>Perform the necessary packet checks until you reach the TCP header.</li>
<li>Calculate the TCP header length to determine the exact offset of the payload.</li>
<li>Read the first 4 bytes of the payload.</li>
<li>Replace these 4 bytes with &lsquo;XXXX&rsquo; using the <code>bpf_skb_store_bytes</code> helper function.</li>
<li>Recalculate the checksum using the <code>bpf_l4_csum_replace</code> helper function.</li>
</ol>
<p><code>bpf_skb_store_bytes</code> helper function has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">long</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_skb_store_bytes</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>While <code>bpf_l4_csum_replace</code> helper function has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">long</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_l4_csum_replace</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u64</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/pkt_cls.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tc&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">modify_http_response</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">__sk_buff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">skb</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_hdr_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">tcp_hdr_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">doff</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">payload</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">tcp_hdr_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">payload</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// ensure there are at least 4 bytes in the payload
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_load_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">payload</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;H&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;T&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;T&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;P&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">new_val</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#39;X&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;X&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;X&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;X&#39;</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_skb_store_bytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">payload</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">new_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">tcp_csum_offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">check</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_l4_csum_replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tcp_csum_offset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">orig_val</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">__u64</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">new_val</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Modified HTTP response header from &#39;HTTP&#39; to &#39;XXXX&#39;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">TC_ACT_OK</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile the code and attach it on ingress traffic using <code>sudo tc filter add dev enp1s0 ingress bpf direct-action obj modify_http_response.o sec tc</code>.</p>
<p>Next, setup a web server on another machine. Then, from the eBPF machine, execute the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nc 192.168.1.6 <span style="color:#0000cf;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>GET /index.html HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.1.6:8080
</span></span></code></pre></div><p>The output should look similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>GET /index.html HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.1.6:8080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>XXXX/1.0 <span style="color:#0000cf;font-weight:bold">404</span> File not found
</span></span><span style="display:flex;"><span>Server: SimpleHTTP/0.6 Python/3.12.3
</span></span><span style="display:flex;"><span>Date: Thu, <span style="color:#0000cf;font-weight:bold">06</span> Mar <span style="color:#0000cf;font-weight:bold">2025</span> 05:13:32 GMT
</span></span><span style="display:flex;"><span>Connection: close
</span></span><span style="display:flex;"><span>Content-Type: text/html<span style="color:#000;font-weight:bold">;</span><span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">335</span>
</span></span></code></pre></div><p><code>HTTP/1.0 404 File not found</code> is now replaced with <code>XXXX/1.0 404 File not found</code>.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    TC Hardware Offload allows NICs to handle specific traffic control tasks (like filtering and policing) in hardware instead of the CPU similar to how XDP offloads packet processing to reduce CPU overhead (XDP will be explained next).

</div>

<p>Next, we will talk about XDP (Express Data Path), where XDP programs are executed before packets reach the kernel network stack.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d78ca62235ff4c2bacce5f846f2bc2ef">5.4 - XDP</h1>
    <div class="lead">Ultra fast packet processing that runs in the NIC driver perfect for DDoS defense.</div>
	<p>XDP (eXpress Data Path) is a high-performance packet processing framework integrated directly into the Linux kernel. It leverages eBPF (extended Berkeley Packet Filter) technology to enable customizable packet processing at the earliest possible stage when packets arrive at the network driver (ingress traffic) before the kernel allocates an sk_buff for them. By operating before the kernel&rsquo;s traditional networking stack processes packets, XDP dramatically reduces latency, improves throughput, and minimizes processing overhead. One of the core reasons XDP achieves such high efficiency is by avoiding traditional kernel operations, such as allocation of the socket buffer structure (<code>sk_buff</code>) or generic receive offload (GRO), which are expensive and unnecessary at this early stage. Unlike traditional Linux networking, XDP does not require packets to be wrapped into the kernel&rsquo;s socket buffer (<code>sk_buff</code>). The <code>sk_buff</code> structure, while powerful and flexible, is relatively heavyweight and incurs significant performance costs because of the extensive metadata and management overhead it introduces. By bypassing the <code>sk_buff</code>, XDP can directly manipulate raw packet data significantly boosting packet processing performance. Additionally, XDP provides the capability for atomic runtime updates to its programs, offering significant operational flexibility without traffic disruption.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    GRO (Generic Receive Offload) is a Linux kernel feature which aggregates multiple incoming network packets into fewer larger packets before passing them up the kernel networking stack to reduces per-packet processing overhead.

</div>

<p>Each packet processed by XDP is represented by a special context structure called <code>xdp_buff</code>. The primary difference between the <code>xdp_buff</code> and traditional <code>sk_buff</code> is related to the processing stage and the complexity of these structures. The <code>xdp_buff</code> is significantly simpler and is employed much earlier in the packet-processing pipeline. XDP programs are classified as <code>BPF_PROG_TYPE_XDP</code> and it used <code>xdp_buff</code> structure which is defined in <code>include/net/xdp.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_buff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_meta</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_hard_start</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_rxq_info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rxq</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_txq_info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">txq</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">frame_sz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>XDP operates in three distinct modes that suit different scenarios: native XDP, offloaded XDP and generic XDP.</p>
<p>Native XDP is the default and most performant mode, running directly within network driver. It delivers optimal efficiency and minimal latency, supported broadly across modern NICs.
Offloaded XDP leverages specialized hardware (SmartNICs) by executing XDP programs directly on NIC hardware, freeing CPU resources and pushing performance even higher, ideal for demanding high-throughput scenarios.
Generic XDP is available when native support isn&rsquo;t present. It executes within the kernel&rsquo;s networking stack rather than the NIC driver, primarily useful for development and testing but provides lower performance due to the additional overhead.</p>
<p>An XDP program uses return codes which are defined in <code>include/uapi/linux/bpf.h</code> header file as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">xdp_action</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XDP_ABORTED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XDP_DROP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XDP_TX</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">XDP_REDIRECT</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>These return codes are used to instruct the network driver on how to handle incoming packets. The return codes are as follows:</p>
<ul>
<li><code>XDP_DROP</code>: Immediately drops packets at the NIC driver, ideal for quick, resource-efficient firewalling and DDoS mitigation.</li>
<li><code>XDP_PASS</code>: Forwards the packet to the kernel&rsquo;s regular network stack.</li>
<li><code>XDP_TX</code>: Sends the packet back out of the same NIC it arrived on, often used in load balancing and packet rewriting scenarios.</li>
<li><code>XDP_REDIRECT</code>: Sends the packet out through a different NIC or redirects it to a different processing CPU.</li>
<li><code>XDP_ABORTED</code>: Signifies an error condition, useful during debugging and development.</li>
</ul>
<p>The following diagram shows the basic XDP workflow:</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/xdp-diagram.png" alt="Centered image" />
</p>
<p>One common use case of XDP is DDoS mitigation, where it quickly identifies and drops malicious traffic with minimal processing overhead. XDP is also heavily used for advanced packet forwarding and load balancing, enabling quick header modifications and packet routing decisions directly at the driver level.
Network analytics and sampling are other powerful XDP applications, where packet data can be efficiently captured and transmitted to user-space applications through memory-mapped ring buffers.
Custom protocol handling, such as encapsulation or decapsulation, is easily achievable with XDP, facilitating efficient interactions with upper-layer network functions such as the GRO engine. Real-world deployments by companies like Facebook (Katran) and Cloudflare have demonstrated substantial performance improvements by integrating XDP for load balancing, firewalling, and DDoS mitigation. For more details please visit <a href="https://docs.cilium.io/en/latest/reference-guides/bpf/progtypes/#xdp">https://docs.cilium.io/en/latest/reference-guides/bpf/progtypes/#xdp</a>.</p>
<p>The next example is explained previously. The following code performs a chain of checks to drop port 8080 on ingress traffic using <code>XDP_DROP</code>. The code uses <code>xdp_md</code> as context instead of <code>sk_buff</code>  as previously explained.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_ingress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping XDP egress packet port 8080</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_DROP</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile the code using LLVM then load it with: <code>sudo ip link set dev enp1s0 xdp obj xdp_drop_8080.o sec xdp</code>.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    <code>xdp obj xdp_drop_8080.o</code> This command loads an XDP program from the ELF object file named <code>xdp_drop_8080.o</code>. By default, the system attempts to use native driver mode if available, falling back to generic mode otherwise. You can also force a specific mode by using one of these options: <strong>xdpgeneric:</strong> Enforce generic XDP mode.  <strong>xdpdrv:</strong> Enforce native driver XDP mode. <strong>xdpoffload:</strong> Enforce offloaded XDP mode for supported hardware. For example,<code>sudo ip link set dev enp1s0 xdpgeneric obj x.o sec xdp</code> will enforce generic XDP mode. To unload the XDP program, run: <code>sudo ip link set dev enp1s0 xdp off</code>.

</div>

<p>As we mentioned earlier, XDP can operate as an efficient load balancer. In the following example, we have an ICMP load balancer implemented using a round-robin approach connected to two backend servers. When load balancer receives ICMP echo request will dispatch it to the servers in order. The idea behind this load balancer is that it routes by re-writing the destination IP, delivering each request to the backend servers in sequential.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    A round-robin load balancer distributes network traffic evenly across a group of servers by sequentially forwarding each new request to the next server in a rotating list.

</div>

<p>The IP header checksum must be recalculated, RFC 1071 explaining in details how IP header checksum, but to simplify the process it has two steps: one&rsquo;s complement addition and folding process. <code>bpf_csum_diff</code> helper function to calculate a checksum difference from the raw buffer pointed by <code>from</code>, of length <code>from_size</code> (that must be a multiple of 4), towards the raw buffer pointed by <code>to</code>, of size <code>to_size</code> (that must be a multiple of 4) and which has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__s64</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_csum_diff</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">__be32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">from_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__be32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">to_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__wsum</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">28</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>In this example, the XPD ICMP load balancer is configured on IP address 192.168.1.2. It has two backend servers: the first backend server has IP address 192.168.1.3 with MAC address 52:54:00:ff:ff:55, and the second backend server has IP address 192.168.1.4 with MAC address 52:54:00:5d:6e:a1. When an ICMP Echo Request reaches the load balancer, it will redirect the first request to the first backend server and the second Echo Request to the second backend server.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/icmp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define LB_IP __constant_htonl(0xC0A87AEE) </span><span style="color:#8f5902;font-style:italic">/* 192.168.1.2 */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">mac</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ETH_ALEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rr_map</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">backend_map</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#000">__u16</span> <span style="color:#000">ip_recalc_csum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_csum_diff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">csum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">icmp_lb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">bpf_htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">daddr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">LB_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_ICMP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">bk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b_ptr</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">b_ptr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000">be0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__constant_htonl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xC0A87A58</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">mac</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0x52</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x54</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x00</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x55</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">be0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000">be1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__constant_htonl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xC0A87AD7</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">mac</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0x52</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x54</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x00</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x5d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x6e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xa1</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">be1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">rr_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rr_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rr_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">p_index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">backend_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">be</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">daddr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">be</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ip_recalc_csum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__builtin_memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">be</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">mac</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ETH_ALEN</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_TX</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, structure was define for backends&rsquo; IPs unsigned 32-bit integer and MAC addresses with <code>ETH_ALEN</code> of length which is 6 as defined in <code>include/linux/if_ether.h</code>. Second,  define a map of type <code>BPF_MAP_TYPE_ARRAY</code> to track the state of our round-robin load balancer with only one entry and key 0 should be initialized to 0. Third, define a map of type <code>BPF_MAP_TYPE_ARRAY</code> to store backends&rsquo; IPs and MAC addresses and key 0 should be initialized to 0.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">mac</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ETH_ALEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">rr_map</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">backend_map</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then, the code performs chain of checks to ensure that the code is only process ICMP packets.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Parse Ethernet header */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">bpf_htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Parse IP header */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Process only packets destined to LB_IP */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">daddr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">LB_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Process only ICMP packets */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_ICMP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Next, the code populates the <code>backend_map</code> with backend information and selects a backend using round-robin from the <code>rr_map</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#000">__u32</span> <span style="color:#000">bk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b_ptr</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">b_ptr</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000">be0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__constant_htonl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xC0A87A58</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">mac</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0x52</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x54</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x00</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x55</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">be0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#000">be1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__constant_htonl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xC0A87AD7</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">mac</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0x52</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x54</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x00</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x5d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x6e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0xa1</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">bk</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">be1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">rr_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rr_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rr_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">p_index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">backend_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">backend</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">be</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">backend_key</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then, the code rewrites the destination IP address to the chosen backend from round-robin map followed by the calculation of the IP header checksum using the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#000">__u16</span> <span style="color:#000">ip_recalc_csum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_csum_diff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">csum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">csum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In short, the checksum is calculated by summing all the 16-bit words of the header using one&rsquo;s complement arithmetic. &ldquo;Folding&rdquo; means that if the sum exceeds 16 bits, any overflow (carry) from the high-order bits is added back into the lower 16 bits. Finally, the one&rsquo;s complement (bitwise NOT) of that folded sum gives the checksum.</p>
<p>As we mentioned before,<code>bpf_csum_diff</code> helper function with seed of zero performs one&rsquo;s complement addition. Next, the folding process which has the following in one of four iteration:</p>
<ol>
<li>Check that right shift by 16 bits <code>csum &gt;&gt; 16</code> (discards the lower 4 hex digits) of <code>bpf_csum_diff</code> output is nonzero.</li>
<li>Extract the lower 16 bits from the output of <code>bpf_csum_diff</code> using a bitwise AND with <code>0xFFFF</code>.</li>
<li>Shift the current checksum value right by 16 bits to extract any carry beyond the lower 16 bits, then add that carry to the lower 16 bits (obtained with <code>csum &amp; 0xffff</code>), and store the result in <code>csum</code>.</li>
<li>Repeat this process (up to 4 iterations) until no carry remains, then return the bitwise NOT of the final result.</li>
</ol>
<p>The final step in the code is to set destination MAC address to the chosen backend&rsquo;s MAC address using<code>__builtin_memcpy</code>. <code>__builtin_memcpy</code> is not a standard C library function; it&rsquo;s a compiler-provided function that offers optimized memory copying and has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">__builtin_memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Compile the code. Then, attach the XDP program to your interface <code>sudo ip link set dev enp1s0 xdp obj icmp_lb.o sec xdp</code>. Next, capture ICMP traffic on both backend using <code>sudo tcpdump -i enp1s0 icmp</code>, then from fourth machine, send Echo request to the load balancer <code>ping 192.168.1.2</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PING 192.168.1.2 <span style="color:#ce5c00;font-weight:bold">(</span>192.168.122.238<span style="color:#ce5c00;font-weight:bold">)</span> 56<span style="color:#ce5c00;font-weight:bold">(</span>84<span style="color:#ce5c00;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.3: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.442 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.4: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.667 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.3: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.713 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.4: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.670 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.3: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.570 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.4: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.647 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.3: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.715 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 192.168.1.4: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>0.715 ms <span style="color:#ce5c00;font-weight:bold">(</span>DIFFERENT ADDRESS!<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>tcpdump</code>from the first backend:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>05:14:35.264928 IP _gateway &gt; test1-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 1, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:35.264969 IP test1-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 1, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:37.321642 IP _gateway &gt; test1-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 3, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:37.321694 IP test1-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 3, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:39.370002 IP _gateway &gt; test1-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 5, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:39.370068 IP test1-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 5, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:41.417230 IP _gateway &gt; test1-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 7, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:41.417282 IP test1-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 7, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span></code></pre></div><p><code>tcpdump</code>from the second backend:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>05:14:36.273275 IP _gateway &gt; test2-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 2, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:36.273355 IP test2-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 2, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:38.320876 IP _gateway &gt; test2-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 4, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:38.320933 IP test2-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 4, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:40.368579 IP _gateway &gt; test2-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 6, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:40.368632 IP test2-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 6, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:42.420358 IP _gateway &gt; test2-Standard-PC-Q35-ICH9-2009: ICMP <span style="color:#204a87">echo</span> request, id 16, seq 8, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>05:14:42.420406 IP test2-Standard-PC-Q35-ICH9-2009 &gt; _gateway: ICMP <span style="color:#204a87">echo</span> reply, id 16, seq 8, length <span style="color:#0000cf;font-weight:bold">64</span>
</span></span></code></pre></div><p>Notice the sequence of ICMP packets: each Echo request is sent to a different backend server.
XDP can also be used to extract metadata from packets which can then be sent to network analysis tool for further investigation, stored for logging as a flight record, or used to assist in incident investigation.</p>
<p>The following example extracts metadata of ingress traffic (source IP, source port, destination IP, destination port and protocol) and send the extracted metadata to ring buffer that can be accessed from user space.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/udp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">metadata_t</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">src_ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">dst_ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">src_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">dst_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span>  <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">24</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_flags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">ringbuf</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">xdp_extract_metadata</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IPPROTO_TCP</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IPPROTO_UDP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u64</span> <span style="color:#000">ip_header_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u64</span> <span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">udphdr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">udphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">uh</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uh</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uh</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uh</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">metadata_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ringbuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_ip</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">saddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_ip</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">daddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">src_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dst_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The code performs chain of checks to extract ports for TCP or UDP, for other protocols, leave ports as 0.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#000">__u16</span> <span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IPPROTO_TCP</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IPPROTO_UDP</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u64</span> <span style="color:#000">ip_header_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4ULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__u64</span> <span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">offset</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">udphdr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">udphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">uh</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uh</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uh</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uh</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then fill out the metadata event</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_ip</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">saddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_ip</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">daddr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">src_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dst_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">meta</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span> 
</span></span></code></pre></div><p>Finally, submit the metadata to the ring buffer. The following user-space program loads the XDP object file, attaches it to the required interface, and retrieves metadata from the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;arpa/inet.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;net/if.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_link.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;netinet/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef XDP_FLAGS_DRV
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define XDP_FLAGS_DRV (1U &lt;&lt; 0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">metadata_t</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">src_ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">dst_ip</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">src_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">dst_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u8</span>  <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data_sz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">metadata_t</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Ring buffer event too small</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">metadata_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">md</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">src_str</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">INET_ADDRSTRLEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dst_str</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">INET_ADDRSTRLEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">inet_ntop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AF_INET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_ip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src_str</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">inet_ntop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AF_INET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_ip</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dst_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dst_str</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">proto_name</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proto_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;TCP&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">IPPROTO_UDP</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proto_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;UDP&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">IPPROTO_ICMP</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proto_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ICMP&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proto_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;UNKNOWN&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Packet: %s:%u -&gt; %s:%u, protocol: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">src_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">src_port</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">dst_str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">md</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dst_port</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">proto_name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_object</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_program</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_map</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ring_buffer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">map_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">pin_path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;ifname&gt;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ifindex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">if_nametoindex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid interface name: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">libbpf_set_strict_mode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LIBBPF_STRICT_ALL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__open_file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp_extract_metadata.o&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_object__open_file() failed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_object__load() failed %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__find_program_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;xdp_extract_metadata&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t find xdp program in ELF</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t get file descriptor for XDP program</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_xdp_attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XDP_FLAGS_DRV</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_xdp_attach(ifindex=%d) failed (err=%d): %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attached XDP program on ifindex %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__find_map_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ringbuf&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t find ringbuf map in ELF</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t get ringbuf map fd</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handle_event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: ring_buffer__new() failed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Listening for events...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ring_buffer__poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: ring_buffer__poll() err=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ring_buffer__free</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_xdp_detach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XDP_FLAGS_DRV</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_object__close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>INET_ADDRSTRLEN</code> is defined in <code>/include/linux/inet.h</code> the kernel source code as 16 bytes which represents the maximum size, in bytes, of a string that can hold an IPv4 address in presentation format. <code>inet_ntop</code> function converts IPv4 and IPv6 addresses from binary to text and it&rsquo;s a part of standard C library defined in <code>arpa/inet.h</code> and has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">inet_ntop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">af</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">dst</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">socklen_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>AF_INET</code>: Specifies the address family (IPv4).<code>&amp;md-&gt;src_ip</code>: A pointer to the binary IPv4 address. <code>src_str</code>: The destination buffer where the converted string will be stored. <code>sizeof(src_str)</code>: The size of the destination buffer.</p>
<p>Then the code uses a new approach by opening the object file directly instead of using a skeleton header file. The steps are as follows:</p>
<ol>
<li>open the eBPF object file.</li>
<li>Load the eBPF program.</li>
<li>Find XDP program by name which is <code>xdp_extract_metadata</code> and load its file descriptor.</li>
<li>Attach the program to the interface.</li>
<li>Look up the ringbuf map by name and load its file descriptor.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Open BPF object file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__open_file</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp_extract_metadata.o&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_object__open_file() failed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Load (verify) BPF program
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_object__load() failed %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Find XDP program by name (we used &#34;xdp_extract_metadata&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__find_program_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;xdp_extract_metadata&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t find xdp program in ELF</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t get file descriptor for XDP program</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Attach the program to the interface (using driver mode as an example)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_xdp_attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XDP_FLAGS_DRV</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: bpf_xdp_attach(ifindex=%d) failed (err=%d): %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attached XDP program on ifindex %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Look up the ringbuf map by name or by index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_object__find_map_by_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ringbuf&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t find ringbuf map in ELF</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ERROR: couldn&#39;t get ringbuf map fd</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>bpf_xdp_attach</code> is a user-space API function (typically provided by libbpf) that attaches an XDP program to a network interface. defined in <code>tools/lib/bpf/libbpf.h</code> with the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_xdp_attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_xdp_attach_opts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>ifindex</code>: Represents the interface ID and <code>ifindex</code> is obtained by</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ifindex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">if_nametoindex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span></code></pre></div><p><code>prog_fd</code>: Represents the program file descriptor.<br>
<code>flags</code>: Can take one of three values and they are defined in <code>include/uapi/linux/if_link.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define XDP_FLAGS_SKB_MODE		(1U &lt;&lt; 1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define XDP_FLAGS_DRV_MODE		(1U &lt;&lt; 2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define XDP_FLAGS_HW_MODE		(1U &lt;&lt; 3)
</span></span></span></code></pre></div><p>XDP_FLAGS_SKB_MODE (1U &laquo; 1): This flag attaches the XDP program in generic mode.<br>
XDP_FLAGS_DRV_MODE (1U &laquo; 2): This flag attaches the XDP program in native driver mode.<br>
XDP_FLAGS_HW_MODE (1U &laquo; 3): This flag is used for offloading the XDP program to supported hardware (NICs that support XDP offload).</p>
<p>Finally, the ring buffer is created, and the metadata is then polled from it. Compile the user-space using: <code>clang -o loader loader.c -lbpf</code>. Then, run the code using <code>sudo ./loader enp1s0</code>. Example output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attached XDP program on ifindex <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>Listening <span style="color:#204a87;font-weight:bold">for</span> events...
</span></span><span style="display:flex;"><span>Packet: 192.168.1.1:53 -&gt; 192.168.1.2:46313, protocol: UDP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.1:53 -&gt; 192.168.1.2:46313, protocol: UDP
</span></span><span style="display:flex;"><span>Packet: 82.65.248.56:123 -&gt; 192.168.1.2:53121, protocol: UDP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.4:0 -&gt; 192.168.1.2:0, protocol: ICMP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.4:0 -&gt; 192.168.1.2:0, protocol: ICMP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.4:0 -&gt; 192.168.1.2:0, protocol: ICMP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span><span style="display:flex;"><span>Packet: 192.168.1.3:35668 -&gt; 192.168.1.2:22, protocol: TCP
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3021ad0e581015aa97f3ef212c1a52c3">5.5 - CGroup Socket Address</h1>
    <div class="lead">A hook on connect bind and accept that lets you allow block or rewrite socket addresses for all processes inside a chosen cgroup giving per-container network policy</div>
	<p><code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code> is a BPF program type designed to attach to control groups (cgroups) and intercept socket address operations, such as connect() calls. It enables administrators to enforce network connection policies—like allowing or blocking connections based on destination IPs and ports—at the cgroup level. This makes it a powerful tool for implementing network security controls within containerized or multi-tenant environments. There are many types of <code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code> programs or ELF section such as:</p>
<ul>
<li>cgroup/bind4: Attaches to IPv4 bind operations. Programs in this section intercept bind() calls on IPv4 sockets, allowing you to control or modify how sockets bind to local addresses.</li>
<li>cgroup/connect4: Attaches to IPv4 connect operations. This section is used to filter or modify outgoing connect() attempts on IPv4 sockets—for example, to allow only connections to certain destination addresses or ports.</li>
<li>cgroup/recvmsg4: Attaches to IPv4 UDP receive message operations with eBPF attache type of <code>BPF_CGROUP_UDP4_RECVMSG</code>. Programs in this section can intervene in recvmsg() calls on UDP sockets, enabling inspection or filtering of incoming datagrams.</li>
<li>cgroup/sendmsg4: Attaches to IPv4 UDP send message operations with eBPF attache type of <code>BPF_CGROUP_UDP4_SENDMSG</code>. This section lets you apply filters or modifications to sendmsg() calls on UDP sockets, potentially controlling which messages are sent.</li>
</ul>
<p>BPF_PROG_TYPE_CGROUP_SOCK_ADDR programs receive a pointer to a <code>struct bpf_sock_addr</code> as their context. This structure contains the socket&rsquo;s address information (such as the destination IP and port, along with other details), which the BPF program can inspect or modify during operations like connect() or bind().
<code>struct bpf_sock_addr</code> is defined in <code>include/uapi/linux/bpf.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_sock_addr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">user_family</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">user_ip4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">user_ip6</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">user_port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">msg_src_ip4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">msg_src_ip6</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__bpf_md_ptr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_sock</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sk</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>If we have a container connected to the internet without any policy.<br>
<code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code> eBPF can be used to make a policy and enforce it. For example, to only port 80 and attach it cgroup associated with that container.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter4/cgroup-after.png" alt="Centered image" />
</p>
<p>eBPF program:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cgroup/connect4&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cgroup_connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_sock_addr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u16</span> <span style="color:#000">allowed_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__bpf_htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">user_port</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">allowed_port</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">//===&gt; Allow connection
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">//===&gt; Block connection
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;fcntl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;cgroup_connect.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cgroup_connect</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;cgroup_path&gt;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cgroup_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">O_DIRECTORY</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">O_RDONLY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroup_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to open cgroup&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cgroup_connect__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cgroup_connect__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cgroup_connect__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">links</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroup_connect</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__attach_cgroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroup_connect</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">links</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroup_connect</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF program to cgroup</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cgroup_connect__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BPF program attached successfully to cgroup: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cgroup_connect__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroup_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_SUCCESS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We have a container with name test.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker ps 
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE           COMMAND       CREATED             STATUS             PORTS     NAMES
</span></span><span style="display:flex;"><span>34ca63d499df   debian:latest   <span style="color:#4e9a06">&#34;/bin/bash&#34;</span>   About an hour ago   Up About an hour             <span style="color:#204a87">test</span>
</span></span></code></pre></div><p>The container PID can be obtained using <code>docker inspect -f '{{.State.Pid}}' test</code>. Let&rsquo;s get cgroup associated with that container using</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /proc/3283/cgroup
</span></span><span style="display:flex;"><span>0::/system.slice/docker-34ca63d499df1071c9d0512aafe7f4a1e73464edc6b40a9b97fdd087542d1930.scope
</span></span></code></pre></div><p>Then, we can link our eBPF program to our container using:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo ./loader /sys/fs/cgroup/system.slice/docker-34ca63d499df1071c9d0512aafe7f4a1e73464edc6b40a9b97fdd087542d1930.scope
</span></span></code></pre></div><p>The link can be tested to make sure that the policy is applied on our container. From inside our container</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl http://172.17.0.1:8080
</span></span><span style="display:flex;"><span>curl: <span style="color:#ce5c00;font-weight:bold">(</span>7<span style="color:#ce5c00;font-weight:bold">)</span> Failed to connect to 172.17.0.1 port <span style="color:#0000cf;font-weight:bold">8080</span> after <span style="color:#0000cf;font-weight:bold">0</span> ms: Couldn<span style="color:#a40000">&#39;</span>t connect to server
</span></span></code></pre></div><p>In this chapter, we explored various networking capabilities in eBPF. We began with socket filter programs, demonstrating how they can detect specific traffic patterns and extract particular strings from network traffic—capabilities that are useful in security applications such as intrusion detection. Next, we examined Traffic Control (TC), which can manage both egress and ingress traffic, and we experimented with its features for firewalling and traffic manipulation. We then discussed Lightweight Tunnel applications, which can also serve as firewalls for tunneled traffic. Then, we explored XDP, which operates on ingress traffic, and tested its potential for firewalling, load balancing, and extracting packet metadata for analysis or logging. Finally, we discussed control group socket address, allows us to apply policies on a cgroup as we did earlier by attaching policies to a container&rsquo;s cgroup.
In the next chapter, we will dive deeper into eBPF security, exploring advanced techniques and strategies for enhancing system protection and monitoring using eBPF.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b19ef890711f7ce8221ae9b15469c412">6 - Security with eBPF</h1>
    <div class="lead">How eBPF enforces policy and observes behavior without kernel patches.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-963291df6b201c8a3b105bddb30c924c">6.1 - Seccomp</h1>
    <div class="lead">Restrict system calls with flexible logic beyond static tables.</div>
	<p>Seccomp, short for Secure Computing Mode, is a powerful kernel feature that limits the system calls a process can make, thereby reducing the exposed kernel surface and mitigating potential attacks. Seccomp is a security facility in the Linux kernel designed to be a tool for sandboxing processes by restricting the set of system calls they can use. to minimizes the kernel’s exposed interface, allowing developers to reduce the risk of kernel-level exploits. The filtering mechanism is implemented using Berkeley Packet Filter (cBPF) programs which inspect system call numbers and arguments before the system call is executed.<br>
User-space security agents are vulnerable to TOCTOU attacks, tampering, and resource exhaustion because they depend on kernel communication to make security decisions. Seccomp addresses these issues by moving filtering into the kernel. Using a cBPF program, seccomp evaluates system call metadata atomically, eliminating the window for TOCTOU exploits and preventing tampering—since filters, once installed, become immutable and are inherited by child processes. This kernel-level enforcement ensures robust protection even if the user-space agent is compromised. Seccomp filtering is implemented as follows:<br>
1- The filter is defined as a cBPF program that evaluates each system call based on its number and its arguments. Since cBPF programs cannot dereference pointers, they operate only on the provided system call metadata, preventing time-of-check-time-of-use (TOCTOU) vulnerabilities.<br>
2- Once a process installs a seccomp filter using either the prctl() or seccomp() system call, every system call is intercepted and evaluated by the BPF program within the kernel. This means that even if the application logic is compromised, the kernel remains protected by the filter rules.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    cBPF’s limitations ensure that the filter logic only works with the system call metadata, making it less susceptible to common attacks that exploit pointer dereferencing.

</div>

<p>The <code>prctl</code> system call is used to control specific characteristics of the calling process and will be explained shortly. Using Seccomp in an application, developers typically follow these steps:<br>
1- The filter is defined using the <code>struct seccomp_data</code> which is defined in the kernel source code <code>include/uapi/linux/seccomp.h</code> which provides the metadata needed to evaluate each system call. This structure is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * struct seccomp_data - the format the BPF program executes over.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @nr: the system call number
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @arch: indicates system call convention as an AUDIT_ARCH_* value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        as defined in &lt;linux/audit.h&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @instruction_pointer: at the time of the system call.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @args: up to 6 system call arguments always stored as 64-bit values
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        regardless of the architecture.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">arch</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">instruction_pointer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>2- Ensure that the process or its children cannot gain elevated privileges after the filter is installed using the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>3- Use the <code>prctl</code>  with <code>PR_SET_SECCOMP</code> to Install or activate seccomp filtering with a BPF program:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Here, <code>prog</code> is a pointer to a <code>struct sock_fprog</code> (defined in <code>include/uapi/linux/filter.h</code>) containing the BPF filter.</p>
<h3 id="seccomp-return-values">Seccomp Return Values<a class="td-heading-self-link" href="#seccomp-return-values" aria-label="Heading self-link"></a></h3>
<p>When a system call is intercepted, the BPF program returns one of several possible values. Each return value directs the kernel on how to handle the intercepted call. The actions are prioritized, meaning that if multiple filters are in place, the one with the highest precedence takes effect. The primary return values are:</p>
<ol>
<li>SECCOMP_RET_KILL_PROCESS: Immediately terminates the entire process. The exit status indicates a SIGSYS signal.</li>
<li>SECCOMP_RET_KILL_THREAD: Terminates only the current thread, again with a SIGSYS signal.</li>
<li>SECCOMP_RET_TRAP: Sends a SIGSYS signal to the process, allowing the kernel to pass metadata about the blocked call (like the system call number and address) to a signal handler.</li>
<li>SECCOMP_RET_ERRNO: Prevents execution of the system call and returns a predefined errno to the calling process.</li>
<li>SECCOMP_RET_USER_NOTIF:  Routes the system call to a user space notification handler, allowing external processes (like container managers) to decide how to handle the call.</li>
<li>SECCOMP_RET_TRACE: If a tracer is attached (via <code>ptrace</code>), the tracer is notified, giving it an opportunity to modify or skip the system call.</li>
<li>SECCOMP_RET_LOG: Logs the system call, then allows its execution. This is useful for development and debugging.</li>
<li>SECCOMP_RET_ALLOW:  Simply allows the system call to execute.</li>
</ol>
<p>Seccomp return values are defined in <code>include/linux/seccomp.h</code> Kernel source code as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL_PROCESS 0x80000000U </span><span style="color:#8f5902;font-style:italic">/* kill the process */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL_THREAD	 0x00000000U </span><span style="color:#8f5902;font-style:italic">/* kill the thread */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL	 SECCOMP_RET_KILL_THREAD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_TRAP	 0x00030000U </span><span style="color:#8f5902;font-style:italic">/* disallow and force a SIGSYS */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_ERRNO	 0x00050000U </span><span style="color:#8f5902;font-style:italic">/* returns an errno */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_USER_NOTIF	 0x7fc00000U </span><span style="color:#8f5902;font-style:italic">/* notifies userspace */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_TRACE	 0x7ff00000U </span><span style="color:#8f5902;font-style:italic">/* pass to a tracer or disallow */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_LOG		 0x7ffc0000U </span><span style="color:#8f5902;font-style:italic">/* allow after logging */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_ALLOW	 0x7fff0000U </span><span style="color:#8f5902;font-style:italic">/* allow */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><h3 id="bpf-macros">BPF Macros<a class="td-heading-self-link" href="#bpf-macros" aria-label="Heading self-link"></a></h3>
<p>Seccomp filters consist of a set of BPF macros. We will explain the most used ones:</p>
<ol>
<li><strong>BPF_STMT</strong> (code, k): A macro used to define a basic cBPF instruction that does not involve conditional branching. The <code>code</code> parameter specifies the operation, and <code>k</code> is an immediate constant value used by the instruction.</li>
<li><strong>BPF_JUMP</strong> (code, k, jt, jf): A macro to define a conditional jump instruction.<br>
code: Specifies the jump operation along with condition flags.<br>
k: The constant value to compare against.<br>
jt (jump true): The number of instructions to skip if the condition is met.<br>
jf (jump false): The number of instructions to skip if the condition is not met.</li>
<li><strong>BPF_LD</strong>: This flag indicates a load instruction, which reads data into the accumulator.</li>
<li><strong>BPF_W</strong>: Specifies that the data to load is a word (typically 32 bits).</li>
<li><strong>BPF_ABS</strong>: Instructs the load operation to use absolute addressing—that is, load data from a fixed offset within the data structure (in this case, the <code>seccomp_data</code> structure).</li>
<li><strong>BPF_K</strong>: Denotes that the operand (<code>k</code>) is an immediate constant.</li>
<li><strong>BPF_JMP</strong>: Indicates that the instruction is a jump (conditional or unconditional) type.</li>
<li><strong>BPF_JEQ</strong>: A condition flag used with jump instructions that causes a jump if the accumulator equals the constant <code>k</code>.</li>
</ol>
<p>Let&rsquo;s explore a simplified C code example demonstrating how to set up a seccomp filter to block <code>socket</code> syscall to prevent a process from initiating new network connections.</p>
<h3 id="code-example">Code Example<a class="td-heading-self-link" href="#code-example" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYSCALL_SOCKET 41 </span><span style="color:#8f5902;font-style:italic">// syscall number for socket
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYSCALL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp filter installed. Attempting socket on %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;socket&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Seccomp filter is written using cBPF macros and defines a simple seccomp policy to block the socket system call. First, loads the system call number (from the <code>nr</code> field of the <code>seccomp_data</code> structure) into the accumulator</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span></code></pre></div><ul>
<li><strong>BPF_LD:</strong> Instructs the program to load data.</li>
<li><strong>BPF_W:</strong> Specifies that a 32-bit word should be loaded.</li>
<li><strong>BPF_ABS:</strong> Indicates that the data is located at an absolute offset from the beginning of the <code>seccomp_data</code> structure.</li>
<li><strong>offsetof(struct seccomp_data, nr)</strong>: Computes the offset of the <code>nr</code> field (which holds the system call number) within the <code>seccomp_data</code> structure.</li>
</ul>
<p>Second, compare the syscall Number with <code>socket</code>. If the syscall is <code>socket</code>, the next instruction (which blocks the syscall) is executed. Otherwise,  the filter skips over the block action and moves on.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYSCALL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><ul>
<li><strong>BPF_JMP</strong>: Specifies that this is a jump instruction.</li>
<li><strong>BPF_JEQ</strong>: Adds the condition &ldquo;jump if equal&rdquo; to the operation.</li>
<li><strong>BPF_K</strong>: Indicates that the comparison value is an immediate constant.</li>
<li><strong>SYSCALL_SOCKET</strong>: The constant to compare against (i.e., the syscall number for <code>socket</code>).
<ul>
<li><strong>0</strong>: If the condition is true (the syscall number equals <code>SYSCALL_SOCKET</code>), do not skip any instructions (i.e., continue with the next instruction).</li>
<li><strong>1</strong>: If the condition is false (the syscall number does not equal <code>SYSCALL_SOCKET</code>), skip one instruction.</li>
</ul>
</li>
</ul>
<p>Third, Block the socket() syscall and return error code (e.g., EPERM).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span></code></pre></div><ul>
<li><strong>BPF_RET:</strong> Instructs the program to return a value immediately, effectively terminating the BPF program&rsquo;s evaluation for this syscall.</li>
<li><strong>BPF_K:</strong> Indicates that the return value is given as an immediate constant.</li>
<li><strong>Return Value:</strong> <code>SECCOMP_RET_ERRNO | (EPERM &amp; SECCOMP_RET_DATA)</code><br>
This tells the kernel to block the syscall by returning an error. Specifically, it sets the syscall&rsquo;s return value to an error code (<code>EPERM</code>), meaning &ldquo;Operation not permitted.&rdquo;</li>
</ul>
<p>Fourth, If the syscall was not <code>socket</code>, this instruction permits it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><ul>
<li><strong>BPF_RET | BPF_K:</strong> Again, a return instruction with a constant.</li>
<li><strong>Return Value:</strong> <code>SECCOMP_RET_ALLOW</code><br>
This instructs the kernel to allow the syscall to proceed.</li>
</ul>
<p>Then, ensure that the process or its children cannot gain elevated privileges after the filter is installed</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>PR_SET_NO_NEW_PRIVS</code>:This option tells the kernel to set a flag that prevents the process or its children from gaining new privileges. Finally, installing the seccomp filter.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Compile the code using <code>clang -g -O2 seccomp_socket.c -o seccomp_socket</code>, then <code>chmod +x seccomp_socket</code>. Next, run the code against <code>ssh</code> similar to the following: <code>./seccomp_socket /usr/bin/ssh test@192.168.1.3</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Seccomp filter installed. Attempting socket on /usr/bin/ssh...
</span></span><span style="display:flex;"><span>socket: Operation not permitted
</span></span><span style="display:flex;"><span>ssh: connect to host 192.168.1.3 port 22: failure
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter5/seccomp-example1.png" alt="Centered image" />
</p>
<p>We can see what is happening under the hood using <code>strace ./seccomp_socket /usr/bin/ssh test@192.168.1.3</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>newfstatat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/etc/nsswitch.conf&#34;</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFREG<span style="color:#000;font-weight:bold">|</span>0644, <span style="color:#000">st_size</span><span style="color:#ce5c00;font-weight:bold">=</span>569, ...<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span>, O_RDONLY<span style="color:#000;font-weight:bold">|</span>O_CLOEXEC<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFREG<span style="color:#000;font-weight:bold">|</span>0644, <span style="color:#000">st_size</span><span style="color:#ce5c00;font-weight:bold">=</span>2232, ...<span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>lseek<span style="color:#ce5c00;font-weight:bold">(</span>3, 0, SEEK_SET<span style="color:#ce5c00;font-weight:bold">)</span>                   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;root:x:0:0:root:/root:/bin/bash\n&#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2232</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#ce5c00;font-weight:bold">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> -1 EPERM <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>getpid<span style="color:#ce5c00;font-weight:bold">()</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2169</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;socket: Operation not permitted\r&#34;</span>..., 33socket: Operation not permitted
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">33</span>
</span></span><span style="display:flex;"><span>getpid<span style="color:#ce5c00;font-weight:bold">()</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2169</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;ssh: connect to host 192.168.1.3&#34;</span>..., 51ssh: connect to host 192.168.1.3 port 22: failure
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Executing socket syscall is being blocked and a return value is showing <code>-1 EPERM (Operation not permitted)</code>, which confirms that the filter is working as intended.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The header file <code>/include/linux/syscalls.h</code> in the Linux kernel source code contains the prototypes for all system calls, providing the necessary declarations for the syscall interfaces. Additionally, for the x86_64 architecture, the file <code>arch/x86/entry/syscalls/syscall_64.tbl</code> lists all the system calls along with their corresponding syscall IDs, which are used to generate the syscall dispatch table during the kernel build process.

</div>

<p>In the previous example we took blacklist approach by denying socket syscall for example. If we want to take the whitelist approach for a specific binary all we have to do is to record all its syscalls using something like strace. Let&rsquo;s explore the whitelist approach, the following code has a menu with list of options such as running command ls which uses execve syscall , or opening /etc/passwd which uses open syscall and write syscall.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;fcntl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">choice</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Syscall Menu:</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1. Execve /usr/bin/ls</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2. Open /etc/passwd</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;3. Write a message to stdout</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;4. Exit</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Enter your choice: &#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">scanf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">choice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid input.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getchar</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#39;\n&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">EOF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">getchar</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">choice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;ls&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">envp</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87">NULL</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Executing /usr/bin/ls via execve syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/usr/bin/ls&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">envp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Opening /etc/passwd via open syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_open</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_RDONLY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;File /etc/passwd opened successfully (fd = %d).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;close syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello from syscall write!</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Writing message to stdout via write syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_write</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STDOUT_FILENO</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exiting via exit_group syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_exit_group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Invalid choice. Please select a number between 1 and 5.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s compile it using <code>gcc -O2 -Wall syscalls.c -o syscalls</code>. Recording syscall can be done using strace. For example, we want to record write option in our code.
<code>strace -c -f ./syscalls</code> , then choose option 3:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span>Hello from syscall write!
</span></span></code></pre></div><p>The strace would look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>% <span style="color:#204a87">time</span>     seconds  usecs/call     calls    errors syscall
</span></span><span style="display:flex;"><span>------ ----------- ----------- --------- --------- ----------------
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           <span style="color:#204a87">read</span>
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">9</span>           write
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           close
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">4</span>           fstat
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">8</span>           mmap
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">3</span>           mprotect
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           munmap
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">3</span>           brk
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           pread64
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span> access
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           execve
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           arch_prctl
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           set_tid_address
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           openat
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           set_robust_list
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           prlimit64
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           getrandom
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           rseq
</span></span><span style="display:flex;"><span>------ ----------- ----------- --------- --------- ----------------
</span></span><span style="display:flex;"><span>100.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>        <span style="color:#0000cf;font-weight:bold">44</span>         <span style="color:#0000cf;font-weight:bold">1</span> total
</span></span></code></pre></div><p>These are all of used syscalls to run the binary to this option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello from syscall write!</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Writing message to stdout via write syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_write</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STDOUT_FILENO</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s build seccomp program to allow only these syscalls</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_READ             0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_WRITE            1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_CLOSE            3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_FSTAT            5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MMAP             9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MPROTECT         10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MUNMAP           11
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_BRK              12
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PREAD64          17
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ACCESS           21
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXECVE           59
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ARCH_PRCTL       158
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_TID_ADDRESS  218
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_OPENAT           257
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_ROBUST_LIST  273
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PRLIMIT64        302
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_GETRANDOM        318
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_RSEQ             334
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_READ</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_WRITE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_CLOSE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_FSTAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MMAP</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MPROTECT</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MUNMAP</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_BRK</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PREAD64</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ACCESS</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXECVE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ARCH_PRCTL</span><span style="color:#000;font-weight:bold">,</span>        <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_TID_ADDRESS</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_OPENAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_ROBUST_LIST</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PRLIMIT64</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_GETRANDOM</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_RSEQ</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp whitelist filter installed. Executing %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile it <code>gcc -O2 -Wall seccomp.c -o seccomp</code>, then <code>chmod +x seccomp</code> and finally <code>./seccomp ./syscalls</code> and choose 3</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span>Hello from syscall write!
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>If you choose something else like 2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>Opening /etc/passwd via open syscall...
</span></span><span style="display:flex;"><span>open syscall failed: Operation not permitted
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>Notice that we have <code>Segmentation fault (core dumped)</code> . Simply because we have a blocked a syscall <code>exit_group</code> , run <code>strace ./seccomp ./syscalls</code> then choose 3:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#ce5c00;font-weight:bold">(</span>0, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFCHR<span style="color:#000;font-weight:bold">|</span>0620, <span style="color:#000">st_rdev</span><span style="color:#ce5c00;font-weight:bold">=</span>makedev<span style="color:#ce5c00;font-weight:bold">(</span>0x88, 0x2<span style="color:#ce5c00;font-weight:bold">)</span>, ...<span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Enter your choice: &#34;</span>, 19Enter your choice: <span style="color:#ce5c00;font-weight:bold">)</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">19</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>0, <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;3\n&#34;</span>, 1024<span style="color:#ce5c00;font-weight:bold">)</span>                    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Writing message to stdout via wr&#34;</span>..., 47Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Hello from syscall write!\n&#34;</span>, 26Hello from syscall write!
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>exit_group<span style="color:#ce5c00;font-weight:bold">(</span>0<span style="color:#ce5c00;font-weight:bold">)</span>                           <span style="color:#ce5c00;font-weight:bold">=</span> -1 EPERM <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>--- SIGSEGV <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">si_signo</span><span style="color:#ce5c00;font-weight:bold">=</span>SIGSEGV, <span style="color:#000">si_code</span><span style="color:#ce5c00;font-weight:bold">=</span>SI_KERNEL, <span style="color:#000">si_addr</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span> ---
</span></span><span style="display:flex;"><span>+++ killed by SIGSEGV <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span> +++
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>We need to whitelist <code>exit_group</code> too in our code. Strace couldn&rsquo;t record <code>exit_group</code> syscall first because syscall such as <code>exit_group</code> syscall terminates the process immediately, so there’s no “return” value for strace to capture. Fixing our code is just by adding <code>exit_group</code> to the whitelist:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_READ             0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_WRITE            1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_CLOSE            3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_FSTAT            5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MMAP             9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MPROTECT         10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MUNMAP           11
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_BRK              12
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PREAD64          17
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ACCESS           21
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXECVE           59
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ARCH_PRCTL       158
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_TID_ADDRESS  218
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_OPENAT           257
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_ROBUST_LIST  273
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PRLIMIT64        302
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_GETRANDOM        318
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_RSEQ             334
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXIT_GROUP 231
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXIT_GROUP</span><span style="color:#000;font-weight:bold">,</span>       <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_READ</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_WRITE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_CLOSE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_FSTAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MMAP</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MPROTECT</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MUNMAP</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_BRK</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PREAD64</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ACCESS</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXECVE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ARCH_PRCTL</span><span style="color:#000;font-weight:bold">,</span>        <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_TID_ADDRESS</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_OPENAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_ROBUST_LIST</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PRLIMIT64</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_GETRANDOM</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_RSEQ</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp whitelist filter installed. Executing %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In the following part, we will explain the LSM kernel framework, a well-defined interface to enforce Mandatory Access Control (MAC) policies in a modular way.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-186e1d77b4d4edf4cd3714847b8a07fe">6.2 - Linux Security Module (LSM)</h1>
    <div class="lead">Insert custom access control checks through BPF without writing a module.</div>
	<p>LSM is a framework built into the Linux kernel that provides a set of hooks—well-defined points in the kernel code—where security modules can enforce access control and other security policies. These hooks are statically integrated into the kernel, meaning that a given security module (such as SELinux, AppArmor, or Smack) is selected at build or boot time via configuration options. Once active, the LSM framework directs security-relevant decisions (like permission checks, file access, or process operations) through these hooks so that the chosen security policy is applied consistently throughout the system.</p>
<h3 id="lsm-with-ebpf-hooks">LSM with eBPF Hooks<a class="td-heading-self-link" href="#lsm-with-ebpf-hooks" aria-label="Heading self-link"></a></h3>
<p>Traditionally, LSM hooks require the security policy to be built into the kernel, and modifying policies often involves a kernel rebuild or reboot. With the rise of eBPF, it is now possible to attach eBPF programs to certain LSM hooks dynamically starting from kernel version 5.7. This modern approach allows for:</p>
<ul>
<li><strong>Dynamic Policy Updates:</strong> eBPF programs can be loaded, updated, or removed at runtime without rebooting the system.</li>
<li><strong>Fine-Grained Control:</strong> LSM with eBPF can potentially provide more granular visibility and control over kernel behavior. It can monitor system calls, intercept kernel functions, and enforce policies with a level of detail that is hard to achieve with static hooks alone.</li>
<li><strong>Flexibility and Experimentation:</strong> Administrators and security professionals can quickly test and deploy new security policies, fine-tune behavior, or respond to emerging threats without lengthy kernel recompilations.</li>
<li><strong>Runtime Enforcement:</strong> eBPF programs attached to LSM hooks (using the BPF_PROG_TYPE_LSM) can inspect the kernel context and actively enforce security decisions (such as logging events or rejecting operations).</li>
</ul>
<p>In short, while traditional LSM modules (such as SELinux) enforce security policies statically at build time, LSM with eBPF hooks introduces dynamic, runtime adaptability to kernel security. This hybrid approach leverages the robustness of the LSM framework and the operational agility of eBPF. The LSM interface triggers immediately before the kernel acts on a data structure, and at each hook point, a callback function determines whether to permit the action.  Let&rsquo;s explore together LSM with eBPF. First, we need to check if <code>BPF LSM</code> is supported by the kernel:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /boot/config-<span style="color:#204a87;font-weight:bold">$(</span>uname -r<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">|</span> grep BPF_LSM
</span></span></code></pre></div><p>If the output is <code>CONFIG_BPF_LSM=y</code> then the <code>BPF LSM</code> is supported. Then we check if <code>BPF LSM</code> is enabled:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat /sys/kernel/security/lsm
</span></span></code></pre></div><p>if the output contains <code>bpf</code> then the module is enabled like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>lockdown,capability,landlock,yama,apparmor,tomoyo,bpf,ipe,ima,evm
</span></span></code></pre></div><p>If the output is similar to <code>ndlock,lockdown,yama,integrity,apparmor</code> with <code>bpf</code>. Then, add
<code>GRUB_CMDLINE_LINUX=&quot;lsm=ndlock,lockdown,yama,integrity,apparmor,bpf&quot;</code> to <code>/etc/default/grub</code> followed by updating the grub using <code>sudo update-grub2</code> and reboot.</p>
<p>The list of all LSM hooks are defined in <code>include/linux/lsm_hook_defs.h</code>, the following is just an example of it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LSM_HOOK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path_chmod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LSM_HOOK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path_chown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">kuid_t</span> <span style="color:#000">uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">kgid_t</span> <span style="color:#000">gid</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LSM_HOOK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path_chroot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>LSM hooks documentation is located at</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>https://github.com/torvalds/linux/blob/457391b0380335d5e9a5babdec90ac53928b23b4/include/linux/lsm_hooks.h 
</span></span></code></pre></div><p>which has descriptive documentation for most of LSM hooks such as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span> * @path_chmod:
</span></span><span style="display:flex;"><span> *	  Check for permission to change a mode of the file @path. The new
</span></span><span style="display:flex;"><span> *	  mode is specified in @mode.
</span></span><span style="display:flex;"><span> *	  @path contains the path structure of the file to change the mode.
</span></span><span style="display:flex;"><span> *	  @mode contains the new DAC&#39;s permission, which is a bitmask of
</span></span><span style="display:flex;"><span> *	  constants from <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">include</span><span style="color:#a40000">/</span><span style="color:#c4a000">uapi</span><span style="color:#a40000">/</span><span style="color:#c4a000">linux</span><span style="color:#a40000">/</span><span style="color:#c4a000">stat</span><span style="color:#a40000">.</span><span style="color:#c4a000">h</span><span style="color:#000;font-weight:bold">&gt;</span>.
</span></span><span style="display:flex;"><span> *	  Return 0 if permission is granted.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> * @path_chown:
</span></span><span style="display:flex;"><span> *	  Check for permission to change owner/group of a file or directory.
</span></span><span style="display:flex;"><span> *	  @path contains the path structure.
</span></span><span style="display:flex;"><span> *	  @uid contains new owner&#39;s ID.
</span></span><span style="display:flex;"><span> *	  @gid contains new group&#39;s ID.
</span></span><span style="display:flex;"><span> *	  Return 0 if permission is granted.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * @path_chroot:
</span></span><span style="display:flex;"><span> *	  Check for permission to change root directory.
</span></span><span style="display:flex;"><span> *	  @path contains the path structure.
</span></span><span style="display:flex;"><span> *	  Return 0 if permission is granted.
</span></span></code></pre></div><p>Let&rsquo;s explore LSM with <code>path_mkdir</code> LSM hook which described as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span> * @path_mkdir:
</span></span><span style="display:flex;"><span> *	  Check permissions to create a new directory in the existing directory
</span></span><span style="display:flex;"><span> *	  associated with path structure @path.
</span></span><span style="display:flex;"><span> *	  @dir contains the path structure of parent of the directory
</span></span><span style="display:flex;"><span> *	  to be created.
</span></span><span style="display:flex;"><span> *	  @dentry contains the dentry structure of new directory.
</span></span><span style="display:flex;"><span> *	  @mode contains the mode of new directory.
</span></span><span style="display:flex;"><span> *	  Return 0 if permission is granted.
</span></span></code></pre></div><p><code>path_mkdir</code> is defined in LSM as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LSM_HOOK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define FULL_PATH_LEN 256
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lsm/path_mkdir&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">FULL_PATH_LEN</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u64</span> <span style="color:#000">uid_gid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_uid_gid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">uid_gid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_path_d_path</span><span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LSM: mkdir &#39;%s&#39; in directory &#39;%s&#39; with mode %d, UID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>struct path</code> is data structure used by the VFS (Virtual Filesystem) layer to represent a location in the filesystem. <code>struct path</code> is defined in <code>include/linux/path.h</code> as the following</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">vfsmount</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mnt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>struct dentry</code> directory entry data structure which is responsible for making links between inodes and filename. <code>struct dentry</code> is defined in <code>include/linux/dcache.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d_flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">seqcount_spinlock_t</span> <span style="color:#000">d_seq</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_bl_node</span> <span style="color:#000">d_hash</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_parent</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">qstr</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">inode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_inode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">d_iname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">DNAME_INLINE_LEN</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry_operations</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_op</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">super_block</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_sb</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">d_time</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_fsdata</span><span style="color:#000;font-weight:bold">;</span>	
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">lockref</span> <span style="color:#000">d_lockref</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">list_head</span> <span style="color:#000">d_lru</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">wait_queue_head_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d_wait</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_node</span> <span style="color:#000">d_sib</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_head</span> <span style="color:#000">d_children</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_node</span> <span style="color:#000">d_alias</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_bl_node</span> <span style="color:#000">d_in_lookup_hash</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	 	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">rcu_head</span> <span style="color:#000">d_rcu</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#000">d_u</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>struct dentry</code> data structure has a member <code>struct qstr</code> data structure that contains information about the name  (a pointer to the actual character array containing the name) defined in <code>include/linux/dcache.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">qstr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HASH_LEN_DECLARE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">u64</span> <span style="color:#000">hash_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>That&rsquo;s how you extract the filename: by reading the <code>dentry</code> data structure, then accessing its <code>d_name</code> member, and finally retrieving the <code>name</code> member using <code>BPF_CORE_READ</code> macro.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>bpf_path_d_path</code> Kernel function i used to extract the path name for the supplied path data structure defined in <code>fs/bpf_fs_kfuncs.c</code> in the kernel source code as  the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">__bpf_kfunc</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_path_d_path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">buf__sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">buf__sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EINVAL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf__sz</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">IS_ERR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">PTR_ERR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buf</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">buf__sz</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">memmove</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>There is a comment in the source code very descriptive about this kernel function which says:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span> * bpf_path_d_path - resolve the pathname for the supplied path
</span></span><span style="display:flex;"><span> * @path: path to resolve the pathname for
</span></span><span style="display:flex;"><span> * @buf: buffer to return the resolved pathname in
</span></span><span style="display:flex;"><span> * @buf__sz: length of the supplied buffer
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * Resolve the pathname for the supplied *path* and store it in *buf*. This BPF
</span></span><span style="display:flex;"><span> * kfunc is the safer variant of the legacy bpf_d_path() helper and should be
</span></span><span style="display:flex;"><span> * used in place of bpf_d_path() whenever possible. It enforces KF_TRUSTED_ARGS
</span></span><span style="display:flex;"><span> * semantics, meaning that the supplied *path* must itself hold a valid
</span></span><span style="display:flex;"><span> * reference, or else the BPF program will be outright rejected by the BPF
</span></span><span style="display:flex;"><span> * verifier.
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * This BPF kfunc may only be called from BPF LSM programs.
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * Return: A positive integer corresponding to the length of the resolved
</span></span><span style="display:flex;"><span> * pathname in *buf*, including the NUL termination character. On error, a
</span></span><span style="display:flex;"><span> * negative integer is returned.
</span></span></code></pre></div><p><code>bpf_get_current_uid_gid</code> helper function to get the current UID and GID.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">u64</span> <span style="color:#000">uid_gid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_uid_gid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">uid_gid</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// the lower 32 bits are the UID
</span></span></span></code></pre></div><p>The user-space code is like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;lsm_mkdir.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">lsm_mkdir</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lsm_mkdir__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lsm_mkdir__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lsm_mkdir__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lsm_mkdir__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> LSM: mkdir <span style="color:#4e9a06">&#39;test1&#39;</span> in directory <span style="color:#4e9a06">&#39;/tmp&#39;</span> with mode 511, UID <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> LSM: mkdir <span style="color:#4e9a06">&#39;test2&#39;</span> in directory <span style="color:#4e9a06">&#39;/tmp&#39;</span> with mode 511, UID <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span></code></pre></div><p>eBPF LSM are classified as <code>BPF_PROG_TYPE_LSM</code>, <code>sudo strace -ebpf ./loader</code> will show similar output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>bpf<span style="color:#ce5c00;font-weight:bold">(</span>BPF_PROG_LOAD, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">prog_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_PROG_TYPE_LSM, <span style="color:#000">insn_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>68, <span style="color:#000">insns</span><span style="color:#ce5c00;font-weight:bold">=</span>0x560837bfc0e0, <span style="color:#000">license</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;GPL&#34;</span>, <span style="color:#000">log_level</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_size</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">log_buf</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL, <span style="color:#000">kern_version</span><span style="color:#ce5c00;font-weight:bold">=</span>KERNEL_VERSION<span style="color:#ce5c00;font-weight:bold">(</span>6, 12, 12<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">prog_flags</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">prog_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;path_mkdir&#34;</span>, <span style="color:#000">prog_ifindex</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">expected_attach_type</span><span style="color:#ce5c00;font-weight:bold">=</span>BPF_LSM_MAC, <span style="color:#000">prog_btf_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>4, <span style="color:#000">func_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>8, <span style="color:#000">func_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x560837bfa650, <span style="color:#000">func_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>1, <span style="color:#000">line_info_rec_size</span><span style="color:#ce5c00;font-weight:bold">=</span>16, <span style="color:#000">line_info</span><span style="color:#ce5c00;font-weight:bold">=</span>0x560837bfcfb0, <span style="color:#000">line_info_cnt</span><span style="color:#ce5c00;font-weight:bold">=</span>11, <span style="color:#000">attach_btf_id</span><span style="color:#ce5c00;font-weight:bold">=</span>58073, <span style="color:#000">attach_prog_fd</span><span style="color:#ce5c00;font-weight:bold">=</span>0, <span style="color:#000">fd_array</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span>, 148<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><p>This is not all, LSM is not just about observability, LSM are made to take decisions, define controls and enforce them. Let&rsquo;s explore another example which its main objective to block opining <code>/etc/passwd</code> file.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define FULL_PATH_LEN 256
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lsm/file_open&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">file_open</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">FULL_PATH_LEN</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">target</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_path_d_path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">f_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">target</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">target</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">target</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Blocking open of: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">full_path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EPERM</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>struct file</code> data structure represents an instance of an open file or device within a process defined in <code>include/linux/fs.h</code> header file in the kernel source code as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">atomic_long_t</span>			<span style="color:#000">f_count</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">spinlock_t</span>			<span style="color:#000">f_lock</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fmode_t</span>				<span style="color:#000">f_mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file_operations</span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_op</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">address_space</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_mapping</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">void</span>				<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">private_data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">inode</span>			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_inode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">f_flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span>			<span style="color:#000">f_iocb_flags</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cred</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_cred</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span>			<span style="color:#000">f_path</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">mutex</span>		<span style="color:#000">f_pos_lock</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">u64</span>			<span style="color:#000">f_pipe</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">loff_t</span>				<span style="color:#000">f_pos</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef CONFIG_SECURITY
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">void</span>				<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_security</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">fown_struct</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_owner</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">errseq_t</span>			<span style="color:#000">f_wb_err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">errseq_t</span>			<span style="color:#000">f_sb_err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef CONFIG_EPOLL
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">hlist_head</span>		<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">f_ep</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">callback_head</span>	<span style="color:#000">f_task_work</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">llist_node</span>	<span style="color:#000">f_llist</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file_ra_state</span>	<span style="color:#000">f_ra</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">freeptr_t</span>		<span style="color:#000">f_freeptr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>struct file</code> members are described as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">Represents</span> <span style="color:#000">a</span> <span style="color:#000">file</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_count</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">reference</span> <span style="color:#000">count</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_lock</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Protects</span> <span style="color:#000">f_ep</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f_flags</span><span style="color:#000;font-weight:bold">.</span> <span style="color:#000">Must</span> <span style="color:#000">not</span> <span style="color:#000">be</span> <span style="color:#000">taken</span> <span style="color:#000">from</span> <span style="color:#000">IRQ</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_mode</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">FMODE_</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">flags</span> <span style="color:#000">often</span> <span style="color:#000">used</span> <span style="color:#000">in</span> <span style="color:#000">hotpaths</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_op</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">file</span> <span style="color:#000">operations</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_mapping</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Contents</span> <span style="color:#000">of</span> <span style="color:#000">a</span> <span style="color:#000">cacheable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mappable</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">private_data</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">filesystem</span> <span style="color:#000">or</span> <span style="color:#000">driver</span> <span style="color:#000">specific</span> <span style="color:#000">data</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_inode</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cached</span> <span style="color:#000">inode</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_flags</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">file</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_iocb_flags</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">iocb</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_cred</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stashed</span> <span style="color:#000">credentials</span> <span style="color:#000">of</span> <span style="color:#000">creator</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">opener</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_path</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">path</span> <span style="color:#000">of</span> <span style="color:#000">the</span> <span style="color:#000">file</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_pos_lock</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">lock</span> <span style="color:#000">protecting</span> <span style="color:#000">file</span> <span style="color:#000">position</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_pipe</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">specific</span> <span style="color:#000">to</span> <span style="color:#000">pipes</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_pos</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">file</span> <span style="color:#000">position</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_security</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">LSM</span> <span style="color:#000">security</span> <span style="color:#000">context</span> <span style="color:#000">of</span> <span style="color:#000">this</span> <span style="color:#000">file</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_owner</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">file</span> <span style="color:#000">owner</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_wb_err</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">writeback</span> <span style="color:#000">error</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_sb_err</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">per</span> <span style="color:#000">sb</span> <span style="color:#000">writeback</span> <span style="color:#000">errors</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_ep</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">link</span> <span style="color:#000">of</span> <span style="color:#000">all</span> <span style="color:#000">epoll</span> <span style="color:#000">hooks</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">this</span> <span style="color:#000">file</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_task_work</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">task</span> <span style="color:#000">work</span> <span style="color:#000">entry</span> <span style="color:#000">point</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_llist</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">work</span> <span style="color:#000">queue</span> <span style="color:#000">entrypoint</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_ra</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">file</span><span style="color:#a40000">&#39;</span><span style="color:#000">s</span> <span style="color:#000">readahead</span> <span style="color:#000">state</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">f_freeptr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Pointer</span> <span style="color:#000">used</span> <span style="color:#000">by</span> <span style="color:#000">SLAB_TYPESAFE_BY_RCU</span> <span style="color:#000">file</span> <span style="color:#000">cache</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">don</span><span style="color:#a40000">&#39;</span><span style="color:#000">t</span> <span style="color:#000">touch</span><span style="color:#000;font-weight:bold">.)</span>
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter5/lsm-passwd.png" alt="Centered image" />
</p>
<p>Output when opening <code>/etc/passwd</code> shows the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat-1673    <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ...11   262.949842: bpf_trace_printk: Blocking open of: /etc/passwd
</span></span></code></pre></div><p>The code can also work based on comparing the inode rather than the filename. The following example uses a hard-coded inode value for demonstration purposes only.


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    An inode (short for &ldquo;index node&rdquo;) a unique inode number is assigned to Each file or directory in a filesystem. When a file is accessed, the system uses the inode to locate and retrieve its metadata and content. Inode does not store the file&rsquo;s name.

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Hard-coding an inode number in your code is not suitable for portability. Inode numbers are specific to a particular filesystem and can change across different systems. This means that relying on a fixed inode number may lead to unexpected behavior in different environments.

</div>
</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define TARGET_INODE 788319
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lsm/file_open&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">file_open</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u64</span> <span style="color:#000">ino</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f_inode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i_ino</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ino</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">TARGET_INODE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Blocking open: inode %llu matched TARGET_INO</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ino</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EPERM</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First we need to obtain <code>/etc/passwd</code> inode using <code>ls-i /etc/passwd</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">788319</span> /etc/passwd
</span></span></code></pre></div><p>Then you use that number in your code to check against the file’s inode. Let&rsquo;s see another example for socket. <code>socket_create</code> described in the source code as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#a40000">@</span><span style="color:#f57900">socket_create</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#000">Check</span> <span style="color:#000">permissions</span> <span style="color:#000">prior</span> <span style="color:#000">to</span> <span style="color:#000">creating</span> <span style="color:#000">a</span> <span style="color:#000">new</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#a40000">@</span><span style="color:#000">family</span> <span style="color:#000">contains</span> <span style="color:#000">the</span> <span style="color:#000">requested</span> <span style="color:#000">protocol</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#a40000">@</span><span style="color:#000">type</span> <span style="color:#000">contains</span> <span style="color:#000">the</span> <span style="color:#000">requested</span> <span style="color:#000">communications</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#a40000">@</span><span style="color:#000">protocol</span> <span style="color:#000">contains</span> <span style="color:#000">the</span> <span style="color:#000">requested</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#a40000">@</span><span style="color:#000">kern</span> <span style="color:#000">set</span> <span style="color:#000">to</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span> <span style="color:#000">kernel</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">*</span>	<span style="color:#000">Return</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">permission</span> <span style="color:#000">is</span> <span style="color:#000">granted</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p><code>socket_create</code> LSM hook look like this in the source code also:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LSM_HOOK</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">socket_create</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kern</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Let&rsquo;s see how to prevent UID 1000 from creating a new socket:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lsm/socket_create&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_PROG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">socket_create</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kern</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u64</span> <span style="color:#000">uid_gid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_uid_gid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">uid_gid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Blocking socket_create for uid %d, family %d, type %d, protocol %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#000">uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">family</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EPERM</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>When a process running as UID 1000 (for example, when a user attempts to run ping or ssh) tries to create a new socket, the LSM hook for socket creation is triggered.The eBPF program intercepts this call and retrieves the current UID using <code>bpf_get_current_uid_gid()</code>. If the UID is 1000, the program returns <code>-EPERM</code> (which means &ldquo;Operation not permitted&rdquo;). This return value causes the socket creation to fail.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ping-2197 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> Blocking socket_create <span style="color:#204a87;font-weight:bold">for</span> uid 1000, family 2, <span style="color:#204a87">type</span> 2, protocol <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>ssh-2198 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> Blocking socket_create <span style="color:#204a87;font-weight:bold">for</span> uid 1000, family 2, <span style="color:#204a87">type</span> 1, protocol <span style="color:#0000cf;font-weight:bold">6</span>
</span></span></code></pre></div><p>Of course—you can fine-tune your policy based on the arguments passed to the hook. For example, if you only want to block socket creation for TCP (protocol number 6), you can do something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">EPERM</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This means that only when the protocol equals 6 (TCP) will the socket creation be blocked, while other protocols will be allowed. Socket family is defined in <code>include/linux/socket.h</code>, while socket type is defined in <code>include/linux/net.h</code> and socket protocol is defined in <code>include/uapi/linux/in.h</code>.</p>
<p>I strongly recommend exploring more LSM hooks on your own and consulting the documentation—you’ll quickly see that working with them is not hard at all.
Next, we will see Landlock which allows a process to restrict its own privileges in unprivileged manner or process sandbox.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8f50351f0c6b2104de204efd796695d8">6.3 - Landlock</h1>
    <div class="lead">User space sandboxing where apps define their own file access rules.</div>
	<p>Landlock is a Linux Security Module (LSM) introduced in Linux kernel 5.13 based on eBPF that allows processes to restrict their own privileges in a fine-grained, stackable, and unprivileged manner. Unlike traditional Mandatory Access Control (MAC) systems such as SELinux and AppArmor, which require administrative setup, Landlock enables unprivileged processes to sandbox themselves. This makes it particularly useful for running potentially vulnerable applications while limiting their ability to perform unauthorized actions.</p>
<p>By defining specific access rules, processes can restrict themselves to only the necessary files and network operations, preventing unauthorized access or modification of sensitive data. This capability is particularly valuable in scenarios where applications handle untrusted input or where minimizing the impact of potential security breaches is critical.</p>
<p>A key advantage of Landlock is its layered security model. Rulesets in Landlock are stackable, meaning multiple rulesets can be enforced incrementally to tighten security restrictions over time. Once a Landlock ruleset is enforced, it cannot be relaxed or removed, ensuring that restrictions remain in place throughout the process&rsquo;s lifetime. Additionally, Landlock operates at the kernel object (e.g., file, process, socket) level rather than filtering syscalls, providing minimal overhead, a stable interface for future developments and race condition free.</p>
<p>To check if Landlock is up and running is by executing <code>sudo dmesg | grep landlock || journalctl -kb -g landlock</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>    0.043191<span style="color:#ce5c00;font-weight:bold">]</span> LSM: initializing <span style="color:#000">lsm</span><span style="color:#ce5c00;font-weight:bold">=</span>lockdown,capability,landlock,yama,apparmor,tomoyo,bpf,ipe,ima,evm
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>    0.043191<span style="color:#ce5c00;font-weight:bold">]</span> landlock: Up and running.
</span></span></code></pre></div><h3 id="how-landlock-works">How Landlock Works<a class="td-heading-self-link" href="#how-landlock-works" aria-label="Heading self-link"></a></h3>
<ol>
<li><strong>Ruleset Creation:</strong><br>
A Landlock ruleset defines what kinds of actions are handled (e.g., file read/write, TCP connect) and denies those actions by default unless they are explicitly allowed by the rules added to that ruleset. There are three types of rules in landlock defined in <code>include/uapi/linux/landlock.h</code> header file : <code>handled_access_fs</code>, <code>handled_access_net</code> and <code>scoped</code> as defined in the following data structure:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @handled_access_fs: Bitmask of handled filesystem actions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * (cf. `Filesystem flags`_).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">handled_access_fs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @handled_access_net: Bitmask of handled network actions (cf. `Network
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * flags`_).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">handled_access_net</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @scoped: Bitmask of scopes (cf. `Scope flags`_)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * restricting a Landlock domain from accessing outside
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * resources (e.g. IPCs).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">scoped</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>handled_access_fs</code> rules to sandbox a process to a set of actions on files and directories and they are as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_WRITE_FILE</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_REMOVE_DIR</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_REMOVE_FILE</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_CHAR</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">6</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_DIR</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">7</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_REG</span><span style="color:#f8f8f8;text-decoration:underline">		   	    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">8</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_SOCK</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">9</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_FIFO</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_BLOCK</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_SYM</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">12</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_REFER</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">13</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_TRUNCATE</span><span style="color:#f8f8f8;text-decoration:underline">			    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">14</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">15</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>They are explained in <code>include/uapi/linux/landlock.h</code> as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Execute</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_WRITE_FILE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Open</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">write</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">access</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Open</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">read</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">access</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Open</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">directory</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">list</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">its</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_REMOVE_DIR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Remove</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">empty</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">directory</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">one</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_REMOVE_FILE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Unlink</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_CHAR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">character</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_DIR</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">directory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_REG</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regular</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_SOCK</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UNIX</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">domain</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_FIFO</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">named</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pipe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_BLOCK</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">block</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_MAKE_SYM</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">symbolic</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_REFER</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Link</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">different</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">directory</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#c4a000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">reparent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hierarchy</span><span style="color:#000;font-weight:bold">).</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_TRUNCATE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Truncate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">with</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">truncate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ftruncate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">creat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">O_TRUNC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Invoke</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">manpage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#a40000">`</span><span style="color:#000">ioctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#a40000">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">commands</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">an</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">opened</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">character</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">or</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">block</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>handled_access_net</code> rules to sandbox a process to a set of network actions and they are defined as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#f8f8f8;text-decoration:underline">			</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>handled_access_net</code> rules are explained as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f57900">LANDLOCK_ACCESS_NET_BIND_TCP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Bind</span> <span style="color:#000">a</span> <span style="color:#000">TCP</span> <span style="color:#000">socket</span> <span style="color:#000">to</span> <span style="color:#000">a</span> <span style="color:#000">local</span> <span style="color:#000">port</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f57900">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Connect</span> <span style="color:#000">an</span> <span style="color:#000">active</span> <span style="color:#000">TCP</span> <span style="color:#000">socket</span> <span style="color:#000">to</span>
</span></span></code></pre></div><p><code>scoped</code> rules to sandbox a process from a set of IPC (inter-process communication) actions or sending signals and they are defined as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span><span style="color:#f8f8f8;text-decoration:underline">		    </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LANDLOCK_SCOPE_SIGNAL</span><span style="color:#f8f8f8;text-decoration:underline">		                </span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1ULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>scoped</code> rules are explained as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f57900">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Restrict</span> <span style="color:#000">a</span> <span style="color:#000">sandboxed</span> <span style="color:#000">process</span> <span style="color:#000">from</span> <span style="color:#000">connecting</span> <span style="color:#000">to</span> <span style="color:#000">an</span> <span style="color:#000">abstract</span> <span style="color:#000">UNIX</span> <span style="color:#000">socket</span> <span style="color:#000">created</span> <span style="color:#000">by</span> <span style="color:#000">a</span> <span style="color:#000">process</span> <span style="color:#000">outside</span> <span style="color:#000">the</span> <span style="color:#000">related</span> <span style="color:#000">Landlock</span> <span style="color:#000">domain</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span> <span style="color:#000">a</span> <span style="color:#000">parent</span> <span style="color:#000">domain</span> <span style="color:#000">or</span> <span style="color:#000">a</span> <span style="color:#000">non</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">sandboxed</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#f57900">LANDLOCK_SCOPE_SIGNAL</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Restrict</span> <span style="color:#000">a</span> <span style="color:#000">sandboxed</span> <span style="color:#000">process</span> <span style="color:#000">from</span> <span style="color:#000">sending</span> <span style="color:#000">a</span> <span style="color:#000">signal</span> <span style="color:#000">to</span> <span style="color:#000">another</span> <span style="color:#000">process</span> <span style="color:#000">outside</span> <span style="color:#000">the</span> <span style="color:#000">domain</span>
</span></span></code></pre></div><p>Ruleset Creation is done using <code>landlock_create_ruleset()</code> syscall.</p>
<ol start="2">
<li><strong>Adding Rules:</strong><br>
Define access rights since the defaults actions is deny. Define access rights can be done using data structures which are <code>landlock_path_beneath_attr</code> and <code>landlock_net_port_attr</code>. For example, block access to entire file system except read files, read directories and execute on <code>/usr/bin/</code>.
<code>landlock_path_beneath_attr</code> data structure is defined in <code>include/uapi/linux/landlock.h</code> header file as the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_path_beneath_attr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @allowed_access: Bitmask of allowed actions for this file hierarchy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * (cf. `Filesystem flags`_).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">allowed_access</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @parent_fd: File descriptor, preferably opened with ``O_PATH``,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * which identifies the parent directory of a file hierarchy, or just a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * file.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__s32</span> <span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * This struct is packed to avoid trailing reserved members.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * Cf. security/landlock/syscalls.c:build_check_abi()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">__attribute__</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">packed</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p><code>landlock_net_port_attr</code> data structure is defined in <code>include/uapi/linux/landlock.h</code> header file as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_net_port_attr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @allowed_access: Bitmask of allowed network actions for a port
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * (cf. `Network flags`_).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">allowed_access</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * @port: Network port in host endianness.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * It should be noted that port 0 passed to :manpage:`bind(2)` will bind
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * to an available port from the ephemeral port range.  This can be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * configured with the ``/proc/sys/net/ipv4/ip_local_port_range`` sysctl
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * (also used for IPv6).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * A Landlock rule with port 0 and the ``LANDLOCK_ACCESS_NET_BIND_TCP``
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * right means that requesting to bind on port 0 is allowed and it will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 * automatically translate to binding on the related port range.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">port</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Adding rules can be done using <code>landlock_add_rule()</code> syscall.</p>
<ol start="3">
<li><strong>Restricting Self:</strong><br>
Once a ruleset is created and populated, a thread (with <code>no_new_privs</code> set, or with <code>CAP_SYS_ADMIN</code> in its namespace) can call <code>landlock_restrict_self()</code>  syscall to enforce it on itself and all child processes. After enforcement, the process can still add more restrictions later, but cannot remove existing ones.</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Each time you call <code>landlock_restrict_self()</code> syscall will add a new layer, and you can stack up to 16 layers (rulesets). If layers exceed 16, it will return <code>E2BIG</code> (Argument list too long).

</div>

<h3 id="abi-versions-and-compatibility">ABI Versions and Compatibility<a class="td-heading-self-link" href="#abi-versions-and-compatibility" aria-label="Heading self-link"></a></h3>
<p>When you call <code>landlock_create_ruleset()</code> with <code>attr = NULL</code> and <code>size = 0</code>, it returns the highest supported ABI. A recommended practice is to do a best-effort approach: detect the system’s ABI, then disable features that are not supported, so your program runs consistently on different kernels.</p>
<ul>
<li><strong>ABI &lt; 2</strong>: Did not allow renaming/linking across directories.</li>
<li><strong>ABI &lt; 3</strong>: File truncation could not be restricted.</li>
<li><strong>ABI &lt; 4</strong>: No network restriction support.</li>
<li><strong>ABI &lt; 5</strong>: Could not restrict <code>ioctl(2)</code> on devices.</li>
<li><strong>ABI &lt; 6</strong>: No scope restrictions for signals or abstract Unix sockets.</li>
</ul>
<p>It&rsquo;s recommended to detect Landlock ABI version to maintain compatibility across different kernel versions as stated in the kernel manual:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">abi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_CREATE_RULESET_VERSION</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Degrades gracefully if Landlock is not handled. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;The running kernel does not enable to use Landlock&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Removes LANDLOCK_ACCESS_FS_REFER for ABI &lt; 2 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_fs</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">LANDLOCK_ACCESS_FS_REFER</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__attribute__</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">fallthrough</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Removes LANDLOCK_ACCESS_FS_TRUNCATE for ABI &lt; 3 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_fs</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">LANDLOCK_ACCESS_FS_TRUNCATE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__attribute__</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">fallthrough</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Removes network support for ABI &lt; 4 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_net</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__attribute__</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">fallthrough</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Removes LANDLOCK_ACCESS_FS_IOCTL_DEV for ABI &lt; 5 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_fs</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">LANDLOCK_ACCESS_FS_IOCTL_DEV</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__attribute__</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">fallthrough</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* Removes LANDLOCK_SCOPE_* for ABI &lt; 6 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scoped</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#000">LANDLOCK_SCOPE_SIGNAL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s see a simple example to sandbox a process from communicating through TCP.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define _GNU_SOURCE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/landlock.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_create_ruleset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_restrict_self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_CREATE_RULESET_VERSION</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landlock network restrictions are not supported (need ABI &gt;= 4).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Running %s without Landlock.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">execvp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execvp&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#000">ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_net</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_create_ruleset&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_restrict_self&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execvp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execvp failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>First, we define inline helper functions to provide a simplified interface for the <code>landlock_create_ruleset</code> and <code>landlock_restrict_self</code> system calls.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_create_ruleset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_restrict_self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then, check Landlock ABI support (version &gt;=4 supports network restrictions):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_CREATE_RULESET_VERSION</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landlock network restrictions are not supported (need ABI &gt;= 4).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Running %s without Landlock.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">execvp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execvp&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then, define rules using <code>landlock_ruleset_attr</code> data structure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#000">ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_net</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>Next,  Ruleset creation using <code>landlock_create_ruleset()</code> syscall and get <code>ruleset_fd</code> as return value:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_create_ruleset&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then, prevent the process from gaining new privileges using <code>prctl</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Finally, enforce rules using <code>landlock_restrict_self()</code> syscall:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_restrict_self&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile the code <code>gcc -Wall landlock_no_tcp.c -o landlock_no_tcp</code>, then, let&rsquo;s test it <code>./landlock_no_tcp ssh 192.168.1.2</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ssh: connect to host 192.168.1.2 port 22: Permission denied
</span></span></code></pre></div><p>We can see why this happened using <code>strace ./landlock_no_tcp ssh 192.168.1.2</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#ce5c00;font-weight:bold">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>fcntl<span style="color:#ce5c00;font-weight:bold">(</span>3, F_SETFD, FD_CLOEXEC<span style="color:#ce5c00;font-weight:bold">)</span>           <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>getsockname<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">sa_family</span><span style="color:#ce5c00;font-weight:bold">=</span>AF_INET, <span style="color:#000">sin_port</span><span style="color:#ce5c00;font-weight:bold">=</span>htons<span style="color:#ce5c00;font-weight:bold">(</span>0<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">sin_addr</span><span style="color:#ce5c00;font-weight:bold">=</span>inet_addr<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0.0.0.0&#34;</span><span style="color:#ce5c00;font-weight:bold">)}</span>, <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">128</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; 16<span style="color:#ce5c00;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>setsockopt<span style="color:#ce5c00;font-weight:bold">(</span>3, SOL_IP, IP_TOS, <span style="color:#ce5c00;font-weight:bold">[</span>16<span style="color:#ce5c00;font-weight:bold">]</span>, 4<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>connect<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">sa_family</span><span style="color:#ce5c00;font-weight:bold">=</span>AF_INET, <span style="color:#000">sin_port</span><span style="color:#ce5c00;font-weight:bold">=</span>htons<span style="color:#ce5c00;font-weight:bold">(</span>22<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">sin_addr</span><span style="color:#ce5c00;font-weight:bold">=</span>inet_addr<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;192.168.1.2&#34;</span><span style="color:#ce5c00;font-weight:bold">)}</span>, 16<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> -1 EACCES <span style="color:#ce5c00;font-weight:bold">(</span>Permission denied<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>getpid<span style="color:#ce5c00;font-weight:bold">()</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2245</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;ssh: connect to host 192.168.1.2&#34;</span>..., 61ssh: connect to host 192.168.1.2 port 22: Permission denied
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">61</span>
</span></span><span style="display:flex;"><span>munmap<span style="color:#ce5c00;font-weight:bold">(</span>0x7f9c722d3000, 135168<span style="color:#ce5c00;font-weight:bold">)</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>exit_group<span style="color:#ce5c00;font-weight:bold">(</span>255<span style="color:#ce5c00;font-weight:bold">)</span>                         <span style="color:#ce5c00;font-weight:bold">=</span> ?
</span></span><span style="display:flex;"><span>+++ exited with <span style="color:#0000cf;font-weight:bold">255</span> +++
</span></span></code></pre></div><p>We can see what is going to happen if we use sudo <code>strace ./landlock_no_tcp sudo ssh 192.168.1.2</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;&#34;</span>, 4096<span style="color:#ce5c00;font-weight:bold">)</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>geteuid<span style="color:#ce5c00;font-weight:bold">()</span>                               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>prctl<span style="color:#ce5c00;font-weight:bold">(</span>PR_GET_NO_NEW_PRIVS, 0, 0, 0, 0<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/usr/share/locale/locale.alias&#34;</span>, O_RDONLY<span style="color:#000;font-weight:bold">|</span>O_CLOEXEC<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFREG<span style="color:#000;font-weight:bold">|</span>0644, <span style="color:#000">st_size</span><span style="color:#ce5c00;font-weight:bold">=</span>2996, ...<span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;# Locale name alias data base.\n#&#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2996</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;&#34;</span>, 4096<span style="color:#ce5c00;font-weight:bold">)</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;sudo&#34;</span>, 4sudo<span style="color:#ce5c00;font-weight:bold">)</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;: &#34;</span>, 2: <span style="color:#ce5c00;font-weight:bold">)</span>                       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;The \&#34;no new privileges\&#34; flag is &#34;</span>..., 78The <span style="color:#4e9a06">&#34;no new privileges&#34;</span> flag is set, which prevents sudo from running as root.<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">78</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The output should look like the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo: The <span style="color:#4e9a06">&#34;no new privileges&#34;</span> flag is set, which prevents sudo from running as root.
</span></span><span style="display:flex;"><span>sudo: If sudo is running in a container, you may need to adjust the container configuration to disable the flag.
</span></span></code></pre></div><p>Below another simplified example illustrating how to use Landlock to allow read-only access to <code>/usr</code>  and <code>/etc/ssl/certs</code> while permitting only TCP port 443 connections, and denying all other filesystem and TCP actions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define _GNU_SOURCE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/landlock.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;fcntl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_create_ruleset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">landlock_rule_type</span> <span style="color:#000">rule_type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rule_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_add_rule</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rule_type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rule_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__u32</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__NR_landlock_restrict_self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary-to-sandbox&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_CREATE_RULESET_VERSION</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Landlock not available. Running %s without restrictions.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">execvp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execvp&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#000">ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_fs</span> <span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_net</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_create_ruleset&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_path_beneath_attr</span> <span style="color:#000">usr_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/usr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_PATH</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">O_CLOEXEC</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open /usr&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_PATH_BENEATH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (/usr)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_path_beneath_attr</span> <span style="color:#000">ssl_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/etc/ssl/certs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_PATH</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">O_CLOEXEC</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open /etc/ssl/certs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_PATH_BENEATH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (/etc/ssl/certs)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_net_port_attr</span> <span style="color:#000">net_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_NET_PORT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">net_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (HTTPS only)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_restrict_self</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_restrict_self&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execvp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execvp failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Here we defined rules for file access and network access then ruleset creation :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_ruleset_attr</span> <span style="color:#000">ruleset_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_fs</span> <span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">handled_access_net</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_BIND_TCP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">landlock_create_ruleset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_attr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_create_ruleset&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then, allow read-only and execute rights to <code>/usr</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_path_beneath_attr</span> <span style="color:#000">usr_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_EXECUTE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/usr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_PATH</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">O_CLOEXEC</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open /usr&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_PATH_BENEATH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (/usr)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">usr_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Then, allow read-only access to <code>/etc/ssl/certs</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_path_beneath_attr</span> <span style="color:#000">ssl_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_FILE</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">LANDLOCK_ACCESS_FS_READ_DIR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/etc/ssl/certs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_PATH</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">O_CLOEXEC</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open /etc/ssl/certs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_PATH_BENEATH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (/etc/ssl/certs)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ssl_attr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parent_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Next, ensure network control is supported by the kernel then allow only TCP port 443:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">abi</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">landlock_net_port_attr</span> <span style="color:#000">net_attr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">allowed_access</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LANDLOCK_ACCESS_NET_CONNECT_TCP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">.</span><span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">landlock_add_rule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">LANDLOCK_RULE_NET_PORT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">net_attr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;landlock_add_rule (HTTPS only)&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ruleset_fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Running <code>./landlock_tcp_bin curl https://8.8.8.8</code> TCP port 443:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;content-type&#34;</span> <span style="color:#000">content</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;text/html;charset=utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
</span></span><span style="display:flex;"><span>&lt;H1&gt;302 Moved&lt;/H1&gt;
</span></span><span style="display:flex;"><span>The document has moved
</span></span><span style="display:flex;"><span>&lt;A <span style="color:#000">HREF</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://dns.google/&#34;</span>&gt;here&lt;/A&gt;.
</span></span><span style="display:flex;"><span>&lt;/BODY&gt;&lt;/HTML&gt;
</span></span></code></pre></div><p>Running <code>./landlock_tcp_bin curl http://1.1.1.1</code> TCP port 80:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl: <span style="color:#ce5c00;font-weight:bold">(</span>7<span style="color:#ce5c00;font-weight:bold">)</span> Failed to connect to 1.1.1.1 port <span style="color:#0000cf;font-weight:bold">80</span> after <span style="color:#0000cf;font-weight:bold">0</span> ms: Could not connect to server
</span></span></code></pre></div><p>Running <code>./landlock_tcp_bin ls /etc</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ls: cannot open directory <span style="color:#4e9a06">&#39;/etc&#39;</span>: Permission denied
</span></span></code></pre></div><p>Let&rsquo;s move on to some tools that can help with advanced monitoring and control or a kind of next-level firewalling.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72b27f510604bdf56670cd8c84779f4a">6.4 - bpf_send_signal</h1>
    <div class="lead">Helper that can raise signals in misbehaving tasks from inside BPF code.</div>
	<p><code>bpf_send_signal()</code> is a helper function that allows a eBPF program to send a Unix signal (e.g., <code>SIGUSR1</code>, <code>SIGKILL</code>, etc.) to the current process (the process that triggered execution of the BPF program). If an anomaly is detected (e.g., unauthorized file access, network connections, or excessive resource usage), the eBPF program can send a signal to terminate the offending process. <code>bpf_send_signal_thread()</code> helper function is similar to <code>bpf_send_signal()</code> except it will send a signal to thread corresponding to the current task.</p>
<p><code>bpf_send_signal</code> has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">long</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">__u32</span> <span style="color:#000">sig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">109</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p><code>sys_ptrace</code> is a system call in Linux and other Unix-like operating systems that allows one process (the tracer) to observe and control the execution of another process (the tracee). The following example, we attached kprobe to <code>sys_ptrace</code> syscall and monitor this call to only allow root (UID = 0) to call this syscall. If UID not zero (non-root user) hen the process will be terminated using <code>bpf_send_signal()</code> helper function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define ALLOWED_UID 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/__x64_sys_ptrace&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE__x64_sys_ptrace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u64</span> <span style="color:#000">uid_gid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_uid_gid</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">__u32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uid_gid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ALLOWED_UID</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unauthorized ptrace attempt by uid %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/resource.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;signal_ptrace.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">libbpf_print_level</span> <span style="color:#000">level</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_list</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vfprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">signal_ptrace</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">libbpf_set_print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_print_fn</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">signal_ptrace__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">signal_ptrace__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load and verify BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">signal_ptrace__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#4e9a06">&#34;to see output of the BPF programs.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">signal_ptrace__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile the code, then generate skeleton file , then compile the loader code. When trying to trigger <code>ptrace</code> syscall with a tool like <code>strace</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>strace /usr/bin/ls
</span></span><span style="display:flex;"><span>Killed
</span></span></code></pre></div><p>Viewing the trace pipe file <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code> will give similar output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>strace-3402    <span style="color:#ce5c00;font-weight:bold">[</span>001<span style="color:#ce5c00;font-weight:bold">]</span> ...21 16100.793628: bpf_trace_printk: Unauthorized ptrace attempt by uid <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span></code></pre></div><p>Below is an example write-up that describes an imaginary privilege escalation scenario and shows the eBPF code that detects the specific syscall sequence (fork, setuid(0), and execve) to terminate the process.</p>
<p>Imagine an attacker attempts a privilege escalation by using the following assembly code to fork, set UID to 0, and finally execute <code>/bin/bash</code> to spawn a root shell:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">section</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cmd</span> <span style="color:#000">db</span> <span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">section</span> <span style="color:#000;font-weight:bold">.</span><span style="color:#000">text</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">global</span> <span style="color:#000">_start</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">_start</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Fork</span> <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mov</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">57</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">edi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">edi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">test</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eax</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jz</span> <span style="color:#000">child_process</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Parent</span> <span style="color:#000">process</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Setuid</span> <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mov</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">105</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">edi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">edi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cmp</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">jne</span> <span style="color:#000">exit_program</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Execve</span> <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mov</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">59</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mov</span> <span style="color:#000">rdi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">rsi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">rdx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rdx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">exit_program</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mov</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">edi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">edi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">child_process</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">;</span> <span style="color:#000">Child</span> <span style="color:#000">process</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">xor</span> <span style="color:#000">eax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eax</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ret</span>
</span></span></code></pre></div><p>First, we compile it using</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nasm -f elf64 -o privilege_escalation.o privilege_escalation.asm
</span></span></code></pre></div><p>Then link it</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ld -o privilege_escalation privilege_escalation.o<span style="color:#4e9a06">`</span>
</span></span></code></pre></div><p>We build an eBPF program that uses <code>bpf_send_signal</code> to monitor for a suspicious sequence of syscalls. If the program detects that a process has <code>forked</code>, then called <code>setuid(0)</code>, and finally executed <code>execve</code> to run <code>/bin/bash</code> (spawning a root shell), it will immediately fire a signal to terminate that process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">forks</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">setuid</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_fork&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_fork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_setuid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_setuid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priv</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">priv</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>sudo ./privilege_escalation</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>priv-3654 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> Fork detected: PID <span style="color:#0000cf;font-weight:bold">3654</span>
</span></span><span style="display:flex;"><span>priv-3654 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> Setuid detected: PID <span style="color:#0000cf;font-weight:bold">3654</span>
</span></span><span style="display:flex;"><span>priv-3654 <span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span> Privilege escalation detected: fork, setuid<span style="color:#ce5c00;font-weight:bold">(</span>0<span style="color:#ce5c00;font-weight:bold">)</span>, execve, PID <span style="color:#0000cf;font-weight:bold">3654</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b7d361a59848674b28ddf805a6cadf60">6.5 - Tetragon</h1>
    <div class="lead">CNCF project using eBPF to monitor and enforce runtime security policies.</div>
	<p>Tetragon is an open-source tool that uses eBPF to monitor and control Linux systems. It tracks events like process execution, network connections, and file access in real time. You can write custom rules to filter these events, and it runs with very little performance impact. Although it works great with Kubernetes and container setups, it can secure any Linux system that supports eBPF. Its kernel-level enforcement can, for example, kill a process if it violates a rule, adding a strong layer of security. Tetragon can be installed from their website <a href="https://tetragon.io/docs/installation/package/">https://tetragon.io/docs/installation/package/</a>, consider download it to follow this part.<br>
Tetragon works by using policies called TracingPolicies. These policies let you define exactly what kernel events to monitor and what actions to take when those events happen. You write rules in a policy that attach probes to kernel functions, filter events based on criteria like arguments or process IDs, and then enforce actions (for example, killing a process) if a rule is matched. This approach gives you fine-grained control over system security in real time. Let&rsquo;s take a glimpse of what Tetragon can do.</p>
<h2 id="tracingpolicy">TracingPolicy<a class="td-heading-self-link" href="#tracingpolicy" aria-label="Heading self-link"></a></h2>
<p>A TracingPolicy is a YAML document that follows Kubernetes’ API conventions. Even if you’re running Tetragon on a CLI (non-Kubernetes) installation, the policy structure remains similar. At its simplest, a tracing policy must include:</p>
<p><strong>API Version and Kind:</strong> This tells Tetragon which version of the API you’re using and what type of object you’re creating. For tracing policies, you typically use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cilium.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TracingPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>Metadata:</strong> Metadata includes a unique name for your policy.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;example-policy&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="spec-section">Spec Section<a class="td-heading-self-link" href="#spec-section" aria-label="Heading self-link"></a></h3>
<p><strong>Spec:</strong> The spec contains all the configuration details about what you want to trace and how. It’s where you define:</p>
<ul>
<li>The hook point (e.g., a kernel function to monitor)</li>
<li>Which arguments you want to capture</li>
<li>Selectors (in-kernel filters) to determine when the policy should trigger, and</li>
<li>The actions to execute when a match occurs.</li>
</ul>
<p>The hook point is the entry point where Tetragon attaches its BPF program. You have several options: kprobes, tracepoints, uprobes and lsmhooks.</p>
<p>Let’s say you want to monitor <code>do_mkdirat</code> kernel function. You would specify:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;do_mkdirat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;filename&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>What This Means:</strong></p>
<ul>
<li>You are instructing Tetragon to insert a kprobe into <code>do_mkdirat</code> kernel function and it&rsquo;s not a syscall.</li>
<li>The policy tells the eBPF code to extract three arguments: the integer value (the file descriptor number), the filename structure (which include the file path) and integer value as mode.
In some cases, you want to capture the return value from a function. To do so, set the <code>return</code> flag to true, define a <code>returnArg</code>, and specify its type.  This is useful when you want to track how a function completes.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;do_mkdirat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;filename&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">returnArg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	  </span><span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="selectors">Selectors<a class="td-heading-self-link" href="#selectors" aria-label="Heading self-link"></a></h3>
<p><strong>Selectors</strong> are the core of in-kernel filtering. They allow you to define conditions that must be met for the policy to apply and actions to be triggered. Within a selector, you can include one or more filters.</p>
<h3 id="filter-types">Filter Types<a class="td-heading-self-link" href="#filter-types" aria-label="Heading self-link"></a></h3>
<p>Each probe can contain up to 5 selectors and each selector can contain one or more filter. Below is a table summarizing the available filters, their definitions, and the operators they support:</p>
<table>
<thead>
<tr>
<th>Filter Name</th>
<th>Definition</th>
<th>Operators</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>matchArgs</strong></td>
<td>Filters on the value of function arguments.</td>
<td>Equal, NotEqual, Prefix, Postfix, Mask, GreaterThan (GT), LessThan (LT), SPort, NotSPort, SPortPriv, NotSPortPriv, DPort, NotDPort, DPortPriv, NotDPortPriv, SAddr, NotSAddr, DAddr, NotDAddr, Protocol, Family, State</td>
</tr>
<tr>
<td><strong>matchReturnArgs</strong></td>
<td>Filters based on the function’s return value.</td>
<td>Equal, NotEqual, Prefix, Postfix</td>
</tr>
<tr>
<td><strong>matchPIDs</strong></td>
<td>Filters on the host PID of the process.</td>
<td>In, NotIn</td>
</tr>
<tr>
<td><strong>matchBinaries</strong></td>
<td>Filters on the binary path (or name) of the process invoking the event.</td>
<td>In, NotIn, Prefix, NotPrefix, Postfix, NotPostfix</td>
</tr>
<tr>
<td><strong>matchNamespaces</strong></td>
<td>Filters based on Linux namespace values.</td>
<td>In, NotIn</td>
</tr>
<tr>
<td><strong>matchCapabilities</strong></td>
<td>Filters based on Linux capabilities in the specified set (Effective, Inheritable, or Permitted).</td>
<td>In, NotIn</td>
</tr>
<tr>
<td><strong>matchNamespaceChanges</strong></td>
<td>Filters based on changes in Linux namespaces (e.g., when a process changes its namespace).</td>
<td>In</td>
</tr>
<tr>
<td><strong>matchCapabilityChanges</strong></td>
<td>Filters based on changes in Linux capabilities (e.g., when a process’s capabilities are altered).</td>
<td>In</td>
</tr>
<tr>
<td><strong>matchActions</strong></td>
<td>Applies an action when the selector matches (executed directly in kernel BPF code or in userspace for some actions).</td>
<td>Not a traditional filter; supports action types such as: Sigkill, Signal, Override, FollowFD, UnfollowFD, CopyFD, GetUrl, DnsLookup, Post, NoPost, TrackSock, UntrackSock, NotifyEnforcer.</td>
</tr>
<tr>
<td><strong>matchReturnActions</strong></td>
<td>Applies an action based on the return value matching the selector.</td>
<td>Similar to <strong>matchActions</strong>; supports action types (as above) that are executed on return events.</td>
</tr>
</tbody>
</table>
<p><strong>matchArgs:</strong> Filter on a specific argument’s value (if filename = /etc/passwd)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/etc/shadow&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>matchBinaries:</strong>  Filters based on the binary path or name of the process invoking the function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchBinaries</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;In&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/usr/bin/sudo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/usr/bin/su&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Imagine you want to monitor any process that tries to open the file <code>/etc/shadow</code> or <code>/etc/passwd</code>. You might set up a selector that uses matchArgs filter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;sys_openat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/etc/shadow&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>First, filter on the second parameter (index=1), then match it with (/etc/passwd or /etc/shadow).</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Instead of writing the full name of syscalls such as <code>__x64_sys_openat</code> you can just use <code>sys_openat</code> and Tetragon will take care of the prefix of the syscall based on the architecture of you machine.

</div>

<h3 id="actions">Actions<a class="td-heading-self-link" href="#actions" aria-label="Heading self-link"></a></h3>
<p><strong>matchActions / matchReturnActions:</strong>  These attach actions to be executed when the selector matches. They also allow you to filter based on the value of return arguments (if needed).<br>
Actions are what your policy does when a selector matches. They allow you to enforce decisions right in the kernel. Some common actions include:<br>
<strong>Sigkill / Signal:</strong>  immediately terminates the offending process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sigkill</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To send a specific signal (e.g., SIGKILL which is signal 9)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Signal</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">argSig</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div><p><strong>Override:</strong>  Modifies the return value of a function, which can cause the caller to receive an error code. This action uses the error injection framework.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Override</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">argError</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Override function used for error injection. Due to security implications, override function is available only if the kernel was compiled with <code>CONFIG_BPF_KPROBE_OVERRIDE</code> option. There is a list of all function that support override and they are tagged with <code>ALLOW_ERROR_INJECTION</code> and they are located at <code>/sys/kernel/debug/error_injection/list</code>.

</div>

<p><strong>FollowFD / UnfollowFD / CopyFD:</strong>  These actions help track file descriptor usage. For example, you can map a file descriptor to a file name during an open call, so that later calls (e.g., sys_write) that only have an FD can be correlated to a file path. The best example to explain FollowFD / UnfollowFD is from Tetragon documentation. This example is how to prevent write to a specific files for example <code>/etc/passwd</code>. <code>sys_write</code> only takes a file descriptor not a name and location. First we hook to <code>fd_install</code> kernel function.<br>
<code>fd_install</code> is a kernel function that&rsquo;s called when a file descriptor is being added to a process&rsquo;s file descriptor table. In simpler terms, when a process opens a file (or performs a similar operation that creates a file descriptor), <code>fd_install</code> is invoked to associate the new file descriptor (an integer) with the corresponding file object. <code>fd_install</code> has the following prototype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">fd_install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Tetragon is planing to remove <code>FollowFD</code>, <code>UnfollowFD</code> and <code>CopyFD</code> starting from Tetragon version 1.5 due to security concerns.

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fd_install&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FollowFD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">argFd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">argName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;sys_write&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;char_buf&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">sizeArgIndex</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;size_t&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sigkill</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;sys_close&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">UnfollowFD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">argFd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">argName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In the previous example, the second argument is defined as <code>file</code> type as the name of the kernel data structure <code>struct file</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>Post:</strong> Sends an event up to user space. You can also ask for kernel and user stack traces to be included, and even limit how often these events fire.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Post</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">rateLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">kernelStackTrace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">userStackTrace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>GetUrl / DnsLookup:</strong> The GetUrl action triggers an HTTP GET request to a specified URL<code>argUrl</code>.  The DnsLookup action initiates a DNS lookup for a specified fully qualified domain name (FQDN) <code>argFqdn</code>.
Both actions are used to notify external systems when a specific event occurs in the kernel such as (Thinkst canaries or webhooks).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">GetUrl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">argUrl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://example.com/trigger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DnsLookup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">argFqdn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">canary.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Below is a complete tracing policy example that monitors when <code>mkdir</code> attempts to create <code>test</code>. When it does, the policy sends a SIGKILL signal to the offending process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cilium.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TracingPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kill-mkdir-test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;do_mkdirat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;filename&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sigkill</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Running this policy using <code>sudo tetragon --tracing-policy mkdir.yaml</code>. Output can be monitored using <code>sudo tetra getevents -o compact</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>process mac-Standard-PC-Q35-ICH9-2009 /usr/bin/mkdir ../tmp/test       
</span></span><span style="display:flex;"><span>syscall mac-Standard-PC-Q35-ICH9-2009 /usr/bin/mkdir do_mkdirat                  
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>    mac-Standard-PC-Q35-ICH9-2009 /usr/bin/mkdir ../tmp/test SIGKILL 
</span></span></code></pre></div><p>Another example for blocking reading files from a specific directory using <code>file_open</code> hook in LSM:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cilium.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TracingPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Block-screct-files&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lsmhooks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">hook</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;file_open&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Prefix&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/tmp/secret/&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sigkill</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>process mac-Standard-PC-Q35-ICH9-2009 /usr/bin/cat /tmp/secret/test1   
</span></span><span style="display:flex;"><span>LSM     mac-Standard-PC-Q35-ICH9-2009 /usr/bin/cat file_open                    
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>    mac-Standard-PC-Q35-ICH9-2009 /usr/bin/cat /tmp/secret/test1 SIGKILL 
</span></span></code></pre></div><p>We can specify a specific binary to block. For example, to block only <code>cat</code> command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchBinaries</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;In&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/usr/bin/cat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Prefix&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/tmp/secret/&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div><p>Another example to block <code>wget</code> command from accessing port 443. We used <code>DPort</code> to define destination port:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cilium.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TracingPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;block-443-for-wget&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;tcp_connect&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;sock&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchBinaries</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;In&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/usr/bin/wget&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;DPort&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#0000cf;font-weight:bold">443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">matchActions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Sigkill</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>wget</code> command is blocked while <code>curl</code> command is working!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>process mac-Standard-PC-Q35-ICH9-2009 /usr/bin/wget https://8.8.8.8    
</span></span><span style="display:flex;"><span>connect mac-Standard-PC-Q35-ICH9-2009 /usr/bin/wget tcp 192.168.122.215:60914 -&gt; 8.8.8.8:443 
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>    mac-Standard-PC-Q35-ICH9-2009 /usr/bin/wget https://8.8.8.8 SIGKILL 
</span></span><span style="display:flex;"><span>process mac-Standard-PC-Q35-ICH9-2009 /usr/bin/curl https://8.8.8.8    
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>    mac-Standard-PC-Q35-ICH9-2009 /usr/bin/curl https://8.8.8.8 <span style="color:#0000cf;font-weight:bold">0</span> 
</span></span></code></pre></div><p>Example for monitoring <code>sudo</code> command using <code>__sys_setresuid</code> kernel function.<br>
<code>__sys_setresuid</code> is the kernel function that implements the <code>setresuid</code> system call. It changes a process’s user IDs—specifically, the real, effective, and saved user IDs—in one atomic operation and it&rsquo;s used to adjust process privileges.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cilium.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TracingPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;detect-sudo&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kprobes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">call</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;__sys_setresuid&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">syscall</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selectors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">matchArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">index</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Tetragon can be configured to send metrics to Prometheus to monitor activities observed by Tetragon <a href="https://tetragon.io/docs/installation/metrics/">https://tetragon.io/docs/installation/metrics/</a> it has also Elastic integration <a href="https://www.elastic.co/guide/en/integrations/current/cilium_tetragon.html">https://www.elastic.co/guide/en/integrations/current/cilium_tetragon.html</a>. Tetragon has policy library and many useful use cases in their documentation. It&rsquo;s a powerful tool and even fun to try it <a href="https://tetragon.io/docs/">https://tetragon.io/docs/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9cde3793eee8ef4ff18d29f255e8e250">6.6 - Bpfilter</h1>
    <div class="lead">A work-in-progress kernel module that translates iptables and nftables rules into eBPF bytecode so the firewall runs through the BPF verifier instead of legacy netfilter tables.</div>
	<p>bpfilter is a eBPF-based packet filtering currently maintained by meta, designed to replace or complement traditional packet filtering systems such as netfilter/iptables. It leverages the power of eBPF programs to implement filtering directly in the kernel. bpfilter is part of a broader shift towards eBPF-driven networking, moving away from older, monolithic approaches with minimal overhead.<br>
bpfilter consists of two parts: daemon and front-ends. Font-end such as <code>bfcli</code> which receives firewall rules from administrators and send them to the daemon (<code>bpfilter</code>). <code>bpfilter</code> daemon parses the ruleset whether provided directly as a string or loaded from a file and then translates these high-level rules into eBPF bytecode that can be executed in the kernel.<br>
bpfilter attaches the generated eBPF programs to specific kernel hooks such as XDP, TC (Traffic Control), or netfilter hooks (like NF_PRE_ROUTING, NF_LOCAL_IN, etc.). Each hook corresponds to a different stage in the packet processing pipeline, allowing bpfilter to intercept packets as early or as late as necessary.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter5/bpfilter-Architecture.png" alt="Centered image" />
</p>
<h2 id="install-bpfilter">Install bpfilter<a class="td-heading-self-link" href="#install-bpfilter" aria-label="Heading self-link"></a></h2>
<p>Follow the following instructions to install bpfilter on ubuntu 24.04/ debian 13.
Install dependencies:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install bison clang-format clang-tidy cmake doxygen flex furo git lcov libbpf-dev libcmocka-dev libbenchmark-dev libgit2-dev libnl-3-dev python3-breathe python3-pip python3-sphinx pkgconf
</span></span></code></pre></div><p>Download bpfilter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/facebook/bpfilter.git
</span></span></code></pre></div><p>Make bpfilter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#204a87">cd</span> bpfilter/
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">SOURCES_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">BUILD_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$SOURCES_DIR</span>/build
</span></span><span style="display:flex;"><span>cmake -S <span style="color:#000">$SOURCES_DIR</span> -B <span style="color:#000">$BUILD_DIR</span>
</span></span><span style="display:flex;"><span>make -C <span style="color:#000">$BUILD_DIR</span>
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    bpfilter can use custom version <code>iptables</code> and <code>nftables</code> and supply your rules in either <code>iptables</code> syntax or <code>nftables</code> syntax such dropping incoming ICMP with <code>iptables</code> using <code>--bpf</code> flag as the following:<br>
<code>sudo ./iptables --bpf -D INPUT -p icmp -j DROP</code>

</div>

<p>Follow the following instructions to install the custom <code>iptables</code> and <code>nftables</code> on ubuntu 24.04
Install dependencies:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install autoconf libtool libmnl-dev libnftnl-dev libgmp-dev libedit-dev
</span></span></code></pre></div><p>Make the custom <code>iptables</code> and <code>nftables</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make -C <span style="color:#000">$BUILD_DIR</span> nftables iptables
</span></span></code></pre></div><h2 id="bpfilter-rules">bpfilter rules<a class="td-heading-self-link" href="#bpfilter-rules" aria-label="Heading self-link"></a></h2>
<p>A bpfilter ruleset is defined using chains and rules with the following structure:</p>
<pre tabindex="0"><code>chain $HOOK policy $POLICY
    rule
        $MATCHER
        $VERDICT
    [...]
[...]
</code></pre><pre tabindex="0"><code>chain $HOOK policy $POLICY
</code></pre><p><strong>$HOOK:</strong> The kernel hook where the chain is attached. The following list is from bpfilter documentation:</p>
<pre tabindex="0"><code>BF_HOOK_XDP: XDP hook.
BF_HOOK_TC_INGRESS: ingress TC hook.
BF_HOOK_NF_PRE_ROUTING: similar to nftables and iptables prerouting hook.
BF_HOOK_NF_LOCAL_IN: similar to nftables and iptables input hook.
BF_HOOK_CGROUP_INGRESS: ingress cgroup hook.
BF_HOOK_CGROUP_EGRESS: egress cgroup hook.
BF_HOOK_NF_FORWARD: similar to nftables and iptables forward hook.
BF_HOOK_NF_LOCAL_OUT: similar to nftables and iptables output hook.
BF_HOOK_NF_POST_ROUTING: similar to nftables and iptables postrouting hook.
BF_HOOK_TC_EGRESS: egress TC hook.
</code></pre><p><strong>$POLICY:</strong> The default action (typically ACCEPT or DROP) applied to packets that do not match any rule in the chain.<br>
<strong>Rule</strong>: Each rule under the chain consists of one or more <strong>matchers</strong> followed by a <strong>verdict</strong>.<br>
<strong>$MATCHER:</strong> A condition (or multiple conditions) that compares parts of the packet. For example, checking the protocol or matching an IP address.<br>
<strong>$VERDICT:</strong> The action to take if the matchers are true. Common verdicts are:</p>
<ul>
<li><strong>ACCEPT:</strong> Let the packet continue through the network stack.</li>
<li><strong>DROP:</strong> Discard the packet.</li>
<li><strong>CONTINUE:</strong> Continue to the next rule (often used in conjunction with packet counting).</li>
</ul>
<p>The following tables are from the bpfilter documentation and they contain detailed information about the various matchers used in bpfilter for filtering network traffic. Each table lists the matcher name (the field of the packet), its corresponding type in bpfilter (for example, <code>udp.sport</code> or <code>tcp.sport</code>), the operator used for comparison (such as <code>eq</code>, <code>not</code>, or <code>range</code>), the payload (the value or range to compare against), and additional notes that explain usage constraints or default behaviors.</p>
<h3 id="meta-matchers">Meta matchers<a class="td-heading-self-link" href="#meta-matchers" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Matches</th>
<th>Type</th>
<th>Operator</th>
<th>Payload</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface index</td>
<td><code>meta.ifindex</code></td>
<td>eq</td>
<td><code>$IFINDEX</code></td>
<td>For chains attached to an ingress hook, <code>$IFINDEX</code> is the input interface index. For chains attached to an egress hook, <code>$IFINDEX</code> is the output interface index.</td>
</tr>
<tr>
<td>L3 protocol</td>
<td><code>meta.l3_proto</code></td>
<td>eq</td>
<td><code>$PROTOCOL</code></td>
<td><code>ipv4</code> and <code>ipv6</code> are supported.</td>
</tr>
<tr>
<td>L4 protocol</td>
<td><code>meta.l4_proto</code></td>
<td>eq</td>
<td><code>$PROTOCOL</code></td>
<td><code>icmp</code>, <code>icmpv6</code>, <code>tcp</code>, <code>udp</code> are supported.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>meta.sport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>meta.sport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.  <em>(Same payload and note as above)</em></td>
</tr>
<tr>
<td>Source port</td>
<td><code>meta.sport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>meta.dport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>meta.dport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.  <em>(Same payload and note as above)</em></td>
</tr>
<tr>
<td>Destination port</td>
<td><code>meta.dport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
</tbody>
</table>
<h3 id="ipv4-matchers">IPv4 matchers<a class="td-heading-self-link" href="#ipv4-matchers" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Matches</th>
<th>Type</th>
<th>Operator</th>
<th>Payload</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source address</td>
<td><code>ip4.saddr</code></td>
<td>eq</td>
<td><code>$IP/$MASK</code></td>
<td><code>/$MASK</code> is optional, <code>/32</code> is used by default.</td>
</tr>
<tr>
<td>Source address</td>
<td><code>ip4.saddr</code></td>
<td>not</td>
<td><code>$IP/$MASK</code></td>
<td><code>/$MASK</code> is optional, <code>/32</code> is used by default.</td>
</tr>
<tr>
<td>Source address</td>
<td><code>ip4.saddr</code></td>
<td>in</td>
<td><code>{$IP[,...]}</code></td>
<td>Only support <code>/32</code> mask.</td>
</tr>
<tr>
<td>Destination address</td>
<td><code>ip4.daddr</code></td>
<td>eq</td>
<td><code>$IP/$MASK</code></td>
<td><code>/$MASK</code> is optional, <code>/32</code> is used by default.</td>
</tr>
<tr>
<td>Destination address</td>
<td><code>ip4.daddr</code></td>
<td>not</td>
<td><code>$IP/$MASK</code></td>
<td><code>/$MASK</code> is optional, <code>/32</code> is used by default.</td>
</tr>
<tr>
<td>Destination address</td>
<td><code>ip4.daddr</code></td>
<td>in</td>
<td><code>{$IP[,...]}</code></td>
<td>Only support <code>/32</code> mask.</td>
</tr>
<tr>
<td>Protocol</td>
<td><code>ip4.proto</code></td>
<td>eq</td>
<td><code>$PROTOCOL</code></td>
<td>Only <code>icmp</code> is supported for now, more protocols will be added.</td>
</tr>
</tbody>
</table>
<h3 id="ipv6-matchers">IPv6 matchers<a class="td-heading-self-link" href="#ipv6-matchers" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Matches</th>
<th>Type</th>
<th>Operator</th>
<th>Payload</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source address</td>
<td><code>ip6.saddr</code></td>
<td>eq</td>
<td><code>$IP/$PREFIX</code></td>
<td><code>/$PREFIX</code> is optional, <code>/128</code> is used by default.</td>
</tr>
<tr>
<td>Source address</td>
<td><code>ip6.saddr</code></td>
<td>not</td>
<td><code>$IP/$PREFIX</code></td>
<td><code>/$PREFIX</code> is optional, <code>/128</code> is used by default.</td>
</tr>
<tr>
<td>Destination address</td>
<td><code>ip6.daddr</code></td>
<td>eq</td>
<td><code>$IP/$PREFIX</code></td>
<td><code>/$PREFIX</code> is optional, <code>/128</code> is used by default.</td>
</tr>
<tr>
<td>Destination address</td>
<td><code>ip6.daddr</code></td>
<td>not</td>
<td><code>$IP/$PREFIX</code></td>
<td><code>/$PREFIX</code> is optional, <code>/128</code> is used by default.</td>
</tr>
</tbody>
</table>
<h3 id="tcp-matchers">TCP matchers<a class="td-heading-self-link" href="#tcp-matchers" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Matches</th>
<th>Type</th>
<th>Operator</th>
<th>Payload</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source port</td>
<td><code>tcp.sport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>tcp.sport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>tcp.sport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>tcp.dport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>tcp.dport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>tcp.dport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
<tr>
<td>Flags</td>
<td><code>tcp.flags</code></td>
<td>eq</td>
<td><code>$FLAGS</code></td>
<td><code>$FLAGS</code> is a comma-separated list of capitalized TCP flags (<code>FIN</code>, <code>RST</code>, <code>ACK</code>, <code>ECE</code>, <code>SYN</code>, <code>PSH</code>, <code>URG</code>, <code>CWR</code>).</td>
</tr>
<tr>
<td>Flags</td>
<td><code>tcp.flags</code></td>
<td>not</td>
<td><code>$FLAGS</code></td>
<td><code>$FLAGS</code> is a comma-separated list of capitalized TCP flags (<code>FIN</code>, <code>RST</code>, <code>ACK</code>, <code>ECE</code>, <code>SYN</code>, <code>PSH</code>, <code>URG</code>, <code>CWR</code>).</td>
</tr>
<tr>
<td>Flags</td>
<td><code>tcp.flags</code></td>
<td>any</td>
<td><code>$FLAGS</code></td>
<td><code>$FLAGS</code> is a comma-separated list of capitalized TCP flags (<code>FIN</code>, <code>RST</code>, <code>ACK</code>, <code>ECE</code>, <code>SYN</code>, <code>PSH</code>, <code>URG</code>, <code>CWR</code>).</td>
</tr>
<tr>
<td>Flags</td>
<td><code>tcp.flags</code></td>
<td>all</td>
<td><code>$FLAGS</code></td>
<td><code>$FLAGS</code> is a comma-separated list of capitalized TCP flags (<code>FIN</code>, <code>RST</code>, <code>ACK</code>, <code>ECE</code>, <code>SYN</code>, <code>PSH</code>, <code>URG</code>, <code>CWR</code>).</td>
</tr>
</tbody>
</table>
<h3 id="udp-matchers">UDP matchers<a class="td-heading-self-link" href="#udp-matchers" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Matches</th>
<th>Type</th>
<th>Operator</th>
<th>Payload</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source port</td>
<td><code>udp.sport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>udp.sport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Source port</td>
<td><code>udp.sport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>udp.dport</code></td>
<td>eq</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>udp.dport</code></td>
<td>not</td>
<td><code>$PORT</code></td>
<td><code>$PORT</code> is a valid port value, as a decimal integer.</td>
</tr>
<tr>
<td>Destination port</td>
<td><code>udp.dport</code></td>
<td>range</td>
<td><code>$START-$END</code></td>
<td><code>$START</code> and <code>$END</code> are valid port values, as decimal integers.</td>
</tr>
</tbody>
</table>
<h2 id="examples">Examples<a class="td-heading-self-link" href="#examples" aria-label="Heading self-link"></a></h2>
<p>Let&rsquo;s explore some examples and how to write bpfilter rules. First, start the daemon:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo build/output/sbin/bpfilter
</span></span><span style="display:flex;"><span>info   : no serialized context found on disk, a new context will be created
</span></span><span style="display:flex;"><span>info   : waiting <span style="color:#204a87;font-weight:bold">for</span> requests...
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    Flag <code>--transient</code> marks the bpfilter ruleset as temporary, meaning it will be removed on daemon restart.

</div>

<p>You can use either iptables or nftables as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo build/tools/install/sbin/./iptables --bpf <span style="color:#ce5c00;font-weight:bold">{</span>Rule<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>or 
</span></span><span style="display:flex;"><span>sudo build/tools/install/sbin/./nft --bpf <span style="color:#ce5c00;font-weight:bold">{</span>Rule<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>As the previous example which blocks ICMP with bpfilter but using custom <code>iptables</code> as front-end:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo build/tools/install/sbin/./iptables --bpf -D INPUT -p icmp -j DROP
</span></span></code></pre></div><p>Let&rsquo;s write rules with <code>bfcli</code>. Let&rsquo;s start with create a simple rule by creating a chain on the TC ingress hook for interface index 2 with a default ACCEPT policy, and it adds a rule to drop any packets where the IPv4 protocol is ICMP:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo build/output/sbin/./bfcli ruleset <span style="color:#204a87">set</span> --str <span style="color:#4e9a06">&#34;chain BF_HOOK_TC_INGRESS{ifindex=2} policy ACCEPT rule ip4.proto eq icmp DROP&#34;</span>
</span></span></code></pre></div><p>You can use XDP instead on the previous rule. It&rsquo;s all dependent on where in the kernel you want to apply your filter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;chain BF_HOOK_XDP{ifindex=2} policy ACCEPT rule ip4.proto eq icmp DROP&#34;</span>
</span></span></code></pre></div><p>Flushing bpfilter is by using:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo build/output/sbin/./bfcli ruleset flush
</span></span></code></pre></div><p>Blocking egress traffic to 192.168.1.24 port 22 on TC egress hook</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;chain BF_HOOK_TC_EGRESS{ifindex=2} policy ACCEPT rule ip4.daddr eq 192.168.1.24 tcp.dport eq 22 DROP&#34;</span>
</span></span></code></pre></div><p>Dropping packets that have both SYN and FIN flags set that’s not normally seen in legitimate traffic as it used by attackers as part of system discovery:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;chain BF_HOOK_TC_INGRESS{ifindex=2} policy ACCEPT rule tcp.flags all SYN,FIN DROP&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9210003ef0c1463a1512d31a898cf50">7 - Tools and languages</h1>
    <div class="lead">User space helpers and patterns that make building and debugging eBPF programs easier</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5f9e11a6923b54f21057d837506b9990">7.1 - bpftrace</h1>
    <div class="lead">DTrace style one liners for quick ad hoc tracing of kernel and user processes.</div>
	<p>bpftrace is a powerful, high-level tracing language for Linux that simplifies the process of creating eBPF (Extended Berkeley Packet Filter) programs. It simplifies the process of instrumenting kernel and user-space code by providing a simple language to attach probes to kernel functions, tracepoints, and user-defined events in a user-friendly syntax, inspired by awk, C, and other tracing tools, enabling users to quickly gain insights into system behavior. By abstracting away the complexities of low-level eBPF programming and leveraging libbpf as its backend, bpftrace allows system administrators, performance engineers, and developers to easily observe and analyze system performance without requiring extensive eBPF expertise. Let&rsquo;s start by looking at the bpftrace command.</p>
<h2 id="bpftrace-options">bpftrace Options<a class="td-heading-self-link" href="#bpftrace-options" aria-label="Heading self-link"></a></h2>
<p>When running bpftrace, you can use various command-line options to control its behavior. Some commonly used options include:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>    -B MODE        output buffering mode <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;full&#39;</span>, <span style="color:#4e9a06">&#39;none&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -f FORMAT      output format <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;text&#39;</span>, <span style="color:#4e9a06">&#39;json&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -o file        redirect bpftrace output to file
</span></span><span style="display:flex;"><span>    -e <span style="color:#4e9a06">&#39;program&#39;</span>   execute this program
</span></span><span style="display:flex;"><span>    -h, --help     show this <span style="color:#204a87">help</span> message
</span></span><span style="display:flex;"><span>    -I DIR         add the directory to the include search path
</span></span><span style="display:flex;"><span>    --include FILE add an <span style="color:#8f5902;font-style:italic">#include file before preprocessing</span>
</span></span><span style="display:flex;"><span>    -l <span style="color:#ce5c00;font-weight:bold">[</span>search<span style="color:#000;font-weight:bold">|</span>filename<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                   list kernel probes or probes in a program
</span></span><span style="display:flex;"><span>    -p PID         <span style="color:#204a87">enable</span> USDT probes on PID
</span></span><span style="display:flex;"><span>    -c <span style="color:#4e9a06">&#39;CMD&#39;</span>       run CMD and <span style="color:#204a87">enable</span> USDT probes on resulting process
</span></span><span style="display:flex;"><span>    --usdt-file-activation
</span></span><span style="display:flex;"><span>                   activate usdt semaphores based on file path
</span></span><span style="display:flex;"><span>    --unsafe       allow unsafe/destructive functionality
</span></span><span style="display:flex;"><span>    -q             keep messages quiet
</span></span><span style="display:flex;"><span>    --info         Print information about kernel BPF support
</span></span><span style="display:flex;"><span>    -k             emit a warning when a bpf helper returns an error <span style="color:#ce5c00;font-weight:bold">(</span>except <span style="color:#204a87">read</span> functions<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -kk            check all bpf helper functions
</span></span><span style="display:flex;"><span>    -V, --version  bpftrace version
</span></span><span style="display:flex;"><span>    --no-warnings  disable all warning messages
</span></span></code></pre></div><p>For example, we can use <code>-l</code> along with <code>*</code> for wildcard for listing such as listing all kprobes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;kprobe:*&#39;</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kprobe:zswap_store
</span></span><span style="display:flex;"><span>kprobe:zswap_swapoff
</span></span><span style="display:flex;"><span>kprobe:zswap_swapon
</span></span><span style="display:flex;"><span>kprobe:zswap_total_pages
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_entry
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_show
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_write
</span></span><span style="display:flex;"><span>kprobe:zswap_zpool_param_set
</span></span></code></pre></div><p>We can list probe parameters for a certain function using</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -lv <span style="color:#4e9a06">&#39;fentry:tcp_reset&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fentry:vmlinux:tcp_reset
</span></span><span style="display:flex;"><span>    struct sock * sk
</span></span><span style="display:flex;"><span>    struct sk_buff * skb
</span></span></code></pre></div><p>We can list all symbols from object or binary files for uprobe such as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;uprobe:/bin/bash:*&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:async_redirect_stdin
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:base_pathname
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_add_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_brace_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_clear_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_default_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_histent
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_history_range
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_last_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_dequote_text
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Using <code>-e</code> can be used to execute a program in one-liner. For example,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;shell_execve called\n&#34;); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span></code></pre></div><p>This program <code>uprobe:/bin/bash:shell_execve { printf(&quot;shell_execve called\n&quot;); }</code> means this action <code>printf(&quot;shell_execve called\n&quot;);</code> will be executed when <code>uprobe:/bin/bash:shell_execve</code> get triggered.</p>
<p>If we want to print out which command is being executed is by printing the first argument with <code>arg0</code> using <code>str</code> function which reads a NULL terminated string similar to <code>bpf_probe_read_str</code> helper function. <code>argN</code> is a bpf builtins while hold arguments passed to the function being traced and it can be used with kprobe and uprobe.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;command:%s\n&#34;, str(arg0)); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>command:/usr/bin/ls
</span></span><span style="display:flex;"><span>command:/usr/bin/ping
</span></span><span style="display:flex;"><span>command:/usr/bin/cat
</span></span></code></pre></div><p>The following table is from the bpftrace manual, listing special variables along with their corresponding helper functions and descriptions.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Kernel</th>
<th>BPF Helper</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$1</code>, <code>$2</code>, <code>...$n</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>The nth positional parameter passed to the bpftrace program. If less than n parameters are passed this evaluates to <code>0</code>. For string arguments use the <code>str()</code> call to retrieve the value.</td>
</tr>
<tr>
<td><code>$#</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>Total amount of positional parameters passed.</td>
</tr>
<tr>
<td><code>arg0</code>, <code>arg1</code>, <code>...argn</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>nth argument passed to the function being traced. These are extracted from the CPU registers. The amount of args passed in registers depends on the CPU architecture. (kprobes, uprobes, usdt).</td>
</tr>
<tr>
<td><code>args</code></td>
<td>struct args</td>
<td>n/a</td>
<td>n/a</td>
<td>The struct of all arguments of the traced function. Available in <code>tracepoint</code>, <code>fentry</code>, <code>fexit</code>, and <code>uprobe</code> (with DWARF) probes. Use <code>args.x</code> to access argument <code>x</code> or <code>args</code> to get a record with all arguments.</td>
</tr>
<tr>
<td><code>cgroup</code></td>
<td>uint64</td>
<td>4.18</td>
<td>get_current_cgroup_id</td>
<td>ID of the cgroup the current process belongs to. Only works with cgroupv2.</td>
</tr>
<tr>
<td><code>comm</code></td>
<td>string[16]</td>
<td>4.2</td>
<td>get_current_comm</td>
<td>Name of the current thread.</td>
</tr>
<tr>
<td><code>cpid</code></td>
<td>uint32</td>
<td>n/a</td>
<td>n/a</td>
<td>Child process ID, if bpftrace is invoked with <code>-c</code>.</td>
</tr>
<tr>
<td><code>cpu</code></td>
<td>uint32</td>
<td>4.1</td>
<td>raw_smp_processor_id</td>
<td>ID of the processor executing the BPF program.</td>
</tr>
<tr>
<td><code>curtask</code></td>
<td>uint64</td>
<td>4.8</td>
<td>get_current_task</td>
<td>Pointer to <code>struct task_struct</code> of the current task.</td>
</tr>
<tr>
<td><code>elapsed</code></td>
<td>uint64</td>
<td>(see nsec)</td>
<td>ktime_get_ns / ktime_get_boot_ns</td>
<td>Nanoseconds elapsed since bpftrace initialization, based on <code>nsecs</code>.</td>
</tr>
<tr>
<td><code>func</code></td>
<td>string</td>
<td>n/a</td>
<td>n/a</td>
<td>Name of the current function being traced (kprobes, uprobes).</td>
</tr>
<tr>
<td><code>gid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>Group ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>jiffies</code></td>
<td>uint64</td>
<td>5.9</td>
<td>get_jiffies_64</td>
<td>Jiffies of the kernel. In 32-bit systems, using this builtin might be slower.</td>
</tr>
<tr>
<td><code>numaid</code></td>
<td>uint32</td>
<td>5.8</td>
<td>numa_node_id</td>
<td>ID of the NUMA node executing the BPF program.</td>
</tr>
<tr>
<td><code>pid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Process ID of the current thread (aka thread group ID), as seen from the init namespace.</td>
</tr>
<tr>
<td><code>probe</code></td>
<td>string</td>
<td>n/na</td>
<td>n/a</td>
<td>Name of the current probe.</td>
</tr>
<tr>
<td><code>rand</code></td>
<td>uint32</td>
<td>4.1</td>
<td>get_prandom_u32</td>
<td>Random number.</td>
</tr>
<tr>
<td><code>return</code></td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>The return keyword is used to exit the current probe. This differs from exit() in that it doesn&rsquo;t exit bpftrace.</td>
</tr>
<tr>
<td><code>retval</code></td>
<td>uint64</td>
<td>n/a</td>
<td>n/a</td>
<td>Value returned by the function being traced (kretprobe, uretprobe, fexit). For kretprobe and uretprobe, its type is <code>uint64</code>, but for fexit it depends. You can look up the type using <code>bpftrace -lv</code>.</td>
</tr>
<tr>
<td><code>tid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Thread ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>uid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>User ID of the current thread, as seen from the init namespace.</td>
</tr>
</tbody>
</table>
<p>The following table is from the bpftrace manual, listing bpftrace functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bswap</td>
<td>Reverse byte order</td>
</tr>
<tr>
<td>buf</td>
<td>Returns a hex-formatted string of the data pointed to by d</td>
</tr>
<tr>
<td>cat</td>
<td>Print file content</td>
</tr>
<tr>
<td>cgroupid</td>
<td>Resolve cgroup ID</td>
</tr>
<tr>
<td>cgroup_path</td>
<td>Convert cgroup id to cgroup path</td>
</tr>
<tr>
<td>exit</td>
<td>Quit bpftrace with an optional exit code</td>
</tr>
<tr>
<td>join</td>
<td>Print the array</td>
</tr>
<tr>
<td>kaddr</td>
<td>Resolve kernel symbol name</td>
</tr>
<tr>
<td>kptr</td>
<td>Annotate as kernelspace pointer</td>
</tr>
<tr>
<td>kstack</td>
<td>Kernel stack trace</td>
</tr>
<tr>
<td>ksym</td>
<td>Resolve kernel address</td>
</tr>
<tr>
<td>len</td>
<td>Count ustack/kstack frames</td>
</tr>
<tr>
<td>macaddr</td>
<td>Convert MAC address data</td>
</tr>
<tr>
<td>nsecs</td>
<td>Timestamps and Time Deltas</td>
</tr>
<tr>
<td>ntop</td>
<td>Convert IP address data to text</td>
</tr>
<tr>
<td>offsetof</td>
<td>Offset of element in structure</td>
</tr>
<tr>
<td>override</td>
<td>Override return value</td>
</tr>
<tr>
<td>path</td>
<td>Return full path</td>
</tr>
<tr>
<td>percpu_kaddr</td>
<td>Resolve percpu kernel symbol name</td>
</tr>
<tr>
<td>print</td>
<td>Print a non-map value with default formatting</td>
</tr>
<tr>
<td>printf</td>
<td>Print formatted</td>
</tr>
<tr>
<td>pton</td>
<td>Convert text IP address to byte array</td>
</tr>
<tr>
<td>reg</td>
<td>Returns the value stored in the named register</td>
</tr>
<tr>
<td>signal</td>
<td>Send a signal to the current process</td>
</tr>
<tr>
<td>sizeof</td>
<td>Return size of a type or expression</td>
</tr>
<tr>
<td>skboutput</td>
<td>Write skb &rsquo;s data section into a PCAP file</td>
</tr>
<tr>
<td>str</td>
<td>Returns the string pointed to by s</td>
</tr>
<tr>
<td>strcontains</td>
<td>Compares whether the string haystack contains the string needle.</td>
</tr>
<tr>
<td>strerror</td>
<td>Get error message for errno code</td>
</tr>
<tr>
<td>strftime</td>
<td>Return a formatted timestamp</td>
</tr>
<tr>
<td>strncmp</td>
<td>Compare first n characters of two strings</td>
</tr>
<tr>
<td>system</td>
<td>Execute shell command</td>
</tr>
<tr>
<td>time</td>
<td>Print formatted time</td>
</tr>
<tr>
<td>uaddr</td>
<td>Resolve user-level symbol name</td>
</tr>
<tr>
<td>uptr</td>
<td>Annotate as userspace pointer</td>
</tr>
<tr>
<td>ustack</td>
<td>User stack trace</td>
</tr>
<tr>
<td>usym</td>
<td>Resolve user space address</td>
</tr>
</tbody>
</table>
<h2 id="how-to-code-in-bpftrace">How to Code in bpftrace<a class="td-heading-self-link" href="#how-to-code-in-bpftrace" aria-label="Heading self-link"></a></h2>
<p>bpftrace scripts are written using a custom domain-specific language (DSL) that is similar in syntax to awk. A basic script consists of one or more probe definitions followed by one or more actions. Each probe targets a specific event (e.g., kernel tracepoints, function entry/exit, or user-space events).</p>
<p>The following table is from the bpftrace manual, listing bpftrace probes along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Probe Name</th>
<th>Short Name</th>
<th>Description</th>
<th>Kernel/User Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>BEGIN/END</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>self</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>hardware</td>
<td><code>h</code></td>
<td>Processor-level events</td>
<td>Kernel</td>
</tr>
<tr>
<td>interval</td>
<td><code>i</code></td>
<td>Timed output</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>iter</td>
<td><code>it</code></td>
<td>Iterators tracing</td>
<td>Kernel</td>
</tr>
<tr>
<td>fentry/fexit</td>
<td><code>f</code>/<code>fr</code></td>
<td>Kernel functions tracing with BTF support</td>
<td>Kernel</td>
</tr>
<tr>
<td>kprobe/kretprobe</td>
<td><code>k</code>/<code>kr</code></td>
<td>Kernel function start/return</td>
<td>Kernel</td>
</tr>
<tr>
<td>profile</td>
<td><code>p</code></td>
<td>Timed sampling</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>rawtracepoint</td>
<td><code>rt</code></td>
<td>Kernel static tracepoints with raw arguments</td>
<td>Kernel</td>
</tr>
<tr>
<td>software</td>
<td><code>s</code></td>
<td>Kernel software events</td>
<td>Kernel</td>
</tr>
<tr>
<td>tracepoint</td>
<td><code>t</code></td>
<td>Kernel static tracepoints</td>
<td>Kernel</td>
</tr>
<tr>
<td>uprobe/uretprobe</td>
<td><code>u</code>/<code>ur</code></td>
<td>User-level function start/return</td>
<td>User</td>
</tr>
<tr>
<td>usdt</td>
<td><code>U</code></td>
<td>User-level static tracepoints</td>
<td>User</td>
</tr>
<tr>
<td>watchpoint/asyncwatchpoint</td>
<td><code>w</code>/<code>aw</code></td>
<td>Memory watchpoints</td>
<td>Kernel</td>
</tr>
</tbody>
</table>
<h3 id="basic-structure-of-a-bpftrace-script">Basic Structure of a bpftrace Script<a class="td-heading-self-link" href="#basic-structure-of-a-bpftrace-script" aria-label="Heading self-link"></a></h3>
<pre tabindex="0"><code class="language-bpftrace" data-lang="bpftrace">probe_type:probe_identifier
{
    // Action code block
    printf(&#34;Hello, world!\n&#34;);
}
</code></pre><p>For example, to print a message every time a process calls the <code>unlinkat()</code> syscall, you might write:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unlinkat syscall invoked</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>sys_enter_unlinkat</code> tracepoint&rsquo;s arguments can be listed from <code>/sys/kernel/debug/tracing/events/syscalls/sys_enter_unlinkat/format</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>name: sys_enter_unlinkat
</span></span><span style="display:flex;"><span>ID: <span style="color:#0000cf;font-weight:bold">849</span>
</span></span><span style="display:flex;"><span>format:
</span></span><span style="display:flex;"><span>	field:unsigned short common_type<span style="color:#000;font-weight:bold">;</span>	offset:0<span style="color:#000;font-weight:bold">;</span>	size:2<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_flags<span style="color:#000;font-weight:bold">;</span>	offset:2<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_preempt_count<span style="color:#000;font-weight:bold">;</span>	offset:3<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int common_pid<span style="color:#000;font-weight:bold">;</span>	offset:4<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	field:int __syscall_nr<span style="color:#000;font-weight:bold">;</span>	offset:8<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int dfd<span style="color:#000;font-weight:bold">;</span>	offset:16<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:const char * pathname<span style="color:#000;font-weight:bold">;</span>	offset:24<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int flag<span style="color:#000;font-weight:bold">;</span>	offset:32<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print fmt: <span style="color:#4e9a06">&#34;dfd: 0x%08lx, pathname: 0x%08lx, flag: 0x%08lx&#34;</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;dfd<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;pathname<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;flag<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>Therefore, we can use <code>str(args.pathname)</code> to extract the name of the file being deleted. <code>args</code> is one of the bpftrace builtins which is a data struct of all arguments of the traced function and it can be used with tracepoint, fentry, fexit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process %s (PID: %d) is deleting a file %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2269<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test1
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2270<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test2
</span></span></code></pre></div><p>Let&rsquo;s convert this eBPF kernel code to bpftrace</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Type of BPF map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// Maximum number of entries in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                            <span style="color:#8f5902;font-style:italic">// Type of the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                          <span style="color:#8f5902;font-style:italic">// Type of the value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Dual BSD/GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s build the same code without Maps as it will be explained shortly</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">kprobe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">do_mkdirat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, mode: %d, filename: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">arg2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(((</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">arg1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The idea is to cast <code>arg1</code> to a pointer to <code>struct filename</code> before accessing <code>name</code> field.</p>
<h2 id="bpftrace-maps">bpftrace Maps<a class="td-heading-self-link" href="#bpftrace-maps" aria-label="Heading self-link"></a></h2>
<p>Maps in bpftrace are defined with <code>@</code> such as <code>@testmap</code>. The following table is from bpftrace manual, listing bpftrace map functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>avg</td>
<td>Calculate the running average of <code>n</code> between consecutive calls.</td>
</tr>
<tr>
<td>clear</td>
<td>Clear all keys/values from a map.</td>
</tr>
<tr>
<td>count</td>
<td>Count how often this function is called.</td>
</tr>
<tr>
<td>delete</td>
<td>Delete a single key from a map.</td>
</tr>
<tr>
<td>has_key</td>
<td>Return true (1) if the key exists in this map. Otherwise return false (0).</td>
</tr>
<tr>
<td>hist</td>
<td>Create a log2 histogram of n using buckets per power of 2, 0 &lt;= k &lt;= 5, defaults to 0.</td>
</tr>
<tr>
<td>len</td>
<td>Return the number of elements in a map.</td>
</tr>
<tr>
<td>lhist</td>
<td>Create a linear histogram of n. lhist creates M ((max - min) / step) buckets in the range [min, max) where each bucket is step in size.</td>
</tr>
<tr>
<td>max</td>
<td>Update the map with n if n is bigger than the current value held.</td>
</tr>
<tr>
<td>min</td>
<td>Update the map with n if n is smaller than the current value held.</td>
</tr>
<tr>
<td>stats</td>
<td>Combines the count, avg and sum calls into one.</td>
</tr>
<tr>
<td>sum</td>
<td>Calculate the sum of all n passed.</td>
</tr>
<tr>
<td>zero</td>
<td>Set all values for all keys to zero.</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">forks</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">setuid</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_fork&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_fork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_setuid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_setuid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priv</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">priv</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Let&rsquo;s see the previous code in bpftrace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace         
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_fork</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_setuid</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_execve</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Define a map with name <code>forks</code> and add current<code>pid</code> as key and <code>1</code> as value if <code>sys_enter_setuid</code> tracepoint is triggered.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Define a map with name <code>setuid</code> and add current <code>pid</code> as key and <code>1</code> as value if <code>sys_enter_fork</code> tracepoint is triggered and UID is zero.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>If <code>sys_enter_execve</code> is triggered, hen it will check if the current <code>pid</code> triggered by <code>sys_enter_setuid</code> and <code>sys_enter_fork</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>signal</code> function is equivalent to <code>bpf_send_signal</code> helper function to terminate the process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We have to run this code with <code>--unsafe</code> because we running dangerous function which is <code>signal</code>, then to run it <code>sudo bpftrace --unsafe priv-esc.bt</code>.
This code is much smaller and simpler than eBPF kernel code, and no need for user-space code.</p>
<p>The next script attaches probes to the <code>sys_enter_read</code> and <code>sys_enter_write</code> syscalls (separated with comma <code>,</code>) and uses a map to count the number of system calls per process using <code>count()</code> map function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_read</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_write</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will activate every 5 seconds (using interval probe) to clear the screen using ANSI escape sequences <code>printf(&quot;\033[H\033[2J&quot;);</code>, then print the content of <code>syscalls</code> map.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-timesyn<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-journal<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>rtkit-daemon<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sudo<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gnome-shell<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">13</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gvfsd-wsdd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bash<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>ls<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bpftrace<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sshd-session<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">818</span>
</span></span></code></pre></div><h2 id="bpftrace-tools">bpftrace Tools<a class="td-heading-self-link" href="#bpftrace-tools" aria-label="Heading self-link"></a></h2>
<p>The following tools from bpftrace github repository. They cover a wide range of functions from tracing I/O and network events to monitoring process and syscall activity.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bashreadline.bt</td>
<td>Print entered bash commands system wide. Examples.</td>
</tr>
<tr>
<td>biolatency.bt</td>
<td>Block I/O latency as a histogram. Examples.</td>
</tr>
<tr>
<td>biosnoop.bt</td>
<td>Block I/O tracing tool, showing per I/O latency. Examples.</td>
</tr>
<tr>
<td>biostacks.bt</td>
<td>Show disk I/O latency with initialization stacks. Examples.</td>
</tr>
<tr>
<td>bitesize.bt</td>
<td>Show disk I/O size as a histogram. Examples.</td>
</tr>
<tr>
<td>capable.bt</td>
<td>Trace security capability checks. Examples.</td>
</tr>
<tr>
<td>cpuwalk.bt</td>
<td>Sample which CPUs are executing processes. Examples.</td>
</tr>
<tr>
<td>dcsnoop.bt</td>
<td>Trace directory entry cache (dcache) lookups. Examples.</td>
</tr>
<tr>
<td>execsnoop.bt</td>
<td>Trace new processes via exec() syscalls. Examples.</td>
</tr>
<tr>
<td>gethostlatency.bt</td>
<td>Show latency for getaddrinfo/gethostbyname[2] calls. Examples.</td>
</tr>
<tr>
<td>killsnoop.bt</td>
<td>Trace signals issued by the kill() syscall. Examples.</td>
</tr>
<tr>
<td>loads.bt</td>
<td>Print load averages. Examples.</td>
</tr>
<tr>
<td>mdflush.bt</td>
<td>Trace md flush events. Examples.</td>
</tr>
<tr>
<td>naptime.bt</td>
<td>Show voluntary sleep calls. Examples.</td>
</tr>
<tr>
<td>opensnoop.bt</td>
<td>Trace open() syscalls showing filenames. Examples.</td>
</tr>
<tr>
<td>oomkill.bt</td>
<td>Trace OOM killer. Examples.</td>
</tr>
<tr>
<td>pidpersec.bt</td>
<td>Count new processes (via fork). Examples.</td>
</tr>
<tr>
<td>runqlat.bt</td>
<td>CPU scheduler run queue latency as a histogram. Examples.</td>
</tr>
<tr>
<td>runqlen.bt</td>
<td>CPU scheduler run queue length as a histogram. Examples.</td>
</tr>
<tr>
<td>setuids.bt</td>
<td>Trace the setuid syscalls: privilege escalation. Examples.</td>
</tr>
<tr>
<td>ssllatency.bt</td>
<td>Summarize SSL/TLS handshake latency as a histogram. Examples.</td>
</tr>
<tr>
<td>sslsnoop.bt</td>
<td>Trace SSL/TLS handshake, showing latency and return value. Examples.</td>
</tr>
<tr>
<td>statsnoop.bt</td>
<td>Trace stat() syscalls for general debugging. Examples.</td>
</tr>
<tr>
<td>swapin.bt</td>
<td>Show swapins by process. Examples.</td>
</tr>
<tr>
<td>syncsnoop.bt</td>
<td>Trace sync() variety of syscalls. Examples.</td>
</tr>
<tr>
<td>syscount.bt</td>
<td>Count system calls. Examples.</td>
</tr>
<tr>
<td>tcpaccept.bt</td>
<td>Trace TCP passive connections (accept()). Examples.</td>
</tr>
<tr>
<td>tcpconnect.bt</td>
<td>Trace TCP active connections (connect()). Examples.</td>
</tr>
<tr>
<td>tcpdrop.bt</td>
<td>Trace kernel-based TCP packet drops with details. Examples.</td>
</tr>
<tr>
<td>tcplife.bt</td>
<td>Trace TCP session lifespans with connection details. Examples.</td>
</tr>
<tr>
<td>tcpretrans.bt</td>
<td>Trace TCP retransmits. Examples.</td>
</tr>
<tr>
<td>tcpsynbl.bt</td>
<td>Show TCP SYN backlog as a histogram. Examples.</td>
</tr>
<tr>
<td>threadsnoop.bt</td>
<td>List new thread creation. Examples.</td>
</tr>
<tr>
<td>undump.bt</td>
<td>Capture UNIX domain socket packages. Examples.</td>
</tr>
<tr>
<td>vfscount.bt</td>
<td>Count VFS calls. Examples.</td>
</tr>
<tr>
<td>vfsstat.bt</td>
<td>Count some VFS calls, with per-second summaries. Examples.</td>
</tr>
<tr>
<td>writeback.bt</td>
<td>Trace file system writeback events with details. Examples.</td>
</tr>
<tr>
<td>xfsdist.bt</td>
<td>Summarize XFS operation latency distribution as a histogram. Examples.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-593e25d400352b1b019a0a3a839e7cdb">7.2 - BCC</h1>
    <div class="lead">BPF Compiler Collection a Python and Lua toolkit that wraps Clang so you can embed small eBPF snippets in scripts and run them with just a few lines of loader code.</div>
	<p>BCC in short  is a toolkit that makes eBPF development easier by providing a higher-level interface. It compiles your eBPF C code at runtime to match the target kernel’s data structures. BCC works with languages like Python, Lua, and C++, and includes helpful macros and shortcuts for simpler programming. Essentially, BCC takes your eBPF program as a C string, preprocesses it, and then compiles it using clang.</p>
<p>The following is a crash course on BCC. I strongly recommend reading the BCC manual as well—it’s incredibly detailed and covers topics that are too extensive for this chapter.</p>
<h2 id="probes-definition">Probes Definition<a class="td-heading-self-link" href="#probes-definition" aria-label="Heading self-link"></a></h2>
<ol>
<li>kprobe: <code>kprobe__</code> followed by the name of kernel function name. For example, int kprobe__do_mkdirat(struct pt_regs *ctx). struct pt_regs *ctx as a context for kprobe. Arguments can be extracted using PT_REGS_PARM1(ctx), PT_REGS_PARM2(ctx), &hellip; macros.</li>
<li>kretprobe: <code>kretprobe__</code> followed by the name of kernel function name. For example, <code>int kretprobe__do_mkdirat(struct pt_regs *ctx)</code>. Return value can be extracted using <code>PT_REGS_RC(ctx)</code> macro.</li>
<li>uprobes: Can be declared as regular C function. For example, <code>int function(struct pt_regs *ctx)</code>. Arguments can be extracted using PT_REGS_PARM1(ctx), PT_REGS_PARM2(ctx), &hellip; macros.</li>
<li>uretprobes: Can be declared as regular C function<code>int function(struct pt_regs *ctx)</code>. Return value can be extracted using <code>PT_REGS_RC(ctx)</code> macro.</li>
<li>Tracepoints: <code>TRACEPOINT_PROBE</code> followed by <code>(category, event)</code> . For example,  <code>TRACEPOINT_PROBE(sched,sched_process_exit)</code>. Arguments are available in an <code>args</code> struct and you can list of argument from the <code>format</code> file. Foe example, <code>args-&gt;pathname</code> in case of <code>TRACEPOINT_PROBE(syscalls, sys_enter_unlinkat)</code>.</li>
<li>Raw Tracepoints: <code>RAW_TRACEPOINT_PROBE(event)</code>.<br>
For example, <code>RAW_TRACEPOINT_PROBE(sys_enter)</code>. As stated before, raw tracepoint uses <code>bpf_raw_tracepoint_args</code> as context and it has args as <code>args[0]</code> -&gt; points to <code>pt_regs</code> structure and <code>args[1]</code> is the syscall number. To access the target functions&rsquo; parameters, you can either cast <code>ctx-&gt;args[0]</code> to a pointer to a <code>struct pt_regs</code> and use it directly, or copy its contents into a local variable of type <code>struct pt_regs</code> (e.g., <code>struct pt_regs regs;</code>). Then, you can extract the syscall parameters using the <code>PT_REGS_PARM</code> macros (such as <code>PT_REGS_PARM1</code>, <code>PT_REGS_PARM2</code>, etc.).</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Copy the pt_regs structure from the raw tracepoint args.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Get the second parameter (pathname) from the registers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><ol start="7">
<li>LSM: <code>LSM_PROBE(hook_name,typeof(arg1), typeof(arg1)...)</code>. For example, to prevent creating a new directory:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LSM_PROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_trace_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LSM path_mkdir: mode=%d, ret=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="data-handling">Data handling<a class="td-heading-self-link" href="#data-handling" aria-label="Heading self-link"></a></h2>
<ol>
<li><strong>bpf_probe_read_kernel</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_kernel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_kernel</code> is used for copying arbitrary data (e.g., structures, buffers) from kernel space and returns 0 on success.</p>
<ol start="2">
<li><strong>bpf_probe_read_kernel_str</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_kernel_str</code> is used for reading null-terminated strings from kernel space and returns the length of the string including the trailing NULL on success.</p>
<ol start="3">
<li><strong>bpf_probe_read_user</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_user</code> is used for copying arbitrary data (e.g., structures, buffers) from user space and returns 0 on success.</p>
<ol start="4">
<li><strong>bpf_probe_read_user_str</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>  
</span></span></code></pre></div><p><code>bpf_probe_read_user_str</code> is used for reading null-terminated strings from user space and returns the length of the string including the trailing NULL on success.</p>
<ol start="5">
<li><strong>bpf_ktime_get_ns</strong>: returns <code>u64</code> time elapsed since system boot in nanoseconds.</li>
<li><strong>bpf_get_current_pid_tgid</strong>: returns <code>u64</code> current tgid and pid.</li>
<li><strong>bpf_get_current_uid_gid</strong>: returns <code>u64</code> current pid and gid.</li>
<li><strong>bpf_get_current_comm(void *buf, __u32 size_of_buf)</strong>:  copy current process name into pointer<code>buf</code> and sizeof at least 16 bytes.
For example:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// TASK_COMM_LEN = 16, defined in include/linux/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><ol start="9">
<li><code>bpf_get_current_task</code> helper function returns current task as a pointer to <code>struct task_struct</code>.</li>
</ol>
<h2 id="buffers">Buffers<a class="td-heading-self-link" href="#buffers" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF_PERF_OUTPUT(name)</code>: creates eBPF table to push data out to user-space using perf buffer.</li>
<li><code>perf_submit</code>: a method of a <code>BPF_PERF_OUTPUT</code> to submit data to user-space. <code>perf_submit</code> has the following prototype: <code>int perf_submit((void *)ctx, (void *)data, u32 data_size)</code>.</li>
<li><code>BPF_RINGBUF_OUTPUT</code>:  creates eBPF table to push data out to user-space using ring buffer. It has the following prototype <code>BPF_RINGBUF_OUTPUT(name, page_cnt)</code>, <code>page_cnt</code> is number of memory pages for ring buffer size.</li>
<li><code>ringbuf_output</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to submit data to user-space.<code>ringbuf_output</code> has the following prototype: <code>int ringbuf_output((void *)data, u64 data_size, u64 flags)</code>.</li>
<li><code>ringbuf_reserve</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to reserve a space in ring buffer and allocate data structure pointer for output data. It has the following prototype: <code>void* ringbuf_reserve(u64 data_size)</code>.</li>
<li><code>ringbuf_submit</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to submit data to user-space. <code>ringbuf_submit</code> has the following prototype: <code>void ringbuf_submit((void *)data, u64 flags)</code>.</li>
</ol>
<h2 id="maps">Maps<a class="td-heading-self-link" href="#maps" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF_HASH</code>: creates hash map. For example, <code>BPF_HASH(my_hash, u64, u64);</code>.</li>
<li><code>BPF_ARRAY</code>: creates array map.</li>
</ol>
<p>BCC has also <code>BPF_HISTOGRAM</code>, <code>BPF_STACK_TRACE</code>, <code>BPF_PERF_ARRAY</code>, <code>BPF_PERCPU_HASH</code>, <code>BPF_PERCPU_ARRAY</code>, <code>BPF_LPM_TRIE</code>,<code>BPF_PROG_ARRAY</code>, <code>BPF_CPUMAP</code>, <code>BPF_ARRAY_OF_MAPS</code> and <code>BPF_HASH_OF_MAPS</code>.</p>
<h2 id="map-operations">Map Operations<a class="td-heading-self-link" href="#map-operations" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>*val map.lookup(&amp;key)</code>: return a pointer to value if exists.</li>
<li><code>map.delete(&amp;key)</code>: delete a key from map.</li>
<li><code>map.update(&amp;key, &amp;val)</code>: updates value for a given key.</li>
<li><code>map.insert(&amp;key, &amp;val)</code>: inserts a value for a given key.</li>
<li><code>map.increment(key[, increment_amount])</code>: increments the key by <code>increment_amount</code>.</li>
</ol>
<h2 id="bcc-python">BCC Python<a class="td-heading-self-link" href="#bcc-python" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF(text=prog)</code>: creates eBPF object.</li>
<li><code>BPF.attach_kprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: attach a probe into kernel function <code>event</code> and use <code>name</code> as kprobe handler.</li>
<li><code>BPF.attach_kretprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_kprobe</code>.</li>
<li><code>BPF.attach_tracepoint(tp=&quot;tracepoint&quot;, fn_name=&quot;name&quot;)</code>: attach a probe into <code>tracepoint</code> and use <code>name</code> as tracepoint handler.</li>
<li><code>BPF.attach_uprobe(name=&quot;location&quot;, sym=&quot;symbol&quot;, fn_name=&quot;name&quot;)</code>: attach a probe to<code>location</code> with <code>symbol</code>use <code>name</code> as uprobe handler. For example,</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attach_uprobe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sym</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;shell_execve&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fn_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;bash_exec&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Attach a probe to <code>shell_execve</code> symbol in binary or object file<code>/bin/bash</code>and use <code>bash_exec</code> as a handler.</p>
<ol start="6">
<li><code>BPF.attach_uretprobe(name=&quot;location&quot;, sym=&quot;symbol&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_uprobe</code>.</li>
<li><code>BPF.attach_raw_tracepoint(tp=&quot;tracepoint&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_tracepoint</code>.</li>
<li><code>BPF.attach_xdp(dev=&quot;device&quot;, fn=b.load_func(&quot;fn_name&quot;,BPF.XDP), flags)</code>: attach XDP to <code>device</code>, use <code>fn_name</code> as handler for each ingress packet. Flags are defined in <code>include/uapi/linux/if_link.h</code> as the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_UPDATE_IF_NOEXIST</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">//--&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_SKB_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_DRV_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_HW_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>XDP_FLAGS_UPDATE_IF_NOEXIST	(1U &laquo; 0): This flag attaches the XDP program if there isn’t already one present.
XDP_FLAGS_SKB_MODE (1U &laquo; 1): This flag attaches the XDP program in generic mode.
XDP_FLAGS_DRV_MODE (1U &laquo; 2): This flag attaches the XDP program in native driver mode.
XDP_FLAGS_HW_MODE (1U &laquo; 3): This flag is used for offloading the XDP program to supported hardware (NICs that support XDP offload).</p>
<ol start="9">
<li><code>BPF.remove_xdp(&quot;device&quot;)</code>: removes XDP program from interface <code>device</code>.</li>
<li><code>BPF.detach_kprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: detach a kprobe.</li>
<li><code>BPF.detach_kretprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: detach a kretprobe.</li>
</ol>
<h2 id="output">Output<a class="td-heading-self-link" href="#output" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF.perf_buffer_poll(timeout=T)</code>: polls data from perf buffer.</li>
<li><code>BPF.ring_buffer_poll(timeout=T)</code>: polls data from ring buffer.</li>
<li><code>table.open_perf_buffer(callback, page_cnt=N, lost_cb=None)</code>: opens a perf ring buffer for <code>BPF_PERF_OUTPUT</code>.</li>
<li><code>table.open_ring_buffer(callback, ctx=None)</code>: opens a buffer ring for <code>BPF_RINGBUF_OUTPUT</code>.</li>
<li><code>BPF.trace_print</code>: reads from <code>/sys/kernel/debug/tracing/trace_pipe</code> and prints the contents.</li>
</ol>
<h2 id="examples">Examples<a class="td-heading-self-link" href="#examples" aria-label="Heading self-link"></a></h2>
<p>Let&rsquo;s look at example The following eBPF kernel code yo attack kprobe to <code>do_mkdirat</code> kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">from</span> <span style="color:#000">bcc</span> <span style="color:#000">import</span> <span style="color:#000">BPF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;uapi/linux/ptrace.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/fs.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_FILENAME_LEN 256
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe__do_mkdirat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_FILENAME_LEN</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_trace_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing mkdir calls... Hit Ctrl-C to exit.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trace_print</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>bpf_trace_printk</code> function is similar to <code>bpf_printk</code> macro. First, we create an eBPF object from the C code using <code>b = BPF(text=prog)</code>. We don&rsquo;t have to add <code>attach_kprobe</code> because we followed the naming convention of kprobe which is <code>kprobe__</code> followed by the name of kernel function name <code>kprobe__do_mkdirat</code>.
Run <code>sudo python3 bcc-mkdir.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>b<span style="color:#4e9a06">&#39;  mkdir-1706 [...] KPROBE ENTRY pid = 1706, filename = test1, mode = 511&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#4e9a06">&#39;  mkdir-1708 [...] KPROBE ENTRY pid = 1708, filename = test2, mode = 511&#39;</span>
</span></span></code></pre></div><p>We don&rsquo;t have to compile because BCC compiles eBPF C code at runtime and there is no need to write a separate user-space. If you notice, the previous code is exactly similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s explore another example which uses Tracepoints with ring buffer map.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">from</span> <span style="color:#000">bcc</span> <span style="color:#000">import</span> <span style="color:#000">BPF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">BPF_RINGBUF_OUTPUT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">TRACEPOINT_PROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sys_enter_unlinkat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// In the tracepoint for unlinkat, the second argument (args-&gt;pathname) is the filename.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">def</span> <span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, COMM: %s, File: %s&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#000">utf</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#000">utf</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">open_ring_buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing unlinkat syscall... Hit Ctrl-C to end.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#f57900">True</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f57900">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ring_buffer_poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">except</span> <span style="color:#f57900">KeyboardInterrupt</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>The <code>print_event</code> callback function to the ring buffer which will be called every time an event is received from the ring buffer. <code>print_event</code> takes cpu number, pointer to raw data of the event data structure defined in eBPF code and size of the event data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">):</span>
</span></span></code></pre></div><p>Then, event is defined automatically using BCC from eBPF data structure <code>event</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Then, printing out the contents of the event:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: </span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">, COMM: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">, File: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;utf-8&#39;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;utf-8&#39;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span></code></pre></div><p>Then,we create an eBPF object from the C code using <code>b = BPF(text=prog)</code>. Then, we opened the ring buffer associated with the map named <code>events</code> with callback function (<code>print_event</code>) to process data that is submitted to the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">open_ring_buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We don&rsquo;t need to use <code>BPF.attach_tracepoint</code> because we followed the naming convention for <code>tracepoints</code> which is <code>TRACEPOINT_PROBE(_category_, _event_)</code>. Finally, we start polling from the ring buffer with 100ms timeout.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ring_buffer_poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 100ms timeout</span>
</span></span></code></pre></div><p>If you noticed, this code is similar to what we did in tracepoint.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_unlinkat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_unlinkat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="bcc-tools">BCC Tools<a class="td-heading-self-link" href="#bcc-tools" aria-label="Heading self-link"></a></h2>
<p>The following tables are from the BCC GitHub repository. These tables contain useful tools for different aspects of system analysis, including general tracing and debugging, memory and process monitoring, performance and timing, CPU and scheduler statistics, network and socket monitoring, as well as storage and filesystems diagnostics. Each category offers a range of tools designed to help you quickly diagnose issues, tune performance, and gather insights into system behavior using BPF-based instrumentation.</p>
<h3 id="general">General<a class="td-heading-self-link" href="#general" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>argdist</td>
<td>Display function parameter values as a histogram or frequency count.</td>
</tr>
<tr>
<td>bashreadline</td>
<td>Print entered bash commands system wide.</td>
</tr>
<tr>
<td>bpflist</td>
<td>Display processes with active BPF programs and maps.</td>
</tr>
<tr>
<td>capable</td>
<td>Trace security capability checks.</td>
</tr>
<tr>
<td>compactsnoop</td>
<td>Trace compact zone events with PID and latency.</td>
</tr>
<tr>
<td>criticalstat</td>
<td>Trace and report long atomic critical sections in the kernel.</td>
</tr>
<tr>
<td>deadlock</td>
<td>Detect potential deadlocks on a running process.</td>
</tr>
<tr>
<td>drsnoop</td>
<td>Trace direct reclaim events with PID and latency.</td>
</tr>
<tr>
<td>funccount</td>
<td>Count kernel function calls.</td>
</tr>
<tr>
<td>inject</td>
<td>Targeted error injection with call chain and predicates.</td>
</tr>
<tr>
<td>klockstat</td>
<td>Traces kernel mutex lock events and displays lock statistics.</td>
</tr>
<tr>
<td>opensnoop</td>
<td>Trace open() syscalls.</td>
</tr>
<tr>
<td>readahead</td>
<td>Show performance of read-ahead cache.</td>
</tr>
<tr>
<td>reset-trace</td>
<td>Reset the state of tracing. Maintenance tool only.</td>
</tr>
<tr>
<td>stackcount</td>
<td>Count kernel function calls and their stack traces.</td>
</tr>
<tr>
<td>syncsnoop</td>
<td>Trace sync() syscall.</td>
</tr>
<tr>
<td>threadsnoop</td>
<td>List new thread creation.</td>
</tr>
<tr>
<td>tplist</td>
<td>Display kernel tracepoints or USDT probes and their formats.</td>
</tr>
<tr>
<td>trace</td>
<td>Trace arbitrary functions, with filters.</td>
</tr>
<tr>
<td>ttysnoop</td>
<td>Watch live output from a tty or pts device.</td>
</tr>
<tr>
<td>ucalls</td>
<td>Summarize method calls or Linux syscalls in high-level languages.</td>
</tr>
<tr>
<td>uflow</td>
<td>Print a method flow graph in high-level languages.</td>
</tr>
<tr>
<td>ugc</td>
<td>Trace garbage collection events in high-level languages.</td>
</tr>
<tr>
<td>uobjnew</td>
<td>Summarize object allocation events by object type and number of bytes allocated.</td>
</tr>
<tr>
<td>ustat</td>
<td>Collect events such as GCs, thread creations, object allocations, exceptions, etc.</td>
</tr>
<tr>
<td>uthreads</td>
<td>Trace thread creation events in Java and raw pthreads.</td>
</tr>
</tbody>
</table>
<h3 id="memory-and-process-tools">Memory and Process Tools<a class="td-heading-self-link" href="#memory-and-process-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>execsnoop</td>
<td>Trace new processes via exec() syscalls.</td>
</tr>
<tr>
<td>exitsnoop</td>
<td>Trace process termination (exit and fatal signals).</td>
</tr>
<tr>
<td>killsnoop</td>
<td>Trace signals issued by the kill() syscall.</td>
</tr>
<tr>
<td>kvmexit</td>
<td>Display the exit_reason and its statistics of each vm exit.</td>
</tr>
<tr>
<td>memleak</td>
<td>Display outstanding memory allocations to find memory leaks.</td>
</tr>
<tr>
<td>numasched</td>
<td>Track the migration of processes between NUMAs.</td>
</tr>
<tr>
<td>oomkill</td>
<td>Trace the out-of-memory (OOM) killer.</td>
</tr>
<tr>
<td>pidpersec</td>
<td>Count new processes (via fork).</td>
</tr>
<tr>
<td>rdmaucma</td>
<td>Trace RDMA Userspace Connection Manager Access events.</td>
</tr>
<tr>
<td>shmsnoop</td>
<td>Trace System V shared memory syscalls.</td>
</tr>
<tr>
<td>slabratetop</td>
<td>Kernel SLAB/SLUB memory cache allocation rate top.</td>
</tr>
</tbody>
</table>
<h3 id="performance-and-time-tools">Performance and Time Tools<a class="td-heading-self-link" href="#performance-and-time-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dbslower</td>
<td>Trace MySQL/PostgreSQL queries slower than a threshold.</td>
</tr>
<tr>
<td>dbstat</td>
<td>Summarize MySQL/PostgreSQL query latency as a histogram.</td>
</tr>
<tr>
<td>funcinterval</td>
<td>Time interval between the same function as a histogram.</td>
</tr>
<tr>
<td>funclatency</td>
<td>Time functions and show their latency distribution.</td>
</tr>
<tr>
<td>funcslower</td>
<td>Trace slow kernel or user function calls.</td>
</tr>
<tr>
<td>hardirqs</td>
<td>Measure hard IRQ (hard interrupt) event time.</td>
</tr>
<tr>
<td>mysqld_qslower</td>
<td>Trace MySQL server queries slower than a threshold.</td>
</tr>
<tr>
<td>ppchcalls</td>
<td>Summarize ppc hcall counts and latencies.</td>
</tr>
<tr>
<td>softirqs</td>
<td>Measure soft IRQ (soft interrupt) event time.</td>
</tr>
<tr>
<td>syscount</td>
<td>Summarize syscall counts and latencies.</td>
</tr>
</tbody>
</table>
<h3 id="cpu-and-scheduler-tools">CPU and Scheduler Tools<a class="td-heading-self-link" href="#cpu-and-scheduler-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpudist</td>
<td>Summarize on- and off-CPU time per task as a histogram.</td>
</tr>
<tr>
<td>cpuunclaimed</td>
<td>Sample CPU run queues and calculate unclaimed idle CPU.</td>
</tr>
<tr>
<td>llcstat</td>
<td>Summarize CPU cache references and misses by process.</td>
</tr>
<tr>
<td>offcputime</td>
<td>Summarize off-CPU time by kernel stack trace.</td>
</tr>
<tr>
<td>offwaketime</td>
<td>Summarize blocked time by kernel off-CPU stack and waker stack.</td>
</tr>
<tr>
<td>profile</td>
<td>Profile CPU usage by sampling stack traces at a timed interval.</td>
</tr>
<tr>
<td>runqlat</td>
<td>Run queue (scheduler) latency as a histogram.</td>
</tr>
<tr>
<td>runqlen</td>
<td>Run queue length as a histogram.</td>
</tr>
<tr>
<td>runqslower</td>
<td>Trace long process scheduling delays.</td>
</tr>
<tr>
<td>wakeuptime</td>
<td>Summarize sleep-to-wakeup time by waker kernel stack.</td>
</tr>
<tr>
<td>wqlat</td>
<td>Summarize work waiting latency on workqueue.</td>
</tr>
</tbody>
</table>
<h3 id="network-and-sockets-tools">Network and Sockets Tools<a class="td-heading-self-link" href="#network-and-sockets-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>gethostlatency</td>
<td>Show latency for getaddrinfo/gethostbyname[2] calls.</td>
</tr>
<tr>
<td>bindsnoop</td>
<td>Trace IPv4 and IPv6 bind() system calls (bind()).</td>
</tr>
<tr>
<td>netqtop</td>
<td>Trace and display packets distribution on NIC queues.</td>
</tr>
<tr>
<td>sofdsnoop</td>
<td>Trace FDs passed through unix sockets.</td>
</tr>
<tr>
<td>solisten</td>
<td>Trace TCP socket listen.</td>
</tr>
<tr>
<td>sslsniff</td>
<td>Sniff OpenSSL written and readed data.</td>
</tr>
<tr>
<td>tcpaccept</td>
<td>Trace TCP passive connections (accept()).</td>
</tr>
<tr>
<td>tcpconnect</td>
<td>Trace TCP active connections (connect()).</td>
</tr>
<tr>
<td>tcpconnlat</td>
<td>Trace TCP active connection latency (connect()).</td>
</tr>
<tr>
<td>tcpdrop</td>
<td>Trace kernel-based TCP packet drops with details.</td>
</tr>
<tr>
<td>tcplife</td>
<td>Trace TCP sessions and summarize lifespan.</td>
</tr>
<tr>
<td>tcpretrans</td>
<td>Trace TCP retransmits and TLPs.</td>
</tr>
<tr>
<td>tcprtt</td>
<td>Trace TCP round trip time.</td>
</tr>
<tr>
<td>tcpstates</td>
<td>Trace TCP session state changes with durations.</td>
</tr>
<tr>
<td>tcpsubnet</td>
<td>Summarize and aggregate TCP send by subnet.</td>
</tr>
<tr>
<td>tcpsynbl</td>
<td>Show TCP SYN backlog.</td>
</tr>
<tr>
<td>tcptop</td>
<td>Summarize TCP send/recv throughput by host. Top for TCP.</td>
</tr>
<tr>
<td>tcptracer</td>
<td>Trace TCP established connections (connect(), accept(), close()).</td>
</tr>
<tr>
<td>tcpcong</td>
<td>Trace TCP socket congestion control status duration.</td>
</tr>
</tbody>
</table>
<h3 id="storage-and-filesystems-tools">Storage and Filesystems Tools<a class="td-heading-self-link" href="#storage-and-filesystems-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bitesize</td>
<td>Show per process I/O size histogram.</td>
</tr>
<tr>
<td>cachestat</td>
<td>Trace page cache hit/miss ratio.</td>
</tr>
<tr>
<td>cachetop</td>
<td>Trace page cache hit/miss ratio by processes.</td>
</tr>
<tr>
<td>dcsnoop</td>
<td>Trace directory entry cache (dcache) lookups.</td>
</tr>
<tr>
<td>dcstat</td>
<td>Directory entry cache (dcache) stats.</td>
</tr>
<tr>
<td>biolatency</td>
<td>Summarize block device I/O latency as a histogram.</td>
</tr>
<tr>
<td>biotop</td>
<td>Top for disks: Summarize block device I/O by process.</td>
</tr>
<tr>
<td>biopattern</td>
<td>Identify random/sequential disk access patterns.</td>
</tr>
<tr>
<td>biosnoop</td>
<td>Trace block device I/O with PID and latency.</td>
</tr>
<tr>
<td>dirtop</td>
<td>File reads and writes by directory. Top for directories.</td>
</tr>
<tr>
<td>filelife</td>
<td>Trace the lifespan of short-lived files.</td>
</tr>
<tr>
<td>filegone</td>
<td>Trace why file gone (deleted or renamed).</td>
</tr>
<tr>
<td>fileslower</td>
<td>Trace slow synchronous file reads and writes.</td>
</tr>
<tr>
<td>filetop</td>
<td>File reads and writes by filename and process. Top for files.</td>
</tr>
<tr>
<td>mdflush</td>
<td>Trace md flush events.</td>
</tr>
<tr>
<td>mountsnoop</td>
<td>Trace mount and umount syscalls system-wide.</td>
</tr>
<tr>
<td>virtiostat</td>
<td>Show VIRTIO device IO statistics.</td>
</tr>
</tbody>
</table>
<h3 id="filesystems-tools">Filesystems Tools<a class="td-heading-self-link" href="#filesystems-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>btrfsdist</td>
<td>Summarize btrfs operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>btrfsslower</td>
<td>Trace slow btrfs operations.</td>
</tr>
<tr>
<td>ext4dist</td>
<td>Summarize ext4 operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>ext4slower</td>
<td>Trace slow ext4 operations.</td>
</tr>
<tr>
<td>nfsslower</td>
<td>Trace slow NFS operations.</td>
</tr>
<tr>
<td>nfsdist</td>
<td>Summarize NFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>vfscount</td>
<td>Count VFS calls.</td>
</tr>
<tr>
<td>vfsstat</td>
<td>Count some VFS calls, with column output.</td>
</tr>
<tr>
<td>xfsdist</td>
<td>Summarize XFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>xfsslower</td>
<td>Trace slow XFS operations.</td>
</tr>
<tr>
<td>zfsdist</td>
<td>Summarize ZFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>zfsslower</td>
<td>Trace slow ZFS operations.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4551197eff5fbdde9f1f1576dc49c24">7.3 - BPFTool</h1>
    <div class="lead">The official command-line utility shipped with the kernel source that loads pins inspects and benchmarks eBPF programs and maps from user space.</div>
	<p><code>BPFTool</code> is a command-line utility for interacting with eBPF programs and maps in the Linux kernel. It provides a comprehensive set of commands for loading, inspecting, and debugging eBPF objects. With <code>bpftool</code>, users can load compiled eBPF programs into the kernel, attach them to various kernel events or network interfaces, and manage eBPF maps used for storing and sharing data between kernel and user space. It also offers powerful introspection capabilities, allowing users to examine the state of running eBPF programs, including their maps, attached probes, and verifier logs, making it an indispensable tool for eBPF developers and system administrators working with modern Linux observability and networking.</p>
<p>We used many times to generate <code>vmlinux.h</code> header file and the skeleton header files:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span><span style="display:flex;"><span>sudo bpftool gen skeleton obj_file.o &gt; obj_file.skel.h
</span></span></code></pre></div><p>Using <code>sudo bpftool -h</code> to show the program&rsquo;s options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Usage: bpftool <span style="color:#ce5c00;font-weight:bold">[</span>OPTIONS<span style="color:#ce5c00;font-weight:bold">]</span> OBJECT <span style="color:#ce5c00;font-weight:bold">{</span> COMMAND <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">help</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       bpftool batch file FILE
</span></span><span style="display:flex;"><span>       bpftool version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       OBJECT :<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span> prog <span style="color:#000;font-weight:bold">|</span> map <span style="color:#000;font-weight:bold">|</span> link <span style="color:#000;font-weight:bold">|</span> cgroup <span style="color:#000;font-weight:bold">|</span> perf <span style="color:#000;font-weight:bold">|</span> net <span style="color:#000;font-weight:bold">|</span> feature <span style="color:#000;font-weight:bold">|</span> btf <span style="color:#000;font-weight:bold">|</span> gen <span style="color:#000;font-weight:bold">|</span> struct_ops <span style="color:#000;font-weight:bold">|</span> iter <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       OPTIONS :<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#ce5c00;font-weight:bold">{</span>-j<span style="color:#000;font-weight:bold">|</span>--json<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">[{</span>-p<span style="color:#000;font-weight:bold">|</span>--pretty<span style="color:#ce5c00;font-weight:bold">}]</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">{</span>-d<span style="color:#000;font-weight:bold">|</span>--debug<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ce5c00;font-weight:bold">{</span>-V<span style="color:#000;font-weight:bold">|</span>--version<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s explore some of these options. First, let&rsquo;s try the following simple code which count how many times <code>getpid</code> syscall get invoked:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">count</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_getpid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">count_getpid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;getpid_count.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">getpid_count</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to get map FD</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BPF program loaded and map updated. Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;getpid call count: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lookup failed for key %d: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getpid_count__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Before compiling and running the code. Run <code>sudo bpftool prog</code> to list all running eBPF programs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>42: cgroup_device  name sd_devices  tag 2705a24f44b96941  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 464B  jited 301B  memlock 4096B
</span></span><span style="display:flex;"><span>43: cgroup_skb  name sd_fw_egress  tag 6deef7357e7b4530  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 64B  jited 67B  memlock 4096B
</span></span><span style="display:flex;"><span>44: cgroup_skb  name sd_fw_ingress  tag 6deef7357e7b4530  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 64B  jited 67B  memlock 4096B
</span></span><span style="display:flex;"><span>46: cgroup_device  name sd_devices  tag 30c3c39a95291292  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T00:27:21-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 1664B  jited 1027B  memlock 4096B
</span></span></code></pre></div><p>You will see a list of <code>cgroup</code> programs running by the system. After compiling and running the previous code and then list all running eBPF code <code>sudo bpftool prog</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>46: cgroup_device  name sd_devices  tag 30c3c39a95291292  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T00:27:21-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 1664B  jited 1027B  memlock 4096B
</span></span><span style="display:flex;"><span>312: tracepoint  name count_getpid  tag be075f8b6a94de72  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T05:38:34-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 152B  jited 99B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">147</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>Also <code>--pretty</code> option can be used <code>sudo bpftool prog --pretty</code> to display the output in prettified JSON.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;id&#34;</span>: 312,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;tracepoint&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;count_getpid&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;tag&#34;</span>: <span style="color:#4e9a06">&#34;be075f8b6a94de72&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;gpl_compatible&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;loaded_at&#34;</span>: 1742290714,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;uid&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;orphaned&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_xlated&#34;</span>: 152,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;jited&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_jited&#34;</span>: 99,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_memlock&#34;</span>: 4096,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;map_ids&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>147<span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;btf_id&#34;</span>: <span style="color:#0000cf;font-weight:bold">511</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Our code has the following properties:<br>
id = 312<br>
Program Type = tracepoint which represents the type of eBPF program<br>
name = count_getpid which is the name of the function defined in the code<br>
tag = be075f8b6a94de72 which is a hash of the compiled instructions.<br>
gpl which is the liscence<br>
loaded_at = 2025-03-18T05:38:34-0400 timestamp when the program was loaded<br>
uid = 0 which indicated that loaded by root<br>
xlated = 152B represents the size of eBPF bytecode<br>
jited = 99B represents the size of the machine code<br>
memlock = 4096B represents the size resrved for this program<br>
map_ids = 147 which is the id of the map loaded in this program<br>
btf_id = 511 which is a unique identifier that the kernel assigns to that block of BTF metadata and can inspect its details using <code>sudo bpftool btf show id 511</code></p>
<p>BPFTool can dump eBPF bytecode using <code>sudo bpftool prog dump xlated id 312</code> :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void * ctx<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void *ctx<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   1: <span style="color:#ce5c00;font-weight:bold">(</span>63<span style="color:#ce5c00;font-weight:bold">)</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r10 -4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span>   2: <span style="color:#ce5c00;font-weight:bold">(</span>bf<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">=</span> r10
</span></span><span style="display:flex;"><span>   3: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">+=</span> -4
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   4: <span style="color:#ce5c00;font-weight:bold">(</span>18<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> map<span style="color:#ce5c00;font-weight:bold">[</span>id:147<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   6: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">264</span>
</span></span><span style="display:flex;"><span>   7: <span style="color:#ce5c00;font-weight:bold">(</span>61<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r2 +0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   8: <span style="color:#ce5c00;font-weight:bold">(</span>35<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> r0 &gt;<span style="color:#ce5c00;font-weight:bold">=</span> 0x1 goto pc+3
</span></span><span style="display:flex;"><span>   9: <span style="color:#ce5c00;font-weight:bold">(</span>67<span style="color:#ce5c00;font-weight:bold">)</span> r0 &lt;&lt;<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  10: <span style="color:#ce5c00;font-weight:bold">(</span>0f<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">+=</span> r1
</span></span><span style="display:flex;"><span>  11: <span style="color:#ce5c00;font-weight:bold">(</span>05<span style="color:#ce5c00;font-weight:bold">)</span> goto pc+1
</span></span><span style="display:flex;"><span>  12: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  13: <span style="color:#ce5c00;font-weight:bold">(</span>15<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">==</span> 0x0 goto pc+3
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  14: <span style="color:#ce5c00;font-weight:bold">(</span>61<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 +0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  15: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  16: <span style="color:#ce5c00;font-weight:bold">(</span>63<span style="color:#ce5c00;font-weight:bold">)</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 +0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  17: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  18: <span style="color:#ce5c00;font-weight:bold">(</span>95<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">exit</span>
</span></span></code></pre></div><p>We can get visual representation of our code instructions using <code>sudo bpftool prog dump xlated id 312 visual &amp;&gt; vis.out</code> and the output <code>vis.out</code> is a DOT language file which is a graph description language and can be viewed Graphviz. It can be converted to PNG using <code>dot -Tpng viz.out -o viz.png</code> and you can display viz.png file.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter6/graphviz.png" alt="Centered image" />
</p>
<p>BPFTool can also dump jited or the program machine code using <code>sudo bpftool prog dump jited id 312</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void * ctx<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>0xffffffffc03735d4:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void *ctx<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0:	nopl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax,%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   5:	nopl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   8:	pushq	%rbp
</span></span><span style="display:flex;"><span>   9:	movq	%rsp, %rbp
</span></span><span style="display:flex;"><span>   c:	subq	<span style="color:#000">$8</span>, %rsp
</span></span><span style="display:flex;"><span>  13:	xorl	%edi, %edi
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  15:	movl	%edi, -4<span style="color:#ce5c00;font-weight:bold">(</span>%rbp<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  18:	movq	%rbp, %rsi
</span></span><span style="display:flex;"><span>  1b:	addq	<span style="color:#000">$-</span>4, %rsi
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  1f:	movabsq	<span style="color:#000">$-</span>121297335560704, %rdi
</span></span><span style="display:flex;"><span>  29:	addq	<span style="color:#000">$272</span>, %rdi
</span></span><span style="display:flex;"><span>  30:	movl	<span style="color:#ce5c00;font-weight:bold">(</span>%rsi<span style="color:#ce5c00;font-weight:bold">)</span>, %eax
</span></span><span style="display:flex;"><span>  33:	cmpq	<span style="color:#000">$1</span>, %rax
</span></span><span style="display:flex;"><span>  37:	jae	0xffffffffc0373616
</span></span><span style="display:flex;"><span>  39:	shlq	<span style="color:#000">$3</span>, %rax
</span></span><span style="display:flex;"><span>  3d:	addq	%rdi, %rax
</span></span><span style="display:flex;"><span>  40:	jmp	0xffffffffc0373618
</span></span><span style="display:flex;"><span>  42:	xorl	%eax, %eax
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  44:	testq	%rax, %rax
</span></span><span style="display:flex;"><span>  47:	je	0xffffffffc0373627
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  49:	movl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>, %edi
</span></span><span style="display:flex;"><span>  4c:	addq	<span style="color:#000">$1</span>, %rdi
</span></span><span style="display:flex;"><span>  50:	movl	%edi, <span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  53:	xorl	%eax, %eax
</span></span><span style="display:flex;"><span>  55:	leave
</span></span><span style="display:flex;"><span>  56:	jmp	0xffffffff85f0410b
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    I had to download the source code and compile bpftool to enable JIT disassembly support. I used the command <code>make LLVM_CONFIG=$(which llvm-config) CFLAGS_EXTRA=&quot;-DENABLE_JIT_DISASM=1&quot;</code> to ensure that LLVM was correctly detected and that JIT disassembly support was enabled.

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    You can inspect eBPF instructions for the object file using <code>llvm-objdump -S getpid.o</code>

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>getpid.o:	file format elf64-bpf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section tracepoint/syscalls/sys_enter_getpid:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000000000000</span> &lt;count_getpid&gt;:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       0:	b7 <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       1:	<span style="color:#0000cf;font-weight:bold">63</span> 1a <span style="color:#204a87">fc</span> ff <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	*<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r10 - 0x4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span>       2:	bf a2 <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">=</span> r10
</span></span><span style="display:flex;"><span>       3:	<span style="color:#0000cf;font-weight:bold">07</span> <span style="color:#0000cf;font-weight:bold">02</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#204a87">fc</span> ff ff ff	<span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">+=</span> -0x4
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       4:	<span style="color:#0000cf;font-weight:bold">18</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0 ll
</span></span><span style="display:flex;"><span>       6:	<span style="color:#0000cf;font-weight:bold">85</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	call 0x1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       7:	<span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">03</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">==</span> 0x0 goto +0x3 &lt;count_getpid+0x58&gt;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       8:	<span style="color:#0000cf;font-weight:bold">61</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 + 0x0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       9:	<span style="color:#0000cf;font-weight:bold">07</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> 0x1
</span></span><span style="display:flex;"><span>      10:	<span style="color:#0000cf;font-weight:bold">63</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	*<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 + 0x0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      11:	b7 <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0
</span></span><span style="display:flex;"><span>      12:	<span style="color:#0000cf;font-weight:bold">95</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#204a87">exit</span>
</span></span></code></pre></div><p>You can find a list of eBPF opcodes from kernel documentation<br>
<a href="https://docs.kernel.org/bpf/standardization/instruction-set.html">https://docs.kernel.org/bpf/standardization/instruction-set.html</a> or RFC 9669 <a href="https://www.rfc-editor.org/rfc/rfc9669.html">https://www.rfc-editor.org/rfc/rfc9669.html</a>.</p>
<p>BPFTool can display the list of all maps using <code>sudo bpftool map</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>11: hash_of_maps  name cgroup_hash  flags 0x0
</span></span><span style="display:flex;"><span>	key 8B  value 4B  max_entries <span style="color:#0000cf;font-weight:bold">2048</span>  memlock 165152B
</span></span><span style="display:flex;"><span>147: array  name count  flags 0x0
</span></span><span style="display:flex;"><span>	key 4B  value 4B  max_entries <span style="color:#0000cf;font-weight:bold">1</span>  memlock 272B
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>We can also inspect map content with id 147 using <code>sudo bpftool map dump id 147</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#8f5902;font-style:italic"># count of how many times `getpid` syscall get invoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Maps can be updated using <code>bpftool</code>. For example, let&rsquo;s change the value to 90 <code>sudo bpftool map update id 147 key 00 00 00 00 value 90 00 00 00</code> and inspect the content again <code>sudo bpftool map dump id 147</code> you might see:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">98</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The extra 8 indicates that between your update and the dump, the <code>getpid</code> syscall was triggered 8 times, and since your eBPF program increments the value each time <code>getpid</code> is called, the counter increased from 90 to 98.</p>
<p>Maps also can be pinned to eBPF filesystem using <code>sudo bpftool map pin id 147 /sys/fs/bpf/getpid_map</code> and even after termination of our program we can dump the content of the pinned map using <code>sudo bpftool map dump pinned /sys/fs/bpf/getpid_map</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">122</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>We can unpin simply by remove the created file <code>sudo rm /sys/fs/bpf/getpid_map</code>.
BPFTool can also load programs. Let&rsquo;s close our program and load it again using:
<code>sudo bpftool prog loadall getpid.o /sys/fs/bpf/test autoattach</code> and then run <code>sudo bpftool prog</code> to make sure that the program is loaded:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>741: tracepoint  name count_getpid  tag be075f8b6a94de72  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T07:03:14-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 152B  jited 99B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">85</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">189</span>
</span></span></code></pre></div><p><code>autoattach</code> option is to load, attach and pin kprobe, kretprobe, uprobe, uretprobe and tracepoints in a single command.</p>
<p>We can again dump the content of the program map <code>sudo bpftool map dump id 85</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>BPFTool can also load and attach another types of eBPF programs such as XDP. Let&rsquo;s see the following code of XDP which drops ingress traffic to port 8080:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_ingress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping XDP egress packet port 8080</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_DROP</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We can load this program using <code>sudo bpftool prog load xdp_drop8080.o /sys/fs/bpf/xdp type xdp</code>. Then running <code>sudo bpftool prog list pinned /sys/fs/bpf/xdp</code> to see if the program is loaded successfully:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>835: xdp  name drop_egress_port_8080  tag 7c15f4a6de3ceb0f  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T07:24:28-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 248B  jited 164B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">122</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">310</span>
</span></span></code></pre></div><p>Then we can attach this program to an interface <code>sudo bpftool net attach xdp id 835 dev enp1s0</code>. To confirm program is attached use <code>sudo bpftool net list</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xdp:
</span></span><span style="display:flex;"><span>enp1s0<span style="color:#ce5c00;font-weight:bold">(</span>2<span style="color:#ce5c00;font-weight:bold">)</span> driver id <span style="color:#0000cf;font-weight:bold">835</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tc:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flow_dissector:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netfilter:
</span></span></code></pre></div><p>Or by viewing <code>ip a</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> xdp/id:835 qdisc fq_codel state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 52:54:00:f6:fe:bc brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    altname enx525400f6febc
</span></span><span style="display:flex;"><span>    inet 192.168.1.238/24 brd 192.168.1.255 scope global dynamic noprefixroute enp1s0
</span></span><span style="display:flex;"><span>       valid_lft 3543sec preferred_lft 3543sec
</span></span><span style="display:flex;"><span>    inet6 fe80::5054:ff:fef6:febc/64 scope link noprefixroute 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>We can see <code>xdp/id:835</code> which confirms program with id 835 of type XDP is attached to <code>enp1s0</code> interface. Use <code>sudo bpftool net detach xdp dev enp1s0</code> to detach the XDP program.
Unloading eBPF program can be done by removing the pinned pseudofile. For example, <code>sudo rm /sys/fs/bpf/xdp</code> to unload the XDP program. We can also use bpftool to load and attached TC programs with <code>tcx_egress</code> for egress traffic and <code>tcx_ingress</code> for ingress traffic. For example, <code>sudo bpftool net attach tcx_egress id 423 dev enp1s0</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-77ec8433956d6a9f2c325fa29eb7ae4d">7.4 - Tail call</h1>
    <div class="lead">One eBPF program can jump straight into another without returning which lets you chain logic and sidestep the per-program instruction limit while adding almost no overhead.</div>
	<p>Tail calls in eBPF let you chain together multiple BPF programs, effectively bypassing the instruction limit imposed on individual programs which is around 4096 instructions before kernel 5.2 and now the limit is one million instructions. Tail calls can also be used to break up the code logic into multiple parts to enable modular design. Tail call transfers control from one eBPF program to another without returning to the caller. 1. The verifier ensures that tail calls do not lead to unbounded recursion and that the jump is safe. It also reduces the effective stack size available (e.g., from 512 bytes to 256 bytes) when tail calls are used with BPF-to-BPF function calls.</p>
<h4 id="how-tail-calls-work">How Tail Calls Work<a class="td-heading-self-link" href="#how-tail-calls-work" aria-label="Heading self-link"></a></h4>
<ol>
<li>eBPF uses a special map type called <code>BPF_MAP_TYPE_PROG_ARRAY</code> that holds file descriptors of other BPF programs. The tail call uses an index (or key) into this map to know which program to jump to.</li>
<li>Within an eBPF program, you can use the helper function <code>bpf_tail_call(ctx, prog_array, key)</code> to transfer execution to another program. If the call is successful, the current program’s execution ends and the new program starts from its entry point.</li>
</ol>
<p>Let&rsquo;s explore an example of XDP code. The idea is to have a main XDP program that inspects incoming packets and, based on the TCP destination port, uses a tail call to jump to the appropriate program—one for port 8080 and one for port 22.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PROG_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">prog_array</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">bpf_htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_tail_call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_tail_call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port8080_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Packet to port 8080 processed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port22_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Packet to port 22 processed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;net/if.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;tail_call.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef libbpf_is_err
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define libbpf_is_err(ptr) ((unsigned long)(ptr) &gt; (unsigned long)-1000L)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tail_call</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_link</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;interface&gt;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ifname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tail_call__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tail_call__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port8080_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid FD for port8080_prog</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to update prog_array for port8080_prog: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port22_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid FD for port22_prog</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to update prog_array for port22_prog: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ifindex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">if_nametoindex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;if_nametoindex&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__attach_xdp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">main_prog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_is_err</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">libbpf_get_error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach XDP program on %s (ifindex: %d): %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;XDP program loaded and tail calls configured on interface %s (ifindex: %d).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Press Ctrl+C to exit...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_link__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tail_call__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter6/tail-call.png" alt="Centered image" />
</p>
<p>Compile the code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>clang -g -O2 -target bpf -c tail_call.c -o tail_call.o
</span></span><span style="display:flex;"><span>sudo bpftool gen skeleton tail_call.o &gt; tail_call.skel.h
</span></span><span style="display:flex;"><span>clang -o loader loader.c -lbpf
</span></span></code></pre></div><p>Run the loader using <code>sudo ./loader enp1s0</code> . Open trace buffer <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8853.538349: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> .Ns2.  8853.539270: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> .Ns2.  8853.539279: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>gnome-shell-2539     <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8853.541321: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>gnome-shell-2539     <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8853.541334: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777125: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777420: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777611: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>llvmpipe-1-2569      <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8860.783551: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span></code></pre></div>
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
