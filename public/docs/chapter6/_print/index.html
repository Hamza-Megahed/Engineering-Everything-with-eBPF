<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://ebpf.hamza-megahed.com/docs/chapter6/">
<link rel="alternate" type="application/rss&#43;xml" href="https://ebpf.hamza-megahed.com/docs/chapter6/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Tools and languages | Engineering Everything with eBPF</title>
<meta name="description" content="User space helpers and patterns that make building and debugging eBPF programs easier">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter6/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="Tools and languages">
  <meta property="og:description" content="User space helpers and patterns that make building and debugging eBPF programs easier">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Tools and languages">
  <meta itemprop="description" content="User space helpers and patterns that make building and debugging eBPF programs easier">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Tools and languages">
  <meta name="twitter:description" content="User space helpers and patterns that make building and debugging eBPF programs easier">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.3c5aebc1447634a6b24181e7c36ac494.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/chapter6/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Tools and languages</h1>
<div class="lead">User space helpers and patterns that make building and debugging eBPF programs easier</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-5f9e11a6923b54f21057d837506b9990">bpftrace</a></li>


    
  
    
    
	
<li>2: <a href="#pg-593e25d400352b1b019a0a3a839e7cdb">BCC</a></li>


    
  
    
    
	
<li>3: <a href="#pg-b4551197eff5fbdde9f1f1576dc49c24">BPFTool</a></li>


    
  
    
    
	
<li>4: <a href="#pg-77ec8433956d6a9f2c325fa29eb7ae4d">Tail call</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5f9e11a6923b54f21057d837506b9990">1 - bpftrace</h1>
    <div class="lead">DTrace style one liners for quick ad hoc tracing of kernel and user processes.</div>
	<p>bpftrace is a powerful, high-level tracing language for Linux that simplifies the process of creating eBPF (Extended Berkeley Packet Filter) programs. It simplifies the process of instrumenting kernel and user-space code by providing a simple language to attach probes to kernel functions, tracepoints, and user-defined events in a user-friendly syntax, inspired by awk, C, and other tracing tools, enabling users to quickly gain insights into system behavior. By abstracting away the complexities of low-level eBPF programming and leveraging libbpf as its backend, bpftrace allows system administrators, performance engineers, and developers to easily observe and analyze system performance without requiring extensive eBPF expertise. Let&rsquo;s start by looking at the bpftrace command.</p>
<h2 id="bpftrace-options">bpftrace Options<a class="td-heading-self-link" href="#bpftrace-options" aria-label="Heading self-link"></a></h2>
<p>When running bpftrace, you can use various command-line options to control its behavior. Some commonly used options include:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>    -B MODE        output buffering mode <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;full&#39;</span>, <span style="color:#4e9a06">&#39;none&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -f FORMAT      output format <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;text&#39;</span>, <span style="color:#4e9a06">&#39;json&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -o file        redirect bpftrace output to file
</span></span><span style="display:flex;"><span>    -e <span style="color:#4e9a06">&#39;program&#39;</span>   execute this program
</span></span><span style="display:flex;"><span>    -h, --help     show this <span style="color:#204a87">help</span> message
</span></span><span style="display:flex;"><span>    -I DIR         add the directory to the include search path
</span></span><span style="display:flex;"><span>    --include FILE add an <span style="color:#8f5902;font-style:italic">#include file before preprocessing</span>
</span></span><span style="display:flex;"><span>    -l <span style="color:#ce5c00;font-weight:bold">[</span>search<span style="color:#000;font-weight:bold">|</span>filename<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                   list kernel probes or probes in a program
</span></span><span style="display:flex;"><span>    -p PID         <span style="color:#204a87">enable</span> USDT probes on PID
</span></span><span style="display:flex;"><span>    -c <span style="color:#4e9a06">&#39;CMD&#39;</span>       run CMD and <span style="color:#204a87">enable</span> USDT probes on resulting process
</span></span><span style="display:flex;"><span>    --usdt-file-activation
</span></span><span style="display:flex;"><span>                   activate usdt semaphores based on file path
</span></span><span style="display:flex;"><span>    --unsafe       allow unsafe/destructive functionality
</span></span><span style="display:flex;"><span>    -q             keep messages quiet
</span></span><span style="display:flex;"><span>    --info         Print information about kernel BPF support
</span></span><span style="display:flex;"><span>    -k             emit a warning when a bpf helper returns an error <span style="color:#ce5c00;font-weight:bold">(</span>except <span style="color:#204a87">read</span> functions<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -kk            check all bpf helper functions
</span></span><span style="display:flex;"><span>    -V, --version  bpftrace version
</span></span><span style="display:flex;"><span>    --no-warnings  disable all warning messages
</span></span></code></pre></div><p>For example, we can use <code>-l</code> along with <code>*</code> for wildcard for listing such as listing all kprobes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;kprobe:*&#39;</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kprobe:zswap_store
</span></span><span style="display:flex;"><span>kprobe:zswap_swapoff
</span></span><span style="display:flex;"><span>kprobe:zswap_swapon
</span></span><span style="display:flex;"><span>kprobe:zswap_total_pages
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_entry
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_show
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_write
</span></span><span style="display:flex;"><span>kprobe:zswap_zpool_param_set
</span></span></code></pre></div><p>We can list probe parameters for a certain function using</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -lv <span style="color:#4e9a06">&#39;fentry:tcp_reset&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fentry:vmlinux:tcp_reset
</span></span><span style="display:flex;"><span>    struct sock * sk
</span></span><span style="display:flex;"><span>    struct sk_buff * skb
</span></span></code></pre></div><p>We can list all symbols from object or binary files for uprobe such as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;uprobe:/bin/bash:*&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:async_redirect_stdin
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:base_pathname
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_add_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_brace_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_clear_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_default_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_histent
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_history_range
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_last_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_dequote_text
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Using <code>-e</code> can be used to execute a program in one-liner. For example,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;shell_execve called\n&#34;); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span></code></pre></div><p>This program <code>uprobe:/bin/bash:shell_execve { printf(&quot;shell_execve called\n&quot;); }</code> means this action <code>printf(&quot;shell_execve called\n&quot;);</code> will be executed when <code>uprobe:/bin/bash:shell_execve</code> get triggered.</p>
<p>If we want to print out which command is being executed is by printing the first argument with <code>arg0</code> using <code>str</code> function which reads a NULL terminated string similar to <code>bpf_probe_read_str</code> helper function. <code>argN</code> is a bpf builtins while hold arguments passed to the function being traced and it can be used with kprobe and uprobe.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;command:%s\n&#34;, str(arg0)); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>command:/usr/bin/ls
</span></span><span style="display:flex;"><span>command:/usr/bin/ping
</span></span><span style="display:flex;"><span>command:/usr/bin/cat
</span></span></code></pre></div><p>The following table is from the bpftrace manual, listing special variables along with their corresponding helper functions and descriptions.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Kernel</th>
<th>BPF Helper</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$1</code>, <code>$2</code>, <code>...$n</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>The nth positional parameter passed to the bpftrace program. If less than n parameters are passed this evaluates to <code>0</code>. For string arguments use the <code>str()</code> call to retrieve the value.</td>
</tr>
<tr>
<td><code>$#</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>Total amount of positional parameters passed.</td>
</tr>
<tr>
<td><code>arg0</code>, <code>arg1</code>, <code>...argn</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>nth argument passed to the function being traced. These are extracted from the CPU registers. The amount of args passed in registers depends on the CPU architecture. (kprobes, uprobes, usdt).</td>
</tr>
<tr>
<td><code>args</code></td>
<td>struct args</td>
<td>n/a</td>
<td>n/a</td>
<td>The struct of all arguments of the traced function. Available in <code>tracepoint</code>, <code>fentry</code>, <code>fexit</code>, and <code>uprobe</code> (with DWARF) probes. Use <code>args.x</code> to access argument <code>x</code> or <code>args</code> to get a record with all arguments.</td>
</tr>
<tr>
<td><code>cgroup</code></td>
<td>uint64</td>
<td>4.18</td>
<td>get_current_cgroup_id</td>
<td>ID of the cgroup the current process belongs to. Only works with cgroupv2.</td>
</tr>
<tr>
<td><code>comm</code></td>
<td>string[16]</td>
<td>4.2</td>
<td>get_current_comm</td>
<td>Name of the current thread.</td>
</tr>
<tr>
<td><code>cpid</code></td>
<td>uint32</td>
<td>n/a</td>
<td>n/a</td>
<td>Child process ID, if bpftrace is invoked with <code>-c</code>.</td>
</tr>
<tr>
<td><code>cpu</code></td>
<td>uint32</td>
<td>4.1</td>
<td>raw_smp_processor_id</td>
<td>ID of the processor executing the BPF program.</td>
</tr>
<tr>
<td><code>curtask</code></td>
<td>uint64</td>
<td>4.8</td>
<td>get_current_task</td>
<td>Pointer to <code>struct task_struct</code> of the current task.</td>
</tr>
<tr>
<td><code>elapsed</code></td>
<td>uint64</td>
<td>(see nsec)</td>
<td>ktime_get_ns / ktime_get_boot_ns</td>
<td>Nanoseconds elapsed since bpftrace initialization, based on <code>nsecs</code>.</td>
</tr>
<tr>
<td><code>func</code></td>
<td>string</td>
<td>n/a</td>
<td>n/a</td>
<td>Name of the current function being traced (kprobes, uprobes).</td>
</tr>
<tr>
<td><code>gid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>Group ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>jiffies</code></td>
<td>uint64</td>
<td>5.9</td>
<td>get_jiffies_64</td>
<td>Jiffies of the kernel. In 32-bit systems, using this builtin might be slower.</td>
</tr>
<tr>
<td><code>numaid</code></td>
<td>uint32</td>
<td>5.8</td>
<td>numa_node_id</td>
<td>ID of the NUMA node executing the BPF program.</td>
</tr>
<tr>
<td><code>pid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Process ID of the current thread (aka thread group ID), as seen from the init namespace.</td>
</tr>
<tr>
<td><code>probe</code></td>
<td>string</td>
<td>n/na</td>
<td>n/a</td>
<td>Name of the current probe.</td>
</tr>
<tr>
<td><code>rand</code></td>
<td>uint32</td>
<td>4.1</td>
<td>get_prandom_u32</td>
<td>Random number.</td>
</tr>
<tr>
<td><code>return</code></td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>The return keyword is used to exit the current probe. This differs from exit() in that it doesn&rsquo;t exit bpftrace.</td>
</tr>
<tr>
<td><code>retval</code></td>
<td>uint64</td>
<td>n/a</td>
<td>n/a</td>
<td>Value returned by the function being traced (kretprobe, uretprobe, fexit). For kretprobe and uretprobe, its type is <code>uint64</code>, but for fexit it depends. You can look up the type using <code>bpftrace -lv</code>.</td>
</tr>
<tr>
<td><code>tid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Thread ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>uid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>User ID of the current thread, as seen from the init namespace.</td>
</tr>
</tbody>
</table>
<p>The following table is from the bpftrace manual, listing bpftrace functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bswap</td>
<td>Reverse byte order</td>
</tr>
<tr>
<td>buf</td>
<td>Returns a hex-formatted string of the data pointed to by d</td>
</tr>
<tr>
<td>cat</td>
<td>Print file content</td>
</tr>
<tr>
<td>cgroupid</td>
<td>Resolve cgroup ID</td>
</tr>
<tr>
<td>cgroup_path</td>
<td>Convert cgroup id to cgroup path</td>
</tr>
<tr>
<td>exit</td>
<td>Quit bpftrace with an optional exit code</td>
</tr>
<tr>
<td>join</td>
<td>Print the array</td>
</tr>
<tr>
<td>kaddr</td>
<td>Resolve kernel symbol name</td>
</tr>
<tr>
<td>kptr</td>
<td>Annotate as kernelspace pointer</td>
</tr>
<tr>
<td>kstack</td>
<td>Kernel stack trace</td>
</tr>
<tr>
<td>ksym</td>
<td>Resolve kernel address</td>
</tr>
<tr>
<td>len</td>
<td>Count ustack/kstack frames</td>
</tr>
<tr>
<td>macaddr</td>
<td>Convert MAC address data</td>
</tr>
<tr>
<td>nsecs</td>
<td>Timestamps and Time Deltas</td>
</tr>
<tr>
<td>ntop</td>
<td>Convert IP address data to text</td>
</tr>
<tr>
<td>offsetof</td>
<td>Offset of element in structure</td>
</tr>
<tr>
<td>override</td>
<td>Override return value</td>
</tr>
<tr>
<td>path</td>
<td>Return full path</td>
</tr>
<tr>
<td>percpu_kaddr</td>
<td>Resolve percpu kernel symbol name</td>
</tr>
<tr>
<td>print</td>
<td>Print a non-map value with default formatting</td>
</tr>
<tr>
<td>printf</td>
<td>Print formatted</td>
</tr>
<tr>
<td>pton</td>
<td>Convert text IP address to byte array</td>
</tr>
<tr>
<td>reg</td>
<td>Returns the value stored in the named register</td>
</tr>
<tr>
<td>signal</td>
<td>Send a signal to the current process</td>
</tr>
<tr>
<td>sizeof</td>
<td>Return size of a type or expression</td>
</tr>
<tr>
<td>skboutput</td>
<td>Write skb &rsquo;s data section into a PCAP file</td>
</tr>
<tr>
<td>str</td>
<td>Returns the string pointed to by s</td>
</tr>
<tr>
<td>strcontains</td>
<td>Compares whether the string haystack contains the string needle.</td>
</tr>
<tr>
<td>strerror</td>
<td>Get error message for errno code</td>
</tr>
<tr>
<td>strftime</td>
<td>Return a formatted timestamp</td>
</tr>
<tr>
<td>strncmp</td>
<td>Compare first n characters of two strings</td>
</tr>
<tr>
<td>system</td>
<td>Execute shell command</td>
</tr>
<tr>
<td>time</td>
<td>Print formatted time</td>
</tr>
<tr>
<td>uaddr</td>
<td>Resolve user-level symbol name</td>
</tr>
<tr>
<td>uptr</td>
<td>Annotate as userspace pointer</td>
</tr>
<tr>
<td>ustack</td>
<td>User stack trace</td>
</tr>
<tr>
<td>usym</td>
<td>Resolve user space address</td>
</tr>
</tbody>
</table>
<h2 id="how-to-code-in-bpftrace">How to Code in bpftrace<a class="td-heading-self-link" href="#how-to-code-in-bpftrace" aria-label="Heading self-link"></a></h2>
<p>bpftrace scripts are written using a custom domain-specific language (DSL) that is similar in syntax to awk. A basic script consists of one or more probe definitions followed by one or more actions. Each probe targets a specific event (e.g., kernel tracepoints, function entry/exit, or user-space events).</p>
<p>The following table is from the bpftrace manual, listing bpftrace probes along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Probe Name</th>
<th>Short Name</th>
<th>Description</th>
<th>Kernel/User Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>BEGIN/END</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>self</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>hardware</td>
<td><code>h</code></td>
<td>Processor-level events</td>
<td>Kernel</td>
</tr>
<tr>
<td>interval</td>
<td><code>i</code></td>
<td>Timed output</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>iter</td>
<td><code>it</code></td>
<td>Iterators tracing</td>
<td>Kernel</td>
</tr>
<tr>
<td>fentry/fexit</td>
<td><code>f</code>/<code>fr</code></td>
<td>Kernel functions tracing with BTF support</td>
<td>Kernel</td>
</tr>
<tr>
<td>kprobe/kretprobe</td>
<td><code>k</code>/<code>kr</code></td>
<td>Kernel function start/return</td>
<td>Kernel</td>
</tr>
<tr>
<td>profile</td>
<td><code>p</code></td>
<td>Timed sampling</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>rawtracepoint</td>
<td><code>rt</code></td>
<td>Kernel static tracepoints with raw arguments</td>
<td>Kernel</td>
</tr>
<tr>
<td>software</td>
<td><code>s</code></td>
<td>Kernel software events</td>
<td>Kernel</td>
</tr>
<tr>
<td>tracepoint</td>
<td><code>t</code></td>
<td>Kernel static tracepoints</td>
<td>Kernel</td>
</tr>
<tr>
<td>uprobe/uretprobe</td>
<td><code>u</code>/<code>ur</code></td>
<td>User-level function start/return</td>
<td>User</td>
</tr>
<tr>
<td>usdt</td>
<td><code>U</code></td>
<td>User-level static tracepoints</td>
<td>User</td>
</tr>
<tr>
<td>watchpoint/asyncwatchpoint</td>
<td><code>w</code>/<code>aw</code></td>
<td>Memory watchpoints</td>
<td>Kernel</td>
</tr>
</tbody>
</table>
<h3 id="basic-structure-of-a-bpftrace-script">Basic Structure of a bpftrace Script<a class="td-heading-self-link" href="#basic-structure-of-a-bpftrace-script" aria-label="Heading self-link"></a></h3>
<pre tabindex="0"><code class="language-bpftrace" data-lang="bpftrace">probe_type:probe_identifier
{
    // Action code block
    printf(&#34;Hello, world!\n&#34;);
}
</code></pre><p>For example, to print a message every time a process calls the <code>unlinkat()</code> syscall, you might write:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unlinkat syscall invoked</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>sys_enter_unlinkat</code> tracepoint&rsquo;s arguments can be listed from <code>/sys/kernel/debug/tracing/events/syscalls/sys_enter_unlinkat/format</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>name: sys_enter_unlinkat
</span></span><span style="display:flex;"><span>ID: <span style="color:#0000cf;font-weight:bold">849</span>
</span></span><span style="display:flex;"><span>format:
</span></span><span style="display:flex;"><span>	field:unsigned short common_type<span style="color:#000;font-weight:bold">;</span>	offset:0<span style="color:#000;font-weight:bold">;</span>	size:2<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_flags<span style="color:#000;font-weight:bold">;</span>	offset:2<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_preempt_count<span style="color:#000;font-weight:bold">;</span>	offset:3<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int common_pid<span style="color:#000;font-weight:bold">;</span>	offset:4<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	field:int __syscall_nr<span style="color:#000;font-weight:bold">;</span>	offset:8<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int dfd<span style="color:#000;font-weight:bold">;</span>	offset:16<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:const char * pathname<span style="color:#000;font-weight:bold">;</span>	offset:24<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int flag<span style="color:#000;font-weight:bold">;</span>	offset:32<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print fmt: <span style="color:#4e9a06">&#34;dfd: 0x%08lx, pathname: 0x%08lx, flag: 0x%08lx&#34;</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;dfd<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;pathname<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;flag<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>Therefore, we can use <code>str(args.pathname)</code> to extract the name of the file being deleted. <code>args</code> is one of the bpftrace builtins which is a data struct of all arguments of the traced function and it can be used with tracepoint, fentry, fexit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process %s (PID: %d) is deleting a file %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2269<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test1
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2270<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test2
</span></span></code></pre></div><p>Let&rsquo;s convert this eBPF kernel code to bpftrace</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Type of BPF map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// Maximum number of entries in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                            <span style="color:#8f5902;font-style:italic">// Type of the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                          <span style="color:#8f5902;font-style:italic">// Type of the value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Dual BSD/GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s build the same code without Maps as it will be explained shortly</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">kprobe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">do_mkdirat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, mode: %d, filename: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">arg2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(((</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">arg1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The idea is to cast <code>arg1</code> to a pointer to <code>struct filename</code> before accessing <code>name</code> field.</p>
<h2 id="bpftrace-maps">bpftrace Maps<a class="td-heading-self-link" href="#bpftrace-maps" aria-label="Heading self-link"></a></h2>
<p>Maps in bpftrace are defined with <code>@</code> such as <code>@testmap</code>. The following table is from bpftrace manual, listing bpftrace map functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>avg</td>
<td>Calculate the running average of <code>n</code> between consecutive calls.</td>
</tr>
<tr>
<td>clear</td>
<td>Clear all keys/values from a map.</td>
</tr>
<tr>
<td>count</td>
<td>Count how often this function is called.</td>
</tr>
<tr>
<td>delete</td>
<td>Delete a single key from a map.</td>
</tr>
<tr>
<td>has_key</td>
<td>Return true (1) if the key exists in this map. Otherwise return false (0).</td>
</tr>
<tr>
<td>hist</td>
<td>Create a log2 histogram of n using buckets per power of 2, 0 &lt;= k &lt;= 5, defaults to 0.</td>
</tr>
<tr>
<td>len</td>
<td>Return the number of elements in a map.</td>
</tr>
<tr>
<td>lhist</td>
<td>Create a linear histogram of n. lhist creates M ((max - min) / step) buckets in the range [min, max) where each bucket is step in size.</td>
</tr>
<tr>
<td>max</td>
<td>Update the map with n if n is bigger than the current value held.</td>
</tr>
<tr>
<td>min</td>
<td>Update the map with n if n is smaller than the current value held.</td>
</tr>
<tr>
<td>stats</td>
<td>Combines the count, avg and sum calls into one.</td>
</tr>
<tr>
<td>sum</td>
<td>Calculate the sum of all n passed.</td>
</tr>
<tr>
<td>zero</td>
<td>Set all values for all keys to zero.</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">forks</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">setuid</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_fork&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_fork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_setuid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_setuid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priv</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">priv</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Let&rsquo;s see the previous code in bpftrace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace         
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_fork</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_setuid</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_execve</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Define a map with name <code>forks</code> and add current<code>pid</code> as key and <code>1</code> as value if <code>sys_enter_setuid</code> tracepoint is triggered.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Define a map with name <code>setuid</code> and add current <code>pid</code> as key and <code>1</code> as value if <code>sys_enter_fork</code> tracepoint is triggered and UID is zero.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>If <code>sys_enter_execve</code> is triggered, hen it will check if the current <code>pid</code> triggered by <code>sys_enter_setuid</code> and <code>sys_enter_fork</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>signal</code> function is equivalent to <code>bpf_send_signal</code> helper function to terminate the process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We have to run this code with <code>--unsafe</code> because we running dangerous function which is <code>signal</code>, then to run it <code>sudo bpftrace --unsafe priv-esc.bt</code>.
This code is much smaller and simpler than eBPF kernel code, and no need for user-space code.</p>
<p>The next script attaches probes to the <code>sys_enter_read</code> and <code>sys_enter_write</code> syscalls (separated with comma <code>,</code>) and uses a map to count the number of system calls per process using <code>count()</code> map function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_read</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_write</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will activate every 5 seconds (using interval probe) to clear the screen using ANSI escape sequences <code>printf(&quot;\033[H\033[2J&quot;);</code>, then print the content of <code>syscalls</code> map.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-timesyn<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-journal<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>rtkit-daemon<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sudo<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gnome-shell<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">13</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gvfsd-wsdd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bash<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>ls<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bpftrace<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sshd-session<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">818</span>
</span></span></code></pre></div><h2 id="bpftrace-tools">bpftrace Tools<a class="td-heading-self-link" href="#bpftrace-tools" aria-label="Heading self-link"></a></h2>
<p>The following tools from bpftrace github repository. They cover a wide range of functions from tracing I/O and network events to monitoring process and syscall activity.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bashreadline.bt</td>
<td>Print entered bash commands system wide. Examples.</td>
</tr>
<tr>
<td>biolatency.bt</td>
<td>Block I/O latency as a histogram. Examples.</td>
</tr>
<tr>
<td>biosnoop.bt</td>
<td>Block I/O tracing tool, showing per I/O latency. Examples.</td>
</tr>
<tr>
<td>biostacks.bt</td>
<td>Show disk I/O latency with initialization stacks. Examples.</td>
</tr>
<tr>
<td>bitesize.bt</td>
<td>Show disk I/O size as a histogram. Examples.</td>
</tr>
<tr>
<td>capable.bt</td>
<td>Trace security capability checks. Examples.</td>
</tr>
<tr>
<td>cpuwalk.bt</td>
<td>Sample which CPUs are executing processes. Examples.</td>
</tr>
<tr>
<td>dcsnoop.bt</td>
<td>Trace directory entry cache (dcache) lookups. Examples.</td>
</tr>
<tr>
<td>execsnoop.bt</td>
<td>Trace new processes via exec() syscalls. Examples.</td>
</tr>
<tr>
<td>gethostlatency.bt</td>
<td>Show latency for getaddrinfo/gethostbyname[2] calls. Examples.</td>
</tr>
<tr>
<td>killsnoop.bt</td>
<td>Trace signals issued by the kill() syscall. Examples.</td>
</tr>
<tr>
<td>loads.bt</td>
<td>Print load averages. Examples.</td>
</tr>
<tr>
<td>mdflush.bt</td>
<td>Trace md flush events. Examples.</td>
</tr>
<tr>
<td>naptime.bt</td>
<td>Show voluntary sleep calls. Examples.</td>
</tr>
<tr>
<td>opensnoop.bt</td>
<td>Trace open() syscalls showing filenames. Examples.</td>
</tr>
<tr>
<td>oomkill.bt</td>
<td>Trace OOM killer. Examples.</td>
</tr>
<tr>
<td>pidpersec.bt</td>
<td>Count new processes (via fork). Examples.</td>
</tr>
<tr>
<td>runqlat.bt</td>
<td>CPU scheduler run queue latency as a histogram. Examples.</td>
</tr>
<tr>
<td>runqlen.bt</td>
<td>CPU scheduler run queue length as a histogram. Examples.</td>
</tr>
<tr>
<td>setuids.bt</td>
<td>Trace the setuid syscalls: privilege escalation. Examples.</td>
</tr>
<tr>
<td>ssllatency.bt</td>
<td>Summarize SSL/TLS handshake latency as a histogram. Examples.</td>
</tr>
<tr>
<td>sslsnoop.bt</td>
<td>Trace SSL/TLS handshake, showing latency and return value. Examples.</td>
</tr>
<tr>
<td>statsnoop.bt</td>
<td>Trace stat() syscalls for general debugging. Examples.</td>
</tr>
<tr>
<td>swapin.bt</td>
<td>Show swapins by process. Examples.</td>
</tr>
<tr>
<td>syncsnoop.bt</td>
<td>Trace sync() variety of syscalls. Examples.</td>
</tr>
<tr>
<td>syscount.bt</td>
<td>Count system calls. Examples.</td>
</tr>
<tr>
<td>tcpaccept.bt</td>
<td>Trace TCP passive connections (accept()). Examples.</td>
</tr>
<tr>
<td>tcpconnect.bt</td>
<td>Trace TCP active connections (connect()). Examples.</td>
</tr>
<tr>
<td>tcpdrop.bt</td>
<td>Trace kernel-based TCP packet drops with details. Examples.</td>
</tr>
<tr>
<td>tcplife.bt</td>
<td>Trace TCP session lifespans with connection details. Examples.</td>
</tr>
<tr>
<td>tcpretrans.bt</td>
<td>Trace TCP retransmits. Examples.</td>
</tr>
<tr>
<td>tcpsynbl.bt</td>
<td>Show TCP SYN backlog as a histogram. Examples.</td>
</tr>
<tr>
<td>threadsnoop.bt</td>
<td>List new thread creation. Examples.</td>
</tr>
<tr>
<td>undump.bt</td>
<td>Capture UNIX domain socket packages. Examples.</td>
</tr>
<tr>
<td>vfscount.bt</td>
<td>Count VFS calls. Examples.</td>
</tr>
<tr>
<td>vfsstat.bt</td>
<td>Count some VFS calls, with per-second summaries. Examples.</td>
</tr>
<tr>
<td>writeback.bt</td>
<td>Trace file system writeback events with details. Examples.</td>
</tr>
<tr>
<td>xfsdist.bt</td>
<td>Summarize XFS operation latency distribution as a histogram. Examples.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-593e25d400352b1b019a0a3a839e7cdb">2 - BCC</h1>
    <div class="lead">BPF Compiler Collection a Python and Lua toolkit that wraps Clang so you can embed small eBPF snippets in scripts and run them with just a few lines of loader code.</div>
	<p>BCC in short  is a toolkit that makes eBPF development easier by providing a higher-level interface. It compiles your eBPF C code at runtime to match the target kernel’s data structures. BCC works with languages like Python, Lua, and C++, and includes helpful macros and shortcuts for simpler programming. Essentially, BCC takes your eBPF program as a C string, preprocesses it, and then compiles it using clang.</p>
<p>The following is a crash course on BCC. I strongly recommend reading the BCC manual as well—it’s incredibly detailed and covers topics that are too extensive for this chapter.</p>
<h2 id="probes-definition">Probes Definition<a class="td-heading-self-link" href="#probes-definition" aria-label="Heading self-link"></a></h2>
<ol>
<li>kprobe: <code>kprobe__</code> followed by the name of kernel function name. For example, int kprobe__do_mkdirat(struct pt_regs *ctx). struct pt_regs *ctx as a context for kprobe. Arguments can be extracted using PT_REGS_PARM1(ctx), PT_REGS_PARM2(ctx), &hellip; macros.</li>
<li>kretprobe: <code>kretprobe__</code> followed by the name of kernel function name. For example, <code>int kretprobe__do_mkdirat(struct pt_regs *ctx)</code>. Return value can be extracted using <code>PT_REGS_RC(ctx)</code> macro.</li>
<li>uprobes: Can be declared as regular C function. For example, <code>int function(struct pt_regs *ctx)</code>. Arguments can be extracted using PT_REGS_PARM1(ctx), PT_REGS_PARM2(ctx), &hellip; macros.</li>
<li>uretprobes: Can be declared as regular C function<code>int function(struct pt_regs *ctx)</code>. Return value can be extracted using <code>PT_REGS_RC(ctx)</code> macro.</li>
<li>Tracepoints: <code>TRACEPOINT_PROBE</code> followed by <code>(category, event)</code> . For example,  <code>TRACEPOINT_PROBE(sched,sched_process_exit)</code>. Arguments are available in an <code>args</code> struct and you can list of argument from the <code>format</code> file. Foe example, <code>args-&gt;pathname</code> in case of <code>TRACEPOINT_PROBE(syscalls, sys_enter_unlinkat)</code>.</li>
<li>Raw Tracepoints: <code>RAW_TRACEPOINT_PROBE(event)</code>.<br>
For example, <code>RAW_TRACEPOINT_PROBE(sys_enter)</code>. As stated before, raw tracepoint uses <code>bpf_raw_tracepoint_args</code> as context and it has args as <code>args[0]</code> -&gt; points to <code>pt_regs</code> structure and <code>args[1]</code> is the syscall number. To access the target functions&rsquo; parameters, you can either cast <code>ctx-&gt;args[0]</code> to a pointer to a <code>struct pt_regs</code> and use it directly, or copy its contents into a local variable of type <code>struct pt_regs</code> (e.g., <code>struct pt_regs regs;</code>). Then, you can extract the syscall parameters using the <code>PT_REGS_PARM</code> macros (such as <code>PT_REGS_PARM1</code>, <code>PT_REGS_PARM2</code>, etc.).</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Copy the pt_regs structure from the raw tracepoint args.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_probe_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Get the second parameter (pathname) from the registers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pathname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">regs</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><ol start="7">
<li>LSM: <code>LSM_PROBE(hook_name,typeof(arg1), typeof(arg1)...)</code>. For example, to prevent creating a new directory:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">LSM_PROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path_mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dentry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dentry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_trace_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LSM path_mkdir: mode=%d, ret=%d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="data-handling">Data handling<a class="td-heading-self-link" href="#data-handling" aria-label="Heading self-link"></a></h2>
<ol>
<li><strong>bpf_probe_read_kernel</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_kernel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_kernel</code> is used for copying arbitrary data (e.g., structures, buffers) from kernel space and returns 0 on success.</p>
<ol start="2">
<li><strong>bpf_probe_read_kernel_str</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_kernel_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_kernel_str</code> is used for reading null-terminated strings from kernel space and returns the length of the string including the trailing NULL on success.</p>
<ol start="3">
<li><strong>bpf_probe_read_user</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_user</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>bpf_probe_read_user</code> is used for copying arbitrary data (e.g., structures, buffers) from user space and returns 0 on success.</p>
<ol start="4">
<li><strong>bpf_probe_read_user_str</strong> helper function with the following prototype:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>  
</span></span></code></pre></div><p><code>bpf_probe_read_user_str</code> is used for reading null-terminated strings from user space and returns the length of the string including the trailing NULL on success.</p>
<ol start="5">
<li><strong>bpf_ktime_get_ns</strong>: returns <code>u64</code> time elapsed since system boot in nanoseconds.</li>
<li><strong>bpf_get_current_pid_tgid</strong>: returns <code>u64</code> current tgid and pid.</li>
<li><strong>bpf_get_current_uid_gid</strong>: returns <code>u64</code> current pid and gid.</li>
<li><strong>bpf_get_current_comm(void *buf, __u32 size_of_buf)</strong>:  copy current process name into pointer<code>buf</code> and sizeof at least 16 bytes.
For example:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">TASK_COMM_LEN</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// TASK_COMM_LEN = 16, defined in include/linux/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><ol start="9">
<li><code>bpf_get_current_task</code> helper function returns current task as a pointer to <code>struct task_struct</code>.</li>
</ol>
<h2 id="buffers">Buffers<a class="td-heading-self-link" href="#buffers" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF_PERF_OUTPUT(name)</code>: creates eBPF table to push data out to user-space using perf buffer.</li>
<li><code>perf_submit</code>: a method of a <code>BPF_PERF_OUTPUT</code> to submit data to user-space. <code>perf_submit</code> has the following prototype: <code>int perf_submit((void *)ctx, (void *)data, u32 data_size)</code>.</li>
<li><code>BPF_RINGBUF_OUTPUT</code>:  creates eBPF table to push data out to user-space using ring buffer. It has the following prototype <code>BPF_RINGBUF_OUTPUT(name, page_cnt)</code>, <code>page_cnt</code> is number of memory pages for ring buffer size.</li>
<li><code>ringbuf_output</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to submit data to user-space.<code>ringbuf_output</code> has the following prototype: <code>int ringbuf_output((void *)data, u64 data_size, u64 flags)</code>.</li>
<li><code>ringbuf_reserve</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to reserve a space in ring buffer and allocate data structure pointer for output data. It has the following prototype: <code>void* ringbuf_reserve(u64 data_size)</code>.</li>
<li><code>ringbuf_submit</code>: a method of the <code>BPF_RINGBUF_OUTPUT</code> to submit data to user-space. <code>ringbuf_submit</code> has the following prototype: <code>void ringbuf_submit((void *)data, u64 flags)</code>.</li>
</ol>
<h2 id="maps">Maps<a class="td-heading-self-link" href="#maps" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF_HASH</code>: creates hash map. For example, <code>BPF_HASH(my_hash, u64, u64);</code>.</li>
<li><code>BPF_ARRAY</code>: creates array map.</li>
</ol>
<p>BCC has also <code>BPF_HISTOGRAM</code>, <code>BPF_STACK_TRACE</code>, <code>BPF_PERF_ARRAY</code>, <code>BPF_PERCPU_HASH</code>, <code>BPF_PERCPU_ARRAY</code>, <code>BPF_LPM_TRIE</code>,<code>BPF_PROG_ARRAY</code>, <code>BPF_CPUMAP</code>, <code>BPF_ARRAY_OF_MAPS</code> and <code>BPF_HASH_OF_MAPS</code>.</p>
<h2 id="map-operations">Map Operations<a class="td-heading-self-link" href="#map-operations" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>*val map.lookup(&amp;key)</code>: return a pointer to value if exists.</li>
<li><code>map.delete(&amp;key)</code>: delete a key from map.</li>
<li><code>map.update(&amp;key, &amp;val)</code>: updates value for a given key.</li>
<li><code>map.insert(&amp;key, &amp;val)</code>: inserts a value for a given key.</li>
<li><code>map.increment(key[, increment_amount])</code>: increments the key by <code>increment_amount</code>.</li>
</ol>
<h2 id="bcc-python">BCC Python<a class="td-heading-self-link" href="#bcc-python" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF(text=prog)</code>: creates eBPF object.</li>
<li><code>BPF.attach_kprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: attach a probe into kernel function <code>event</code> and use <code>name</code> as kprobe handler.</li>
<li><code>BPF.attach_kretprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_kprobe</code>.</li>
<li><code>BPF.attach_tracepoint(tp=&quot;tracepoint&quot;, fn_name=&quot;name&quot;)</code>: attach a probe into <code>tracepoint</code> and use <code>name</code> as tracepoint handler.</li>
<li><code>BPF.attach_uprobe(name=&quot;location&quot;, sym=&quot;symbol&quot;, fn_name=&quot;name&quot;)</code>: attach a probe to<code>location</code> with <code>symbol</code>use <code>name</code> as uprobe handler. For example,</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">attach_uprobe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sym</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;shell_execve&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fn_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;bash_exec&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Attach a probe to <code>shell_execve</code> symbol in binary or object file<code>/bin/bash</code>and use <code>bash_exec</code> as a handler.</p>
<ol start="6">
<li><code>BPF.attach_uretprobe(name=&quot;location&quot;, sym=&quot;symbol&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_uprobe</code>.</li>
<li><code>BPF.attach_raw_tracepoint(tp=&quot;tracepoint&quot;, fn_name=&quot;name&quot;)</code>: the same as <code>attach_tracepoint</code>.</li>
<li><code>BPF.attach_xdp(dev=&quot;device&quot;, fn=b.load_func(&quot;fn_name&quot;,BPF.XDP), flags)</code>: attach XDP to <code>device</code>, use <code>fn_name</code> as handler for each ingress packet. Flags are defined in <code>include/uapi/linux/if_link.h</code> as the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_UPDATE_IF_NOEXIST</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">//--&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_SKB_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_DRV_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">#</span><span style="color:#000">define</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XDP_FLAGS_HW_MODE</span><span style="color:#f8f8f8;text-decoration:underline">		</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">1U</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">3</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>XDP_FLAGS_UPDATE_IF_NOEXIST	(1U &laquo; 0): This flag attaches the XDP program if there isn’t already one present.
XDP_FLAGS_SKB_MODE (1U &laquo; 1): This flag attaches the XDP program in generic mode.
XDP_FLAGS_DRV_MODE (1U &laquo; 2): This flag attaches the XDP program in native driver mode.
XDP_FLAGS_HW_MODE (1U &laquo; 3): This flag is used for offloading the XDP program to supported hardware (NICs that support XDP offload).</p>
<ol start="9">
<li><code>BPF.remove_xdp(&quot;device&quot;)</code>: removes XDP program from interface <code>device</code>.</li>
<li><code>BPF.detach_kprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: detach a kprobe.</li>
<li><code>BPF.detach_kretprobe(event=&quot;event&quot;, fn_name=&quot;name&quot;)</code>: detach a kretprobe.</li>
</ol>
<h2 id="output">Output<a class="td-heading-self-link" href="#output" aria-label="Heading self-link"></a></h2>
<ol>
<li><code>BPF.perf_buffer_poll(timeout=T)</code>: polls data from perf buffer.</li>
<li><code>BPF.ring_buffer_poll(timeout=T)</code>: polls data from ring buffer.</li>
<li><code>table.open_perf_buffer(callback, page_cnt=N, lost_cb=None)</code>: opens a perf ring buffer for <code>BPF_PERF_OUTPUT</code>.</li>
<li><code>table.open_ring_buffer(callback, ctx=None)</code>: opens a buffer ring for <code>BPF_RINGBUF_OUTPUT</code>.</li>
<li><code>BPF.trace_print</code>: reads from <code>/sys/kernel/debug/tracing/trace_pipe</code> and prints the contents.</li>
</ol>
<h2 id="examples">Examples<a class="td-heading-self-link" href="#examples" aria-label="Heading self-link"></a></h2>
<p>Let&rsquo;s look at example The following eBPF kernel code yo attack kprobe to <code>do_mkdirat</code> kernel function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">from</span> <span style="color:#000">bcc</span> <span style="color:#000">import</span> <span style="color:#000">BPF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;uapi/linux/ptrace.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/fs.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define MAX_FILENAME_LEN 256
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe__do_mkdirat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">MAX_FILENAME_LEN</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fname</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name_ptr</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_trace_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing mkdir calls... Hit Ctrl-C to exit.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trace_print</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>bpf_trace_printk</code> function is similar to <code>bpf_printk</code> macro. First, we create an eBPF object from the C code using <code>b = BPF(text=prog)</code>. We don&rsquo;t have to add <code>attach_kprobe</code> because we followed the naming convention of kprobe which is <code>kprobe__</code> followed by the name of kernel function name <code>kprobe__do_mkdirat</code>.
Run <code>sudo python3 bcc-mkdir.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>b<span style="color:#4e9a06">&#39;  mkdir-1706 [...] KPROBE ENTRY pid = 1706, filename = test1, mode = 511&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#4e9a06">&#39;  mkdir-1708 [...] KPROBE ENTRY pid = 1708, filename = test2, mode = 511&#39;</span>
</span></span></code></pre></div><p>We don&rsquo;t have to compile because BCC compiles eBPF C code at runtime and there is no need to write a separate user-space. If you notice, the previous code is exactly similar to the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">kprobe_mkdir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">pt_regs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">PT_REGS_PARM2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PT_REGS_PARM3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KPROBE ENTRY pid = %d, filename = %s, mode = %u</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s explore another example which uses Tracepoints with ring buffer map.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">from</span> <span style="color:#000">bcc</span> <span style="color:#000">import</span> <span style="color:#000">BPF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">BPF_RINGBUF_OUTPUT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">TRACEPOINT_PROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sys_enter_unlinkat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// In the tracepoint for unlinkat, the second argument (args-&gt;pathname) is the filename.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">def</span> <span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, COMM: %s, File: %s&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#000">utf</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#000">utf</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">open_ring_buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tracing unlinkat syscall... Hit Ctrl-C to end.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#f57900">True</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f57900">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ring_buffer_poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">except</span> <span style="color:#f57900">KeyboardInterrupt</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>The <code>print_event</code> callback function to the ring buffer which will be called every time an event is received from the ring buffer. <code>print_event</code> takes cpu number, pointer to raw data of the event data structure defined in eBPF code and size of the event data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cpu</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">):</span>
</span></span></code></pre></div><p>Then, event is defined automatically using BCC from eBPF data structure <code>event</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Then, printing out the contents of the event:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: </span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">, COMM: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">, File: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;utf-8&#39;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">event</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;utf-8&#39;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span></code></pre></div><p>Then,we create an eBPF object from the C code using <code>b = BPF(text=prog)</code>. Then, we opened the ring buffer associated with the map named <code>events</code> with callback function (<code>print_event</code>) to process data that is submitted to the ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">open_ring_buffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">print_event</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We don&rsquo;t need to use <code>BPF.attach_tracepoint</code> because we followed the naming convention for <code>tracepoints</code> which is <code>TRACEPOINT_PROBE(_category_, _event_)</code>. Finally, we start polling from the ring buffer with 100ms timeout.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ring_buffer_poll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 100ms timeout</span>
</span></span></code></pre></div><p>If you noticed, this code is similar to what we did in tracepoint.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__u32</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_RINGBUF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">events</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_unlinkat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_unlinkat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ringbuf_reserve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">events</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_get_current_comm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_user_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_ringbuf_submit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="bcc-tools">BCC Tools<a class="td-heading-self-link" href="#bcc-tools" aria-label="Heading self-link"></a></h2>
<p>The following tables are from the BCC GitHub repository. These tables contain useful tools for different aspects of system analysis, including general tracing and debugging, memory and process monitoring, performance and timing, CPU and scheduler statistics, network and socket monitoring, as well as storage and filesystems diagnostics. Each category offers a range of tools designed to help you quickly diagnose issues, tune performance, and gather insights into system behavior using BPF-based instrumentation.</p>
<h3 id="general">General<a class="td-heading-self-link" href="#general" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>argdist</td>
<td>Display function parameter values as a histogram or frequency count.</td>
</tr>
<tr>
<td>bashreadline</td>
<td>Print entered bash commands system wide.</td>
</tr>
<tr>
<td>bpflist</td>
<td>Display processes with active BPF programs and maps.</td>
</tr>
<tr>
<td>capable</td>
<td>Trace security capability checks.</td>
</tr>
<tr>
<td>compactsnoop</td>
<td>Trace compact zone events with PID and latency.</td>
</tr>
<tr>
<td>criticalstat</td>
<td>Trace and report long atomic critical sections in the kernel.</td>
</tr>
<tr>
<td>deadlock</td>
<td>Detect potential deadlocks on a running process.</td>
</tr>
<tr>
<td>drsnoop</td>
<td>Trace direct reclaim events with PID and latency.</td>
</tr>
<tr>
<td>funccount</td>
<td>Count kernel function calls.</td>
</tr>
<tr>
<td>inject</td>
<td>Targeted error injection with call chain and predicates.</td>
</tr>
<tr>
<td>klockstat</td>
<td>Traces kernel mutex lock events and displays lock statistics.</td>
</tr>
<tr>
<td>opensnoop</td>
<td>Trace open() syscalls.</td>
</tr>
<tr>
<td>readahead</td>
<td>Show performance of read-ahead cache.</td>
</tr>
<tr>
<td>reset-trace</td>
<td>Reset the state of tracing. Maintenance tool only.</td>
</tr>
<tr>
<td>stackcount</td>
<td>Count kernel function calls and their stack traces.</td>
</tr>
<tr>
<td>syncsnoop</td>
<td>Trace sync() syscall.</td>
</tr>
<tr>
<td>threadsnoop</td>
<td>List new thread creation.</td>
</tr>
<tr>
<td>tplist</td>
<td>Display kernel tracepoints or USDT probes and their formats.</td>
</tr>
<tr>
<td>trace</td>
<td>Trace arbitrary functions, with filters.</td>
</tr>
<tr>
<td>ttysnoop</td>
<td>Watch live output from a tty or pts device.</td>
</tr>
<tr>
<td>ucalls</td>
<td>Summarize method calls or Linux syscalls in high-level languages.</td>
</tr>
<tr>
<td>uflow</td>
<td>Print a method flow graph in high-level languages.</td>
</tr>
<tr>
<td>ugc</td>
<td>Trace garbage collection events in high-level languages.</td>
</tr>
<tr>
<td>uobjnew</td>
<td>Summarize object allocation events by object type and number of bytes allocated.</td>
</tr>
<tr>
<td>ustat</td>
<td>Collect events such as GCs, thread creations, object allocations, exceptions, etc.</td>
</tr>
<tr>
<td>uthreads</td>
<td>Trace thread creation events in Java and raw pthreads.</td>
</tr>
</tbody>
</table>
<h3 id="memory-and-process-tools">Memory and Process Tools<a class="td-heading-self-link" href="#memory-and-process-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>execsnoop</td>
<td>Trace new processes via exec() syscalls.</td>
</tr>
<tr>
<td>exitsnoop</td>
<td>Trace process termination (exit and fatal signals).</td>
</tr>
<tr>
<td>killsnoop</td>
<td>Trace signals issued by the kill() syscall.</td>
</tr>
<tr>
<td>kvmexit</td>
<td>Display the exit_reason and its statistics of each vm exit.</td>
</tr>
<tr>
<td>memleak</td>
<td>Display outstanding memory allocations to find memory leaks.</td>
</tr>
<tr>
<td>numasched</td>
<td>Track the migration of processes between NUMAs.</td>
</tr>
<tr>
<td>oomkill</td>
<td>Trace the out-of-memory (OOM) killer.</td>
</tr>
<tr>
<td>pidpersec</td>
<td>Count new processes (via fork).</td>
</tr>
<tr>
<td>rdmaucma</td>
<td>Trace RDMA Userspace Connection Manager Access events.</td>
</tr>
<tr>
<td>shmsnoop</td>
<td>Trace System V shared memory syscalls.</td>
</tr>
<tr>
<td>slabratetop</td>
<td>Kernel SLAB/SLUB memory cache allocation rate top.</td>
</tr>
</tbody>
</table>
<h3 id="performance-and-time-tools">Performance and Time Tools<a class="td-heading-self-link" href="#performance-and-time-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dbslower</td>
<td>Trace MySQL/PostgreSQL queries slower than a threshold.</td>
</tr>
<tr>
<td>dbstat</td>
<td>Summarize MySQL/PostgreSQL query latency as a histogram.</td>
</tr>
<tr>
<td>funcinterval</td>
<td>Time interval between the same function as a histogram.</td>
</tr>
<tr>
<td>funclatency</td>
<td>Time functions and show their latency distribution.</td>
</tr>
<tr>
<td>funcslower</td>
<td>Trace slow kernel or user function calls.</td>
</tr>
<tr>
<td>hardirqs</td>
<td>Measure hard IRQ (hard interrupt) event time.</td>
</tr>
<tr>
<td>mysqld_qslower</td>
<td>Trace MySQL server queries slower than a threshold.</td>
</tr>
<tr>
<td>ppchcalls</td>
<td>Summarize ppc hcall counts and latencies.</td>
</tr>
<tr>
<td>softirqs</td>
<td>Measure soft IRQ (soft interrupt) event time.</td>
</tr>
<tr>
<td>syscount</td>
<td>Summarize syscall counts and latencies.</td>
</tr>
</tbody>
</table>
<h3 id="cpu-and-scheduler-tools">CPU and Scheduler Tools<a class="td-heading-self-link" href="#cpu-and-scheduler-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpudist</td>
<td>Summarize on- and off-CPU time per task as a histogram.</td>
</tr>
<tr>
<td>cpuunclaimed</td>
<td>Sample CPU run queues and calculate unclaimed idle CPU.</td>
</tr>
<tr>
<td>llcstat</td>
<td>Summarize CPU cache references and misses by process.</td>
</tr>
<tr>
<td>offcputime</td>
<td>Summarize off-CPU time by kernel stack trace.</td>
</tr>
<tr>
<td>offwaketime</td>
<td>Summarize blocked time by kernel off-CPU stack and waker stack.</td>
</tr>
<tr>
<td>profile</td>
<td>Profile CPU usage by sampling stack traces at a timed interval.</td>
</tr>
<tr>
<td>runqlat</td>
<td>Run queue (scheduler) latency as a histogram.</td>
</tr>
<tr>
<td>runqlen</td>
<td>Run queue length as a histogram.</td>
</tr>
<tr>
<td>runqslower</td>
<td>Trace long process scheduling delays.</td>
</tr>
<tr>
<td>wakeuptime</td>
<td>Summarize sleep-to-wakeup time by waker kernel stack.</td>
</tr>
<tr>
<td>wqlat</td>
<td>Summarize work waiting latency on workqueue.</td>
</tr>
</tbody>
</table>
<h3 id="network-and-sockets-tools">Network and Sockets Tools<a class="td-heading-self-link" href="#network-and-sockets-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>gethostlatency</td>
<td>Show latency for getaddrinfo/gethostbyname[2] calls.</td>
</tr>
<tr>
<td>bindsnoop</td>
<td>Trace IPv4 and IPv6 bind() system calls (bind()).</td>
</tr>
<tr>
<td>netqtop</td>
<td>Trace and display packets distribution on NIC queues.</td>
</tr>
<tr>
<td>sofdsnoop</td>
<td>Trace FDs passed through unix sockets.</td>
</tr>
<tr>
<td>solisten</td>
<td>Trace TCP socket listen.</td>
</tr>
<tr>
<td>sslsniff</td>
<td>Sniff OpenSSL written and readed data.</td>
</tr>
<tr>
<td>tcpaccept</td>
<td>Trace TCP passive connections (accept()).</td>
</tr>
<tr>
<td>tcpconnect</td>
<td>Trace TCP active connections (connect()).</td>
</tr>
<tr>
<td>tcpconnlat</td>
<td>Trace TCP active connection latency (connect()).</td>
</tr>
<tr>
<td>tcpdrop</td>
<td>Trace kernel-based TCP packet drops with details.</td>
</tr>
<tr>
<td>tcplife</td>
<td>Trace TCP sessions and summarize lifespan.</td>
</tr>
<tr>
<td>tcpretrans</td>
<td>Trace TCP retransmits and TLPs.</td>
</tr>
<tr>
<td>tcprtt</td>
<td>Trace TCP round trip time.</td>
</tr>
<tr>
<td>tcpstates</td>
<td>Trace TCP session state changes with durations.</td>
</tr>
<tr>
<td>tcpsubnet</td>
<td>Summarize and aggregate TCP send by subnet.</td>
</tr>
<tr>
<td>tcpsynbl</td>
<td>Show TCP SYN backlog.</td>
</tr>
<tr>
<td>tcptop</td>
<td>Summarize TCP send/recv throughput by host. Top for TCP.</td>
</tr>
<tr>
<td>tcptracer</td>
<td>Trace TCP established connections (connect(), accept(), close()).</td>
</tr>
<tr>
<td>tcpcong</td>
<td>Trace TCP socket congestion control status duration.</td>
</tr>
</tbody>
</table>
<h3 id="storage-and-filesystems-tools">Storage and Filesystems Tools<a class="td-heading-self-link" href="#storage-and-filesystems-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bitesize</td>
<td>Show per process I/O size histogram.</td>
</tr>
<tr>
<td>cachestat</td>
<td>Trace page cache hit/miss ratio.</td>
</tr>
<tr>
<td>cachetop</td>
<td>Trace page cache hit/miss ratio by processes.</td>
</tr>
<tr>
<td>dcsnoop</td>
<td>Trace directory entry cache (dcache) lookups.</td>
</tr>
<tr>
<td>dcstat</td>
<td>Directory entry cache (dcache) stats.</td>
</tr>
<tr>
<td>biolatency</td>
<td>Summarize block device I/O latency as a histogram.</td>
</tr>
<tr>
<td>biotop</td>
<td>Top for disks: Summarize block device I/O by process.</td>
</tr>
<tr>
<td>biopattern</td>
<td>Identify random/sequential disk access patterns.</td>
</tr>
<tr>
<td>biosnoop</td>
<td>Trace block device I/O with PID and latency.</td>
</tr>
<tr>
<td>dirtop</td>
<td>File reads and writes by directory. Top for directories.</td>
</tr>
<tr>
<td>filelife</td>
<td>Trace the lifespan of short-lived files.</td>
</tr>
<tr>
<td>filegone</td>
<td>Trace why file gone (deleted or renamed).</td>
</tr>
<tr>
<td>fileslower</td>
<td>Trace slow synchronous file reads and writes.</td>
</tr>
<tr>
<td>filetop</td>
<td>File reads and writes by filename and process. Top for files.</td>
</tr>
<tr>
<td>mdflush</td>
<td>Trace md flush events.</td>
</tr>
<tr>
<td>mountsnoop</td>
<td>Trace mount and umount syscalls system-wide.</td>
</tr>
<tr>
<td>virtiostat</td>
<td>Show VIRTIO device IO statistics.</td>
</tr>
</tbody>
</table>
<h3 id="filesystems-tools">Filesystems Tools<a class="td-heading-self-link" href="#filesystems-tools" aria-label="Heading self-link"></a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>btrfsdist</td>
<td>Summarize btrfs operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>btrfsslower</td>
<td>Trace slow btrfs operations.</td>
</tr>
<tr>
<td>ext4dist</td>
<td>Summarize ext4 operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>ext4slower</td>
<td>Trace slow ext4 operations.</td>
</tr>
<tr>
<td>nfsslower</td>
<td>Trace slow NFS operations.</td>
</tr>
<tr>
<td>nfsdist</td>
<td>Summarize NFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>vfscount</td>
<td>Count VFS calls.</td>
</tr>
<tr>
<td>vfsstat</td>
<td>Count some VFS calls, with column output.</td>
</tr>
<tr>
<td>xfsdist</td>
<td>Summarize XFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>xfsslower</td>
<td>Trace slow XFS operations.</td>
</tr>
<tr>
<td>zfsdist</td>
<td>Summarize ZFS operation latency distribution as a histogram.</td>
</tr>
<tr>
<td>zfsslower</td>
<td>Trace slow ZFS operations.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4551197eff5fbdde9f1f1576dc49c24">3 - BPFTool</h1>
    <div class="lead">The official command-line utility shipped with the kernel source that loads pins inspects and benchmarks eBPF programs and maps from user space.</div>
	<p><code>BPFTool</code> is a command-line utility for interacting with eBPF programs and maps in the Linux kernel. It provides a comprehensive set of commands for loading, inspecting, and debugging eBPF objects. With <code>bpftool</code>, users can load compiled eBPF programs into the kernel, attach them to various kernel events or network interfaces, and manage eBPF maps used for storing and sharing data between kernel and user space. It also offers powerful introspection capabilities, allowing users to examine the state of running eBPF programs, including their maps, attached probes, and verifier logs, making it an indispensable tool for eBPF developers and system administrators working with modern Linux observability and networking.</p>
<p>We used many times to generate <code>vmlinux.h</code> header file and the skeleton header files:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span><span style="display:flex;"><span>sudo bpftool gen skeleton obj_file.o &gt; obj_file.skel.h
</span></span></code></pre></div><p>Using <code>sudo bpftool -h</code> to show the program&rsquo;s options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Usage: bpftool <span style="color:#ce5c00;font-weight:bold">[</span>OPTIONS<span style="color:#ce5c00;font-weight:bold">]</span> OBJECT <span style="color:#ce5c00;font-weight:bold">{</span> COMMAND <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">help</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       bpftool batch file FILE
</span></span><span style="display:flex;"><span>       bpftool version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       OBJECT :<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span> prog <span style="color:#000;font-weight:bold">|</span> map <span style="color:#000;font-weight:bold">|</span> link <span style="color:#000;font-weight:bold">|</span> cgroup <span style="color:#000;font-weight:bold">|</span> perf <span style="color:#000;font-weight:bold">|</span> net <span style="color:#000;font-weight:bold">|</span> feature <span style="color:#000;font-weight:bold">|</span> btf <span style="color:#000;font-weight:bold">|</span> gen <span style="color:#000;font-weight:bold">|</span> struct_ops <span style="color:#000;font-weight:bold">|</span> iter <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       OPTIONS :<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#ce5c00;font-weight:bold">{</span>-j<span style="color:#000;font-weight:bold">|</span>--json<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">[{</span>-p<span style="color:#000;font-weight:bold">|</span>--pretty<span style="color:#ce5c00;font-weight:bold">}]</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">{</span>-d<span style="color:#000;font-weight:bold">|</span>--debug<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ce5c00;font-weight:bold">{</span>-V<span style="color:#000;font-weight:bold">|</span>--version<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s explore some of these options. First, let&rsquo;s try the following simple code which count how many times <code>getpid</code> syscall get invoked:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">count</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_getpid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">count_getpid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;signal.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;getpid_count.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">getpid_count</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getpid_count__attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">map_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to get map FD</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BPF program loaded and map updated. Press Ctrl+C to exit.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">lookup_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;getpid call count: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Lookup failed for key %d: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lookup_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getpid_count__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Before compiling and running the code. Run <code>sudo bpftool prog</code> to list all running eBPF programs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>42: cgroup_device  name sd_devices  tag 2705a24f44b96941  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 464B  jited 301B  memlock 4096B
</span></span><span style="display:flex;"><span>43: cgroup_skb  name sd_fw_egress  tag 6deef7357e7b4530  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 64B  jited 67B  memlock 4096B
</span></span><span style="display:flex;"><span>44: cgroup_skb  name sd_fw_ingress  tag 6deef7357e7b4530  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-17T23:38:12-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 64B  jited 67B  memlock 4096B
</span></span><span style="display:flex;"><span>46: cgroup_device  name sd_devices  tag 30c3c39a95291292  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T00:27:21-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 1664B  jited 1027B  memlock 4096B
</span></span></code></pre></div><p>You will see a list of <code>cgroup</code> programs running by the system. After compiling and running the previous code and then list all running eBPF code <code>sudo bpftool prog</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>46: cgroup_device  name sd_devices  tag 30c3c39a95291292  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T00:27:21-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 1664B  jited 1027B  memlock 4096B
</span></span><span style="display:flex;"><span>312: tracepoint  name count_getpid  tag be075f8b6a94de72  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T05:38:34-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 152B  jited 99B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">147</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>Also <code>--pretty</code> option can be used <code>sudo bpftool prog --pretty</code> to display the output in prettified JSON.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;id&#34;</span>: 312,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;tracepoint&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;count_getpid&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;tag&#34;</span>: <span style="color:#4e9a06">&#34;be075f8b6a94de72&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;gpl_compatible&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;loaded_at&#34;</span>: 1742290714,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;uid&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;orphaned&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_xlated&#34;</span>: 152,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;jited&#34;</span>: true,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_jited&#34;</span>: 99,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;bytes_memlock&#34;</span>: 4096,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;map_ids&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>147<span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;btf_id&#34;</span>: <span style="color:#0000cf;font-weight:bold">511</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Our code has the following properties:<br>
id = 312<br>
Program Type = tracepoint which represents the type of eBPF program<br>
name = count_getpid which is the name of the function defined in the code<br>
tag = be075f8b6a94de72 which is a hash of the compiled instructions.<br>
gpl which is the liscence<br>
loaded_at = 2025-03-18T05:38:34-0400 timestamp when the program was loaded<br>
uid = 0 which indicated that loaded by root<br>
xlated = 152B represents the size of eBPF bytecode<br>
jited = 99B represents the size of the machine code<br>
memlock = 4096B represents the size resrved for this program<br>
map_ids = 147 which is the id of the map loaded in this program<br>
btf_id = 511 which is a unique identifier that the kernel assigns to that block of BTF metadata and can inspect its details using <code>sudo bpftool btf show id 511</code></p>
<p>BPFTool can dump eBPF bytecode using <code>sudo bpftool prog dump xlated id 312</code> :</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void * ctx<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void *ctx<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   1: <span style="color:#ce5c00;font-weight:bold">(</span>63<span style="color:#ce5c00;font-weight:bold">)</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r10 -4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span>   2: <span style="color:#ce5c00;font-weight:bold">(</span>bf<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">=</span> r10
</span></span><span style="display:flex;"><span>   3: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">+=</span> -4
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   4: <span style="color:#ce5c00;font-weight:bold">(</span>18<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> map<span style="color:#ce5c00;font-weight:bold">[</span>id:147<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   6: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">264</span>
</span></span><span style="display:flex;"><span>   7: <span style="color:#ce5c00;font-weight:bold">(</span>61<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r2 +0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   8: <span style="color:#ce5c00;font-weight:bold">(</span>35<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> r0 &gt;<span style="color:#ce5c00;font-weight:bold">=</span> 0x1 goto pc+3
</span></span><span style="display:flex;"><span>   9: <span style="color:#ce5c00;font-weight:bold">(</span>67<span style="color:#ce5c00;font-weight:bold">)</span> r0 &lt;&lt;<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  10: <span style="color:#ce5c00;font-weight:bold">(</span>0f<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">+=</span> r1
</span></span><span style="display:flex;"><span>  11: <span style="color:#ce5c00;font-weight:bold">(</span>05<span style="color:#ce5c00;font-weight:bold">)</span> goto pc+1
</span></span><span style="display:flex;"><span>  12: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  13: <span style="color:#ce5c00;font-weight:bold">(</span>15<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">==</span> 0x0 goto pc+3
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  14: <span style="color:#ce5c00;font-weight:bold">(</span>61<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 +0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  15: <span style="color:#ce5c00;font-weight:bold">(</span>07<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  16: <span style="color:#ce5c00;font-weight:bold">(</span>63<span style="color:#ce5c00;font-weight:bold">)</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 +0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  17: <span style="color:#ce5c00;font-weight:bold">(</span>b7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  18: <span style="color:#ce5c00;font-weight:bold">(</span>95<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">exit</span>
</span></span></code></pre></div><p>We can get visual representation of our code instructions using <code>sudo bpftool prog dump xlated id 312 visual &amp;&gt; vis.out</code> and the output <code>vis.out</code> is a DOT language file which is a graph description language and can be viewed Graphviz. It can be converted to PNG using <code>dot -Tpng viz.out -o viz.png</code> and you can display viz.png file.</p>
<p style="text-align: center;">
  <img src="/images/docs/chapter6/graphviz.png" alt="Centered image" />
</p>
<p>BPFTool can also dump jited or the program machine code using <code>sudo bpftool prog dump jited id 312</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void * ctx<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>0xffffffffc03735d4:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int count_getpid<span style="color:#ce5c00;font-weight:bold">(</span>void *ctx<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   0:	nopl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax,%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   5:	nopl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   8:	pushq	%rbp
</span></span><span style="display:flex;"><span>   9:	movq	%rsp, %rbp
</span></span><span style="display:flex;"><span>   c:	subq	<span style="color:#000">$8</span>, %rsp
</span></span><span style="display:flex;"><span>  13:	xorl	%edi, %edi
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  15:	movl	%edi, -4<span style="color:#ce5c00;font-weight:bold">(</span>%rbp<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  18:	movq	%rbp, %rsi
</span></span><span style="display:flex;"><span>  1b:	addq	<span style="color:#000">$-</span>4, %rsi
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  1f:	movabsq	<span style="color:#000">$-</span>121297335560704, %rdi
</span></span><span style="display:flex;"><span>  29:	addq	<span style="color:#000">$272</span>, %rdi
</span></span><span style="display:flex;"><span>  30:	movl	<span style="color:#ce5c00;font-weight:bold">(</span>%rsi<span style="color:#ce5c00;font-weight:bold">)</span>, %eax
</span></span><span style="display:flex;"><span>  33:	cmpq	<span style="color:#000">$1</span>, %rax
</span></span><span style="display:flex;"><span>  37:	jae	0xffffffffc0373616
</span></span><span style="display:flex;"><span>  39:	shlq	<span style="color:#000">$3</span>, %rax
</span></span><span style="display:flex;"><span>  3d:	addq	%rdi, %rax
</span></span><span style="display:flex;"><span>  40:	jmp	0xffffffffc0373618
</span></span><span style="display:flex;"><span>  42:	xorl	%eax, %eax
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  44:	testq	%rax, %rax
</span></span><span style="display:flex;"><span>  47:	je	0xffffffffc0373627
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  49:	movl	<span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>, %edi
</span></span><span style="display:flex;"><span>  4c:	addq	<span style="color:#000">$1</span>, %rdi
</span></span><span style="display:flex;"><span>  50:	movl	%edi, <span style="color:#ce5c00;font-weight:bold">(</span>%rax<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  53:	xorl	%eax, %eax
</span></span><span style="display:flex;"><span>  55:	leave
</span></span><span style="display:flex;"><span>  56:	jmp	0xffffffff85f0410b
</span></span></code></pre></div>

<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    I had to download the source code and compile bpftool to enable JIT disassembly support. I used the command <code>make LLVM_CONFIG=$(which llvm-config) CFLAGS_EXTRA=&quot;-DENABLE_JIT_DISASM=1&quot;</code> to ensure that LLVM was correctly detected and that JIT disassembly support was enabled.

</div>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    You can inspect eBPF instructions for the object file using <code>llvm-objdump -S getpid.o</code>

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>getpid.o:	file format elf64-bpf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section tracepoint/syscalls/sys_enter_getpid:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0000000000000000</span> &lt;count_getpid&gt;:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       0:	b7 <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     int <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       1:	<span style="color:#0000cf;font-weight:bold">63</span> 1a <span style="color:#204a87">fc</span> ff <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	*<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r10 - 0x4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span>       2:	bf a2 <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">=</span> r10
</span></span><span style="display:flex;"><span>       3:	<span style="color:#0000cf;font-weight:bold">07</span> <span style="color:#0000cf;font-weight:bold">02</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#204a87">fc</span> ff ff ff	<span style="color:#000">r2</span> <span style="color:#ce5c00;font-weight:bold">+=</span> -0x4
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> bpf_map_lookup_elem<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>count, <span style="color:#000;font-weight:bold">&amp;</span>key<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       4:	<span style="color:#0000cf;font-weight:bold">18</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0 ll
</span></span><span style="display:flex;"><span>       6:	<span style="color:#0000cf;font-weight:bold">85</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	call 0x1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span>value<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       7:	<span style="color:#0000cf;font-weight:bold">15</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">03</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">==</span> 0x0 goto +0x3 &lt;count_getpid+0x58&gt;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#ce5c00;font-weight:bold">(</span>*value<span style="color:#ce5c00;font-weight:bold">)</span>++<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>       8:	<span style="color:#0000cf;font-weight:bold">61</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">=</span> *<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 + 0x0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       9:	<span style="color:#0000cf;font-weight:bold">07</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">01</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> 0x1
</span></span><span style="display:flex;"><span>      10:	<span style="color:#0000cf;font-weight:bold">63</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	*<span style="color:#ce5c00;font-weight:bold">(</span>u32 *<span style="color:#ce5c00;font-weight:bold">)(</span>r0 + 0x0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> r1
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#204a87;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      11:	b7 <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#000">r0</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0x0
</span></span><span style="display:flex;"><span>      12:	<span style="color:#0000cf;font-weight:bold">95</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> <span style="color:#0000cf;font-weight:bold">00</span> 00	<span style="color:#204a87">exit</span>
</span></span></code></pre></div><p>You can find a list of eBPF opcodes from kernel documentation<br>
<a href="https://docs.kernel.org/bpf/standardization/instruction-set.html">https://docs.kernel.org/bpf/standardization/instruction-set.html</a> or RFC 9669 <a href="https://www.rfc-editor.org/rfc/rfc9669.html">https://www.rfc-editor.org/rfc/rfc9669.html</a>.</p>
<p>BPFTool can display the list of all maps using <code>sudo bpftool map</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>11: hash_of_maps  name cgroup_hash  flags 0x0
</span></span><span style="display:flex;"><span>	key 8B  value 4B  max_entries <span style="color:#0000cf;font-weight:bold">2048</span>  memlock 165152B
</span></span><span style="display:flex;"><span>147: array  name count  flags 0x0
</span></span><span style="display:flex;"><span>	key 4B  value 4B  max_entries <span style="color:#0000cf;font-weight:bold">1</span>  memlock 272B
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">511</span>
</span></span></code></pre></div><p>We can also inspect map content with id 147 using <code>sudo bpftool map dump id 147</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#8f5902;font-style:italic"># count of how many times `getpid` syscall get invoked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Maps can be updated using <code>bpftool</code>. For example, let&rsquo;s change the value to 90 <code>sudo bpftool map update id 147 key 00 00 00 00 value 90 00 00 00</code> and inspect the content again <code>sudo bpftool map dump id 147</code> you might see:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">98</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>The extra 8 indicates that between your update and the dump, the <code>getpid</code> syscall was triggered 8 times, and since your eBPF program increments the value each time <code>getpid</code> is called, the counter increased from 90 to 98.</p>
<p>Maps also can be pinned to eBPF filesystem using <code>sudo bpftool map pin id 147 /sys/fs/bpf/getpid_map</code> and even after termination of our program we can dump the content of the pinned map using <code>sudo bpftool map dump pinned /sys/fs/bpf/getpid_map</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">122</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>We can unpin simply by remove the created file <code>sudo rm /sys/fs/bpf/getpid_map</code>.
BPFTool can also load programs. Let&rsquo;s close our program and load it again using:
<code>sudo bpftool prog loadall getpid.o /sys/fs/bpf/test autoattach</code> and then run <code>sudo bpftool prog</code> to make sure that the program is loaded:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>741: tracepoint  name count_getpid  tag be075f8b6a94de72  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T07:03:14-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 152B  jited 99B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">85</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">189</span>
</span></span></code></pre></div><p><code>autoattach</code> option is to load, attach and pin kprobe, kretprobe, uprobe, uretprobe and tracepoints in a single command.</p>
<p>We can again dump the content of the program map <code>sudo bpftool map dump id 85</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;key&#34;</span>: 0,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#0000cf;font-weight:bold">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>BPFTool can also load and attach another types of eBPF programs such as XDP. Let&rsquo;s see the following code of XDP which drops ingress traffic to port 8080:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">drop_ingress_port_8080</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ip_header_length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ip_header_length</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping XDP egress packet port 8080</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_DROP</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We can load this program using <code>sudo bpftool prog load xdp_drop8080.o /sys/fs/bpf/xdp type xdp</code>. Then running <code>sudo bpftool prog list pinned /sys/fs/bpf/xdp</code> to see if the program is loaded successfully:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>835: xdp  name drop_egress_port_8080  tag 7c15f4a6de3ceb0f  gpl
</span></span><span style="display:flex;"><span>	loaded_at 2025-03-18T07:24:28-0400  uid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	xlated 248B  jited 164B  memlock 4096B  map_ids <span style="color:#0000cf;font-weight:bold">122</span>
</span></span><span style="display:flex;"><span>	btf_id <span style="color:#0000cf;font-weight:bold">310</span>
</span></span></code></pre></div><p>Then we can attach this program to an interface <code>sudo bpftool net attach xdp id 835 dev enp1s0</code>. To confirm program is attached use <code>sudo bpftool net list</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xdp:
</span></span><span style="display:flex;"><span>enp1s0<span style="color:#ce5c00;font-weight:bold">(</span>2<span style="color:#ce5c00;font-weight:bold">)</span> driver id <span style="color:#0000cf;font-weight:bold">835</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tc:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flow_dissector:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netfilter:
</span></span></code></pre></div><p>Or by viewing <code>ip a</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> xdp/id:835 qdisc fq_codel state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 52:54:00:f6:fe:bc brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    altname enx525400f6febc
</span></span><span style="display:flex;"><span>    inet 192.168.1.238/24 brd 192.168.1.255 scope global dynamic noprefixroute enp1s0
</span></span><span style="display:flex;"><span>       valid_lft 3543sec preferred_lft 3543sec
</span></span><span style="display:flex;"><span>    inet6 fe80::5054:ff:fef6:febc/64 scope link noprefixroute 
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>We can see <code>xdp/id:835</code> which confirms program with id 835 of type XDP is attached to <code>enp1s0</code> interface. Use <code>sudo bpftool net detach xdp dev enp1s0</code> to detach the XDP program.
Unloading eBPF program can be done by removing the pinned pseudofile. For example, <code>sudo rm /sys/fs/bpf/xdp</code> to unload the XDP program. We can also use bpftool to load and attached TC programs with <code>tcx_egress</code> for egress traffic and <code>tcx_ingress</code> for ingress traffic. For example, <code>sudo bpftool net attach tcx_egress id 423 dev enp1s0</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-77ec8433956d6a9f2c325fa29eb7ae4d">4 - Tail call</h1>
    <div class="lead">One eBPF program can jump straight into another without returning which lets you chain logic and sidestep the per-program instruction limit while adding almost no overhead.</div>
	<p>Tail calls in eBPF let you chain together multiple BPF programs, effectively bypassing the instruction limit imposed on individual programs which is around 4096 instructions before kernel 5.2 and now the limit is one million instructions. Tail calls can also be used to break up the code logic into multiple parts to enable modular design. Tail call transfers control from one eBPF program to another without returning to the caller. 1. The verifier ensures that tail calls do not lead to unbounded recursion and that the jump is safe. It also reduces the effective stack size available (e.g., from 512 bytes to 256 bytes) when tail calls are used with BPF-to-BPF function calls.</p>
<h4 id="how-tail-calls-work">How Tail Calls Work<a class="td-heading-self-link" href="#how-tail-calls-work" aria-label="Heading self-link"></a></h4>
<ol>
<li>eBPF uses a special map type called <code>BPF_MAP_TYPE_PROG_ARRAY</code> that holds file descriptors of other BPF programs. The tail call uses an index (or key) into this map to know which program to jump to.</li>
<li>Within an eBPF program, you can use the helper function <code>bpf_tail_call(ctx, prog_array, key)</code> to transfer execution to another program. If the call is successful, the current program’s execution ends and the new program starts from its entry point.</li>
</ol>
<p>Let&rsquo;s explore an example of XDP code. The idea is to have a main XDP program that inspects incoming packets and, based on the TCP destination port, uses a tail call to jump to the appropriate program—one for port 8080 and one for port 22.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/bpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_endian.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/if_ether.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/ip.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/tcp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/in.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PROG_ARRAY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value_size</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">prog_array</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">_license</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">data_end</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ethhdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">iphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tcphdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">eth</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">h_proto</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">bpf_htons</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ETH_P_IP</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">eth</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">iph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">IPPROTO_TCP</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ihl</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">tcph</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tcph</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">data_end</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_ABORTED</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_ntohs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcph</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_tail_call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dport</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_tail_call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port8080_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Packet to port 8080 processed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xdp&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port22_prog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">xdp_md</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Packet to port 22 processed</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">XDP_PASS</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>User-space code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;net/if.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/libbpf.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;tail_call.skel.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef libbpf_is_err
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define libbpf_is_err(ptr) ((unsigned long)(ptr) &gt; (unsigned long)-1000L)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">tail_call</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">bpf_link</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;interface&gt;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ifname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tail_call__open</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to open BPF skeleton</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tail_call__load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to load BPF skeleton: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port8080_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid FD for port8080_prog</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to update prog_array for port8080_prog: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__fd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port22_prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid FD for port22_prog</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map__update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">maps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prog_array</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prog_fd</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to update prog_array for port22_prog: %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ifindex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">if_nametoindex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;if_nametoindex&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_program__attach_xdp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">progs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">main_prog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">libbpf_is_err</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">libbpf_get_error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to attach XDP program on %s (ifindex: %d): %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">link</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;XDP program loaded and tail calls configured on interface %s (ifindex: %d).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>           <span style="color:#000">ifname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ifindex</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Press Ctrl+C to exit...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">cleanup</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_link__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">link</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tail_call__destroy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">skel</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#f57900">err</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter6/tail-call.png" alt="Centered image" />
</p>
<p>Compile the code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>clang -g -O2 -target bpf -c tail_call.c -o tail_call.o
</span></span><span style="display:flex;"><span>sudo bpftool gen skeleton tail_call.o &gt; tail_call.skel.h
</span></span><span style="display:flex;"><span>clang -o loader loader.c -lbpf
</span></span></code></pre></div><p>Run the loader using <code>sudo ./loader enp1s0</code> . Open trace buffer <code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8853.538349: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> .Ns2.  8853.539270: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> .Ns2.  8853.539279: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>gnome-shell-2539     <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8853.541321: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>gnome-shell-2539     <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8853.541334: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">8080</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777125: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777420: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>&lt;idle&gt;-0             <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s2.  8860.777611: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span><span style="display:flex;"><span>llvmpipe-1-2569      <span style="color:#ce5c00;font-weight:bold">[</span>003<span style="color:#ce5c00;font-weight:bold">]</span> ..s1.  8860.783551: bpf_trace_printk: Packet to port <span style="color:#0000cf;font-weight:bold">22</span> processed
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
