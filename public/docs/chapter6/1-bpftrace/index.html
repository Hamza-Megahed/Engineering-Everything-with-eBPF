<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>bpftrace | Engineering Everything with eBPF</title>
<meta name="description" content="DTrace style one liners for quick ad hoc tracing of kernel and user processes.">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter6/1-bpftrace/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="bpftrace">
  <meta property="og:description" content="DTrace style one liners for quick ad hoc tracing of kernel and user processes.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">

  <meta itemprop="name" content="bpftrace">
  <meta itemprop="description" content="DTrace style one liners for quick ad hoc tracing of kernel and user processes.">
  <meta itemprop="wordCount" content="2571">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="bpftrace">
  <meta name="twitter:description" content="DTrace style one liners for quick ad hoc tracing of kernel and user processes.">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.2d2954103a1ca7b99d7bf4e15a887a32.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Engineering Everything with eBPF" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter0-li">
  <a href="/docs/chapter0/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter0"><span class="">Before We Begin</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter01-author-li">
  <a href="/docs/chapter0/1-author/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter01-author"><span class="">Author</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter03-copyright-li">
  <a href="/docs/chapter0/3-copyright/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter03-copyright"><span class="">Copyright</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter04-preface-li">
  <a href="/docs/chapter0/4-preface/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter04-preface"><span class="">Preface</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter05-contribution-li">
  <a href="/docs/chapter0/5-contribution/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter05-contribution"><span class="">Contribution Guidelines</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter02-acknowledgements-li">
  <a href="/docs/chapter0/2-acknowledgements/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter02-acknowledgements"><span class=""></span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter1-li">
  <a href="/docs/chapter1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter1"><span class="">What is eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter11-intro-li">
  <a href="/docs/chapter1/1-intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter11-intro"><span class="">Introduction</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter12-history-li">
  <a href="/docs/chapter1/2-history/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter12-history"><span class="">History of eBPF</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter13-real-world-li">
  <a href="/docs/chapter1/3-real-world/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter13-real-world"><span class="">eBPF in the Real World</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter14-why-li">
  <a href="/docs/chapter1/4-why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter14-why"><span class="">Why eBPF?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter15-arch-li">
  <a href="/docs/chapter1/5-arch/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter15-arch"><span class="">eBPF Architecture</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter2-li">
  <a href="/docs/chapter2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter2"><span class="">eBPF Taking off</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter21-bpf_syscall-li">
  <a href="/docs/chapter2/1-bpf_syscall/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter21-bpf_syscall"><span class="">bpf() syscall</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter22-maps-li">
  <a href="/docs/chapter2/2-maps/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter22-maps"><span class="">eBPF Maps</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter23-map_operations-li">
  <a href="/docs/chapter2/3-map_operations/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter23-map_operations"><span class="">eBPF Map Operations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter24-prog_types-li">
  <a href="/docs/chapter2/4-prog_types/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter24-prog_types"><span class="">eBPF Program Types</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter3-li">
  <a href="/docs/chapter3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter3"><span class="">eBPF Probes</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter31-kprobe-kretprobe-li">
  <a href="/docs/chapter3/1-kprobe-kretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter31-kprobe-kretprobe"><span class="">Kprobe and Kretprobe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter32-uprobe-uretprobe-li">
  <a href="/docs/chapter3/2-uprobe-uretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter32-uprobe-uretprobe"><span class="">Uprobes and Uretprobes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter33-tracepoints-li">
  <a href="/docs/chapter3/3-tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter33-tracepoints"><span class="">Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter34-raw_tracepoints-li">
  <a href="/docs/chapter3/4-raw_tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter34-raw_tracepoints"><span class="">Raw Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter35-fentry-fexit-li">
  <a href="/docs/chapter3/5-fentry-fexit/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter35-fentry-fexit"><span class="">Fentry and Fexit</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter4-li">
  <a href="/docs/chapter4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter4"><span class="">Networking with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter41-socket-li">
  <a href="/docs/chapter4/1-socket/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter41-socket"><span class="">Socket Filter</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter42-lwt-li">
  <a href="/docs/chapter4/2-lwt/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter42-lwt"><span class="">Lightweight Tunnels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter43-tc-li">
  <a href="/docs/chapter4/3-tc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter43-tc"><span class="">Traffic Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter44-xdp-li">
  <a href="/docs/chapter4/4-xdp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter44-xdp"><span class="">XDP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter45-cgroup_sock_addr-li">
  <a href="/docs/chapter4/5-cgroup_sock_addr/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter45-cgroup_sock_addr"><span class="">CGroup Socket Address</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter5-li">
  <a href="/docs/chapter5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter5"><span class="">Security with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter51-seccomp-li">
  <a href="/docs/chapter5/1-seccomp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter51-seccomp"><span class="">Seccomp</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter52-lsm-li">
  <a href="/docs/chapter5/2-lsm/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter52-lsm"><span class="">Linux Security Module (LSM)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter53-landlock-li">
  <a href="/docs/chapter5/3-landlock/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter53-landlock"><span class="">Landlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter54-bpf_send_signal-li">
  <a href="/docs/chapter5/4-bpf_send_signal/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter54-bpf_send_signal"><span class="">bpf_send_signal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter55-tetragon-li">
  <a href="/docs/chapter5/5-tetragon/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter55-tetragon"><span class="">Tetragon</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter56-bpfilter-li">
  <a href="/docs/chapter5/6-bpfilter/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter56-bpfilter"><span class="">Bpfilter</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docschapter6-li">
  <a href="/docs/chapter6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter6"><span class="">Tools and languages</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docschapter61-bpftrace-li">
  <a href="/docs/chapter6/1-bpftrace/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-docschapter61-bpftrace"><span class="td-sidebar-nav-active-item">bpftrace</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter62-bcc-li">
  <a href="/docs/chapter6/2-bcc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter62-bcc"><span class="">BCC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter63-bpftool-li">
  <a href="/docs/chapter6/3-bpftool/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter63-bpftool"><span class="">BPFTool</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter64-tail-call-li">
  <a href="/docs/chapter6/4-tail-call/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter64-tail-call"><span class="">Tail call</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/tree/main/content/docs/chapter6/1-bpftrace.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/edit/main/content/docs/chapter6/1-bpftrace.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/new/main/content/docs/chapter6?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new?title=bpftrace" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/docs/chapter6/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#bpftrace-options">bpftrace Options</a></li>
    <li><a href="#how-to-code-in-bpftrace">How to Code in bpftrace</a>
      <ul>
        <li><a href="#basic-structure-of-a-bpftrace-script">Basic Structure of a bpftrace Script</a></li>
      </ul>
    </li>
    <li><a href="#bpftrace-maps">bpftrace Maps</a></li>
    <li><a href="#bpftrace-tools">bpftrace Tools</a></li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a></li>
  <li class="breadcrumb-item">
    <a href="/docs/chapter6/">Tools and languages</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    bpftrace</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>bpftrace</h1>
	<div class="lead">DTrace style one liners for quick ad hoc tracing of kernel and user processes.</div>
	<header class="article-meta">
		
  </header>
	<p>bpftrace is a powerful, high-level tracing language for Linux that simplifies the process of creating eBPF (Extended Berkeley Packet Filter) programs. It simplifies the process of instrumenting kernel and user-space code by providing a simple language to attach probes to kernel functions, tracepoints, and user-defined events in a user-friendly syntax, inspired by awk, C, and other tracing tools, enabling users to quickly gain insights into system behavior. By abstracting away the complexities of low-level eBPF programming and leveraging libbpf as its backend, bpftrace allows system administrators, performance engineers, and developers to easily observe and analyze system performance without requiring extensive eBPF expertise. Let&rsquo;s start by looking at the bpftrace command.</p>
<h2 id="bpftrace-options">bpftrace Options<a class="td-heading-self-link" href="#bpftrace-options" aria-label="Heading self-link"></a></h2>
<p>When running bpftrace, you can use various command-line options to control its behavior. Some commonly used options include:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>    -B MODE        output buffering mode <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;full&#39;</span>, <span style="color:#4e9a06">&#39;none&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -f FORMAT      output format <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;text&#39;</span>, <span style="color:#4e9a06">&#39;json&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -o file        redirect bpftrace output to file
</span></span><span style="display:flex;"><span>    -e <span style="color:#4e9a06">&#39;program&#39;</span>   execute this program
</span></span><span style="display:flex;"><span>    -h, --help     show this <span style="color:#204a87">help</span> message
</span></span><span style="display:flex;"><span>    -I DIR         add the directory to the include search path
</span></span><span style="display:flex;"><span>    --include FILE add an <span style="color:#8f5902;font-style:italic">#include file before preprocessing</span>
</span></span><span style="display:flex;"><span>    -l <span style="color:#ce5c00;font-weight:bold">[</span>search<span style="color:#000;font-weight:bold">|</span>filename<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>                   list kernel probes or probes in a program
</span></span><span style="display:flex;"><span>    -p PID         <span style="color:#204a87">enable</span> USDT probes on PID
</span></span><span style="display:flex;"><span>    -c <span style="color:#4e9a06">&#39;CMD&#39;</span>       run CMD and <span style="color:#204a87">enable</span> USDT probes on resulting process
</span></span><span style="display:flex;"><span>    --usdt-file-activation
</span></span><span style="display:flex;"><span>                   activate usdt semaphores based on file path
</span></span><span style="display:flex;"><span>    --unsafe       allow unsafe/destructive functionality
</span></span><span style="display:flex;"><span>    -q             keep messages quiet
</span></span><span style="display:flex;"><span>    --info         Print information about kernel BPF support
</span></span><span style="display:flex;"><span>    -k             emit a warning when a bpf helper returns an error <span style="color:#ce5c00;font-weight:bold">(</span>except <span style="color:#204a87">read</span> functions<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -kk            check all bpf helper functions
</span></span><span style="display:flex;"><span>    -V, --version  bpftrace version
</span></span><span style="display:flex;"><span>    --no-warnings  disable all warning messages
</span></span></code></pre></div><p>For example, we can use <code>-l</code> along with <code>*</code> for wildcard for listing such as listing all kprobes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;kprobe:*&#39;</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kprobe:zswap_store
</span></span><span style="display:flex;"><span>kprobe:zswap_swapoff
</span></span><span style="display:flex;"><span>kprobe:zswap_swapon
</span></span><span style="display:flex;"><span>kprobe:zswap_total_pages
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_entry
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_show
</span></span><span style="display:flex;"><span>kprobe:zswap_writeback_write
</span></span><span style="display:flex;"><span>kprobe:zswap_zpool_param_set
</span></span></code></pre></div><p>We can list probe parameters for a certain function using</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -lv <span style="color:#4e9a06">&#39;fentry:tcp_reset&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>fentry:vmlinux:tcp_reset
</span></span><span style="display:flex;"><span>    struct sock * sk
</span></span><span style="display:flex;"><span>    struct sk_buff * skb
</span></span></code></pre></div><p>We can list all symbols from object or binary files for uprobe such as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -l <span style="color:#4e9a06">&#39;uprobe:/bin/bash:*&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:async_redirect_stdin
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:base_pathname
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_add_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_brace_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_clear_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_default_completion
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_histent
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_history_range
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_delete_last_history
</span></span><span style="display:flex;"><span>uprobe:/bin/bash:bash_dequote_text
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Using <code>-e</code> can be used to execute a program in one-liner. For example,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;shell_execve called\n&#34;); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span><span style="display:flex;"><span>open<span style="color:#ce5c00;font-weight:bold">()</span> called
</span></span></code></pre></div><p>This program <code>uprobe:/bin/bash:shell_execve { printf(&quot;shell_execve called\n&quot;); }</code> means this action <code>printf(&quot;shell_execve called\n&quot;);</code> will be executed when <code>uprobe:/bin/bash:shell_execve</code> get triggered.</p>
<p>If we want to print out which command is being executed is by printing the first argument with <code>arg0</code> using <code>str</code> function which reads a NULL terminated string similar to <code>bpf_probe_read_str</code> helper function. <code>argN</code> is a bpf builtins while hold arguments passed to the function being traced and it can be used with kprobe and uprobe.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo bpftrace -e <span style="color:#4e9a06">&#39;uprobe:/bin/bash:shell_execve { printf(&#34;command:%s\n&#34;, str(arg0)); }&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>command:/usr/bin/ls
</span></span><span style="display:flex;"><span>command:/usr/bin/ping
</span></span><span style="display:flex;"><span>command:/usr/bin/cat
</span></span></code></pre></div><p>The following table is from the bpftrace manual, listing special variables along with their corresponding helper functions and descriptions.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Kernel</th>
<th>BPF Helper</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$1</code>, <code>$2</code>, <code>...$n</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>The nth positional parameter passed to the bpftrace program. If less than n parameters are passed this evaluates to <code>0</code>. For string arguments use the <code>str()</code> call to retrieve the value.</td>
</tr>
<tr>
<td><code>$#</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>Total amount of positional parameters passed.</td>
</tr>
<tr>
<td><code>arg0</code>, <code>arg1</code>, <code>...argn</code></td>
<td>int64</td>
<td>n/a</td>
<td>n/a</td>
<td>nth argument passed to the function being traced. These are extracted from the CPU registers. The amount of args passed in registers depends on the CPU architecture. (kprobes, uprobes, usdt).</td>
</tr>
<tr>
<td><code>args</code></td>
<td>struct args</td>
<td>n/a</td>
<td>n/a</td>
<td>The struct of all arguments of the traced function. Available in <code>tracepoint</code>, <code>fentry</code>, <code>fexit</code>, and <code>uprobe</code> (with DWARF) probes. Use <code>args.x</code> to access argument <code>x</code> or <code>args</code> to get a record with all arguments.</td>
</tr>
<tr>
<td><code>cgroup</code></td>
<td>uint64</td>
<td>4.18</td>
<td>get_current_cgroup_id</td>
<td>ID of the cgroup the current process belongs to. Only works with cgroupv2.</td>
</tr>
<tr>
<td><code>comm</code></td>
<td>string[16]</td>
<td>4.2</td>
<td>get_current_comm</td>
<td>Name of the current thread.</td>
</tr>
<tr>
<td><code>cpid</code></td>
<td>uint32</td>
<td>n/a</td>
<td>n/a</td>
<td>Child process ID, if bpftrace is invoked with <code>-c</code>.</td>
</tr>
<tr>
<td><code>cpu</code></td>
<td>uint32</td>
<td>4.1</td>
<td>raw_smp_processor_id</td>
<td>ID of the processor executing the BPF program.</td>
</tr>
<tr>
<td><code>curtask</code></td>
<td>uint64</td>
<td>4.8</td>
<td>get_current_task</td>
<td>Pointer to <code>struct task_struct</code> of the current task.</td>
</tr>
<tr>
<td><code>elapsed</code></td>
<td>uint64</td>
<td>(see nsec)</td>
<td>ktime_get_ns / ktime_get_boot_ns</td>
<td>Nanoseconds elapsed since bpftrace initialization, based on <code>nsecs</code>.</td>
</tr>
<tr>
<td><code>func</code></td>
<td>string</td>
<td>n/a</td>
<td>n/a</td>
<td>Name of the current function being traced (kprobes, uprobes).</td>
</tr>
<tr>
<td><code>gid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>Group ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>jiffies</code></td>
<td>uint64</td>
<td>5.9</td>
<td>get_jiffies_64</td>
<td>Jiffies of the kernel. In 32-bit systems, using this builtin might be slower.</td>
</tr>
<tr>
<td><code>numaid</code></td>
<td>uint32</td>
<td>5.8</td>
<td>numa_node_id</td>
<td>ID of the NUMA node executing the BPF program.</td>
</tr>
<tr>
<td><code>pid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Process ID of the current thread (aka thread group ID), as seen from the init namespace.</td>
</tr>
<tr>
<td><code>probe</code></td>
<td>string</td>
<td>n/na</td>
<td>n/a</td>
<td>Name of the current probe.</td>
</tr>
<tr>
<td><code>rand</code></td>
<td>uint32</td>
<td>4.1</td>
<td>get_prandom_u32</td>
<td>Random number.</td>
</tr>
<tr>
<td><code>return</code></td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>The return keyword is used to exit the current probe. This differs from exit() in that it doesn&rsquo;t exit bpftrace.</td>
</tr>
<tr>
<td><code>retval</code></td>
<td>uint64</td>
<td>n/a</td>
<td>n/a</td>
<td>Value returned by the function being traced (kretprobe, uretprobe, fexit). For kretprobe and uretprobe, its type is <code>uint64</code>, but for fexit it depends. You can look up the type using <code>bpftrace -lv</code>.</td>
</tr>
<tr>
<td><code>tid</code></td>
<td>uint32</td>
<td>4.2</td>
<td>get_current_pid_tgid</td>
<td>Thread ID of the current thread, as seen from the init namespace.</td>
</tr>
<tr>
<td><code>uid</code></td>
<td>uint64</td>
<td>4.2</td>
<td>get_current_uid_gid</td>
<td>User ID of the current thread, as seen from the init namespace.</td>
</tr>
</tbody>
</table>
<p>The following table is from the bpftrace manual, listing bpftrace functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bswap</td>
<td>Reverse byte order</td>
</tr>
<tr>
<td>buf</td>
<td>Returns a hex-formatted string of the data pointed to by d</td>
</tr>
<tr>
<td>cat</td>
<td>Print file content</td>
</tr>
<tr>
<td>cgroupid</td>
<td>Resolve cgroup ID</td>
</tr>
<tr>
<td>cgroup_path</td>
<td>Convert cgroup id to cgroup path</td>
</tr>
<tr>
<td>exit</td>
<td>Quit bpftrace with an optional exit code</td>
</tr>
<tr>
<td>join</td>
<td>Print the array</td>
</tr>
<tr>
<td>kaddr</td>
<td>Resolve kernel symbol name</td>
</tr>
<tr>
<td>kptr</td>
<td>Annotate as kernelspace pointer</td>
</tr>
<tr>
<td>kstack</td>
<td>Kernel stack trace</td>
</tr>
<tr>
<td>ksym</td>
<td>Resolve kernel address</td>
</tr>
<tr>
<td>len</td>
<td>Count ustack/kstack frames</td>
</tr>
<tr>
<td>macaddr</td>
<td>Convert MAC address data</td>
</tr>
<tr>
<td>nsecs</td>
<td>Timestamps and Time Deltas</td>
</tr>
<tr>
<td>ntop</td>
<td>Convert IP address data to text</td>
</tr>
<tr>
<td>offsetof</td>
<td>Offset of element in structure</td>
</tr>
<tr>
<td>override</td>
<td>Override return value</td>
</tr>
<tr>
<td>path</td>
<td>Return full path</td>
</tr>
<tr>
<td>percpu_kaddr</td>
<td>Resolve percpu kernel symbol name</td>
</tr>
<tr>
<td>print</td>
<td>Print a non-map value with default formatting</td>
</tr>
<tr>
<td>printf</td>
<td>Print formatted</td>
</tr>
<tr>
<td>pton</td>
<td>Convert text IP address to byte array</td>
</tr>
<tr>
<td>reg</td>
<td>Returns the value stored in the named register</td>
</tr>
<tr>
<td>signal</td>
<td>Send a signal to the current process</td>
</tr>
<tr>
<td>sizeof</td>
<td>Return size of a type or expression</td>
</tr>
<tr>
<td>skboutput</td>
<td>Write skb &rsquo;s data section into a PCAP file</td>
</tr>
<tr>
<td>str</td>
<td>Returns the string pointed to by s</td>
</tr>
<tr>
<td>strcontains</td>
<td>Compares whether the string haystack contains the string needle.</td>
</tr>
<tr>
<td>strerror</td>
<td>Get error message for errno code</td>
</tr>
<tr>
<td>strftime</td>
<td>Return a formatted timestamp</td>
</tr>
<tr>
<td>strncmp</td>
<td>Compare first n characters of two strings</td>
</tr>
<tr>
<td>system</td>
<td>Execute shell command</td>
</tr>
<tr>
<td>time</td>
<td>Print formatted time</td>
</tr>
<tr>
<td>uaddr</td>
<td>Resolve user-level symbol name</td>
</tr>
<tr>
<td>uptr</td>
<td>Annotate as userspace pointer</td>
</tr>
<tr>
<td>ustack</td>
<td>User stack trace</td>
</tr>
<tr>
<td>usym</td>
<td>Resolve user space address</td>
</tr>
</tbody>
</table>
<h2 id="how-to-code-in-bpftrace">How to Code in bpftrace<a class="td-heading-self-link" href="#how-to-code-in-bpftrace" aria-label="Heading self-link"></a></h2>
<p>bpftrace scripts are written using a custom domain-specific language (DSL) that is similar in syntax to awk. A basic script consists of one or more probe definitions followed by one or more actions. Each probe targets a specific event (e.g., kernel tracepoints, function entry/exit, or user-space events).</p>
<p>The following table is from the bpftrace manual, listing bpftrace probes along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Probe Name</th>
<th>Short Name</th>
<th>Description</th>
<th>Kernel/User Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>BEGIN/END</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>self</td>
<td>-</td>
<td>Built-in events</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>hardware</td>
<td><code>h</code></td>
<td>Processor-level events</td>
<td>Kernel</td>
</tr>
<tr>
<td>interval</td>
<td><code>i</code></td>
<td>Timed output</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>iter</td>
<td><code>it</code></td>
<td>Iterators tracing</td>
<td>Kernel</td>
</tr>
<tr>
<td>fentry/fexit</td>
<td><code>f</code>/<code>fr</code></td>
<td>Kernel functions tracing with BTF support</td>
<td>Kernel</td>
</tr>
<tr>
<td>kprobe/kretprobe</td>
<td><code>k</code>/<code>kr</code></td>
<td>Kernel function start/return</td>
<td>Kernel</td>
</tr>
<tr>
<td>profile</td>
<td><code>p</code></td>
<td>Timed sampling</td>
<td>Kernel/User</td>
</tr>
<tr>
<td>rawtracepoint</td>
<td><code>rt</code></td>
<td>Kernel static tracepoints with raw arguments</td>
<td>Kernel</td>
</tr>
<tr>
<td>software</td>
<td><code>s</code></td>
<td>Kernel software events</td>
<td>Kernel</td>
</tr>
<tr>
<td>tracepoint</td>
<td><code>t</code></td>
<td>Kernel static tracepoints</td>
<td>Kernel</td>
</tr>
<tr>
<td>uprobe/uretprobe</td>
<td><code>u</code>/<code>ur</code></td>
<td>User-level function start/return</td>
<td>User</td>
</tr>
<tr>
<td>usdt</td>
<td><code>U</code></td>
<td>User-level static tracepoints</td>
<td>User</td>
</tr>
<tr>
<td>watchpoint/asyncwatchpoint</td>
<td><code>w</code>/<code>aw</code></td>
<td>Memory watchpoints</td>
<td>Kernel</td>
</tr>
</tbody>
</table>
<h3 id="basic-structure-of-a-bpftrace-script">Basic Structure of a bpftrace Script<a class="td-heading-self-link" href="#basic-structure-of-a-bpftrace-script" aria-label="Heading self-link"></a></h3>
<pre tabindex="0"><code class="language-bpftrace" data-lang="bpftrace">probe_type:probe_identifier
{
    // Action code block
    printf(&#34;Hello, world!\n&#34;);
}
</code></pre><p>For example, to print a message every time a process calls the <code>unlinkat()</code> syscall, you might write:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unlinkat syscall invoked</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>sys_enter_unlinkat</code> tracepoint&rsquo;s arguments can be listed from <code>/sys/kernel/debug/tracing/events/syscalls/sys_enter_unlinkat/format</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>name: sys_enter_unlinkat
</span></span><span style="display:flex;"><span>ID: <span style="color:#0000cf;font-weight:bold">849</span>
</span></span><span style="display:flex;"><span>format:
</span></span><span style="display:flex;"><span>	field:unsigned short common_type<span style="color:#000;font-weight:bold">;</span>	offset:0<span style="color:#000;font-weight:bold">;</span>	size:2<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_flags<span style="color:#000;font-weight:bold">;</span>	offset:2<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:unsigned char common_preempt_count<span style="color:#000;font-weight:bold">;</span>	offset:3<span style="color:#000;font-weight:bold">;</span>	size:1<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int common_pid<span style="color:#000;font-weight:bold">;</span>	offset:4<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	field:int __syscall_nr<span style="color:#000;font-weight:bold">;</span>	offset:8<span style="color:#000;font-weight:bold">;</span>	size:4<span style="color:#000;font-weight:bold">;</span>	signed:1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int dfd<span style="color:#000;font-weight:bold">;</span>	offset:16<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:const char * pathname<span style="color:#000;font-weight:bold">;</span>	offset:24<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	field:int flag<span style="color:#000;font-weight:bold">;</span>	offset:32<span style="color:#000;font-weight:bold">;</span>	size:8<span style="color:#000;font-weight:bold">;</span>	signed:0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print fmt: <span style="color:#4e9a06">&#34;dfd: 0x%08lx, pathname: 0x%08lx, flag: 0x%08lx&#34;</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;dfd<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;pathname<span style="color:#ce5c00;font-weight:bold">))</span>, <span style="color:#ce5c00;font-weight:bold">((</span>unsigned long<span style="color:#ce5c00;font-weight:bold">)(</span>REC-&gt;flag<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>Therefore, we can use <code>str(args.pathname)</code> to extract the name of the file being deleted. <code>args</code> is one of the bpftrace builtins which is a data struct of all arguments of the traced function and it can be used with tracepoint, fentry, fexit.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_unlinkat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Process %s (PID: %d) is deleting a file %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pathname</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Attaching <span style="color:#0000cf;font-weight:bold">1</span> probe...
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2269<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test1
</span></span><span style="display:flex;"><span>Process rm <span style="color:#ce5c00;font-weight:bold">(</span>PID: 2270<span style="color:#ce5c00;font-weight:bold">)</span> is deleting a file test2
</span></span></code></pre></div><p>Let&rsquo;s convert this eBPF kernel code to bpftrace</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __TARGET_ARCH_x86
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Type of BPF map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// Maximum number of entries in the map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                            <span style="color:#8f5902;font-style:italic">// Type of the key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">);</span>                          <span style="color:#8f5902;font-style:italic">// Type of the value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">mkdir</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Dual BSD/GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kprobe/do_mkdirat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">BPF_KPROBE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">do_mkdirat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">umode_t</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pid_t</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">event</span> <span style="color:#000">ev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BPF_CORE_READ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_probe_read_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_perf_event_output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">mkdir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_F_CURRENT_CPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ev</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s build the same code without Maps as it will be explained shortly</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">kprobe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">do_mkdirat</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PID: %d, mode: %d, filename: %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">arg2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">(((</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">filename</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">arg1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The idea is to cast <code>arg1</code> to a pointer to <code>struct filename</code> before accessing <code>name</code> field.</p>
<h2 id="bpftrace-maps">bpftrace Maps<a class="td-heading-self-link" href="#bpftrace-maps" aria-label="Heading self-link"></a></h2>
<p>Maps in bpftrace are defined with <code>@</code> such as <code>@testmap</code>. The following table is from bpftrace manual, listing bpftrace map functions along with their corresponding descriptions.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>avg</td>
<td>Calculate the running average of <code>n</code> between consecutive calls.</td>
</tr>
<tr>
<td>clear</td>
<td>Clear all keys/values from a map.</td>
</tr>
<tr>
<td>count</td>
<td>Count how often this function is called.</td>
</tr>
<tr>
<td>delete</td>
<td>Delete a single key from a map.</td>
</tr>
<tr>
<td>has_key</td>
<td>Return true (1) if the key exists in this map. Otherwise return false (0).</td>
</tr>
<tr>
<td>hist</td>
<td>Create a log2 histogram of n using buckets per power of 2, 0 &lt;= k &lt;= 5, defaults to 0.</td>
</tr>
<tr>
<td>len</td>
<td>Return the number of elements in a map.</td>
</tr>
<tr>
<td>lhist</td>
<td>Create a linear histogram of n. lhist creates M ((max - min) / step) buckets in the range [min, max) where each bucket is step in size.</td>
</tr>
<tr>
<td>max</td>
<td>Update the map with n if n is bigger than the current value held.</td>
</tr>
<tr>
<td>min</td>
<td>Update the map with n if n is smaller than the current value held.</td>
</tr>
<tr>
<td>stats</td>
<td>Combines the count, avg and sum calls into one.</td>
</tr>
<tr>
<td>sum</td>
<td>Calculate the sum of all n passed.</td>
</tr>
<tr>
<td>zero</td>
<td>Set all values for all keys to zero.</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&#34;vmlinux.h&#34;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">forks</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_MAP_TYPE_HASH</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_entries</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">setuid</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.maps&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_fork&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_fork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_setuid&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_setuid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">u8</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_map_update_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BPF_ANY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">trace_execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">trace_event_raw_sys_enter</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u32</span> <span style="color:#000">pid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_get_current_pid_tgid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priv</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bpf_map_lookup_elem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">forked</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">priv</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bpf_send_signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">LICENSE</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">SEC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;license&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GPL&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Let&rsquo;s see the previous code in bpftrace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace         
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_fork</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fork detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_setuid</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Setuid detected: PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_execve</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Privilege escalation detected: fork, setuid(0), execve, PID %d</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Define a map with name <code>forks</code> and add current<code>pid</code> as key and <code>1</code> as value if <code>sys_enter_setuid</code> tracepoint is triggered.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>Define a map with name <code>setuid</code> and add current <code>pid</code> as key and <code>1</code> as value if <code>sys_enter_fork</code> tracepoint is triggered and UID is zero.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>If <code>sys_enter_execve</code> is triggered, hen it will check if the current <code>pid</code> triggered by <code>sys_enter_setuid</code> and <code>sys_enter_fork</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">forks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#a40000">@</span><span style="color:#000">setuid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>signal</code> function is equivalent to <code>bpf_send_signal</code> helper function to terminate the process.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We have to run this code with <code>--unsafe</code> because we running dangerous function which is <code>signal</code>, then to run it <code>sudo bpftrace --unsafe priv-esc.bt</code>.
This code is much smaller and simpler than eBPF kernel code, and no need for user-space code.</p>
<p>The next script attaches probes to the <code>sys_enter_read</code> and <code>sys_enter_write</code> syscalls (separated with comma <code>,</code>) and uses a map to count the number of system calls per process using <code>count()</code> map function.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bpftrace
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_read</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">tracepoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">syscalls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">sys_enter_write</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">comm</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This will activate every 5 seconds (using interval probe) to clear the screen using ANSI escape sequences <code>printf(&quot;\033[H\033[2J&quot;);</code>, then print the content of <code>syscalls</code> map.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f57900">interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f57900">s</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#000;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[H</span><span style="color:#4e9a06">\033</span><span style="color:#4e9a06">[2J&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">@</span><span style="color:#000">syscalls</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-timesyn<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd-journal<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>systemd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>rtkit-daemon<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sudo<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gnome-shell<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">13</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>gvfsd-wsdd<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bash<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>ls<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>bpftrace<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>@syscalls<span style="color:#ce5c00;font-weight:bold">[</span>sshd-session<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#0000cf;font-weight:bold">818</span>
</span></span></code></pre></div><h2 id="bpftrace-tools">bpftrace Tools<a class="td-heading-self-link" href="#bpftrace-tools" aria-label="Heading self-link"></a></h2>
<p>The following tools from bpftrace github repository. They cover a wide range of functions from tracing I/O and network events to monitoring process and syscall activity.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bashreadline.bt</td>
<td>Print entered bash commands system wide. Examples.</td>
</tr>
<tr>
<td>biolatency.bt</td>
<td>Block I/O latency as a histogram. Examples.</td>
</tr>
<tr>
<td>biosnoop.bt</td>
<td>Block I/O tracing tool, showing per I/O latency. Examples.</td>
</tr>
<tr>
<td>biostacks.bt</td>
<td>Show disk I/O latency with initialization stacks. Examples.</td>
</tr>
<tr>
<td>bitesize.bt</td>
<td>Show disk I/O size as a histogram. Examples.</td>
</tr>
<tr>
<td>capable.bt</td>
<td>Trace security capability checks. Examples.</td>
</tr>
<tr>
<td>cpuwalk.bt</td>
<td>Sample which CPUs are executing processes. Examples.</td>
</tr>
<tr>
<td>dcsnoop.bt</td>
<td>Trace directory entry cache (dcache) lookups. Examples.</td>
</tr>
<tr>
<td>execsnoop.bt</td>
<td>Trace new processes via exec() syscalls. Examples.</td>
</tr>
<tr>
<td>gethostlatency.bt</td>
<td>Show latency for getaddrinfo/gethostbyname[2] calls. Examples.</td>
</tr>
<tr>
<td>killsnoop.bt</td>
<td>Trace signals issued by the kill() syscall. Examples.</td>
</tr>
<tr>
<td>loads.bt</td>
<td>Print load averages. Examples.</td>
</tr>
<tr>
<td>mdflush.bt</td>
<td>Trace md flush events. Examples.</td>
</tr>
<tr>
<td>naptime.bt</td>
<td>Show voluntary sleep calls. Examples.</td>
</tr>
<tr>
<td>opensnoop.bt</td>
<td>Trace open() syscalls showing filenames. Examples.</td>
</tr>
<tr>
<td>oomkill.bt</td>
<td>Trace OOM killer. Examples.</td>
</tr>
<tr>
<td>pidpersec.bt</td>
<td>Count new processes (via fork). Examples.</td>
</tr>
<tr>
<td>runqlat.bt</td>
<td>CPU scheduler run queue latency as a histogram. Examples.</td>
</tr>
<tr>
<td>runqlen.bt</td>
<td>CPU scheduler run queue length as a histogram. Examples.</td>
</tr>
<tr>
<td>setuids.bt</td>
<td>Trace the setuid syscalls: privilege escalation. Examples.</td>
</tr>
<tr>
<td>ssllatency.bt</td>
<td>Summarize SSL/TLS handshake latency as a histogram. Examples.</td>
</tr>
<tr>
<td>sslsnoop.bt</td>
<td>Trace SSL/TLS handshake, showing latency and return value. Examples.</td>
</tr>
<tr>
<td>statsnoop.bt</td>
<td>Trace stat() syscalls for general debugging. Examples.</td>
</tr>
<tr>
<td>swapin.bt</td>
<td>Show swapins by process. Examples.</td>
</tr>
<tr>
<td>syncsnoop.bt</td>
<td>Trace sync() variety of syscalls. Examples.</td>
</tr>
<tr>
<td>syscount.bt</td>
<td>Count system calls. Examples.</td>
</tr>
<tr>
<td>tcpaccept.bt</td>
<td>Trace TCP passive connections (accept()). Examples.</td>
</tr>
<tr>
<td>tcpconnect.bt</td>
<td>Trace TCP active connections (connect()). Examples.</td>
</tr>
<tr>
<td>tcpdrop.bt</td>
<td>Trace kernel-based TCP packet drops with details. Examples.</td>
</tr>
<tr>
<td>tcplife.bt</td>
<td>Trace TCP session lifespans with connection details. Examples.</td>
</tr>
<tr>
<td>tcpretrans.bt</td>
<td>Trace TCP retransmits. Examples.</td>
</tr>
<tr>
<td>tcpsynbl.bt</td>
<td>Show TCP SYN backlog as a histogram. Examples.</td>
</tr>
<tr>
<td>threadsnoop.bt</td>
<td>List new thread creation. Examples.</td>
</tr>
<tr>
<td>undump.bt</td>
<td>Capture UNIX domain socket packages. Examples.</td>
</tr>
<tr>
<td>vfscount.bt</td>
<td>Count VFS calls. Examples.</td>
</tr>
<tr>
<td>vfsstat.bt</td>
<td>Count some VFS calls, with per-second summaries. Examples.</td>
</tr>
<tr>
<td>writeback.bt</td>
<td>Trace file system writeback events with details. Examples.</td>
</tr>
<tr>
<td>xfsdist.bt</td>
<td>Summarize XFS operation latency distribution as a histogram. Examples.</td>
</tr>
</tbody>
</table>

	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>