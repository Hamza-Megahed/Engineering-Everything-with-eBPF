<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Seccomp | Engineering Everything with eBPF</title>
<meta name="description" content="Restrict system calls with flexible logic beyond static tables.">
<meta property="og:url" content="https://ebpf.hamza-megahed.com/docs/chapter5/1-seccomp/">
  <meta property="og:site_name" content="Engineering Everything with eBPF">
  <meta property="og:title" content="Seccomp">
  <meta property="og:description" content="Restrict system calls with flexible logic beyond static tables.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">

  <meta itemprop="name" content="Seccomp">
  <meta itemprop="description" content="Restrict system calls with flexible logic beyond static tables.">
  <meta itemprop="wordCount" content="3156">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Seccomp">
  <meta name="twitter:description" content="Restrict system calls with flexible logic beyond static tables.">
<link rel="preload" href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" as="style" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<link href="/scss/main.min.48c25d0a5a23a1e8cae94d6c5e7622061e5345cf098171b1d6ee41d8e309e6c8.css" rel="stylesheet" integrity="sha256-SMJdClojoejK6U1sXnYiBh5TRc8JgXGx1u5B2OMJ5sg=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"></span><span class="navbar-brand__name">Engineering Everything with eBPF</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><span>Documentation</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.d321c7c75caef9d9e13951f6e9298449.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.d321c7c75caef9d9e13951f6e9298449.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Engineering Everything with eBPF" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter0-li">
  <a href="/docs/chapter0/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter0"><span class="">Before We Begin</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter01-author-li">
  <a href="/docs/chapter0/1-author/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter01-author"><span class="">Author</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter03-copyright-li">
  <a href="/docs/chapter0/3-copyright/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter03-copyright"><span class="">Copyright</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter04-preface-li">
  <a href="/docs/chapter0/4-preface/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter04-preface"><span class="">Preface</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter05-contribution-li">
  <a href="/docs/chapter0/5-contribution/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter05-contribution"><span class="">Contribution Guidelines</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter02-acknowledgements-li">
  <a href="/docs/chapter0/2-acknowledgements/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter02-acknowledgements"><span class=""></span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter1-li">
  <a href="/docs/chapter1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter1"><span class="">What is eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter11-intro-li">
  <a href="/docs/chapter1/1-intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter11-intro"><span class="">Introduction</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter12-history-li">
  <a href="/docs/chapter1/2-history/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter12-history"><span class="">History of eBPF</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter13-real-world-li">
  <a href="/docs/chapter1/3-real-world/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter13-real-world"><span class="">eBPF in the Real World</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter14-why-li">
  <a href="/docs/chapter1/4-why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter14-why"><span class="">Why eBPF?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter15-arch-li">
  <a href="/docs/chapter1/5-arch/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter15-arch"><span class="">eBPF Architecture</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter2-li">
  <a href="/docs/chapter2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter2"><span class="">eBPF Taking off</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter21-bpf_syscall-li">
  <a href="/docs/chapter2/1-bpf_syscall/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter21-bpf_syscall"><span class="">bpf() syscall</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter22-maps-li">
  <a href="/docs/chapter2/2-maps/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter22-maps"><span class="">eBPF Maps</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter23-map_operations-li">
  <a href="/docs/chapter2/3-map_operations/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter23-map_operations"><span class="">eBPF Map Operations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter24-prog_types-li">
  <a href="/docs/chapter2/4-prog_types/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter24-prog_types"><span class="">eBPF Program Types</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter3-li">
  <a href="/docs/chapter3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter3"><span class="">eBPF Probes</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter31-kprobe-kretprobe-li">
  <a href="/docs/chapter3/1-kprobe-kretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter31-kprobe-kretprobe"><span class="">Kprobe and Kretprobe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter32-uprobe-uretprobe-li">
  <a href="/docs/chapter3/2-uprobe-uretprobe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter32-uprobe-uretprobe"><span class="">Uprobes and Uretprobes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter33-tracepoints-li">
  <a href="/docs/chapter3/3-tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter33-tracepoints"><span class="">Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter34-raw_tracepoints-li">
  <a href="/docs/chapter3/4-raw_tracepoints/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter34-raw_tracepoints"><span class="">Raw Tracepoints</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter35-fentry-fexit-li">
  <a href="/docs/chapter3/5-fentry-fexit/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter35-fentry-fexit"><span class="">Fentry and Fexit</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter4-li">
  <a href="/docs/chapter4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter4"><span class="">Networking with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter41-socket-li">
  <a href="/docs/chapter4/1-socket/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter41-socket"><span class="">Socket Filter</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter42-lwt-li">
  <a href="/docs/chapter4/2-lwt/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter42-lwt"><span class="">Lightweight Tunnels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter43-tc-li">
  <a href="/docs/chapter4/3-tc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter43-tc"><span class="">Traffic Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter44-xdp-li">
  <a href="/docs/chapter4/4-xdp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter44-xdp"><span class="">XDP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter45-cgroup_sock_addr-li">
  <a href="/docs/chapter4/5-cgroup_sock_addr/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter45-cgroup_sock_addr"><span class="">CGroup Socket Address</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docschapter5-li">
  <a href="/docs/chapter5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter5"><span class="">Security with eBPF</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docschapter51-seccomp-li">
  <a href="/docs/chapter5/1-seccomp/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-docschapter51-seccomp"><span class="td-sidebar-nav-active-item">Seccomp</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter52-lsm-li">
  <a href="/docs/chapter5/2-lsm/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter52-lsm"><span class="">Linux Security Module (LSM)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter53-landlock-li">
  <a href="/docs/chapter5/3-landlock/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter53-landlock"><span class="">Landlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter54-bpf_send_signal-li">
  <a href="/docs/chapter5/4-bpf_send_signal/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter54-bpf_send_signal"><span class="">bpf_send_signal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter55-tetragon-li">
  <a href="/docs/chapter5/5-tetragon/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter55-tetragon"><span class="">Tetragon</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter56-bpfilter-li">
  <a href="/docs/chapter5/6-bpfilter/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter56-bpfilter"><span class="">Bpfilter</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docschapter6-li">
  <a href="/docs/chapter6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docschapter6"><span class="">Tools and languages</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter61-bpftrace-li">
  <a href="/docs/chapter6/1-bpftrace/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter61-bpftrace"><span class="">bpftrace</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter62-bcc-li">
  <a href="/docs/chapter6/2-bcc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter62-bcc"><span class="">BCC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter63-bpftool-li">
  <a href="/docs/chapter6/3-bpftool/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter63-bpftool"><span class="">BPFTool</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docschapter64-tail-call-li">
  <a href="/docs/chapter6/4-tail-call/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docschapter64-tail-call"><span class="">Tail call</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/tree/main/content/docs/chapter5/1-seccomp.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/edit/main/content/docs/chapter5/1-seccomp.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/new/main/content/docs/chapter5?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new?title=Seccomp" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF/issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="/docs/chapter5/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#seccomp-return-values">Seccomp Return Values</a></li>
        <li><a href="#bpf-macros">BPF Macros</a></li>
        <li><a href="#code-example">Code Example</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a></li>
  <li class="breadcrumb-item">
    <a href="/docs/chapter5/">Security with eBPF</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    Seccomp</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Seccomp</h1>
	<div class="lead">Restrict system calls with flexible logic beyond static tables.</div>
	<header class="article-meta">
		
  </header>
	<p>Seccomp, short for Secure Computing Mode, is a powerful kernel feature that limits the system calls a process can make, thereby reducing the exposed kernel surface and mitigating potential attacks. Seccomp is a security facility in the Linux kernel designed to be a tool for sandboxing processes by restricting the set of system calls they can use. to minimizes the kernel’s exposed interface, allowing developers to reduce the risk of kernel-level exploits. The filtering mechanism is implemented using Berkeley Packet Filter (cBPF) programs which inspect system call numbers and arguments before the system call is executed.</p>
<p>User-space security agents are vulnerable to TOCTOU attacks, tampering, and resource exhaustion because they depend on kernel communication to make security decisions. Seccomp addresses these issues by moving filtering into the kernel. Using a cBPF program, seccomp evaluates system call metadata atomically, eliminating the window for TOCTOU exploits and preventing tampering—since filters, once installed, become immutable and are inherited by child processes. This kernel-level enforcement ensures robust protection even if the user-space agent is compromised. Seccomp filtering is implemented as follows:</p>
<ol>
<li>The filter is defined as a cBPF program that evaluates each system call based on its number and its arguments. Since cBPF programs cannot dereference pointers, they operate only on the provided system call metadata, preventing time-of-check-time-of-use (TOCTOU) vulnerabilities.</li>
<li>Once a process installs a seccomp filter using either the prctl() or seccomp() system call, every system call is intercepted and evaluated by the BPF program within the kernel. This means that even if the application logic is compromised, the kernel remains protected by the filter rules.</li>
</ol>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    cBPF’s limitations ensure that the filter logic only works with the system call metadata, making it less susceptible to common attacks that exploit pointer dereferencing.

</div>

<p>The <code>prctl</code> system call is used to control specific characteristics of the calling process and will be explained shortly. Using Seccomp in an application, developers typically follow these steps:</p>
<ol>
<li>The filter is defined using the <code>struct seccomp_data</code> which is defined in the kernel source code <code>include/uapi/linux/seccomp.h</code> which provides the metadata needed to evaluate each system call. This structure is defined as follows:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * struct seccomp_data - the format the BPF program executes over.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @nr: the system call number
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @arch: indicates system call convention as an AUDIT_ARCH_* value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        as defined in &lt;linux/audit.h&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @instruction_pointer: at the time of the system call.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @args: up to 6 system call arguments always stored as 64-bit values
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *        regardless of the architecture.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u32</span> <span style="color:#000">arch</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">instruction_pointer</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__u64</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><ol start="2">
<li>Ensure that the process or its children cannot gain elevated privileges after the filter is installed using the following:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><ol start="3">
<li>Use the <code>prctl</code>  with <code>PR_SET_SECCOMP</code> to Install or activate seccomp filtering with a BPF program:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Here, <code>prog</code> is a pointer to a <code>struct sock_fprog</code> (defined in <code>include/uapi/linux/filter.h</code>) containing the BPF filter.</p>
<h3 id="seccomp-return-values">Seccomp Return Values<a class="td-heading-self-link" href="#seccomp-return-values" aria-label="Heading self-link"></a></h3>
<p>When a system call is intercepted, the BPF program returns one of several possible values. Each return value directs the kernel on how to handle the intercepted call. The actions are prioritized, meaning that if multiple filters are in place, the one with the highest precedence takes effect. The primary return values are:</p>
<ol>
<li><code>SECCOMP_RET_KILL_PROCESS</code>: Immediately terminates the entire process. The exit status indicates a SIGSYS signal.</li>
<li><code>SECCOMP_RET_KILL_THREAD</code>: Terminates only the current thread, again with a SIGSYS signal.</li>
<li><code>SECCOMP_RET_TRAP</code>: Sends a SIGSYS signal to the process, allowing the kernel to pass metadata about the blocked call (like the system call number and address) to a signal handler.</li>
<li><code>SECCOMP_RET_ERRNO</code>: Prevents execution of the system call and returns a predefined errno to the calling process.</li>
<li><code>SECCOMP_RET_USER_NOTIF</code>:  Routes the system call to a user space notification handler, allowing external processes (like container managers) to decide how to handle the call.</li>
<li><code>SECCOMP_RET_TRACE</code>: If a tracer is attached (via <code>ptrace</code>), the tracer is notified, giving it an opportunity to modify or skip the system call.</li>
<li><code>SECCOMP_RET_LOG</code>: Logs the system call, then allows its execution. This is useful for development and debugging.</li>
<li><code>SECCOMP_RET_ALLOW</code>: Simply allows the system call to execute.</li>
</ol>
<p>Seccomp return values are defined in <code>include/linux/seccomp.h</code> Kernel source code as the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL_PROCESS 0x80000000U </span><span style="color:#8f5902;font-style:italic">/* kill the process */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL_THREAD	 0x00000000U </span><span style="color:#8f5902;font-style:italic">/* kill the thread */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_KILL	 SECCOMP_RET_KILL_THREAD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_TRAP	 0x00030000U </span><span style="color:#8f5902;font-style:italic">/* disallow and force a SIGSYS */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_ERRNO	 0x00050000U </span><span style="color:#8f5902;font-style:italic">/* returns an errno */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_USER_NOTIF	 0x7fc00000U </span><span style="color:#8f5902;font-style:italic">/* notifies userspace */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_TRACE	 0x7ff00000U </span><span style="color:#8f5902;font-style:italic">/* pass to a tracer or disallow */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_LOG		 0x7ffc0000U </span><span style="color:#8f5902;font-style:italic">/* allow after logging */</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SECCOMP_RET_ALLOW	 0x7fff0000U </span><span style="color:#8f5902;font-style:italic">/* allow */</span><span style="color:#8f5902;font-style:italic">
</span></span></span></code></pre></div><h3 id="bpf-macros">BPF Macros<a class="td-heading-self-link" href="#bpf-macros" aria-label="Heading self-link"></a></h3>
<p>Seccomp filters consist of a set of BPF macros. We will explain the most used ones:</p>
<ol>
<li><code>BPF_STMT</code> (code, k): A macro used to define a basic cBPF instruction that does not involve conditional branching. The <code>code</code> parameter specifies the operation, and <code>k</code> is an immediate constant value used by the instruction.</li>
<li><code>BPF_JUMP</code> (code, k, jt, jf): A macro to define a conditional jump instruction.<br>
code: Specifies the jump operation along with condition flags.<br>
k: The constant value to compare against.<br>
jt (jump true): The number of instructions to skip if the condition is met.<br>
jf (jump false): The number of instructions to skip if the condition is not met.</li>
<li><code>BPF_LD</code>: This flag indicates a load instruction, which reads data into the accumulator.</li>
<li><code>BPF_W</code>: Specifies that the data to load is a word (typically 32 bits).</li>
<li><code>BPF_ABS</code>: Instructs the load operation to use absolute addressing—that is, load data from a fixed offset within the data structure (in this case, the <code>seccomp_data</code> structure).</li>
<li><code>BPF_K</code>: Denotes that the operand (<code>k</code>) is an immediate constant.</li>
<li><code>BPF_JMP</code>: Indicates that the instruction is a jump (conditional or unconditional) type.</li>
<li><code>BPF_JEQ</code>: A condition flag used with jump instructions that causes a jump if the accumulator equals the constant <code>k</code>.</li>
</ol>
<p>Let&rsquo;s explore a simplified C code example demonstrating how to set up a seccomp filter to block <code>socket</code> syscall to prevent a process from initiating new network connections.</p>
<h3 id="code-example">Code Example<a class="td-heading-self-link" href="#code-example" aria-label="Heading self-link"></a></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYSCALL_SOCKET 41 </span><span style="color:#8f5902;font-style:italic">// syscall number for socket
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYSCALL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp filter installed. Attempting socket on %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;socket&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Seccomp filter is written using cBPF macros and defines a simple seccomp policy to block the socket system call. First, loads the system call number (from the <code>nr</code> field of the <code>seccomp_data</code> structure) into the accumulator</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span></code></pre></div><ul>
<li><code>BPF_LD</code>: Instructs the program to load data.</li>
<li><code>BPF_W</code>: Specifies that a 32-bit word should be loaded.</li>
<li><code>BPF_ABS</code>: Indicates that the data is located at an absolute offset from the beginning of the <code>seccomp_data</code> structure.</li>
<li><code>offsetof(struct seccomp_data, nr)</code>: Computes the offset of the <code>nr</code> field (which holds the system call number) within the <code>seccomp_data</code> structure.</li>
</ul>
<p>Second, compare the syscall Number with <code>socket</code>. If the syscall is <code>socket</code>, the next instruction (which blocks the syscall) is executed. Otherwise, the filter skips over the block action and moves on.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYSCALL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><ul>
<li><code>BPF_JMP</code>: Specifies that this is a jump instruction.</li>
<li><code>BPF_JEQ</code>: Adds the condition &ldquo;jump if equal&rdquo; to the operation.</li>
<li><code>BPF_K</code>: Indicates that the comparison value is an immediate constant.</li>
<li><code>SYSCALL_SOCKET</code>: The constant to compare against (i.e., the syscall number for <code>socket</code>).
<ul>
<li><code>0</code>: If the condition is true (the syscall number equals <code>SYSCALL_SOCKET</code>), do not skip any instructions (i.e., continue with the next instruction).</li>
<li><code>1</code>: If the condition is false (the syscall number does not equal <code>SYSCALL_SOCKET</code>), skip one instruction.</li>
</ul>
</li>
</ul>
<p>Third, Block the socket() syscall and return error code (e.g., EPERM).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span></code></pre></div><ul>
<li><code>BPF_RET</code>: Instructs the program to return a value immediately, effectively terminating the BPF program&rsquo;s evaluation for this syscall.</li>
<li><code>BPF_K</code>: Indicates that the return value is given as an immediate constant.</li>
<li><code>Return Value</code>: <code>SECCOMP_RET_ERRNO | (EPERM &amp; SECCOMP_RET_DATA)</code><br>
This tells the kernel to block the syscall by returning an error. Specifically, it sets the syscall&rsquo;s return value to an error code (<code>EPERM</code>), meaning &ldquo;Operation not permitted.&rdquo;</li>
</ul>
<p>Fourth, If the syscall was not <code>socket</code>, this instruction permits it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><ul>
<li><code>BPF_RET | BPF_K</code>: Again, a return instruction with a constant.</li>
<li><code>Return Value</code>: <code>SECCOMP_RET_ALLOW</code>. This instructs the kernel to allow the syscall to proceed.</li>
</ul>
<p>Then, ensure that the process or its children cannot gain elevated privileges after the filter is installed</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>PR_SET_NO_NEW_PRIVS</code>:This option tells the kernel to set a flag that prevents the process or its children from gaining new privileges. Finally, installing the seccomp filter.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Compile the code using <code>clang -g -O2 seccomp_socket.c -o seccomp_socket</code>, then <code>chmod +x seccomp_socket</code>. Next, run the code against <code>ssh</code> similar to the following: <code>./seccomp_socket /usr/bin/ssh test@192.168.1.3</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Seccomp filter installed. Attempting socket on /usr/bin/ssh...
</span></span><span style="display:flex;"><span>socket: Operation not permitted
</span></span><span style="display:flex;"><span>ssh: connect to host 192.168.1.3 port 22: failure
</span></span></code></pre></div><p style="text-align: center;">
  <img src="/images/docs/chapter5/seccomp-example1.png" alt="Centered image" />
</p>
<p>We can see what is happening under the hood using <code>strace ./seccomp_socket /usr/bin/ssh test@192.168.1.3</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>newfstatat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/etc/nsswitch.conf&#34;</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFREG<span style="color:#000;font-weight:bold">|</span>0644, <span style="color:#000">st_size</span><span style="color:#ce5c00;font-weight:bold">=</span>569, ...<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span>, O_RDONLY<span style="color:#000;font-weight:bold">|</span>O_CLOEXEC<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFREG<span style="color:#000;font-weight:bold">|</span>0644, <span style="color:#000">st_size</span><span style="color:#ce5c00;font-weight:bold">=</span>2232, ...<span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>lseek<span style="color:#ce5c00;font-weight:bold">(</span>3, 0, SEEK_SET<span style="color:#ce5c00;font-weight:bold">)</span>                   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;root:x:0:0:root:/root:/bin/bash\n&#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2232</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>3<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>socket<span style="color:#ce5c00;font-weight:bold">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> -1 EPERM <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>getpid<span style="color:#ce5c00;font-weight:bold">()</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2169</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;socket: Operation not permitted\r&#34;</span>..., 33socket: Operation not permitted
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">33</span>
</span></span><span style="display:flex;"><span>getpid<span style="color:#ce5c00;font-weight:bold">()</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2169</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;ssh: connect to host 192.168.1.3&#34;</span>..., 51ssh: connect to host 192.168.1.3 port 22: failure
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>Executing socket syscall is being blocked and a return value is showing <code>-1 EPERM (Operation not permitted)</code>, which confirms that the filter is working as intended.</p>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">Note</h4>

    The header file <code>/include/linux/syscalls.h</code> in the Linux kernel source code contains the prototypes for all system calls, providing the necessary declarations for the syscall interfaces. Additionally, for the x86_64 architecture, the file <code>arch/x86/entry/syscalls/syscall_64.tbl</code> lists all the system calls along with their corresponding syscall IDs, which are used to generate the syscall dispatch table during the kernel build process.

</div>

<p>In the previous example we took blacklist approach by denying socket syscall for example. If we want to take the whitelist approach for a specific binary all we have to do is to record all its syscalls using something like strace. Let&rsquo;s explore the whitelist approach, the following code has a menu with list of options such as running command ls which uses execve syscall , or opening /etc/passwd which uses open syscall and write syscall.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;fcntl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">choice</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Syscall Menu:</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1. Execve /usr/bin/ls</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2. Open /etc/passwd</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;3. Write a message to stdout</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;4. Exit</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Enter your choice: &#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">scanf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">choice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Invalid input.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getchar</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#39;\n&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">EOF</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">getchar</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">choice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;ls&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">envp</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87">NULL</span> <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Executing /usr/bin/ls via execve syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_execve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/usr/bin/ls&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">envp</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Opening /etc/passwd via open syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_open</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/etc/passwd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">O_RDONLY</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;open syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;File /etc/passwd opened successfully (fd = %d).</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;close syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello from syscall write!</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Writing message to stdout via write syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_write</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STDOUT_FILENO</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exiting via exit_group syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_exit_group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Invalid choice. Please select a number between 1 and 5.</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s compile it using <code>gcc -O2 -Wall syscalls.c -o syscalls</code>. Recording syscall can be done using strace. For example, we want to record write option in our code.
<code>strace -c -f ./syscalls</code> , then choose option 3:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span>Hello from syscall write!
</span></span></code></pre></div><p>The strace would look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>% <span style="color:#204a87">time</span>     seconds  usecs/call     calls    errors syscall
</span></span><span style="display:flex;"><span>------ ----------- ----------- --------- --------- ----------------
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           <span style="color:#204a87">read</span>
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">9</span>           write
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           close
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">4</span>           fstat
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">8</span>           mmap
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">3</span>           mprotect
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           munmap
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">3</span>           brk
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           pread64
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span> access
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           execve
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           arch_prctl
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           set_tid_address
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">2</span>           openat
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           set_robust_list
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           prlimit64
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           getrandom
</span></span><span style="display:flex;"><span>  0.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">1</span>           rseq
</span></span><span style="display:flex;"><span>------ ----------- ----------- --------- --------- ----------------
</span></span><span style="display:flex;"><span>100.00    0.000000           <span style="color:#0000cf;font-weight:bold">0</span>        <span style="color:#0000cf;font-weight:bold">44</span>         <span style="color:#0000cf;font-weight:bold">1</span> total
</span></span></code></pre></div><p>These are all of used syscalls to run the binary to this option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello from syscall write!</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Writing message to stdout via write syscall...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SYS_write</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">STDOUT_FILENO</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write syscall failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s build seccomp program to allow only these syscalls</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_READ             0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_WRITE            1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_CLOSE            3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_FSTAT            5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MMAP             9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MPROTECT         10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MUNMAP           11
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_BRK              12
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PREAD64          17
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ACCESS           21
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXECVE           59
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ARCH_PRCTL       158
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_TID_ADDRESS  218
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_OPENAT           257
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_ROBUST_LIST  273
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PRLIMIT64        302
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_GETRANDOM        318
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_RSEQ             334
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_READ</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_WRITE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_CLOSE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_FSTAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MMAP</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MPROTECT</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MUNMAP</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_BRK</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PREAD64</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ACCESS</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXECVE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ARCH_PRCTL</span><span style="color:#000;font-weight:bold">,</span>        <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_TID_ADDRESS</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_OPENAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_ROBUST_LIST</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PRLIMIT64</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_GETRANDOM</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_RSEQ</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp whitelist filter installed. Executing %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Compile it <code>gcc -O2 -Wall seccomp.c -o seccomp</code>, then <code>chmod +x seccomp</code> and finally <code>./seccomp ./syscalls</code> and choose 3</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span>Hello from syscall write!
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>If you choose something else like 2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Syscall Menu:
</span></span><span style="display:flex;"><span>1. Execve /usr/bin/ls
</span></span><span style="display:flex;"><span>2. Open /etc/passwd
</span></span><span style="display:flex;"><span>3. Write a message to stdout
</span></span><span style="display:flex;"><span>4. Exit
</span></span><span style="display:flex;"><span>Enter your choice: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>Opening /etc/passwd via open syscall...
</span></span><span style="display:flex;"><span>open syscall failed: Operation not permitted
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>Notice that we have <code>Segmentation fault (core dumped)</code> . Simply because we have a blocked a syscall <code>exit_group</code> , run <code>strace ./seccomp ./syscalls</code> then choose 3:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#ce5c00;font-weight:bold">(</span>0, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">st_mode</span><span style="color:#ce5c00;font-weight:bold">=</span>S_IFCHR<span style="color:#000;font-weight:bold">|</span>0620, <span style="color:#000">st_rdev</span><span style="color:#ce5c00;font-weight:bold">=</span>makedev<span style="color:#ce5c00;font-weight:bold">(</span>0x88, 0x2<span style="color:#ce5c00;font-weight:bold">)</span>, ...<span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Enter your choice: &#34;</span>, 19Enter your choice: <span style="color:#ce5c00;font-weight:bold">)</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">19</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>0, <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;3\n&#34;</span>, 1024<span style="color:#ce5c00;font-weight:bold">)</span>                    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Writing message to stdout via wr&#34;</span>..., 47Writing message to stdout via write syscall...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;Hello from syscall write!\n&#34;</span>, 26Hello from syscall write!
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>exit_group<span style="color:#ce5c00;font-weight:bold">(</span>0<span style="color:#ce5c00;font-weight:bold">)</span>                           <span style="color:#ce5c00;font-weight:bold">=</span> -1 EPERM <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>--- SIGSEGV <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">si_signo</span><span style="color:#ce5c00;font-weight:bold">=</span>SIGSEGV, <span style="color:#000">si_code</span><span style="color:#ce5c00;font-weight:bold">=</span>SI_KERNEL, <span style="color:#000">si_addr</span><span style="color:#ce5c00;font-weight:bold">=</span>NULL<span style="color:#ce5c00;font-weight:bold">}</span> ---
</span></span><span style="display:flex;"><span>+++ killed by SIGSEGV <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span> +++
</span></span><span style="display:flex;"><span>Segmentation fault <span style="color:#ce5c00;font-weight:bold">(</span>core dumped<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>We need to whitelist <code>exit_group</code> too in our code. Strace couldn&rsquo;t record <code>exit_group</code> syscall first because syscall such as <code>exit_group</code> syscall terminates the process immediately, so there’s no return value for strace to capture. Fixing our code is just by adding <code>exit_group</code> to the whitelist:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/prctl.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/seccomp.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;linux/filter.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;errno.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;sys/syscall.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_READ             0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_WRITE            1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_CLOSE            3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_FSTAT            5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MMAP             9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MPROTECT         10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_MUNMAP           11
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_BRK              12
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PREAD64          17
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ACCESS           21
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXECVE           59
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_ARCH_PRCTL       158
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_TID_ADDRESS  218
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_OPENAT           257
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_SET_ROBUST_LIST  273
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_PRLIMIT64        302
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_GETRANDOM        318
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_RSEQ             334
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SYS_EXIT_GROUP 231
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_filter</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_LD</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_W</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_ABS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">offsetof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">seccomp_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXIT_GROUP</span><span style="color:#000;font-weight:bold">,</span>       <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_READ</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_WRITE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">17</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_CLOSE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_FSTAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MMAP</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MPROTECT</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">13</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_MUNMAP</span><span style="color:#000;font-weight:bold">,</span>           <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_BRK</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PREAD64</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ACCESS</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_EXECVE</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_ARCH_PRCTL</span><span style="color:#000;font-weight:bold">,</span>        <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_TID_ADDRESS</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_OPENAT</span><span style="color:#000;font-weight:bold">,</span>            <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_SET_ROBUST_LIST</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_PRLIMIT64</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_GETRANDOM</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_JUMP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_JMP</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_JEQ</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SYS_RSEQ</span><span style="color:#000;font-weight:bold">,</span>              <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ERRNO</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">EPERM</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">SECCOMP_RET_DATA</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BPF_STMT</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BPF_RET</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">BPF_K</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_RET_ALLOW</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sock_fprog</span> <span style="color:#000">prog</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Usage: %s &lt;binary&gt; [args...]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_NO_NEW_PRIVS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prctl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PR_SET_SECCOMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SECCOMP_MODE_FILTER</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">prog</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Seccomp whitelist filter installed. Executing %s...</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">execve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">perror</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;execve failed&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">EXIT_FAILURE</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>In the following part, we will explain the LSM kernel framework, a well-defined interface to enforce Mandatory Access Control (MAC) policies in a modular way.</p>

	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/Hamza-Megahed/Engineering-Everything-with-eBPF" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">Hamza Megahed | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js" integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>